{"code_html": "\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\" />\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n  <title>Password Recovery Demo</title>\n  <style>\n    /* ========== Global & Layout (Req §4, §10) ========== */\n    :root{\n      --bg: #0f172a;\n      --card: #ffffff;\n      --text: #0b1020;\n      --muted: #5b6478;\n      --primary: #2563eb;\n      --primary-600:#1d4ed8;\n      --border:#e5e7eb;\n      --error:#dc2626;\n      --success:#16a34a;\n      --warning:#b45309;\n      --focus: #3b82f6;\n    }\n    *{box-sizing:border-box}\n    html,body{height:100%}\n    body{\n      margin:0;\n      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, \"Apple Color Emoji\",\"Segoe UI Emoji\";\n      background: linear-gradient(180deg, #0f172a 0%, #111827 100%);\n      color: var(--text);\n      display:flex;\n      flex-direction:column;\n      align-items:center;\n    }\n    header{\n      width:100%;\n      max-width: 560px;\n      padding: 24px 16px 8px;\n      color:#e5e7eb;\n      text-align:center;\n    }\n    header h1{\n      margin:0;\n      font-size: 20px;\n      letter-spacing:.2px;\n    }\n    main{\n      width:100%;\n      display:flex;\n      justify-content:center;\n      padding: 8px 16px 32px;\n    }\n    .card{\n      width:100%;\n      max-width: 440px; /* Req §4: max-width ~440px */\n      background: var(--card);\n      border-radius: 12px;\n      box-shadow: 0 10px 30px rgba(0,0,0,.25);\n      padding: 20px 20px 16px;\n    }\n    .card header.state-title{\n      padding: 4px 2px 8px;\n      border-bottom: 1px solid var(--border);\n      margin: -4px 0 16px;\n    }\n    .state-title h2{\n      margin:0;\n      font-size: 18px;\n    }\n    section[hidden]{display:none !important;}\n\n    /* Forms & Controls */\n    form{margin:0}\n    .field{margin-bottom:14px}\n    label{\n      display:block;\n      margin-bottom:6px;\n      font-size: 14px;\n      color: #111827;\n      font-weight: 600;\n    }\n    input[type=\"text\"],\n    input[type=\"email\"],\n    input[type=\"password\"]{\n      width:100%;\n      padding: 12px 12px;\n      height: 44px; /* Req §4: 44px min */\n      border:1px solid var(--border);\n      border-radius: 8px;\n      font-size: 16px;\n      outline: none;\n      transition: border-color .15s;\n    }\n    input:focus{\n      border-color: var(--focus);\n      box-shadow: 0 0 0 3px rgba(59,130,246,0.2);\n    }\n    .hint{\n      font-size: 13px;\n      color: var(--muted);\n      margin-top: 6px;\n    }\n    .error{\n      color: var(--error);\n      font-size: 13px;\n      margin-top: 6px;\n    }\n    .notice{\n      color: var(--warning);\n      font-size: 13px;\n      margin-top: 8px;\n    }\n    .success{\n      color: var(--success);\n    }\n\n    /* Buttons */\n    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px;}\n    .btn{\n      border: none;\n      border-radius: 8px;\n      padding: 12px 16px;\n      min-height: 44px; /* Req §4 tap target */\n      font-size: 15px;\n      cursor: pointer;\n      transition: transform .02s ease-in-out, background-color .15s, color .15s, opacity .15s;\n    }\n    .btn:active{transform: translateY(1px)}\n    .btn-primary{\n      background: var(--primary);\n      color: #fff;\n    }\n    .btn-primary:hover{background: var(--primary-600)}\n    .btn-secondary{\n      background: #f3f4f6;\n      color: #111827;\n      border: 1px solid var(--border);\n    }\n    .btn-link{\n      background: transparent;\n      color: var(--primary);\n      text-decoration: underline;\n      padding: 0;\n      min-height: 0;\n    }\n    .btn[disabled]{\n      opacity: .55;\n      cursor: not-allowed;\n    }\n\n    /* Radios */\n    .radio-row{\n      display:flex; align-items:center; gap:10px;\n      border:1px solid var(--border);\n      padding:12px; border-radius:8px;\n    }\n    .radio-row input[type=\"radio\"]{width:20px;height:20px}\n\n    /* Spinner and inline loading (Req §4 Loading) */\n    .inline-status{\n      display:flex; align-items:center; gap:8px;\n      font-size: 14px;\n      color: var(--muted);\n      margin-top: 8px;\n      min-height: 22px;\n    }\n    .spinner{\n      width:16px; height:16px;\n      border:2px solid #cbd5e1; border-right-color: transparent;\n      border-radius:50%;\n      animation: spin 0.9s linear infinite;\n    }\n    @keyframes spin{to{transform:rotate(360deg)}}\n\n    /* Code input */\n    .code-input{\n      letter-spacing: 6px;\n      text-align: center;\n      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\",\"Courier New\", monospace;\n    }\n\n    /* Password meter & checklist (Req §8) */\n    .meter{\n      display:flex; align-items:center; justify-content:space-between;\n      gap:8px; margin: 6px 0 8px;\n    }\n    .meter .bar{\n      flex:1; height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden;\n    }\n    .meter .bar > span{\n      display:block; height: 100%; width: 0%;\n      background: var(--error);\n      transition: width .2s ease, background .2s ease;\n      border-radius: inherit;\n    }\n    .meter .label{min-width: 60px; font-size: 13px; color: var(--muted);}\n    ul.checklist{\n      padding-left: 20px;\n      margin: 8px 0 0;\n    }\n    ul.checklist li{\n      margin: 4px 0;\n      font-size: 14px;\n      color: #374151;\n    }\n    ul.checklist li.ok{ color: var(--success); }\n    ul.checklist li::marker{ color: #9ca3af; }\n    ul.checklist li.ok::marker{ color: var(--success); }\n\n    /* Success */\n    .success-wrap{\n      text-align:center; padding: 8px 4px 6px;\n    }\n    .big-check{\n      width:68px; height:68px; border-radius:50%;\n      display:inline-flex; align-items:center; justify-content:center;\n      background: #ecfdf5; color: var(--success);\n      font-size: 40px;\n      margin: 8px 0 10px;\n    }\n\n    footer{\n      width:100%; max-width:560px;\n      color:#cbd5e1; text-align:center;\n      padding: 10px 16px 24px;\n      font-size: 13px;\n    }\n    .muted{color:#9ca3af}\n  </style>\n</head>\n<body>\n  <!-- Header (Req §3) -->\n  <header>\n    <h1>Password Recovery Demo</h1>\n  </header>\n\n  <main>\n    <div class=\"card\" role=\"region\" aria-label=\"Password Recovery Card\">\n      <!-- ========== Start (Req §5.1) ========== -->\n      <section id=\"view-start\">\n        <header class=\"state-title\"><h2>Welcome</h2></header>\n        <p class=\"hint\">This is a client-only demo. Sign-in is intentionally disabled.</p>\n        <form id=\"formStart\" novalidate>\n          <div class=\"field\">\n            <label for=\"startEmail\">Email</label>\n            <input id=\"startEmail\" name=\"email\" type=\"email\" autocomplete=\"username\" placeholder=\"you@example.com\" />\n          </div>\n          <div class=\"field\">\n            <label for=\"startPassword\">Password</label>\n            <input id=\"startPassword\" name=\"password\" type=\"password\" autocomplete=\"current-password\" placeholder=\"••••••••••\" />\n          </div>\n          <div class=\"actions\">\n            <button class=\"btn btn-primary\" type=\"submit\" disabled aria-disabled=\"true\" title=\"Disabled in this demo\">Sign in</button>\n            <button id=\"btnForgot\" class=\"btn btn-secondary\" type=\"button\" aria-describedby=\"demoNote\">Forgot your password?</button>\n          </div>\n          <p id=\"demoNote\" class=\"hint\">Use the “Forgot your password?” button to try the recovery flow.</p>\n        </form>\n      </section>\n\n      <!-- ========== Identify Account (Req §5.2) ========== -->\n      <section id=\"view-identify\" hidden>\n        <header class=\"state-title\"><h2>Identify account</h2></header>\n        <form id=\"formIdentify\" novalidate>\n          <div class=\"field\">\n            <label for=\"identifyInput\">Enter your email or username</label>\n            <input id=\"identifyInput\" type=\"text\" autocomplete=\"username email\" placeholder=\"Email or username\" />\n            <div id=\"identifyError\" class=\"error\" aria-live=\"polite\"></div>\n          </div>\n          <div class=\"actions\">\n            <button type=\"button\" class=\"btn btn-secondary\" id=\"backToStart\">Back</button>\n            <button type=\"submit\" class=\"btn btn-primary\" id=\"btnIdentifyContinue\" disabled>Continue</button>\n          </div>\n          <div class=\"inline-status\" aria-live=\"polite\" id=\"identifyStatus\"></div>\n        </form>\n      </section>\n\n      <!-- ========== Choose Delivery Method (Req §5.3) ========== -->\n      <section id=\"view-delivery\" hidden>\n        <header class=\"state-title\"><h2>Choose how to receive your code</h2></header>\n        <form id=\"formDelivery\" novalidate>\n          <fieldset class=\"field\" style=\"border:none; padding:0; margin:0\">\n            <legend class=\"hint\" style=\"margin-bottom:6px\">Delivery method</legend>\n            <label class=\"radio-row\">\n              <input type=\"radio\" name=\"delivery\" value=\"email\" checked />\n              <span>Email: <strong id=\"maskedEmail\">ja***@example.com</strong></span>\n            </label>\n          </fieldset>\n          <div class=\"actions\">\n            <button type=\"button\" class=\"btn btn-secondary\" id=\"backToIdentify\">Back</button>\n            <button type=\"submit\" class=\"btn btn-primary\" id=\"btnSendCode\">Send code</button>\n          </div>\n          <div class=\"inline-status\" aria-live=\"polite\" id=\"deliveryStatus\"></div>\n          <p class=\"hint\">In this demo, the code is printed to the console.</p>\n        </form>\n      </section>\n\n      <!-- ========== Enter Code (Req §5.4) ========== -->\n      <section id=\"view-code\" hidden>\n        <header class=\"state-title\"><h2>Enter code</h2></header>\n        <p class=\"hint\">Enter the 6-digit code we sent to your email (check console in this demo).</p>\n        <form id=\"formCode\" novalidate>\n          <div class=\"field\">\n            <label for=\"codeInput\">6-digit code</label>\n            <input id=\"codeInput\" class=\"code-input\" inputmode=\"numeric\" pattern=\"[0-9]*\" autocomplete=\"one-time-code\" maxlength=\"6\" placeholder=\"••••••\" />\n            <div id=\"codeError\" class=\"error\" aria-live=\"polite\"></div>\n            <div id=\"codeNotice\" class=\"notice\" aria-live=\"polite\"></div>\n          </div>\n          <div class=\"actions\">\n            <button type=\"button\" class=\"btn btn-secondary\" id=\"backToDelivery\">Back</button>\n            <button type=\"button\" class=\"btn btn-secondary\" id=\"btnResend\">Resend code</button>\n            <button type=\"submit\" class=\"btn btn-primary\" id=\"btnVerify\" disabled>Verify</button>\n          </div>\n          <div class=\"inline-status\" aria-live=\"polite\" id=\"codeStatus\"></div>\n        </form>\n      </section>\n\n      <!-- ========== Set New Password (Req §5.5 & §8) ========== -->\n      <section id=\"view-setpassword\" hidden>\n        <header class=\"state-title\"><h2>Create a new password</h2></header>\n        <form id=\"formSetPassword\" novalidate>\n          <div class=\"field\">\n            <label for=\"newPassword\">New password</label>\n            <input id=\"newPassword\" type=\"password\" autocomplete=\"new-password\" placeholder=\"At least 10 characters\" />\n          </div>\n          <div class=\"field\">\n            <label for=\"confirmPassword\">Confirm new password</label>\n            <input id=\"confirmPassword\" type=\"password\" autocomplete=\"new-password\" placeholder=\"Re-enter new password\" />\n            <div id=\"confirmError\" class=\"error\" aria-live=\"polite\"></div>\n          </div>\n          <div class=\"field\" style=\"margin-top:-4px\">\n            <label style=\"display:flex; align-items:center; gap:8px; font-weight:400\">\n              <input type=\"checkbox\" id=\"toggleShowPw\" />\n              <span>Show password</span>\n            </label>\n          </div>\n\n          <!-- Strength meter -->\n          <div class=\"meter\" aria-live=\"polite\">\n            <div class=\"bar\"><span id=\"meterFill\" style=\"width:0%\"></span></div>\n            <div class=\"label\" id=\"meterLabel\">Weak</div>\n          </div>\n          <!-- Checklist (Req §8) -->\n          <ul class=\"checklist\" id=\"pwChecklist\">\n            <li id=\"ruleLen\">Password must be at least 10 characters.</li>\n            <li id=\"ruleClasses\">Include at least 3 of: lowercase, uppercase, number, symbol.</li>\n            <li id=\"ruleNoUser\">Do not include “testuser” or “jane.doe”.</li>\n            <li id=\"ruleMatch\">Confirmation must exactly match.</li>\n          </ul>\n\n          <div class=\"actions\">\n            <button type=\"button\" class=\"btn btn-secondary\" id=\"backToCode\">Back</button>\n            <button type=\"submit\" class=\"btn btn-primary\" id=\"btnSavePassword\" disabled>Save password</button>\n          </div>\n          <div class=\"inline-status\" aria-live=\"polite\" id=\"pwStatus\"></div>\n        </form>\n      </section>\n\n      <!-- ========== Success (Req §5.6) ========== -->\n      <section id=\"view-success\" hidden>\n        <div class=\"success-wrap\">\n          <div class=\"big-check\" aria-hidden=\"true\">✓</div>\n          <h3>Your password has been reset.</h3>\n          <p class=\"hint\">You can now sign in with your new password. (Sign-in is disabled in this demo.)</p>\n          <div class=\"actions\" style=\"justify-content:center; margin-top:14px\">\n            <button type=\"button\" class=\"btn btn-primary\" id=\"backToSignIn\">Back to Sign in</button>\n          </div>\n        </div>\n      </section>\n    </div>\n  </main>\n\n  <footer>\n    <p class=\"muted\">Security disclaimer: This is a mock, client-only demo. No real accounts, emails, or servers are used. Codes are intentionally printed to the browser console for this study.</p>\n    <p class=\"muted\">Test account: username “testuser”, email “jane.doe@example.com”.</p>\n  </footer>\n\n  <script>\n    /* ============================================================\n     * Password Recovery System — Single-Page, Client-Only, Mocked\n     * Maps to Requirements sections via comments throughout.\n     * ============================================================\n     */\n\n    // ====== Constants & In-Memory Data Model (Req §6, §11)\n    const TEST_USER = {\n      username: \"testuser\",\n      email: \"jane.doe@example.com\"\n    };\n    const EMAIL_LOCAL = TEST_USER.email.split(\"@\")[0]; // \"jane.doe\"\n    const CODE_TTL_MS = 5 * 60 * 1000; // 5 minutes (Req §9)\n\n    const state = {\n      user: { ...TEST_USER },\n      state: {\n        currentView: \"start\",\n        latestCode: null,\n        latestCodeIssuedAt: 0,\n        failedCodeAttempts: 0,\n        newPasswordTemp: null\n      }\n    };\n\n    // Expose last set password for inspection (Req §8)\n    window.__demoLastSetPassword = null;\n\n    // ====== Utilities (masking, focus, helpers) ======\n    // Mask email as \"ja***@example.com\" (Req §6)\n    function maskEmail(email){\n      const [local, domain] = email.split(\"@\");\n      const prefix = local.slice(0, 2);\n      return `${prefix}***@${domain}`;\n    }\n\n    // Focus management: first interactive element (Req §4)\n    function focusFirstInteractive(sectionEl){\n      if(!sectionEl) return;\n      const target = sectionEl.querySelector(\n        'input, select, textarea, button:not([disabled]), [tabindex]:not([tabindex=\"-1\"])'\n      );\n      // timeout to ensure element is visible in DOM\n      setTimeout(() => target && target.focus(), 0);\n    }\n\n    // Simulated delay between 600–1200ms (Req §4)\n    function simulatedDelay(){\n      const ms = 600 + Math.floor(Math.random() * 601);\n      return new Promise(res => setTimeout(res, ms));\n    }\n\n    // ====== Mock Delivery (Req §7)\n    const MockDelivery = {\n      issueCode(){\n        const code = String(Math.floor(100000 + Math.random() * 900000)); // 6-digit\n        state.state.latestCode = code;\n        state.state.latestCodeIssuedAt = Date.now();\n        this.logToConsole(code);\n        return code;\n      },\n      logToConsole(code){\n        // EXACT format per spec (Req §7)\n        console.log(`[RecoveryDemo] Delivering mock reset code via EMAIL to ${TEST_USER.email}`);\n        console.log(`[RecoveryDemo] CODE: ${code}`);\n        console.log(`[RecoveryDemo] RESET LINK: https://example.com/reset?token=RESET-TOKEN-ABC123 (demo only)`);\n      }\n    };\n\n    // ====== UI Routing (Req §3) ======\n    const views = {\n      start: document.getElementById('view-start'),\n      identify: document.getElementById('view-identify'),\n      delivery: document.getElementById('view-delivery'),\n      code: document.getElementById('view-code'),\n      setPassword: document.getElementById('view-setpassword'),\n      success: document.getElementById('view-success'),\n    };\n\n    function showView(name){\n      // Hide all, then show one (Req §3)\n      Object.values(views).forEach(v => v.setAttribute('hidden', ''));\n      const el = views[name];\n      if(el){ el.removeAttribute('hidden'); }\n      state.state.currentView = name;\n      focusFirstInteractive(el);\n    }\n\n    // ====== Event Handlers (Req §12) ======\n    function onClickForgot(){\n      clearIdentifyErrors();\n      document.getElementById('identifyInput').value = '';\n      document.getElementById('btnIdentifyContinue').disabled = true;\n      showView('identify');\n    }\n\n    function onSubmitIdentify(ev){\n      ev.preventDefault();\n      const input = document.getElementById('identifyInput');\n      const status = document.getElementById('identifyStatus');\n      const btn = document.getElementById('btnIdentifyContinue');\n      const identifier = (input.value || '').trim().toLowerCase();\n      clearIdentifyErrors();\n\n      if(!identifier){\n        setInlineError('identifyError', \"Please enter your email or username.\");\n        return;\n      }\n      btn.disabled = true;\n      status.innerHTML = '<span class=\"spinner\" aria-hidden=\"true\"></span> Please wait… Looking up account';\n      simulatedDelay().then(() => {\n        const match = (identifier === TEST_USER.username.toLowerCase()) ||\n                      (identifier === TEST_USER.email.toLowerCase());\n        if(match){\n          // Per §5.2: log code upon successful identify\n          MockDelivery.issueCode();\n          // Update masked email\n          document.getElementById('maskedEmail').textContent = maskEmail(TEST_USER.email);\n          status.textContent = '';\n          showView('delivery');\n          // Reset attempts for a new flow\n          state.state.failedCodeAttempts = 0;\n          document.getElementById('btnSendCode').disabled = false;\n          document.getElementById('deliveryStatus').textContent = '';\n        }else{\n          setInlineError('identifyError', \"We couldn’t find that account.\");\n          btn.disabled = false;\n          status.textContent = '';\n          input.focus();\n        }\n      });\n    }\n\n    function onClickSendCode(ev){\n      ev.preventDefault();\n      const btn = document.getElementById('btnSendCode');\n      const status = document.getElementById('deliveryStatus');\n      btn.disabled = true;\n      status.innerHTML = '<span class=\"spinner\" aria-hidden=\"true\"></span> Sending code…';\n      simulatedDelay().then(() => {\n        MockDelivery.issueCode(); // Per §5.3 re-send on \"Send code\"\n        status.innerHTML = 'We’ve sent a code to your email (check console in this demo).';\n        // Auto-advance to Enter Code after ~1.5s (Req §5.3)\n        setTimeout(() => {\n          document.getElementById('codeInput').value = '';\n          document.getElementById('codeError').textContent = '';\n          document.getElementById('codeNotice').textContent = '';\n          document.getElementById('btnVerify').disabled = true;\n          showView('code');\n        }, 1500);\n      });\n    }\n\n    function onSubmitCode(ev){\n      ev.preventDefault();\n      const input = document.getElementById('codeInput');\n      const codeStr = (input.value || '').trim();\n      const err = document.getElementById('codeError');\n      const notice = document.getElementById('codeNotice');\n      const status = document.getElementById('codeStatus');\n      clearCodeMessages();\n\n      // Lock state check\n      if(state.state.failedCodeAttempts >= 3){\n        err.textContent = \"Too many attempts. Please resend a new code.\";\n        document.getElementById('btnVerify').disabled = true;\n        return;\n      }\n\n      // Expiry check (Req §9)\n      if(!state.state.latestCode || (Date.now() - state.state.latestCodeIssuedAt) > CODE_TTL_MS){\n        err.textContent = \"This code has expired. Please resend a new code.\";\n        document.getElementById('btnVerify').disabled = true;\n        return;\n      }\n\n      // Basic format guard\n      if(codeStr.length !== 6){\n        err.textContent = \"Please enter the 6-digit code.\";\n        return;\n      }\n\n      // Compare with latest code (Req §7 latest only valid)\n      if(codeStr === state.state.latestCode){\n        status.innerHTML = '<span class=\"spinner\" aria-hidden=\"true\"></span> Verifying…';\n        simulatedDelay().then(() => {\n          status.textContent = '';\n          state.state.failedCodeAttempts = 0;\n          showView('setPassword');\n          // Prep password view\n          resetPasswordFormUI();\n        });\n      }else{\n        state.state.failedCodeAttempts += 1;\n        if(state.state.failedCodeAttempts >= 3){\n          err.textContent = \"Too many attempts. Please resend a new code.\";\n          document.getElementById('btnVerify').disabled = true;\n        }else{\n          err.textContent = \"That code is incorrect.\";\n        }\n      }\n    }\n\n    function onClickResend(){\n      const status = document.getElementById('codeStatus');\n      const notice = document.getElementById('codeNotice');\n      const err = document.getElementById('codeError');\n      const btnVerify = document.getElementById('btnVerify');\n      status.innerHTML = '<span class=\"spinner\" aria-hidden=\"true\"></span> Sending new code…';\n      // Simulate delay then issue a new code (Req §5.4)\n      simulatedDelay().then(() => {\n        MockDelivery.issueCode();\n        state.state.failedCodeAttempts = 0;\n        err.textContent = '';\n        status.textContent = '';\n        notice.textContent = 'New code sent. Use the latest one.';\n        btnVerify.disabled = document.getElementById('codeInput').value.trim().length !== 6;\n        document.getElementById('codeInput').focus();\n      });\n    }\n\n    function onSubmitNewPassword(ev){\n      ev.preventDefault();\n      const pw = document.getElementById('newPassword').value;\n      const pw2 = document.getElementById('confirmPassword').value;\n      const allOk = evaluatePasswordAndRender();\n      if(!allOk) return;\n\n      // Simulated save (in-memory only) (Req §5.5, §8)\n      state.state.newPasswordTemp = pw;\n      window.__demoLastSetPassword = pw;\n\n      document.getElementById('pwStatus').innerHTML = '<span class=\"spinner\" aria-hidden=\"true\"></span> Saving…';\n      simulatedDelay().then(() => {\n        document.getElementById('pwStatus').textContent = '';\n        showView('success');\n      });\n    }\n\n    function onClickBack(target){\n      // Clear transient errors when navigating back (Req §3)\n      if(target === 'start'){\n        resetFlowToStart();\n        return;\n      }\n      if(target === 'identify'){\n        clearIdentifyErrors();\n        showView('identify');\n        return;\n      }\n      if(target === 'delivery'){\n        document.getElementById('deliveryStatus').textContent = '';\n        showView('delivery');\n        return;\n      }\n      if(target === 'code'){\n        clearCodeMessages();\n        showView('code');\n        return;\n      }\n    }\n\n    // ====== Validation & Rendering Helpers ======\n    function setInlineError(id, message){\n      const el = document.getElementById(id);\n      el.textContent = message;\n    }\n    function clearIdentifyErrors(){\n      setInlineError('identifyError', '');\n      document.getElementById('identifyStatus').textContent = '';\n    }\n    function clearCodeMessages(){\n      document.getElementById('codeError').textContent = '';\n      document.getElementById('codeNotice').textContent = '';\n      document.getElementById('codeStatus').textContent = '';\n    }\n\n    // Code input formatting: allow only digits, allow paste (Req §5.4)\n    function normalizeCodeInput(){\n      const input = document.getElementById('codeInput');\n      const btn = document.getElementById('btnVerify');\n      const raw = (input.value || '');\n      const digits = raw.replace(/\\D+/g, '').slice(0, 6);\n      if(raw !== digits) input.value = digits;\n      const locked = state.state.failedCodeAttempts >= 3;\n      const expired = !state.state.latestCode || (Date.now() - state.state.latestCodeIssuedAt) > CODE_TTL_MS;\n      btn.disabled = (digits.length !== 6) || locked || expired;\n    }\n\n    // Password strength & rules evaluation (Req §8)\n    function evaluatePasswordAndRender(){\n      const pw = document.getElementById('newPassword').value || '';\n      const pw2 = document.getElementById('confirmPassword').value || '';\n\n      const hasLower = /[a-z]/.test(pw);\n      const hasUpper = /[A-Z]/.test(pw);\n      const hasDigit = /[0-9]/.test(pw);\n      const hasSymbol = /[^A-Za-z0-9]/.test(pw);\n      const classes = [hasLower, hasUpper, hasDigit, hasSymbol].filter(Boolean).length;\n\n      const lenOK = pw.length >= 10;\n      const noUser = !pw.toLowerCase().includes(TEST_USER.username.toLowerCase())\n                  && !pw.toLowerCase().includes(EMAIL_LOCAL.toLowerCase());\n      const matchOK = pw2 === pw && pw.length > 0;\n\n      // Strength meter: Weak/Okay/Strong\n      let strength = 'Weak';\n      let pct = 25;\n      let color = 'var(--error)';\n      if(lenOK && classes >= 2){ strength = 'Okay'; pct = 60; color = '#f59e0b'; } // amber\n      if(lenOK && classes >= 3 && pw.length >= 12){ strength = 'Strong'; pct = 100; color = 'var(--success)'; }\n\n      const fill = document.getElementById('meterFill');\n      const label = document.getElementById('meterLabel');\n      fill.style.width = pct + '%';\n      fill.style.background = color;\n      label.textContent = strength;\n\n      // Checklist UI\n      toggleChecklist('ruleLen', lenOK);\n      toggleChecklist('ruleClasses', classes >= 3);\n      toggleChecklist('ruleNoUser', noUser);\n      toggleChecklist('ruleMatch', matchOK);\n\n      // Inline errors (examples in Req §8)\n      const confirmErr = document.getElementById('confirmError');\n      confirmErr.textContent = matchOK ? '' : 'Confirmation does not match.';\n      // Hints for improvement (non-blocking)\n      const pwStatus = document.getElementById('pwStatus');\n      if(!lenOK){\n        pwStatus.textContent = 'Password must be at least 10 characters.';\n      }else if(classes < 2){\n        pwStatus.textContent = 'Add a number or symbol to make it stronger.';\n      }else{\n        pwStatus.textContent = '';\n      }\n\n      const allValid = lenOK && (classes >= 3) && noUser && matchOK;\n      document.getElementById('btnSavePassword').disabled = !allValid;\n      return allValid;\n    }\n\n    function toggleChecklist(id, ok){\n      const el = document.getElementById(id);\n      if(ok) el.classList.add('ok'); else el.classList.remove('ok');\n    }\n\n    function resetPasswordFormUI(){\n      document.getElementById('newPassword').value = '';\n      document.getElementById('confirmPassword').value = '';\n      document.getElementById('confirmError').textContent = '';\n      document.getElementById('pwStatus').textContent = '';\n      document.getElementById('btnSavePassword').disabled = true;\n      document.getElementById('meterFill').style.width = '0%';\n      document.getElementById('meterFill').style.background = 'var(--error)';\n      document.getElementById('meterLabel').textContent = 'Weak';\n      ['ruleLen','ruleClasses','ruleNoUser','ruleMatch'].forEach(id => document.getElementById(id).classList.remove('ok'));\n      document.getElementById('toggleShowPw').checked = false;\n      setPasswordVisibility(false);\n    }\n\n    function setPasswordVisibility(show){\n      const t = show ? 'text' : 'password';\n      document.getElementById('newPassword').type = t;\n      document.getElementById('confirmPassword').type = t;\n    }\n\n    function resetFlowToStart(){\n      // Reset transient UI state (Req §9 Refresh/reset behavior)\n      document.getElementById('formStart').reset();\n      document.getElementById('formIdentify').reset();\n      document.getElementById('formDelivery').reset();\n      document.getElementById('formCode').reset();\n      document.getElementById('formSetPassword').reset();\n\n      clearIdentifyErrors();\n      clearCodeMessages();\n      resetPasswordFormUI();\n\n      document.getElementById('btnIdentifyContinue').disabled = true;\n      document.getElementById('btnSendCode').disabled = false;\n      document.getElementById('btnVerify').disabled = true;\n\n      // Do not clear state.latestCode to allow inspecting console, but it is fine either way.\n      state.state.failedCodeAttempts = 0;\n      showView('start');\n    }\n\n    // ====== Wire-up (DOMContentLoaded) ======\n    (function init(){\n      // Start view\n      showView('start');\n\n      // Start actions (Req §5.1)\n      document.getElementById('btnForgot').addEventListener('click', onClickForgot);\n      document.getElementById('formStart').addEventListener('submit', (e) => e.preventDefault());\n\n      // Identify (Req §5.2)\n      document.getElementById('formIdentify').addEventListener('submit', onSubmitIdentify);\n      document.getElementById('identifyInput').addEventListener('input', (e)=>{\n        const has = (e.target.value || '').trim().length > 0;\n        document.getElementById('btnIdentifyContinue').disabled = !has;\n      });\n      document.getElementById('backToStart').addEventListener('click', ()=> onClickBack('start'));\n\n      // Delivery (Req §5.3)\n      document.getElementById('formDelivery').addEventListener('submit', onClickSendCode);\n      document.getElementById('backToIdentify').addEventListener('click', ()=> onClickBack('identify'));\n\n      // Code (Req §5.4)\n      document.getElementById('formCode').addEventListener('submit', onSubmitCode);\n      document.getElementById('codeInput').addEventListener('input', normalizeCodeInput);\n      document.getElementById('btnResend').addEventListener('click', onClickResend);\n      document.getElementById('backToDelivery').addEventListener('click', ()=> onClickBack('delivery'));\n\n      // Password (Req §5.5 & §8)\n      document.getElementById('formSetPassword').addEventListener('submit', onSubmitNewPassword);\n      document.getElementById('newPassword').addEventListener('input', evaluatePasswordAndRender);\n      document.getElementById('confirmPassword').addEventListener('input', evaluatePasswordAndRender);\n      document.getElementById('toggleShowPw').addEventListener('change', (e)=> setPasswordVisibility(e.target.checked));\n      document.getElementById('backToCode').addEventListener('click', ()=> onClickBack('code'));\n\n      // Success (Req §5.6)\n      document.getElementById('backToSignIn').addEventListener('click', ()=> onClickBack('start'));\n\n      // Set masked email shown in Delivery card (initial)\n      document.getElementById('maskedEmail').textContent = maskEmail(TEST_USER.email);\n\n      // Accessibility niceties: prevent Escape from doing anything (Req §4 Esc does nothing)\n      document.addEventListener('keydown', (e)=> {\n        if(e.key === 'Escape') { e.preventDefault(); }\n      });\n    })();\n  </script>\n</body>\n</html>\n", "task_list": [], "evaluator_md": "", "done": false, "iter": 1, "mode": "single"}
