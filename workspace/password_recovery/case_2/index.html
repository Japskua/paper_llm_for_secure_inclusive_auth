
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Password Recovery Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* ===============================
       Styles mapped to §4 Visual/Interaction Requirements
       =============================== */
    :root{
      --bg:#f7f7fb;
      --card:#fff;
      --text:#1f2937;
      --muted:#6b7280;
      --primary:#2563eb;
      --primary-600:#1d4ed8;
      --danger:#dc2626;
      --success:#059669;
      --warning:#d97706;
      --border:#e5e7eb;
      --focus:#9333ea;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.4;
    }
    header, footer{
      text-align:center;
      padding:16px 12px;
    }
    header h1{
      margin:0;
      font-size:1.25rem;
      font-weight:700;
    }
    .container{
      display:grid;
      place-items:center;
      padding:12px;
    }
    .card{
      width:100%;
      max-width:440px; /* per §4 */
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow:0 6px 24px rgba(0,0,0,0.06);
      padding:20px;
    }
    h2{
      margin:0 0 8px 0;
      font-size:1.15rem;
    }
    p{
      margin:6px 0 12px 0;
      color:var(--muted);
    }
    form{
      margin-top:8px;
    }
    label{
      display:block;
      font-weight:600;
      margin-bottom:6px;
    }
    .field{
      margin-bottom:14px;
    }
    input[type="text"],
    input[type="email"],
    input[type="password"]{
      width:100%;
      padding:12px 12px;
      min-height:44px; /* tap target per §4 */
      border:1px solid var(--border);
      border-radius:8px;
      font-size:16px;
      outline:none;
      background:#fff;
      color:var(--text);
    }
    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus{
      border-color:var(--focus);
      box-shadow:0 0 0 3px rgba(147,51,234,0.15);
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:0 16px;
      min-height:44px;
      border-radius:8px;
      border:1px solid transparent;
      cursor:pointer;
      font-weight:600;
      text-align:center;
      user-select:none;
      transition:background .15s, color .15s, border-color .15s, opacity .15s;
    }
    .btn.primary{
      background:var(--primary);
      color:#fff;
    }
    .btn.primary:hover{ background:var(--primary-600); }
    .btn.secondary{
      background:#fff;
      color:var(--text);
      border-color:var(--border);
    }
    .btn.secondary:hover{ border-color:#cfd3d8; }
    .btn.link{
      background:transparent;
      border:none;
      color:var(--primary);
      padding:0;
      min-height:auto;
      height:auto;
    }
    .btn[disabled], .btn:disabled{
      opacity:.6;
      cursor:not-allowed;
    }
    .help{
      font-size:.9rem;
      color:var(--muted);
    }
    .error{
      color:var(--danger);
      font-size:.92rem;
      margin-top:6px;
    }
    .status{
      color:var(--success);
      font-size:.92rem;
      margin-top:6px;
    }
    .warn{
      color:var(--warning);
      font-size:.92rem;
      margin-top:6px;
    }
    .inline-spinner{
      display:inline-block;
      min-width:1ch;
      margin-left:8px;
      color:var(--muted);
      font-style:italic;
    }
    .radio{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:8px;
    }
    .radio input{
      width:20px; height:20px;
    }
    .muted{
      color:var(--muted);
    }
    ul.rules{
      list-style:none;
      padding-left:0;
      margin:8px 0 8px;
    }
    ul.rules li{
      display:flex;
      align-items:center;
      gap:8px;
      margin:4px 0;
      color:var(--muted);
      font-size:.95rem;
    }
    ul.rules li .dot{
      width:10px; height:10px;
      border-radius:50%;
      background:#d1d5db;
      display:inline-block;
    }
    ul.rules li.pass{
      color:var(--success);
    }
    ul.rules li.pass .dot{
      background:var(--success);
    }
    .strength{
      font-weight:700;
    }
    .strength.weak{ color:var(--danger); }
    .strength.okay{ color:#2563eb; }
    .strength.strong{ color:var(--success); }
    .top-space{ margin-top:18px; }
    .center{ text-align:center; }
    .sr-only{
      position:absolute !important;
      height:1px; width:1px;
      overflow:hidden;
      clip:rect(1px,1px,1px,1px);
      white-space:nowrap;
      border:0; padding:0; margin:-1px;
    }
    footer small{
      color:var(--muted);
      display:block;
      max-width:680px;
      margin:0 auto;
    }
  </style>
</head>
<body>
  <!-- ===============================
       Header per §3 Page Architecture
       =============================== -->
  <header>
    <h1>Password Recovery Demo</h1>
  </header>

  <div class="container">
    <div class="card" role="region" aria-label="Password recovery card">
      <!-- ===============================
           §5.1 Start
           =============================== -->
      <section id="view-start">
        <h2>Welcome</h2>
        <p>This is a self-contained demo. Sign-in is disabled; use “Forgot your password?” to try the recovery flow.</p>
        <form id="signInForm" aria-describedby="start-note">
          <div class="field">
            <label for="signin-email">Email</label>
            <input id="signin-email" type="email" autocomplete="username" placeholder="you@example.com" aria-describedby="start-note">
          </div>
          <div class="field">
            <label for="signin-password">Password</label>
            <input id="signin-password" type="password" autocomplete="current-password" placeholder="••••••••••">
          </div>
          <div id="start-note" class="help">Sign-in is disabled in this demo.</div>
          <div class="row top-space">
            <button class="btn primary" type="submit" disabled aria-disabled="true">Sign in</button>
            <button id="forgotBtn" class="btn link" type="button" aria-describedby="start-note">Forgot your password?</button>
          </div>
        </form>
      </section>

      <!-- ===============================
           §5.2 Identify Account
           =============================== -->
      <section id="view-identify" hidden>
        <h2>Identify your account</h2>
        <p>Enter your email or username.</p>
        <form id="identifyForm" novalidate>
          <div class="field">
            <label for="identifier">Email or username</label>
            <input id="identifier" type="text" autocomplete="email username" placeholder="e.g., jane.doe@example.com or testuser" required>
            <div id="identifyError" class="error" aria-live="polite"></div>
          </div>
          <div class="row">
            <button id="identifyBack" type="button" class="btn secondary">Back</button>
            <button id="identifyContinue" type="submit" class="btn primary" disabled>Continue</button>
            <span id="identifyWait" class="inline-spinner" aria-live="polite"></span>
          </div>
        </form>
      </section>

      <!-- ===============================
           §5.3 Choose Delivery Method
           =============================== -->
      <section id="view-delivery" hidden>
        <h2>Choose how to receive your code</h2>
        <p class="muted">Email is available in this demo.</p>
        <form id="deliveryForm">
          <div class="field">
            <label class="sr-only" for="delivery-email">Email</label>
            <div class="radio">
              <input id="delivery-email" type="radio" name="delivery" value="email" checked>
              <div>
                <div><strong>Email</strong></div>
                <div class="help">ja***@example.com</div>
              </div>
            </div>
          </div>
          <div id="deliveryStatus" class="status" aria-live="polite"></div>
          <div class="row top-space">
            <button id="deliveryBack" type="button" class="btn secondary">Back</button>
            <button id="sendCodeBtn" type="submit" class="btn primary">Send code</button>
            <span id="deliveryWait" class="inline-spinner" aria-live="polite"></span>
          </div>
        </form>
      </section>

      <!-- ===============================
           §5.4 Enter Code
           =============================== -->
      <section id="view-code" hidden>
        <h2>Enter code</h2>
        <p>Enter the 6-digit code we sent to your email (check console in this demo). Sent to ja***@example.com.</p>
        <form id="codeForm" novalidate>
          <div class="field">
            <label for="codeInput">6-digit code</label>
            <input id="codeInput" type="text" inputmode="numeric" autocomplete="one-time-code" placeholder="••••••" aria-describedby="codeHelp codeError codeInfo" maxlength="6">
            <div id="codeHelp" class="help">Numbers only. You can paste the code.</div>
            <div id="codeError" class="error" aria-live="polite"></div>
            <div id="codeInfo" class="status" aria-live="polite"></div>
          </div>
          <div class="row">
            <button id="codeBack" type="button" class="btn secondary">Back</button>
            <button id="verifyBtn" type="submit" class="btn primary" disabled>Verify</button>
            <button id="resendBtn" type="button" class="btn link">Resend code</button>
          </div>
        </form>
      </section>

      <!-- ===============================
           §5.5 Set New Password
           =============================== -->
      <section id="view-setpassword" hidden>
        <h2>Create a new password</h2>
        <p>Choose a strong password and confirm it below.</p>
        <form id="passwordForm" novalidate>
          <div class="field">
            <label for="pw1">New password</label>
            <input id="pw1" type="password" autocomplete="new-password" placeholder="At least 10 characters">
          </div>
          <div class="field">
            <label for="pw2">Confirm password</label>
            <input id="pw2" type="password" autocomplete="new-password" placeholder="Re-enter password">
          </div>
          <div class="field">
            <label class="radio" style="gap:8px; padding:0; border:none">
              <input id="toggleShowPw" type="checkbox">
              <span>Show password</span>
            </label>
          </div>
          <div class="field">
            <div>Strength: <span id="strengthText" class="strength weak">Weak</span></div>
            <ul class="rules" aria-live="polite">
              <li id="rule-length"><span class="dot"></span> Password must be at least 10 characters.</li>
              <li id="rule-classes"><span class="dot"></span> Include at least 3 types: lowercase, uppercase, number, symbol.</li>
              <li id="rule-excludes"><span class="dot"></span> Must not contain “testuser” or “jane.doe”.</li>
              <li id="rule-match"><span class="dot"></span> Confirmation matches.</li>
            </ul>
            <div id="pwErrors" class="error" aria-live="polite"></div>
          </div>
          <div class="row top-space">
            <button id="passwordBack" type="button" class="btn secondary">Back</button>
            <button id="savePasswordBtn" type="submit" class="btn primary" disabled>Save password</button>
          </div>
        </form>
      </section>

      <!-- ===============================
           §5.6 Success
           =============================== -->
      <section id="view-success" hidden class="center">
        <h2>Your password has been reset.</h2>
        <p class="muted">You can now return to the sign-in screen.</p>
        <div class="top-space">
          <button id="backToSignIn" type="button" class="btn primary">Back to Sign in</button>
        </div>
      </section>
    </div>
  </div>

  <!-- ===============================
       Footer per §3
       =============================== -->
  <footer>
    <small>
      Demo only. No real emails are sent; codes are printed to the console for this study. No data is persisted.
    </small>
  </footer>

  <script>
    /* ===============================
       JS Architecture mapped to §10 & §12
       =============================== */

    // §11 Data Model (In-Memory Only)
    const Model = {
      user: {
        username: "testuser",
        email: "jane.doe@example.com"
      },
      state: {
        currentView: "start", // "start" | "identify" | "delivery" | "code" | "setPassword" | "success"
        latestCode: null,
        latestCodeIssuedAt: null,
        failedCodeAttempts: 0,
        newPasswordTemp: null,
        verifyLocked: false,
        expiredLock: false
      }
    };
    window.__demoLastSetPassword = null; // per §6 and §14

    // Constants for masking and expiry
    const MASKED_EMAIL = "ja***@example.com"; // §6 masking
    const CODE_EXPIRY_MS = 5 * 60 * 1000; // §9: 5 minutes

    // Cache DOM elements for performance
    const Views = {
      start: document.getElementById("view-start"),
      identify: document.getElementById("view-identify"),
      delivery: document.getElementById("view-delivery"),
      code: document.getElementById("view-code"),
      setPassword: document.getElementById("view-setpassword"),
      success: document.getElementById("view-success")
    };

    // Identify form elements
    const identifyForm = document.getElementById("identifyForm");
    const identifyInput = document.getElementById("identifier");
    const identifyError = document.getElementById("identifyError");
    const identifyContinue = document.getElementById("identifyContinue");
    const identifyBack = document.getElementById("identifyBack");
    const identifyWait = document.getElementById("identifyWait");

    // Delivery form elements
    const deliveryForm = document.getElementById("deliveryForm");
    const sendCodeBtn = document.getElementById("sendCodeBtn");
    const deliveryBack = document.getElementById("deliveryBack");
    const deliveryStatus = document.getElementById("deliveryStatus");
    const deliveryWait = document.getElementById("deliveryWait");

    // Code form elements
    const codeForm = document.getElementById("codeForm");
    const codeInput = document.getElementById("codeInput");
    const verifyBtn = document.getElementById("verifyBtn");
    const codeBack = document.getElementById("codeBack");
    const codeError = document.getElementById("codeError");
    const codeInfo = document.getElementById("codeInfo");
    const resendBtn = document.getElementById("resendBtn");

    // Password form elements
    const passwordForm = document.getElementById("passwordForm");
    const pw1 = document.getElementById("pw1");
    const pw2 = document.getElementById("pw2");
    const toggleShowPw = document.getElementById("toggleShowPw");
    const strengthText = document.getElementById("strengthText");
    const ruleLength = document.getElementById("rule-length");
    const ruleClasses = document.getElementById("rule-classes");
    const ruleExcludes = document.getElementById("rule-excludes");
    const ruleMatch = document.getElementById("rule-match");
    const pwErrors = document.getElementById("pwErrors");
    const passwordBack = document.getElementById("passwordBack");
    const savePasswordBtn = document.getElementById("savePasswordBtn");

    // Start view elements
    const forgotBtn = document.getElementById("forgotBtn");
    const backToSignIn = document.getElementById("backToSignIn");

    // Utility: show one view, hide others, manage focus (§4 focus management)
    function showView(name) {
      Model.state.currentView = name;
      Object.entries(Views).forEach(([key, el]) => {
        if (key === nameMap(name)) {
          el.hidden = false;
        } else {
          el.hidden = true;
        }
      });
      // Move focus to the first interactive element in the shown view
      const current = Views[nameMap(name)];
      setTimeout(() => {
        const focusable = current.querySelector('input:not([disabled]), button:not([disabled]), select:not([disabled]), textarea:not([disabled])');
        if (focusable) focusable.focus();
      }, 0);
    }
    function nameMap(name){
      // Normalize mapping to object keys
      switch(name){
        case "start": return "start";
        case "identify": return "identify";
        case "delivery": return "delivery";
        case "code": return "code";
        case "setPassword": return "setPassword";
        case "success": return "success";
        default: return "start";
      }
    }

    // Utility: random delay promise (for "Please wait..." UI) §4 Loading
    function delay(min=600, max=1200){
      const ms = Math.floor(Math.random() * (max - min + 1)) + min;
      return new Promise(res => setTimeout(res, ms));
    }

    // §7 Mock Delivery: issueCode()
    function generateSixDigit() {
      return String(Math.floor(100000 + Math.random() * 900000));
    }
    function issueCode() {
      // Generate a new 6-digit code; ensure change on resend
      let code = generateSixDigit();
      if (Model.state.latestCode && code === Model.state.latestCode) {
        // Ensure it's different
        code = generateSixDigit();
      }
      Model.state.latestCode = code;
      Model.state.latestCodeIssuedAt = Date.now();
      Model.state.failedCodeAttempts = 0;
      Model.state.verifyLocked = false;
      Model.state.expiredLock = false;

      // Exact console protocol per §7
      console.log("[RecoveryDemo] Delivering mock reset code via EMAIL to jane.doe@example.com");
      console.log("[RecoveryDemo] CODE: " + code);
      console.log("[RecoveryDemo] RESET LINK: https://example.com/reset?token=RESET-TOKEN-ABC123 (demo only)");
    }

    // §12: Handlers

    // onClickForgot() → show Identify.
    function onClickForgot(){
      clearIdentifyErrors();
      identifyInput.value = "";
      identifyContinue.disabled = true;
      showView("identify");
    }

    // onSubmitIdentify(identifier)
    async function onSubmitIdentify(e){
      e.preventDefault();
      clearIdentifyErrors();
      const raw = (identifyInput.value || "").trim();
      if (!raw) {
        identifyError.textContent = "Please enter an email or username.";
        return;
      }
      const id = raw.toLowerCase();
      const matches = (id === Model.user.username.toLowerCase()) || (id === Model.user.email.toLowerCase());
      if (!matches) {
        identifyError.textContent = "We couldn’t find that account.";
        return;
      }
      // Simulate lookup delay
      setIdentifyBusy(true);
      await delay();
      issueCode(); // §5.2 & §7: console log on successful identification
      setIdentifyBusy(false);
      showView("delivery");
      resetDeliveryStatus();
    }

    function setIdentifyBusy(busy){
      identifyWait.textContent = busy ? "Please wait…" : "";
      identifyContinue.disabled = busy;
      identifyBack.disabled = busy;
    }
    function clearIdentifyErrors(){
      identifyError.textContent = "";
    }

    // onClickSendCode() – simulate "sending" UI then auto-advance (no new code per §7)
    async function onClickSendCode(e){
      e.preventDefault();
      deliveryStatus.textContent = "";
      setDeliveryBusy(true);
      await delay();
      // Do NOT issue a new code here; per §7, logging occurs on identify or when user taps Resend.
      setDeliveryBusy(false);
      deliveryStatus.textContent = "We’ve sent a code to your email (check console in this demo).";
      // Auto-advance after 1–2s
      await delay(1000, 2000);
      codeInput.value = "";
      codeError.textContent = "";
      codeInfo.textContent = "";
      updateVerifyButton();
      showView("code");
    }
    function setDeliveryBusy(busy){
      deliveryWait.textContent = busy ? "Please wait…" : "";
      sendCodeBtn.disabled = busy;
      deliveryBack.disabled = busy;
    }
    function resetDeliveryStatus(){
      deliveryStatus.textContent = "";
      deliveryWait.textContent = "";
    }

    // Numeric-only handling for code input
    function onCodeInputChanged(){
      const sanitized = (codeInput.value || "").replace(/\D+/g, "").slice(0,6);
      if (sanitized !== codeInput.value) codeInput.value = sanitized;
      codeError.textContent = "";
      // If locked due to expiry or attempts, keep Verify disabled
      updateVerifyButton();
    }

    function updateVerifyButton(){
      const lenOk = codeInput.value.trim().length === 6;
      verifyBtn.disabled = !(lenOk && !Model.state.verifyLocked && !Model.state.expiredLock);
      if (Model.state.verifyLocked) {
        codeError.textContent = "Too many attempts. Please resend a new code.";
      } else if (Model.state.expiredLock) {
        codeError.textContent = "This code has expired. Please resend a new code.";
      }
    }

    // onSubmitCode(code)
    function onSubmitCode(e){
      e.preventDefault();
      if (Model.state.verifyLocked || Model.state.expiredLock) {
        updateVerifyButton();
        return;
      }
      const code = (codeInput.value || "").trim();
      if (code.length !== 6) {
        codeError.textContent = "Please enter the 6-digit code.";
        updateVerifyButton();
        return;
      }
      // Expiry check
      const issuedAt = Model.state.latestCodeIssuedAt || 0;
      const age = Date.now() - issuedAt;
      if (!issuedAt || age > CODE_EXPIRY_MS) {
        Model.state.expiredLock = true;
        codeError.textContent = "This code has expired. Please resend a new code.";
        updateVerifyButton();
        return;
      }
      if (code === Model.state.latestCode) {
        // success
        codeError.textContent = "";
        codeInfo.textContent = "";
        showView("setPassword");
        updatePasswordUI(); // reset strength/checks
        return;
      }
      // wrong code
      Model.state.failedCodeAttempts++;
      const attemptsLeft = 3 - Model.state.failedCodeAttempts;
      if (Model.state.failedCodeAttempts >= 3) {
        Model.state.verifyLocked = true;
        codeError.textContent = "Too many attempts. Please resend a new code.";
      } else {
        codeError.textContent = "That code is incorrect." + (attemptsLeft > 0 ? " " + attemptsLeft + " attempt(s) left." : "");
      }
      updateVerifyButton();
    }

    // onClickResend()
    function onClickResend(){
      issueCode();
      codeInput.value = "";
      codeError.textContent = "";
      codeInfo.textContent = "New code sent. Use the latest one.";
      updateVerifyButton();
      codeInput.focus();
    }

    // Password validation per §8
    function classifyPassword(pw){
      const hasLower = /[a-z]/.test(pw);
      const hasUpper = /[A-Z]/.test(pw);
      const hasDigit = /\d/.test(pw);
      const hasSymbol = /[^A-Za-z0-9]/.test(pw);
      const classesCount = [hasLower, hasUpper, hasDigit, hasSymbol].filter(Boolean).length;
      return { hasLower, hasUpper, hasDigit, hasSymbol, classesCount };
    }
    function containsUserInfo(pw){
      const user = Model.user.username.toLowerCase();
      const local = Model.user.email.split("@")[0].toLowerCase(); // "jane.doe"
      const p = (pw || "").toLowerCase();
      return p.includes(user) || p.includes(local);
    }
    function strengthLabel(pw, classesCount){
      const len = (pw || "").length;
      if (len >= 12 && classesCount >= 3) return "Strong";
      if (len >= 10 && classesCount >= 3) return "Okay";
      return "Weak";
    }
    function updatePasswordUI(){
      const a = pw1.value || "";
      const b = pw2.value || "";

      // Evaluate rules
      const lengthOk = a.length >= 10;
      const classes = classifyPassword(a);
      const classesOk = classes.classesCount >= 3;
      const excludesOk = !containsUserInfo(a);
      const matchOk = a.length > 0 && a === b;

      // Checklist UI
      toggleRule(ruleLength, lengthOk);
      toggleRule(ruleClasses, classesOk);
      toggleRule(ruleExcludes, excludesOk);
      toggleRule(ruleMatch, matchOk);

      // Strength label
      const label = strengthLabel(a, classes.classesCount);
      strengthText.textContent = label;
      strengthText.classList.remove("weak","okay","strong");
      strengthText.classList.add(label.toLowerCase() === "strong" ? "strong" : (label.toLowerCase() === "okay" ? "okay" : "weak"));

      // Error hints (non-blocking, but show a single most relevant)
      pwErrors.textContent = "";
      if (a && !lengthOk) pwErrors.textContent = "Password must be at least 10 characters.";
      else if (a && !classesOk) pwErrors.textContent = "Add a number or symbol to make it stronger.";
      else if (a && !excludesOk) pwErrors.textContent = "Password must not include your username or email.";
      else if (b && !matchOk) pwErrors.textContent = "Confirmation does not match.";

      // Enable/disable save button
      const allOk = lengthOk && classesOk && excludesOk && matchOk;
      savePasswordBtn.disabled = !allOk;
    }
    function toggleRule(el, pass){
      el.classList.toggle("pass", !!pass);
    }

    function onToggleShowPw(){
      const type = toggleShowPw.checked ? "text" : "password";
      pw1.type = type;
      pw2.type = type;
    }

    // onSubmitNewPassword(pw1, pw2)
    function onSubmitNewPassword(e){
      e.preventDefault();
      updatePasswordUI();
      if (savePasswordBtn.disabled) return;
      const newPw = pw1.value;
      Model.state.newPasswordTemp = newPw;
      window.__demoLastSetPassword = newPw; // store in-memory per §6/§8/§14
      // Clear sensitive fields
      pw1.value = "";
      pw2.value = "";
      updatePasswordUI();
      showView("success");
    }

    // Back navigation helpers with transient clean-up
    function goBackFromDelivery(){
      resetDeliveryStatus();
      showView("identify");
    }
    function goBackFromCode(){
      codeError.textContent = "";
      codeInfo.textContent = "";
      showView("delivery");
    }
    function goBackFromPassword(){
      pwErrors.textContent = "";
      showView("code");
    }

    // Reset flow to Start (§5.6)
    function resetFlowToStart(){
      // Clear transient state
      Model.state.currentView = "start";
      Model.state.latestCode = null;
      Model.state.latestCodeIssuedAt = null;
      Model.state.failedCodeAttempts = 0;
      Model.state.newPasswordTemp = null;
      Model.state.verifyLocked = false;
      Model.state.expiredLock = false;

      // Clear UI fields/messages
      identifyInput.value = "";
      identifyError.textContent = "";
      identifyWait.textContent = "";
      identifyContinue.disabled = true;

      deliveryStatus.textContent = "";
      deliveryWait.textContent = "";

      codeInput.value = "";
      codeError.textContent = "";
      codeInfo.textContent = "";
      verifyBtn.disabled = true;

      pw1.value = "";
      pw2.value = "";
      toggleShowPw.checked = false;
      onToggleShowPw();
      updatePasswordUI();

      showView("start");
    }

    // Event wiring
    document.getElementById("forgotBtn").addEventListener("click", onClickForgot);

    identifyInput.addEventListener("input", () => {
      identifyError.textContent = "";
      identifyContinue.disabled = (identifyInput.value.trim().length === 0);
    });
    identifyBack.addEventListener("click", () => showView("start"));
    identifyForm.addEventListener("submit", onSubmitIdentify);

    deliveryBack.addEventListener("click", goBackFromDelivery);
    deliveryForm.addEventListener("submit", onClickSendCode);

    codeInput.addEventListener("input", onCodeInputChanged);
    codeBack.addEventListener("click", goBackFromCode);
    resendBtn.addEventListener("click", onClickResend);
    codeForm.addEventListener("submit", onSubmitCode);

    pw1.addEventListener("input", updatePasswordUI);
    pw2.addEventListener("input", updatePasswordUI);
    toggleShowPw.addEventListener("change", onToggleShowPw);
    passwordBack.addEventListener("click", goBackFromPassword);
    passwordForm.addEventListener("submit", onSubmitNewPassword);

    backToSignIn.addEventListener("click", resetFlowToStart);

    // Initialize UI
    showView("start");
    updatePasswordUI(); // initialize rules UI
  </script>
</body>
</html>
