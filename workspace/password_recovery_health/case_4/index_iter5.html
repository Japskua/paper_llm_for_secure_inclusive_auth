
<!doctype html>
<!--
  Password Recovery System — Single-Page, Client-Only, Mocked
  This file implements all logic, UI, and accessibility in one HTML document.

  Mapping to Requirements:
  - Semantic HTML, inline CSS & JS: yes (single file, no external calls)
  - Clear intro with step-by-step outline: header/introduction
  - Progress indicator (Identify, Verify, New Password, Done): <nav aria-label="Progress">
  - Step 1: collect email/username, Continue: #step1 form
  - Step 1 submission: deterministic code via console.log, persist progress: JS generateCode + localStorage
  - Confirmation after Step 1 without revealing account existence: status copy in Step 2
  - Step 2: enter code, guidance, Resend Code re-logs deterministic code, validation feedback: #step2 form
  - Step 3: new password + confirm, show/hide toggles, simple rules, inline validation: #step3 form
  - On success: advance to Step 4, clear sensitive inputs: JS clearSensitive()
  - Step 4: confirmation + next steps + restart: #step4
  - Persist step and key inputs; restore on load; focus management: localStorage + focus heading
  - High-contrast, low-distraction styling; large tap targets: CSS
  - ADHD-friendly microcopy; no timeouts; clear feedback: microcopy in each step
  - Help available on every step: persistent <details id="help">
  - Back and Cancel controls; never auto-advance without user action: buttons in each step
  - ARIA roles/labels/live regions; keyboard accessible: aria-live regions, landmarks, focus order
  - Client-only; no network calls: no fetch/XHR; mocked delivery via console.log
  - Start Over action with confirm; clears local storage: Start Over controls
  - Inline comments link to inclusivity and mocking requirements
  - Testing checklist: see bottom comments

  NOTE: This is a demonstration. Not for production use.
-->
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Password Recovery (Client-side Mock)</title>
  <style>
    /* Accessibility & Inclusivity: high-contrast, low-distraction, generous spacing */
    :root {
      --bg: #ffffff;
      --text: #111111;
      --muted: #444444;
      --accent: #005fcc; /* strong blue */
      --accent-contrast: #ffffff;
      --ok: #0a7f2e;
      --warn: #a65e00;
      --error: #b00020;
      --focus: #ff9900;
      --surface: #f5f7fa;
      --border: #d6dbe1;
      --link: #004b9a;
    }
    * { box-sizing: border-box; }
    html, body {
      background: var(--bg);
      color: var(--text);
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.5;
      scroll-behavior: auto; /* reduce disorienting motion */
    }
    a { color: var(--link); }
    a:focus, button:focus, input:focus, summary:focus {
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }
    header.site {
      padding: 1.25rem;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 1.25rem;
    }
    h1, h2, h3 {
      line-height: 1.2;
      margin-top: 0;
    }
    p { margin: 0.5rem 0 1rem; }
    .intro {
      color: var(--muted);
    }

    /* Progress indicator */
    nav.progress {
      margin: 1rem 0 1.25rem;
      padding: 0.5rem;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    .steps {
      list-style: none;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
      margin: 0;
      padding: 0;
    }
    .steps li {
      text-align: center;
      padding: 0.75rem 0.5rem;
      border-radius: 6px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: #fff;
      font-weight: 600;
      font-size: 0.95rem;
    }
    .steps li.current {
      background: var(--accent);
      color: var(--accent-contrast);
      border-color: var(--accent);
    }
    .steps li.done {
      background: #e8f4ff;
      color: #0b4294;
      border-color: #bcd9ff;
    }

    /* Forms & controls */
    form {
      margin-top: 0.5rem;
    }
    .field {
      margin: 0 0 1rem;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.35rem;
    }
    .hint {
      color: var(--muted);
      font-size: 0.95rem;
      margin-top: -0.25rem;
      margin-bottom: 0.75rem;
    }
    input[type="text"], input[type="email"], input[type="password"], input[type="tel"] {
      width: 100%;
      padding: 0.8rem 0.9rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      background: #fff;
    }
    input[aria-invalid="true"] {
      border-color: var(--error);
    }
    .row {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }
    button, .button-like {
      appearance: none;
      border: none;
      background: var(--accent);
      color: var(--accent-contrast);
      padding: 0.9rem 1.1rem;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      min-height: 44px; /* large tap target */
    }
    button.secondary {
      background: #eef2f7;
      color: #0b1324;
      border: 1px solid var(--border);
    }
    button.link {
      background: transparent;
      color: var(--link);
      padding: 0.25rem 0.25rem;
      border-radius: 6px;
      border: 1px dashed transparent;
      text-decoration: underline;
      font-weight: 600;
    }
    button.danger {
      background: #ffe9ec;
      color: #8a0010;
      border: 1px solid #ffc6ce;
    }

    /* Status & validation messages (ARIA live) */
    .status {
      margin: 0.75rem 0;
      padding: 0.75rem 0.75rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #f9fbff;
      color: #0b2c5a;
    }
    .status.ok {
      background: #ecf9f0;
      color: var(--ok);
      border-color: #bde7c9;
    }
    .status.error {
      background: #fff1f1;
      color: var(--error);
      border-color: #ffd7d7;
    }
    /* Requirement: type-specific global status styles (non-intrusive but noticeable) */
    .status--info {
      background: #f0f5ff;
      color: #0b2c5a;
      border-color: #c9dcff;
    }
    .status--success {
      background: #ecf9f0;
      color: var(--ok);
      border-color: #bde7c9;
    }
    .status--error {
      background: #fff1f1;
      color: var(--error);
      border-color: #ffd7d7;
    }
    .visually-hidden {
      position: absolute !important;
      height: 1px; width: 1px;
      overflow: hidden;
      clip: rect(1px, 1px, 1px, 1px);
      white-space: nowrap;
    }

    /* Panels */
    .panel {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    details#help {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.75rem 1rem;
      background: #fff;
      margin: 1rem 0;
    }
    details#help summary {
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      list-style: none;
    }
    details#help[open] {
      background: #f7fbff;
    }
    .subtle {
      color: var(--muted);
      font-size: 0.95rem;
    }
    footer.site {
      border-top: 1px solid var(--border);
      background: var(--surface);
      padding: 1rem 1.25rem;
      color: var(--muted);
      font-size: 0.95rem;
    }

    /* Step sections hidden by [hidden] for semantic hiding */
    section[hidden] { display: none; }

    /* Password show/hide group */
    .password-wrap {
      position: relative;
    }
    .toggle-visibility {
      position: absolute;
      right: 0.35rem;
      top: 0.35rem;
      background: transparent;
      color: var(--link);
      border: 1px dashed transparent;
      padding: 0.4rem 0.6rem;
      text-decoration: underline;
      min-height: 44px; /* Increased to meet large tap target requirement */
    }

    /* Reduce cognitive load with consistent spacing */
    .spacer { height: 0.25rem; }
  </style>
</head>
<body>
  <header class="site" role="banner">
    <div class="container">
      <h1 id="app-title">Reset your password</h1>
      <p class="intro">
        Simple, step-by-step flow. No time limits. You can pause and return anytime.
        This demo runs entirely in your browser. The verification code is simulated.
      </p>
      <nav class="progress" aria-label="Progress">
        <ol class="steps" id="progress-steps">
          <li id="step-pill-1" aria-current="step">1. Identify</li>
          <li id="step-pill-2">2. Verify</li>
          <li id="step-pill-3">3. New Password</li>
          <li id="step-pill-4">4. Done</li>
        </ol>
        <div id="progress-live" class="visually-hidden" role="status" aria-live="polite"></div>
      </nav>

      <!-- Help is available on every step (Inclusivity: easy access, low stress) -->
      <details id="help">
        <summary aria-controls="help-content">Need help?</summary>
        <div id="help-content">
          <p>
            Tips:
          </p>
          <ul>
            <li>There’s no timer. Take your time.</li>
            <li>We keep your place if you close this page and return.</li>
            <li>If you lose the code, choose “Resend code”. It will be the same for this demo.</li>
          </ul>
          <p class="subtle">
            Contact (placeholder): 555‑0000 or help@hospital.example. This demo does not send emails or texts.
          </p>
        </div>
      </details>
    </div>
  </header>

  <main class="container" id="app" role="main">
    <!-- Accessibility decision (Task): Use a single live region for global announcements to prevent duplicate SR output.
         - #global-status (below) is screen-reader-only with role="status" aria-live="polite".
         - #global-status-visible mirrors the text for sighted users but is aria-hidden="true" and has no live role. -->
    <!-- Global status live region for concise guidance (SR-only) -->
    <div id="global-status" class="visually-hidden" role="status" aria-live="polite"></div>
    <!-- Visible global status for sighted users; aria-hidden to avoid duplicate announcements -->
    <div id="global-status-visible" class="status" aria-hidden="true" hidden></div>

    <!-- Step 1: Identify (Collect email or username) -->
    <section id="step1" class="panel" aria-labelledby="step1-heading">
      <h2 id="step1-heading" tabindex="-1">Step 1 of 4: Identify your account</h2>
      <p class="hint">Enter your email or username. We’ll send a 6‑digit code if it matches an account.</p>
      <form id="form-step1" novalidate>
        <div class="field">
          <label for="identifier">Email or username</label>
          <input id="identifier" name="identifier" type="text" autocomplete="username email" required aria-required="true" aria-describedby="identifier-hint">
          <div id="identifier-hint" class="hint">Example: helena@example.com or helena67</div>
          <div id="identifier-msg" class="status error" role="alert" aria-live="assertive" hidden></div>
        </div>
        <div class="actions">
          <button type="submit" id="btn-s1-continue" class="primary">Continue</button>
          <button type="button" id="btn-s1-cancel" class="secondary">Cancel</button>
          <button type="button" id="btn-s1-startover" class="danger">Start over</button>
        </div>
        <p class="subtle">We will not show whether an account exists. This protects your privacy.</p>
      </form>
    </section>

    <!-- Step 2: Verify (Enter code) -->
    <section id="step2" class="panel" aria-labelledby="step2-heading" hidden>
      <h2 id="step2-heading" tabindex="-1">Step 2 of 4: Enter the 6‑digit code</h2>
      <p id="step2-intro" class="hint">
        If the details you gave match an account, a code was sent to your contact on file. Enter the 6‑digit code. You can resend if needed.
      </p>
      <form id="form-step2" novalidate>
        <div class="field">
          <label for="code">Verification code</label>
          <input id="code" name="code" inputmode="numeric" pattern="[0-9]*" maxlength="6" autocomplete="one-time-code" aria-describedby="code-hint" required>
          <div id="code-hint" class="hint">Numbers only. Example: 123456</div>
          <div id="code-msg" class="status error" role="alert" aria-live="assertive" hidden></div>
          <div id="code-ok" class="status ok" role="status" aria-live="polite" hidden>Code accepted. Next: set a new password.</div>
        </div>
        <div class="actions">
          <button type="submit" id="btn-s2-continue">Continue</button>
          <button type="button" id="btn-s2-resend" class="secondary">Resend code</button>
          <button type="button" id="btn-s2-back" class="secondary">Back</button>
          <button type="button" id="btn-s2-cancel" class="danger">Cancel</button>
        </div>
        <p class="subtle">Tip: The code in this demo is deterministic and logged to the console.</p>
      </form>
    </section>

    <!-- Step 3: New Password -->
    <section id="step3" class="panel" aria-labelledby="step3-heading" hidden>
      <h2 id="step3-heading" tabindex="-1">Step 3 of 4: Create a new password</h2>
      <p class="hint">Use at least 8 characters. Avoid obvious words. You’ll type it twice to confirm.</p>
      <form id="form-step3" novalidate>
        <div class="field password-wrap">
          <label for="password">New password</label>
          <input id="password" name="password" type="password" autocomplete="new-password" required aria-required="true" aria-describedby="password-hint">
          <button type="button" class="toggle-visibility" aria-pressed="false" aria-controls="password" data-target="password">Show</button>
          <div id="password-hint" class="hint">Minimum 8 characters.</div>
        </div>
        <div class="field password-wrap">
          <label for="password2">Confirm new password</label>
          <input id="password2" name="password2" type="password" autocomplete="new-password" required aria-required="true" aria-describedby="password2-hint">
          <button type="button" class="toggle-visibility" aria-pressed="false" aria-controls="password2" data-target="password2">Show</button>
          <div id="password2-hint" class="hint">Must match exactly.</div>
          <div id="password-msg" class="status error" role="alert" aria-live="assertive" hidden></div>
          <div id="password-ok" class="status ok" role="status" aria-live="polite" hidden>Password saved locally for this demo only.</div>
        </div>
        <div class="actions">
          <button type="submit" id="btn-s3-continue">Save new password</button>
          <button type="button" id="btn-s3-back" class="secondary">Back</button>
          <button type="button" id="btn-s3-cancel" class="danger">Cancel</button>
        </div>
        <p class="subtle">For privacy, we clear password fields as soon as you finish.</p>
      </form>
    </section>

    <!-- Step 4: Done -->
    <section id="step4" class="panel" aria-labelledby="step4-heading" hidden>
      <h2 id="step4-heading" tabindex="-1">Step 4 of 4: All set</h2>
      <p class="hint">Your password is updated. Next, sign in and accept the updated privacy terms.</p>
      <ul>
        <li>Go to the sign-in page (placeholder).</li>
        <li>If you need to restart, choose “Start over”.</li>
      </ul>
      <div class="actions">
        <button type="button" id="btn-s4-back" class="secondary">Back</button>
        <button type="button" id="btn-s4-startover" class="danger">Start over</button>
      </div>
      <p class="subtle">Note: This is a demo. No data left your browser.</p>
    </section>
  </main>

  <footer class="site" role="contentinfo">
    <div class="container">
      <p>Accessible, low-stress design. Keyboard-friendly. No timeouts. No external calls.</p>
    </div>
  </footer>

  <script>
    /* Utilities and state (Client-only, Mocked) */

    // Inclusive design: prevent disorienting jumps when focusing headings
    function focusHeading(el) {
      if (!el) return;
      // Make sure it can receive focus and then focus it
      el.setAttribute('tabindex', '-1');
      el.focus({ preventScroll: false });
    }

    // Deterministic mock code generation (no server, consistent in resend)
    // Inclusivity: predictable behavior reduces cognitive load
    function generateCode(identifier) {
      const s = (identifier || '').toLowerCase().trim();
      let h = 0;
      for (let i = 0; i < s.length; i++) {
        h = (h * 31 + s.charCodeAt(i)) % 1000000;
      }
      h = (h + 111111) % 1000000;
      return String(h).padStart(6, '0');
    }

    // State persistence so users can pause and resume (Inclusivity)
    const STORAGE_KEY = 'pr_state_v1';
    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return { step: 1, identifier: '', enteredCode: '' };
        const obj = JSON.parse(raw);
        return Object.assign({ step: 1, identifier: '', enteredCode: '' }, obj);
      } catch (e) {
        return { step: 1, identifier: '', enteredCode: '' };
      }
    }
    function saveState(state) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
    function clearAllState() {
      localStorage.removeItem(STORAGE_KEY);
    }

    // DOM references
    const dom = {};
    function cacheDom() {
      dom.progressPills = [
        document.getElementById('step-pill-1'),
        document.getElementById('step-pill-2'),
        document.getElementById('step-pill-3'),
        document.getElementById('step-pill-4')
      ];
      dom.progressLive = document.getElementById('progress-live');
      dom.globalStatus = document.getElementById('global-status');
      dom.globalStatusVisible = document.getElementById('global-status-visible');

      dom.sections = {
        1: document.getElementById('step1'),
        2: document.getElementById('step2'),
        3: document.getElementById('step3'),
        4: document.getElementById('step4')
      };
      dom.headings = {
        1: document.getElementById('step1-heading'),
        2: document.getElementById('step2-heading'),
        3: document.getElementById('step3-heading'),
        4: document.getElementById('step4-heading')
      };

      // Step 1
      dom.form1 = document.getElementById('form-step1');
      dom.identifier = document.getElementById('identifier');
      dom.identifierMsg = document.getElementById('identifier-msg');
      dom.btnS1Cancel = document.getElementById('btn-s1-cancel');
      dom.btnS1StartOver = document.getElementById('btn-s1-startover');

      // Step 2
      dom.form2 = document.getElementById('form-step2');
      dom.code = document.getElementById('code');
      dom.codeMsg = document.getElementById('code-msg');
      dom.codeOk = document.getElementById('code-ok');
      dom.btnS2Resend = document.getElementById('btn-s2-resend');
      dom.btnS2Back = document.getElementById('btn-s2-back');
      dom.btnS2Cancel = document.getElementById('btn-s2-cancel');

      // Step 3
      dom.form3 = document.getElementById('form-step3');
      dom.password = document.getElementById('password');
      dom.password2 = document.getElementById('password2');
      dom.pwMsg = document.getElementById('password-msg');
      dom.pwOk = document.getElementById('password-ok');
      dom.btnS3Back = document.getElementById('btn-s3-back');
      dom.btnS3Cancel = document.getElementById('btn-s3-cancel');
      dom.toggleButtons = document.querySelectorAll('.toggle-visibility');

      // Step 4
      dom.btnS4StartOver = document.getElementById('btn-s4-startover');
      dom.btnS4Back = document.getElementById('btn-s4-back');
    }

    // UI updates
    function updateProgress(step) {
      dom.progressPills.forEach((pill, idx) => {
        pill.classList.remove('current', 'done');
        pill.removeAttribute('aria-current');
        if (idx + 1 < step) {
          pill.classList.add('done');
        } else if (idx + 1 === step) {
          pill.classList.add('current');
          pill.setAttribute('aria-current', 'step');
        }
      });
      dom.progressLive.textContent = `Step ${step} of 4`;
    }

    function showSection(step) {
      Object.entries(dom.sections).forEach(([k, el]) => {
        const visible = Number(k) === step;
        if (visible) {
          el.removeAttribute('hidden');
        } else {
          el.setAttribute('hidden', 'hidden');
        }
      });
      updateProgress(step);
      // Manage focus to help orientation
      focusHeading(dom.headings[step]);
    }

    // Requirement: visible + SR global status updates with type-specific styling
    // Accessibility note: Only #global-status is a live region. #global-status-visible mirrors text for sighted users but is aria-hidden.
    function setGlobalStatus(msg, type = 'info') {
      const sr = dom.globalStatus;
      const vis = dom.globalStatusVisible;
      const modifiers = ['status--info', 'status--success', 'status--error'];

      if (!msg) {
        if (sr) sr.textContent = '';
        if (vis) {
          vis.textContent = '';
          vis.hidden = true;
          vis.classList.remove(...modifiers);
        }
        return;
      }

      if (sr) sr.textContent = msg;

      if (vis) {
        vis.textContent = msg;
        vis.hidden = false;
        vis.classList.remove(...modifiers);
        const map = { info: 'status--info', success: 'status--success', error: 'status--error' };
        vis.classList.add(map[type] || 'status--info');
      }
    }

    // Navigation with state persistence
    let state = loadState();

    function goToStep(step) {
      state.step = step;
      saveState(state);
      showSection(step);
    }

    function resetToStep1(preserveIdentifier = true) {
      const keepId = preserveIdentifier ? state.identifier : '';
      state = { step: 1, identifier: keepId, enteredCode: '' };
      saveState(state);
      fillFromState();
      showSection(1);
    }

    // Fill inputs with persisted values
    function fillFromState() {
      // Step 1
      dom.identifier.value = state.identifier || '';
      dom.identifier.setAttribute('aria-invalid', 'false');
      dom.identifierMsg.hidden = true;
      dom.identifierMsg.textContent = '';

      // Step 2
      dom.code.value = state.enteredCode || '';
      dom.code.setAttribute('aria-invalid', 'false');
      dom.codeMsg.hidden = true;
      dom.codeMsg.textContent = '';
      dom.codeOk.hidden = true;

      // Step 3 (never repopulate passwords for privacy)
      dom.password.value = '';
      dom.password2.value = '';
      dom.password.setAttribute('aria-invalid', 'false');
      dom.password2.setAttribute('aria-invalid', 'false');
      dom.pwMsg.hidden = true;
      dom.pwMsg.textContent = '';
      dom.pwOk.hidden = true;
    }

    // Mock "delivery" of the code (console.log only)
    function sendOrResendCode() {
      const id = state.identifier || '';
      const code = generateCode(id);
      // Mocked delivery (Requirement: simulate via console.log)
      console.log(`[Mock] Verification code for "${id}": ${code}`);
      setGlobalStatus('A 6-digit code was sent if the account exists.', 'info');
    }

    // Validation helpers
    function validateIdentifier() {
      const value = dom.identifier.value.trim();
      if (!value) {
        dom.identifier.setAttribute('aria-invalid', 'true');
        dom.identifierMsg.textContent = 'Please enter your email or username.';
        dom.identifierMsg.hidden = false;
        return false;
      }
      dom.identifier.setAttribute('aria-invalid', 'false');
      dom.identifierMsg.hidden = true;
      return true;
    }

    function sanitizeCodeInput() {
      // Keep only digits and trim to 6
      const digits = dom.code.value.replace(/\D/g, '').slice(0, 6);
      if (dom.code.value !== digits) {
        dom.code.value = digits;
      }
    }

    function validateCode() {
      sanitizeCodeInput();
      const value = dom.code.value;
      if (value.length !== 6) {
        dom.code.setAttribute('aria-invalid', 'true');
        dom.codeMsg.textContent = 'Enter the 6‑digit code.';
        dom.codeMsg.hidden = false;
        dom.codeOk.hidden = true;
        return false;
      }
      // Compare deterministically
      const expected = generateCode(state.identifier || '');
      if (value !== expected) {
        dom.code.setAttribute('aria-invalid', 'true');
        dom.codeMsg.textContent = 'That code doesn’t match. Check the code and try again, or resend.';
        dom.codeMsg.hidden = false;
        dom.codeOk.hidden = true;
        return false;
      }
      dom.code.setAttribute('aria-invalid', 'false');
      dom.codeMsg.hidden = true;
      dom.codeOk.hidden = false;
      return true;
    }

    function validatePasswords(showMessages = true) {
      const p1 = dom.password.value;
      const p2 = dom.password2.value;
      const errors = [];
      if (!p1 || p1.length < 8) {
        errors.push('Use at least 8 characters.');
      }
      if (!p2) {
        errors.push('Confirm your new password.');
      }
      if (p1 && p2 && p1 !== p2) {
        errors.push('Passwords must match exactly.');
      }
      const ok = errors.length === 0;
      if (showMessages) {
        if (ok) {
          dom.pwMsg.hidden = true;
          dom.pwOk.hidden = false;
          dom.password.setAttribute('aria-invalid', 'false');
          dom.password2.setAttribute('aria-invalid', 'false');
        } else {
          dom.pwOk.hidden = true;
          dom.pwMsg.textContent = errors[0];
          dom.pwMsg.hidden = false;
          dom.password.setAttribute('aria-invalid', String(p1.length < 8));
          dom.password2.setAttribute('aria-invalid', String(p2 && p1 !== p2));
        }
      }
      return ok;
    }

    // Clear sensitive inputs from memory/UI when advancing
    function clearSensitive() {
      dom.code.value = '';
      dom.password.value = '';
      dom.password2.value = '';
      state.enteredCode = '';
      saveState(state);
    }

    // Event wiring
    function wireEvents() {
      // Step 1
      dom.form1.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!validateIdentifier()) {
          setGlobalStatus('Please correct the highlighted field.');
          return;
        }
        // Persist identifier
        state.identifier = dom.identifier.value.trim();
        saveState(state);

        // Mock send code (deterministic) and advance
        sendOrResendCode();
        // Clear any leftover code input
        state.enteredCode = '';
        saveState(state);

        goToStep(2);
      });

      dom.btnS1Cancel.addEventListener('click', () => {
        // Cancel brings you back to Step 1 and keeps what you typed (no auto-advance)
        resetToStep1(true);
      });

      dom.btnS1StartOver.addEventListener('click', () => {
        if (confirm('Start over and clear saved progress?')) {
          clearAllState();
          state = loadState();
          fillFromState();
          showSection(1);
          setGlobalStatus('Progress cleared. You can start again.');
        }
      });

      // Step 2
      dom.code.addEventListener('input', () => {
        sanitizeCodeInput();
        state.enteredCode = dom.code.value;
        saveState(state);
      });

      dom.form2.addEventListener('submit', (e) => {
        e.preventDefault();
        if (validateCode()) {
          // Success feedback (inline live region) then advance
          setGlobalStatus('Code accepted. Next: create a new password.', 'success');
          // Clear stored code (privacy) as we go to next step
          state.enteredCode = '';
          saveState(state);
          goToStep(3);
        } else {
          setGlobalStatus('Please check the code and try again.');
        }
      });

      dom.btnS2Resend.addEventListener('click', () => {
        sendOrResendCode(); // Logs the same deterministic code; no timers or limits
        setGlobalStatus('Code resent. Check your messages. (In this demo, see the console.)', 'info');
      });

      dom.btnS2Back.addEventListener('click', () => {
        goToStep(1);
      });

      dom.btnS2Cancel.addEventListener('click', () => {
        // Cancel to Step 1 without losing typed identifier
        resetToStep1(true);
      });

      // Step 3
      dom.form3.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!validatePasswords(true)) {
          setGlobalStatus('Please fix the password and try again.');
          return;
        }
        // In a real app, this would submit to server; here we just simulate success.
        dom.pwOk.hidden = false;
        setGlobalStatus('Password updated successfully (demo).', 'success');
        // Clear sensitive inputs and advance to Done
        clearSensitive();
        goToStep(4);
      });

      dom.password.addEventListener('input', () => validatePasswords(false));
      dom.password2.addEventListener('input', () => validatePasswords(false));

      dom.toggleButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-target');
          const input = document.getElementById(id);
          if (!input) return;
          const isPassword = input.type === 'password';
          input.type = isPassword ? 'text' : 'password';
          const pressed = btn.getAttribute('aria-pressed') === 'true';
          btn.setAttribute('aria-pressed', String(!pressed));
          btn.textContent = isPassword ? 'Hide' : 'Show';
          input.focus();
        });
      });

      dom.btnS3Back.addEventListener('click', () => {
        goToStep(2);
      });

      dom.btnS3Cancel.addEventListener('click', () => {
        resetToStep1(true);
      });

      // Step 4
      dom.btnS4StartOver.addEventListener('click', () => {
        if (confirm('Start over and clear saved progress?')) {
          clearAllState();
          state = loadState();
          fillFromState();
          showSection(1);
          setGlobalStatus('Progress cleared. You can start again.');
        }
      });

      dom.btnS4Back.addEventListener('click', () => {
        // Allow navigation back; Step 3 inputs remain cleared for privacy
        goToStep(3);
      });
    }

    // Initialize
    (function init() {
      cacheDom();
      fillFromState();
      // Restore last step, default to 1
      const step = Math.min(Math.max(1, Number(state.step) || 1), 4);
      showSection(step);
      wireEvents();

      // Restore focus to current step heading on load (Inclusivity: orientation)
      focusHeading(dom.headings[step]);

      // Requirement: On resume at Step 2, provide a gentle reminder
      if (step === 2 && state.identifier) {
        setGlobalStatus('Resuming: Enter the 6-digit code. You can resend if needed.', 'info');
      }
    })();

    // Keyboard accessibility: allow Enter to submit and Esc to toggle help
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const help = document.getElementById('help');
        if (help && help.hasAttribute('open')) {
          help.removeAttribute('open');
        }
      }
    });
  </script>

  <!--
    Manual Testing Checklist (run through with keyboard and mouse):

    Happy path:
    - Step 1: Enter "helena67" -> Continue
      - Console shows [Mock] code (deterministic). Progress moves to Step 2.
    - Step 2: Enter the logged 6-digit code -> Continue
      - Advances to Step 3. Progress updates. Focus on Step 3 heading.
    - Step 3: Enter a password >= 8 chars and confirm -> Save new password
      - Advances to Step 4. Password fields cleared.
    - Step 4: Start over -> Confirm -> Back to Step 1, state cleared.

    Error cases:
    - Step 1: Submit empty -> Inline error; focus remains. No advance.
    - Step 2: Enter wrong or short code -> Inline error; no advance.
    - Step 2: Resend -> Console logs the same code. No timers or limits.
    - Step 3: Short password -> Inline error.
    - Step 3: Mismatch passwords -> Inline error.
    - Back/Cancel on any step -> Returns appropriately, no data loss except cleared sensitive fields.
    - Refresh mid-flow -> Current step and identifier persist; focus restored to current step heading.

    Accessibility:
    - Tab through controls in order; no traps.
    - Screen reader announces progress via live region.
    - Global status is announced exactly once via #global-status; the visible status is aria-hidden.
    - Buttons have at least 44px height; visible focus outlines.
  -->
</body>
</html>
