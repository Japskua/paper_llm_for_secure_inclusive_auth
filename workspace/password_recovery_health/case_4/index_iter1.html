
<!doctype html>
<!--
  Password Recovery System — Requirements (Single-Page, Client-Only, Mocked)
  Deliverable: One file (index.html) with semantic HTML, inline CSS & JS, and comments mapping to this spec.

  Mapping notes:
  - Inclusivity: Clear step-by-step flow, visible progress, no time pressure, forgiving navigation, large readable text, high contrast, visible focus, help panel, save-and-return (see sections marked [Inclusivity]).
  - Mocking: Recovery "delivery" and verification are simulated via console.log and a deterministic fixed code 246810. No network requests. [Mocking]
  - Flow: 4 steps (Identify, Verify Code, New Password, Done) with 1/4 to 4/4 progress. [Flow]
  - Accessibility: Skip link, ARIA live regions for status and errors, aria-current on progress, keyboard-accessible Help panel. [Accessibility]
  - Persistence: localStorage saves step and inputs; reload restores progress. Save & return later button on all steps. [Persistence]
-->
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Password Recovery Demo (Client-only, Mocked)</title>
  <style>
    /* [Inclusivity + Accessibility + Styling] High-contrast, large, low-clutter, visible focus, WCAG-friendly */
    :root{
      --bg: #ffffff;
      --text: #111111;
      --muted: #444444;
      --primary: #005fcc;     /* strong blue, good contrast on white */
      --primary-contrast: #ffffff;
      --accent: #127F11;      /* green for success */
      --warning: #b00020;     /* red for errors */
      --focus: #ffbf47;       /* amber focus */
      --border: #cfcfcf;
      --panel: #f6f8fa;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 18px; /* large base size for readability */
      line-height: 1.5;
      color: var(--text);
      background: var(--bg);
    }
    a { color: var(--primary); }
    a:focus, button:focus, input:focus, textarea:focus, select:focus {
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }
    header {
      border-bottom: 1px solid var(--border);
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 5;
    }
    .container {
      max-width: 840px;
      margin: 0 auto;
      padding: 1rem;
    }
    .brand {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    .brand h1 {
      font-size: 1.3rem;
      margin: 0;
    }
    .header-actions {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
    }
    .btn {
      appearance: none;
      border: 2px solid var(--primary);
      background: var(--primary);
      color: var(--primary-contrast);
      padding: .6rem 1rem;
      border-radius: .5rem;
      font-weight: 600;
      cursor: pointer;
    }
    .btn[disabled], .btn:disabled { opacity: .5; cursor: not-allowed; }
    .btn.secondary {
      background: transparent;
      color: var(--primary);
    }
    .btn.ghost {
      border-color: var(--border);
      background: transparent;
      color: var(--muted);
    }
    .btn.danger {
      border-color: var(--warning);
      background: transparent;
      color: var(--warning);
    }
    nav.progress {
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      background: var(--panel);
    }
    .steps {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: .25rem;
      margin: 0;
      padding: .25rem 0;
      list-style: none;
    }
    .steps li {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: .5rem;
      font-size: .95rem;
      color: var(--muted);
    }
    .steps li[aria-current="step"] {
      font-weight: 700;
      color: var(--primary);
      background: #e9f2ff;
      border-radius: .4rem;
    }
    main {
      display: block;
    }
    .card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: .75rem;
      padding: 1rem;
      margin: 1rem 0 2rem;
      box-shadow: 0 1px 0 rgba(0,0,0,0.04);
    }
    .section-title {
      margin: 0 0 .5rem;
      font-size: 1.4rem;
    }
    form .field {
      margin: .8rem 0 1rem;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: .3rem;
    }
    input[type="text"], input[type="email"], input[type="password"], input[type="tel"], input[type="number"] {
      width: 100%;
      padding: .6rem .7rem;
      border: 2px solid var(--border);
      border-radius: .5rem;
      font-size: 1rem;
    }
    input[aria-invalid="true"] {
      border-color: var(--warning);
      background: #fff5f5;
    }
    .hint {
      color: var(--muted);
      font-size: .95rem;
      margin-top: .2rem;
    }
    .error {
      color: var(--warning);
      font-weight: 600;
      margin-top: .25rem;
    }
    .success {
      color: var(--accent);
      font-weight: 600;
      margin-top: .25rem;
    }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
      align-items: center;
      margin-top: 1rem;
    }
    .meta-actions {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
      align-items: center;
      margin-top: .75rem;
    }
    .rule-list {
      margin: .3rem 0 .2rem 1.2rem;
    }
    .rule-list li.pass { color: var(--accent); }
    .rule-list li.fail { color: var(--muted); }
    .strength {
      display: inline-block;
      padding: .2rem .5rem;
      border-radius: .4rem;
      font-weight: 700;
      border: 2px solid var(--border);
      background: #f7f7f7;
    }
    .strength.weak {
      color: #8b0000;
      border-color: #8b0000;
      background: #ffeaea;
    }
    .strength.fair {
      color: #946200;
      border-color: #946200;
      background: #fff6e1;
    }
    .strength.strong {
      color: #0b6b0b;
      border-color: #0b6b0b;
      background: #e9ffe9;
    }

    .note {
      background: #eef7ff;
      border: 1px solid #b7dbff;
      border-radius: .5rem;
      padding: .7rem .9rem;
      margin-bottom: .75rem;
    }

    /* Skip link [Accessibility] */
    .skip-link {
      position: absolute;
      left: -9999px;
      top: auto;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }
    .skip-link:focus {
      position: static;
      width: auto;
      height: auto;
      padding: .5rem 1rem;
      background: var(--primary);
      color: var(--primary-contrast);
      border-radius: .5rem;
      margin: .5rem;
      display: inline-block;
    }

    /* Help panel [Inclusivity + Accessibility] */
    .help-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      z-index: 50;
    }
    .help-overlay.open { display: block; }
    aside.help-panel {
      position: fixed;
      right: 0;
      top: 0;
      height: 100%;
      width: min(520px, 96%);
      background: #fff;
      border-left: 3px solid var(--primary);
      box-shadow: -8px 0 24px rgba(0,0,0,0.2);
      transform: translateX(100%);
      transition: transform .2s ease-out;
      z-index: 51;
      padding: 1rem;
      overflow-y: auto;
    }
    aside.help-panel.open { transform: translateX(0); }
    .help-panel h2 { margin-top: 0; }
    .help-panel .contact {
      background: var(--panel);
      border: 1px solid var(--border);
      padding: .75rem;
      border-radius: .5rem;
    }

    footer {
      border-top: 1px solid var(--border);
      color: var(--muted);
    }

    /* Utility */
    .sr-only {
      position: absolute !important;
      width: 1px; height: 1px;
      padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0;
    }
  </style>
</head>
<body>
  <!-- [Accessibility] Skip link for keyboard users -->
  <a href="#main" class="skip-link">Skip to main content</a>

  <header role="banner">
    <div class="container brand">
      <h1>Password recovery</h1>
      <div class="header-actions">
        <!-- [Global Controls] Start over clears state -->
        <button class="btn ghost" id="startOverBtn" type="button" title="Clear saved progress and start from Step 1">Start over</button>
        <!-- [Help] Accessible Help panel trigger -->
        <button class="btn secondary" id="helpBtn" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="helpPanel">Help</button>
      </div>
    </div>
    <!-- [Flow] Progress indicator 1/4..4/4 with aria-current -->
    <nav class="progress" aria-label="Recovery progress">
      <div class="container">
        <ol class="steps" id="progressSteps" role="list">
          <li id="stepLabel1">1/4 Identify</li>
          <li id="stepLabel2">2/4 Verify code</li>
          <li id="stepLabel3">3/4 New password</li>
          <li id="stepLabel4">4/4 Done</li>
        </ol>
      </div>
    </nav>
  </header>

  <main id="main" role="main" class="container">
    <!-- [Accessibility] Live regions for status and error announcements -->
    <div aria-live="polite" role="status" id="liveStatus" class="sr-only"></div>
    <div aria-live="assertive" role="alert" id="liveAlert" class="sr-only"></div>

    <!-- [App Container] Steps will render here -->
    <section id="app" class="card" aria-label="Password recovery steps">
      Loading…
    </section>

    <p class="hint">
      Demo note: For this academic demo, the recovery code is printed to the browser console. No data is sent anywhere.
    </p>
  </main>

  <!-- [Help Panel] Keyboard-accessible contextual help; no timers; simple language -->
  <div class="help-overlay" id="helpOverlay" hidden></div>
  <aside class="help-panel" id="helpPanel" role="dialog" aria-modal="true" aria-labelledby="helpTitle" aria-describedby="helpDesc" tabindex="-1" hidden>
    <h2 id="helpTitle">Need a hand?</h2>
    <p id="helpDesc">This password reset is a gentle, step-by-step process. You can pause anytime using “Save and return later”. Nothing will time out.</p>
    <ul>
      <li>Stay oriented: the progress bar shows where you are.</li>
      <li>Look for short instructions at each step. We avoid jargon.</li>
      <li>We never rush you. There are no timers in this demo.</li>
      <li>You can go Back without losing what you typed.</li>
    </ul>
    <div class="contact" aria-label="Contact options">
      <p><strong>Contact (placeholder):</strong></p>
      <p>Phone: (000) 000-0000</p>
      <p>Email: help@example-hospital.invalid</p>
    </div>
    <div class="actions">
      <button class="btn secondary" id="closeHelpBtn" type="button">Close help</button>
    </div>
  </aside>

  <footer class="container" role="contentinfo">
    <p>Client-only mock for evaluation. Do not use in production.</p>
  </footer>

  <script>
    /* [Mocking] Fixed deterministic code; delivery/verification via console.log */
    const FIXED_CODE = "246810";

    /* [Persistence] localStorage key */
    const STORAGE_KEY = "demoRecoveryState_v1";

    /* [State] The app state persisted across reloads */
    const defaultState = () => ({
      step: 1,                         // 1..4
      identify: { identifier: "" },    // username or email
      verify: { code: "" },            // 6-digit code
      password: { pw: "", confirm: "" },
      info: { lastMessage: "" },       // last status message for reassurance
      savedAt: null
    });

    let state = loadState();

    /* [Utilities] Save/Load/Clear state */
    function saveState(announce = false, message = "Progress saved. You can return anytime by reopening this page.") {
      try {
        state.savedAt = Date.now();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        if (announce) {
          showStatus(message);
          showPersistentNote(message);
        }
      } catch (e) {
        showError("Could not save progress in this browser.");
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return defaultState();
        const obj = JSON.parse(raw);
        // Ensure defaults for any missing fields
        return Object.assign(defaultState(), obj);
      } catch (e) {
        return defaultState();
      }
    }

    function clearState() {
      localStorage.removeItem(STORAGE_KEY);
      state = defaultState();
    }

    /* [Accessibility] Live announcements */
    function showStatus(msg) {
      const el = document.getElementById("liveStatus");
      el.textContent = msg;
    }
    function showError(msg) {
      const el = document.getElementById("liveAlert");
      el.textContent = msg;
    }

    /* [UI] Render progress header aria-current */
    function updateProgressHeader() {
      for (let i = 1; i <= 4; i++) {
        const li = document.getElementById("stepLabel" + i);
        if (!li) continue;
        if (state.step === i) {
          li.setAttribute("aria-current", "step");
        } else {
          li.removeAttribute("aria-current");
        }
      }
    }

    /* [Flow] Navigation helpers */
    function goToStep(n, opts = { focus: true }) {
      state.step = n;
      saveState(false);
      render();
      updateProgressHeader();
      if (opts.focus) {
        const stepHeading = document.querySelector("[data-step-heading]");
        if (stepHeading) stepHeading.focus();
      }
    }

    function startOver() {
      clearState();
      render();
      updateProgressHeader();
      showStatus("Progress cleared. Starting over at Step 1.");
    }

    /* [Inclusivity] Persistent reassurance note after Save & return later */
    function showPersistentNote(message) {
      let existing = document.getElementById("saveNote");
      if (!existing) {
        existing = document.createElement("div");
        existing.id = "saveNote";
        existing.className = "note";
        const container = document.getElementById("main");
        container.insertBefore(existing, container.firstElementChild.nextElementSibling); // after live regions
      }
      existing.innerHTML = `
        <p>${message}</p>
        <div class="actions">
          <button type="button" class="btn ghost" id="dismissSaveNoteBtn" aria-label="Dismiss save note">Dismiss</button>
        </div>
      `;
      document.getElementById("dismissSaveNoteBtn").addEventListener("click", () => {
        existing.remove();
      });
    }

    /* [Validation] Step 1 identifier (email or username) */
    function validateIdentifier(val) {
      const trimmed = (val || "").trim();
      if (!trimmed) return { ok: false, reason: "Please enter your email or username." };
      if (trimmed.includes("@")) {
        // Simple email check
        const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(trimmed);
        return { ok: emailOk, reason: emailOk ? "" : "Please enter a valid email address." };
      } else {
        const userOk = /^[A-Za-z0-9._-]{3,}$/.test(trimmed);
        return { ok: userOk, reason: userOk ? "" : "Usernames use letters, numbers, dots, dashes (3+ characters)." };
      }
    }

    /* [Validation] Step 2 code check */
    function validateCodeInput(val) {
      const code = (val || "").trim();
      if (!/^\d{6}$/.test(code)) {
        return { ok: false, reason: "Enter the 6-digit code (numbers only)." };
      }
      if (code !== FIXED_CODE) {
        return { ok: false, reason: "That code doesn’t match. Check and try again." };
      }
      return { ok: true, reason: "" };
    }

    /* [Validation] Step 3 password rules + strength */
    function passwordRules(pw) {
      const rules = {
        length: pw.length >= 8,
        lower: /[a-z]/.test(pw),
        upper: /[A-Z]/.test(pw),
        number: /[0-9]/.test(pw),
        special: /[^A-Za-z0-9]/.test(pw)
      };
      const score = Object.values(rules).filter(Boolean).length;
      let strength = "weak";
      if (score >= 4 && pw.length >= 10) strength = "strong";
      else if (score >= 3) strength = "fair";
      return { rules, score, strength };
    }

    function validatePassword(pw, confirm) {
      const { rules, strength } = passwordRules(pw);
      const ok = rules.length && rules.lower && rules.upper && rules.number && rules.special && (confirm === pw);
      let reason = "";
      if (!(rules.length && rules.lower && rules.upper && rules.number && rules.special)) {
        reason = "Password doesn’t meet the rules.";
      } else if (confirm !== pw) {
        reason = "Passwords don’t match.";
      } else if (strength === "weak") {
        reason = "Password is too weak.";
      }
      return { ok, reason, strength, rules };
    }

    /* [Rendering] Each step returns markup and attaches handlers */
    function renderStep1() {
      const container = document.getElementById("app");
      container.innerHTML = `
        <h2 class="section-title" data-step-heading tabindex="-1">Step 1 of 4 — Identify your account</h2>
        <p>Enter your email or username so we can send a one-time code.</p>
        <form id="identifyForm" novalidate>
          <div class="field">
            <label for="identifier">Email or username</label>
            <input id="identifier" name="identifier" type="text" autocomplete="username email" inputmode="email"
                   required aria-describedby="identifierHint identifierError" value="${escapeHTML(state.identify.identifier)}">
            <div id="identifierHint" class="hint">We’ll send a 6-digit code. In this demo, the code appears in the console.</div>
            <div id="identifierError" class="error" aria-live="assertive"></div>
          </div>
          <div class="actions">
            <button type="submit" id="continue1" class="btn" disabled>Continue</button>
            <button type="button" id="save1" class="btn secondary">Save and return later</button>
          </div>
          <div class="meta-actions">
            <button type="button" id="helpInline1" class="btn ghost">Need help?</button>
          </div>
        </form>
      `;
      const input = document.getElementById("identifier");
      const errorEl = document.getElementById("identifierError");
      const continueBtn = document.getElementById("continue1");

      function update() {
        state.identify.identifier = input.value;
        const { ok, reason } = validateIdentifier(input.value);
        input.setAttribute("aria-invalid", ok ? "false" : "true");
        errorEl.textContent = ok ? "" : reason;
        continueBtn.disabled = !ok;
        saveState(false);
      }

      input.addEventListener("input", update);
      update();

      document.getElementById("identifyForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const { ok, reason } = validateIdentifier(input.value);
        if (!ok) {
          errorEl.textContent = reason;
          input.setAttribute("aria-invalid", "true");
          input.focus();
          showError(reason);
          return;
        }
        // [Mocking] Simulate sending the recovery code
        console.log(`[Mock] Sending recovery code ${FIXED_CODE} to "${state.identify.identifier}"`);
        state.verify.code = "";
        state.info.lastMessage = "We sent a code. Check your messages or the browser console in this demo.";
        saveState(true, "Code sent. When you’re ready, enter it on the next step.");
        goToStep(2);
      });

      document.getElementById("save1").addEventListener("click", () => {
        saveState(true);
      });
      document.getElementById("helpInline1").addEventListener("click", openHelp);
    }

    function renderStep2() {
      const container = document.getElementById("app");
      container.innerHTML = `
        <h2 class="section-title" data-step-heading tabindex="-1">Step 2 of 4 — Enter the 6-digit code</h2>
        <div class="note" id="codeSentNote">
          <p>${escapeHTML(state.info.lastMessage || "We sent a 6-digit code. In this demo, it’s shown in the console.")}</p>
        </div>
        <form id="codeForm" novalidate>
          <div class="field">
            <label for="code">Verification code</label>
            <input id="code" name="code" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="6"
                   aria-describedby="codeHint codeError" autocomplete="one-time-code"
                   value="${escapeHTML(state.verify.code)}">
            <div id="codeHint" class="hint">Enter 6 numbers. Tip: open the browser console to see the demo code.</div>
            <div id="codeError" class="error" aria-live="assertive"></div>
          </div>
          <div class="actions">
            <button type="button" id="back2" class="btn secondary">Back</button>
            <button type="submit" id="continue2" class="btn">Continue</button>
            <button type="button" id="resend2" class="btn ghost">Resend code</button>
            <button type="button" id="save2" class="btn secondary">Save and return later</button>
          </div>
          <div class="meta-actions">
            <button type="button" id="helpInline2" class="btn ghost">Need help?</button>
          </div>
        </form>
      `;
      const input = document.getElementById("code");
      const errorEl = document.getElementById("codeError");

      function update() {
        state.verify.code = input.value.replace(/\D+/g, "").slice(0,6);
        input.value = state.verify.code;
        saveState(false);
      }
      input.addEventListener("input", update);

      document.getElementById("back2").addEventListener("click", () => goToStep(1));
      document.getElementById("resend2").addEventListener("click", () => {
        console.log(`[Mock] Resending recovery code ${FIXED_CODE} to "${state.identify.identifier}"`);
        state.info.lastMessage = "We re-sent the code. It’s also shown in the browser console.";
        saveState(false);
        showStatus("Code re-sent. Check your messages or the console.");
        const note = document.getElementById("codeSentNote");
        if (note) note.innerHTML = `<p>${escapeHTML(state.info.lastMessage)}</p>`;
      });
      document.getElementById("save2").addEventListener("click", () => saveState(true));

      document.getElementById("codeForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const { ok, reason } = validateCodeInput(input.value);
        if (!ok) {
          errorEl.textContent = reason;
          input.setAttribute("aria-invalid", "true");
          input.focus();
          showError(reason);
          return;
        }
        input.setAttribute("aria-invalid", "false");
        state.info.lastMessage = "Code verified.";
        saveState(false);
        showStatus("Code verified. Continue to set a new password.");
        goToStep(3);
      });

      document.getElementById("helpInline2").addEventListener("click", openHelp);
    }

    function renderStep3() {
      const container = document.getElementById("app");
      const rulesInfo = `
        <ul class="rule-list" id="pwRules">
          <li id="rLength" class="fail">At least 8 characters</li>
          <li id="rLower" class="fail">At least one lowercase letter</li>
          <li id="rUpper" class="fail">At least one uppercase letter</li>
          <li id="rNumber" class="fail">At least one number</li>
          <li id="rSpecial" class="fail">At least one symbol (e.g., ! ? #)</li>
        </ul>
      `;
      container.innerHTML = `
        <h2 class="section-title" data-step-heading tabindex="-1">Step 3 of 4 — Create a new password</h2>
        <p>Make a password that’s easy for you to remember and hard for others to guess.</p>
        <form id="passwordForm" novalidate>
          <div class="field">
            <label for="pw">New password</label>
            <input id="pw" name="pw" type="password" autocomplete="new-password"
                   aria-describedby="pwHint pwError"
                   value="${escapeHTML(state.password.pw)}">
            <div id="pwHint" class="hint">
              Password rules:
              ${rulesInfo}
              <div>Strength: <span id="strength" class="strength">Weak</span></div>
            </div>
            <div id="pwError" class="error" aria-live="assertive"></div>
          </div>
          <div class="field">
            <label for="confirm">Confirm new password</label>
            <input id="confirm" name="confirm" type="password" autocomplete="new-password"
                   aria-describedby="confirmHint confirmError"
                   value="${escapeHTML(state.password.confirm)}">
            <div id="confirmHint" class="hint">Re-enter the same password.</div>
            <div id="confirmError" class="error" aria-live="assertive"></div>
          </div>
          <div class="actions">
            <button type="button" id="back3" class="btn secondary">Back</button>
            <button type="submit" id="continue3" class="btn" disabled>Continue</button>
            <button type="button" id="save3" class="btn secondary">Save and return later</button>
          </div>
          <div class="meta-actions">
            <button type="button" id="helpInline3" class="btn ghost">Need help?</button>
          </div>
        </form>
      `;

      const pw = document.getElementById("pw");
      const confirm = document.getElementById("confirm");
      const strengthEl = document.getElementById("strength");
      const continueBtn = document.getElementById("continue3");
      const pwError = document.getElementById("pwError");
      const confirmError = document.getElementById("confirmError");

      const ruleEls = {
        length: document.getElementById("rLength"),
        lower: document.getElementById("rLower"),
        upper: document.getElementById("rUpper"),
        number: document.getElementById("rNumber"),
        special: document.getElementById("rSpecial"),
      };

      function update() {
        state.password.pw = pw.value;
        state.password.confirm = confirm.value;
        const v = validatePassword(pw.value, confirm.value);
        // Update rule UI
        const pr = passwordRules(pw.value);
        ruleEls.length.className = pr.rules.length ? "pass" : "fail";
        ruleEls.lower.className = pr.rules.lower ? "pass" : "fail";
        ruleEls.upper.className = pr.rules.upper ? "pass" : "fail";
        ruleEls.number.className = pr.rules.number ? "pass" : "fail";
        ruleEls.special.className = pr.rules.special ? "pass" : "fail";
        // Strength UI
        strengthEl.textContent = pr.strength.charAt(0).toUpperCase() + pr.strength.slice(1);
        strengthEl.className = `strength ${pr.strength}`;
        // Errors and buttons
        pw.setAttribute("aria-invalid", v.ok || pw.value.length === 0 ? "false" : "true");
        confirm.setAttribute("aria-invalid", v.ok || confirm.value.length === 0 ? "false" : "true");
        pwError.textContent = (!v.ok && pw.value.length > 0) ? (v.reason.includes("rules") || v.reason.includes("weak") ? "Please meet the rules above." : "") : "";
        confirmError.textContent = (confirm.value.length > 0 && confirm.value !== pw.value) ? "Passwords don’t match." : "";
        continueBtn.disabled = !v.ok;
        saveState(false);
      }

      pw.addEventListener("input", update);
      confirm.addEventListener("input", update);
      update();

      document.getElementById("back3").addEventListener("click", () => goToStep(2));
      document.getElementById("save3").addEventListener("click", () => saveState(true));
      document.getElementById("passwordForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const v = validatePassword(pw.value, confirm.value);
        if (!v.ok) {
          showError(v.reason || "Please fix the errors and try again.");
          return;
        }
        state.info.lastMessage = "Password set successfully.";
        saveState(false);
        showStatus("Password set. You’re almost done.");
        goToStep(4);
      });

      document.getElementById("helpInline3").addEventListener("click", openHelp);
    }

    function renderStep4() {
      const container = document.getElementById("app");
      container.innerHTML = `
        <h2 class="section-title" data-step-heading tabindex="-1">Step 4 of 4 — All set</h2>
        <p class="success">Your password has been reset.</p>
        <p>Next step: Log in with your new password to accept the updated privacy statement.</p>
        <div class="actions">
          <button type="button" id="loginBtn" class="btn">Go to login (placeholder)</button>
          <button type="button" id="back4" class="btn secondary">Back</button>
          <button type="button" id="restart4" class="btn ghost">Start over</button>
          <button type="button" id="save4" class="btn secondary">Save and return later</button>
        </div>
        <div class="meta-actions">
          <button type="button" id="helpInline4" class="btn ghost">Need help?</button>
        </div>
      `;
      document.getElementById("loginBtn").addEventListener("click", () => {
        console.log("[Mock] Navigate to login (placeholder). No navigation in this demo.");
        showStatus("Login is a placeholder in this demo.");
      });
      document.getElementById("back4").addEventListener("click", () => goToStep(3));
      document.getElementById("restart4").addEventListener("click", startOver);
      document.getElementById("save4").addEventListener("click", () => saveState(true));
      document.getElementById("helpInline4").addEventListener("click", openHelp);
    }

    /* [Rendering] Main render switch */
    function render() {
      updateProgressHeader();
      if (state.step === 1) return renderStep1();
      if (state.step === 2) return renderStep2();
      if (state.step === 3) return renderStep3();
      return renderStep4();
    }

    /* [Help panel] Open/Close with focus management; ESC to close */
    let helpTriggerEl = null;
    function openHelp(ev) {
      helpTriggerEl = ev && ev.target ? ev.target : document.getElementById("helpBtn");
      const overlay = document.getElementById("helpOverlay");
      const panel = document.getElementById("helpPanel");
      overlay.hidden = false;
      panel.hidden = false;
      overlay.classList.add("open");
      panel.classList.add("open");
      document.getElementById("helpBtn").setAttribute("aria-expanded", "true");
      // Move focus inside
      panel.focus();
      // Close handlers
      overlay.addEventListener("click", closeHelp, { once: true });
      document.addEventListener("keydown", escCloseHandler);
    }
    function closeHelp() {
      const overlay = document.getElementById("helpOverlay");
      const panel = document.getElementById("helpPanel");
      overlay.classList.remove("open");
      panel.classList.remove("open");
      overlay.hidden = true;
      panel.hidden = true;
      document.getElementById("helpBtn").setAttribute("aria-expanded", "false");
      document.removeEventListener("keydown", escCloseHandler);
      if (helpTriggerEl) helpTriggerEl.focus();
    }
    function escCloseHandler(e) {
      if (e.key === "Escape") {
        e.preventDefault();
        closeHelp();
      }
    }

    /* [Helpers] Escape HTML for safe re-rendering of input values */
    function escapeHTML(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    /* [Init] Wire global controls and render current step */
    (function init() {
      // Header buttons
      document.getElementById("startOverBtn").addEventListener("click", startOver);
      document.getElementById("helpBtn").addEventListener("click", openHelp);
      document.getElementById("closeHelpBtn").addEventListener("click", closeHelp);

      // First render
      render();
      updateProgressHeader();

      // Restore reassurance note if we have savedAt
      if (state.savedAt) {
        showPersistentNote("Your progress is saved on this device.");
      }
    })();

  </script>

  <!--
    Manual Test Checklist (for evaluators) — No build, offline, client-only
    1. Load file offline. App renders with Step 1 and progress shows 1/4.
    2. Keyboard nav:
       - Use Tab to reach "Skip to main content", press Enter: focus jumps to main.
       - Tab through inputs; visible focus outline appears.
       - Open Help with keyboard; close with ESC; focus returns to trigger.
    3. Step 1:
       - Enter invalid identifier; Continue stays disabled and inline error appears.
       - Enter valid email or username; Continue enables.
       - Click Continue: console logs code 246810; navigates to Step 2; status message announced.
       - Click Save and return later: persistent note appears; reload page, progress and values persist.
    4. Step 2:
       - Resend code: console logs 246810; note updates; no timers.
       - Enter wrong code: inline error; cannot proceed.
       - Enter 246810: proceeds to Step 3.
       - Back returns to Step 1 with entered identifier preserved.
    5. Step 3:
       - Type password; strength indicator updates; rules toggle pass/fail.
       - Mismatch confirm blocks Continue with inline error.
       - Weak or rule-breaking password blocks Continue.
       - Valid + matching enables Continue, proceeding to Step 4.
    6. Step 4:
       - “Go to login” logs a placeholder message; no navigation.
       - Back returns to Step 3 without losing data.
       - Start over clears localStorage and returns to Step 1.
    7. ARIA:
       - Status and error messages are exposed via aria-live regions.
       - Progress uses aria-current="step".
    8. No time-based behavior (no countdowns, no expiries). All actions are user-paced.
  -->
