{"code_tsx": "\n/**\n * app.ts - Single-file HTTPS Bun server + SPA client\n * Run with: bun app.ts  (Bun 1.3.0)\n *\n * This file implements a Password Recovery System per requirements.\n * - HTTPS with mkcert certs\n * - Strict security headers (HSTS, CSP with nonce, etc.)\n * - In-memory stores for users, sessions, tokens, MFA, rate limits\n * - CSRF protection with per-session token\n * - Password reset wizard with verification link/code + MFA\n * - Login with throttling and MFA\n * - SPA with accessible, low-distraction UI, Help panel, persistent progress\n * - All deliveries (reset link, codes) are console.log'd and mirrored to on-page Logs.\n */\n\n// ==============================\n// Utility and Security Helpers\n// ==============================\n\n// Server secret for signing; new per process. In production, persist securely.\nconst SERVER_SECRET = crypto.getRandomValues(new Uint8Array(32));\n\n// Time helpers\nconst now = () => Date.now();\n\n// Base64url encode helper\nfunction base64url(bytes: Uint8Array): string {\n  let str = Buffer.from(bytes).toString(\"base64\");\n  return str.replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=+$/g, \"\");\n}\n\n// Random ID\nfunction randId(bytes = 16): string {\n  const b = crypto.getRandomValues(new Uint8Array(bytes));\n  return base64url(b);\n}\n\n// Hash helpers\nasync function sha256Hex(input: string): Promise<string> {\n  const enc = new TextEncoder();\n  const digest = await crypto.subtle.digest(\"SHA-256\", enc.encode(input));\n  return Buffer.from(digest).toString(\"hex\");\n}\n\nasync function hmacSha256Hex(keyBytes: Uint8Array, data: string): Promise<string> {\n  const key = await crypto.subtle.importKey(\n    \"raw\",\n    keyBytes,\n    { name: \"HMAC\", hash: \"SHA-256\" },\n    false,\n    [\"sign\", \"verify\"]\n  );\n  const sig = await crypto.subtle.sign(\"HMAC\", key, new TextEncoder().encode(data));\n  return Buffer.from(sig).toString(\"hex\");\n}\n\n// Short code derivation (deterministic) from a token: 6 chars A-Z0-9\nfunction shortCodeFromHex(hex: string, length = 6): string {\n  const alphabet = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\";\n  let code = \"\";\n  // Convert hex to array of numbers\n  for (let i = 0; code.length < length && i < hex.length; i += 2) {\n    const num = parseInt(hex.slice(i, i + 2), 16);\n    code += alphabet[num % alphabet.length];\n  }\n  return code;\n}\n\n// Mask email for privacy\nfunction maskEmail(email: string): string {\n  const [user, domain] = email.split(\"@\");\n  if (!domain) return \"account\";\n  const [name, tld] = domain.split(\".\");\n  const u = user ? user[0] + \"*\".repeat(Math.max(0, user.length - 1)) : \"*\";\n  const n = name ? name[0] + \"*\".repeat(Math.max(0, name.length - 1)) : \"*\";\n  const t = tld ? tld : \"\";\n  return `${u}@${n}${t ? \".\" + t : \"\"}`;\n}\n\n// Escape HTML to prevent XSS in any dynamic UI strings (client also has a sanitizer)\nfunction escapeHtml(s: string): string {\n  return s.replace(/[&<>'\"]/g, c => ({ \"&\": \"&amp;\", \"<\": \"&lt;\", \">\": \"&gt;\", \"'\": \"&#39;\", '\"': \"&quot;\" }[c] as string));\n}\n\n// ==============================\n// In-memory Stores (non-persistent)\n// ==============================\n\n// Users\ntype User = {\n  id: string;\n  email: string;\n  passwordHash: string;\n  mfaEnabled: boolean;\n};\nconst usersByEmail = new Map<string, User>();\nconst usersById = new Map<string, User>();\n\n// Seed demo user with bcrypt/argon2id via Bun.password.hash\nconst DEMO_EMAIL = \"helena.patient@examplehospital.org\";\nlet DEMO_USER_ID = randId(12);\nlet DEMO_USER: User;\n// Use top-level await for seeding\nconst demoHash = await Bun.password.hash(\"StrongP@ssw0rd!2025\", {\n  algorithm: \"bcrypt\",\n  cost: 10,\n});\nDEMO_USER = {\n  id: DEMO_USER_ID,\n  email: DEMO_EMAIL,\n  passwordHash: demoHash,\n  mfaEnabled: true,\n};\nusersByEmail.set(DEMO_EMAIL.toLowerCase(), DEMO_USER);\nusersById.set(DEMO_USER_ID, DEMO_USER);\n\n// Sessions\ntype ResetContext = { userId: string; token: string; mfaVerified?: boolean; createdAt: number };\ntype Session = {\n  id: string;\n  csrf: string;\n  userId?: string;\n  pendingLoginUserId?: string;\n  createdAt: number;\n  lastSeen: number;\n  // small counters per endpoint for simple throttling\n  counters: Record<string, number>;\n  reset?: ResetContext;\n};\nconst sessions = new Map<string, Session>();\n\n// Reset tokens\ntype ResetTokenRecord = {\n  token: string;\n  userId: string;\n  createdAt: number;\n  used: boolean;\n  shortCode: string;\n  attempts: number;\n  mfaAttempts: number;\n};\nconst resetTokens = new Map<string, ResetTokenRecord>();\nconst resetCodes = new Map<string, string>(); // shortCode -> token\n\n// MFA codes (for demo, deterministic from token or user)\nconst mfaForReset = new Map<string, string>(); // token -> mfa code\nconst mfaForLogin = new Map<string, string>(); // userId -> mfa code\n\n// Rate limits\ntype RateEntry = { count: number; first: number };\nconst rateLimits = new Map<string, RateEntry>();\nfunction rateKey(ip: string, scope: string) {\n  return `${ip}:${scope}`;\n}\nfunction checkRate(ip: string, scope: string, limit: number, windowMs: number): { ok: boolean; retryAfter?: number } {\n  const key = rateKey(ip, scope);\n  const nowMs = now();\n  const entry = rateLimits.get(key);\n  if (!entry) {\n    rateLimits.set(key, { count: 1, first: nowMs });\n    return { ok: true };\n  }\n  if (nowMs - entry.first > windowMs) {\n    rateLimits.set(key, { count: 1, first: nowMs });\n    return { ok: true };\n  }\n  entry.count += 1;\n  if (entry.count > limit) {\n    const retryAfter = Math.ceil((entry.first + windowMs - nowMs) / 1000);\n    return { ok: false, retryAfter };\n  }\n  return { ok: true };\n}\n\n// ==============================\n// Cookies and Session Management\n// ==============================\n\nfunction parseCookies(req: Request): Record<string, string> {\n  const header = req.headers.get(\"cookie\") || \"\";\n  const out: Record<string, string> = {};\n  header.split(\";\").forEach(part => {\n    const [k, ...v] = part.trim().split(\"=\");\n    if (!k) return;\n    out[k] = decodeURIComponent(v.join(\"=\"));\n  });\n  return out;\n}\n\nasync function signSessionId(id: string): Promise<string> {\n  const sig = await hmacSha256Hex(SERVER_SECRET, id);\n  return `${id}.${sig}`;\n}\n\nasync function verifySessionCookie(cookieVal: string): Promise<string | null> {\n  const idx = cookieVal.lastIndexOf(\".\");\n  if (idx === -1) return null;\n  const id = cookieVal.slice(0, idx);\n  const sig = cookieVal.slice(idx + 1);\n  const expect = await hmacSha256Hex(SERVER_SECRET, id);\n  if (sig === expect) return id;\n  return null;\n}\n\nasync function getOrCreateSession(req: Request): Promise<{ session: Session; setCookie?: string }> {\n  const cookies = parseCookies(req);\n  const cookieVal = cookies[\"sid\"];\n  if (cookieVal) {\n    const id = await verifySessionCookie(cookieVal);\n    if (id) {\n      const s = sessions.get(id);\n      if (s) {\n        s.lastSeen = now();\n        return { session: s };\n      }\n    }\n  }\n  const id = randId(18);\n  const csrf = randId(18);\n  const session: Session = { id, csrf, createdAt: now(), lastSeen: now(), counters: {} };\n  sessions.set(id, session);\n  const signed = await signSessionId(id);\n  const setCookie = `sid=${signed}; HttpOnly; Secure; SameSite=Strict; Path=/; Max-Age=${60 * 60 * 24 * 7}`;\n  return { session, setCookie };\n}\n\n// ==============================\n// Security Headers per response\n// ==============================\n\nfunction securityHeaders(nonce?: string, isHTML = false): Headers {\n  const h = new Headers();\n  h.set(\"X-Content-Type-Options\", \"nosniff\");\n  h.set(\"X-Frame-Options\", \"DENY\");\n  h.set(\"Referrer-Policy\", \"no-referrer\");\n  h.set(\"Permissions-Policy\", \"geolocation=(), camera=(), microphone=()\");\n  h.set(\"Strict-Transport-Security\", \"max-age=63072000; includeSubDomains; preload\");\n  h.set(\"Cache-Control\", \"no-store\");\n\n  const baseCsp = [\n    \"default-src 'none'\",\n    `connect-src 'self'`,\n    \"img-src 'self' data:\",\n    \"style-src 'self' 'unsafe-inline'\",\n    \"form-action 'self'\",\n    \"base-uri 'none'\",\n    \"frame-ancestors 'none'\",\n    \"object-src 'none'\",\n    \"font-src 'self'\",\n  ];\n  if (isHTML && nonce) {\n    baseCsp.push(`script-src 'nonce-${nonce}'`);\n  } else {\n    baseCsp.push(\"script-src 'none'\");\n  }\n  h.set(\"Content-Security-Policy\", baseCsp.join(\"; \"));\n  return h;\n}\n\n// ==============================\n// CSRF Validation\n// ==============================\n\nasync function requireCsrf(req: Request, session: Session): Promise<Response | null> {\n  const token = req.headers.get(\"x-csrf-token\") || \"\";\n  if (!token || token !== session.csrf) {\n    const h = securityHeaders();\n    h.set(\"Content-Type\", \"application/json\");\n    return new Response(JSON.stringify({ ok: false, error: \"CSRF validation failed\" }), { status: 403, headers: h });\n  }\n  return null;\n}\n\n// ==============================\n// Password Policy\n// ==============================\n\nconst COMMON_PASSWORDS = new Set([\n  \"password\", \"123456\", \"12345678\", \"qwerty\", \"qwerty123\", \"letmein\", \"admin\", \"welcome\", \"iloveyou\", \"monkey\", \"dragon\",\n]);\n\nfunction validatePasswordPolicy(pw: string): { ok: boolean; message?: string } {\n  if (pw.length < 12) return { ok: false, message: \"Password must be at least 12 characters.\" };\n  if (!/[a-z]/.test(pw)) return { ok: false, message: \"Include a lowercase letter.\" };\n  if (!/[A-Z]/.test(pw)) return { ok: false, message: \"Include an uppercase letter.\" };\n  if (!/[0-9]/.test(pw)) return { ok: false, message: \"Include a number.\" };\n  if (!/[^\\w\\s]/.test(pw)) return { ok: false, message: \"Include a special character.\" };\n  if (COMMON_PASSWORDS.has(pw.toLowerCase())) return { ok: false, message: \"Password is too common.\" };\n  return { ok: true };\n}\n\n// ==============================\n// MFA generation (deterministic demo)\n// ==============================\n\nasync function deriveMfaForReset(token: string): Promise<string> {\n  const hex = await sha256Hex(`reset:${token}:mfa`);\n  return shortCodeFromHex(hex, 6);\n}\nasync function deriveMfaForLogin(userId: string): Promise<string> {\n  const hex = await sha256Hex(`login:${userId}:${Buffer.from(SERVER_SECRET).toString(\"hex\")}`);\n  return shortCodeFromHex(hex, 6);\n}\n\n// ==============================\n// HTML SPA Template\n// ==============================\n\nfunction spaHtml(nonce: string, csrf: string): string {\n  // No untrusted/inline event attributes; all JS uses addEventListener and is allowed by CSP nonce\n  return `<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\">\n  <title>Healthcare Account — Secure Login & Password Recovery</title>\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n  <meta name=\"csrf-token\" content=\"${csrf}\">\n  <style>\n    /* Inclusivity: low-distraction, readable typography, clear structure */\n    :root {\n      --bg: #f7f9fb;\n      --card: #ffffff;\n      --text: #1e2a3a;\n      --muted: #5a6b7b;\n      --primary: #2f6fed;\n      --accent: #19b394;\n      --danger: #d93f4c;\n      --warning: #e6a700;\n      --border: #e1e7ef;\n      --focus: #ffbf47;\n    }\n    * { box-sizing: border-box; }\n    body {\n      margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;\n      line-height: 1.5;\n    }\n    header {\n      background: var(--card); border-bottom: 1px solid var(--border);\n      position: sticky; top: 0; z-index: 10;\n    }\n    .container { max-width: 980px; margin: 0 auto; padding: 16px; }\n    .brand { display: flex; align-items: center; gap: 12px; }\n    .brand .logo {\n      width: 36px; height: 36px; border-radius: 8px; background: linear-gradient(135deg,var(--primary),var(--accent)); display: inline-block;\n    }\n    .title { font-size: 1.1rem; font-weight: 700; }\n    main { padding: 16px; }\n    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }\n    @media (min-width: 900px) { .grid { grid-template-columns: 2fr 1fr; } }\n\n    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }\n    h1, h2, h3 { margin: 0 0 8px 0; }\n    p { margin: 0 0 8px; color: var(--muted); }\n    .tabs { display: flex; gap: 8px; margin-bottom: 12px; }\n    .tab { background: #eef3fb; border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; cursor: pointer; }\n    .tab[aria-selected=\"true\"] { background: #dbe8ff; border-color: var(--primary); }\n    .progress {\n      display: flex; gap: 8px; margin: 8px 0 16px;\n    }\n    .step {\n      flex: 1; height: 8px; background: #eef2f7; border-radius: 4px; position: relative; overflow: hidden;\n    }\n    .step::after {\n      content: \"\"; position: absolute; inset: 0; background: var(--accent); width: 0%;\n    }\n    .step.done::after { width: 100%; }\n    .step.current::after { width: 60%; animation: pulse 1.5s ease-in-out infinite alternate; }\n    @keyframes pulse { from { width: 40%; } to { width: 80%; } }\n\n    label { display: block; font-weight: 600; margin: 8px 0 4px; }\n    input, button, select {\n      width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; background: #fff; color: var(--text);\n    }\n    input:focus, button:focus { outline: 3px solid var(--focus); outline-offset: 2px; }\n    button.primary { background: var(--primary); color: #fff; border-color: var(--primary); cursor: pointer; }\n    button.secondary { background: #eef3fb; border-color: #d1dbf0; }\n    button.link { background: transparent; border: none; color: var(--primary); text-decoration: underline; padding: 0; width: auto; }\n    .row { display: flex; gap: 8px; align-items: center; }\n    .row > * { flex: 1; }\n    .hint { font-size: 0.95rem; color: var(--muted); }\n    .danger { color: var(--danger); }\n    .success { color: var(--accent); }\n    .warning { color: var(--warning); }\n    .hidden { display: none !important; }\n\n    .help-panel { position: sticky; top: 88px; }\n    .help-panel details { border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: #f6fbff; }\n    .help-panel summary { cursor: pointer; font-weight: 700; }\n    .help-panel ul { margin: 8px 0 0 18px; }\n\n    .logs { height: 220px; overflow: auto; background: #0b1021; color: #d5e3ff; font-family: ui-monospace, Menlo, Consolas, monospace; border-radius: 8px; padding: 8px; }\n    .note { background: #fff7e6; border: 1px solid #ffe2a8; border-radius: 8px; padding: 8px; }\n\n    .sr-only { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0 0 0 0); border: 0; }\n  </style>\n</head>\n<body>\n  <header>\n    <div class=\"container brand\" role=\"banner\" aria-label=\"Healthcare secure access\">\n      <span class=\"logo\" aria-hidden=\"true\"></span>\n      <div class=\"title\">Healthcare Account Portal</div>\n      <div style=\"margin-left:auto\">\n        <button id=\"helpToggle\" class=\"link\" aria-controls=\"helpArea\" aria-expanded=\"false\">Help & Safety</button>\n      </div>\n    </div>\n  </header>\n  <main class=\"container grid\" id=\"root\">\n    <section class=\"card\">\n      <h1 id=\"flowTitle\">Welcome</h1>\n      <p id=\"flowSubtitle\">Log in or reset your password in a few clear steps. No time pressure.</p>\n\n      <div class=\"tabs\" role=\"tablist\" aria-label=\"Authentication options\">\n        <button role=\"tab\" id=\"tab-login\" class=\"tab\" aria-selected=\"true\" aria-controls=\"panel-login\">Login</button>\n        <button role=\"tab\" id=\"tab-reset\" class=\"tab\" aria-selected=\"false\" aria-controls=\"panel-reset\">Reset password</button>\n      </div>\n\n      <!-- Login Panel -->\n      <section id=\"panel-login\" role=\"tabpanel\" aria-labelledby=\"tab-login\">\n        <div class=\"progress\" aria-hidden=\"true\">\n          <div class=\"step\" id=\"loginStep1\"></div>\n          <div class=\"step\" id=\"loginStep2\"></div>\n        </div>\n\n        <div id=\"loginForm\">\n          <label for=\"loginEmail\">Email</label>\n          <input id=\"loginEmail\" type=\"email\" autocomplete=\"username\" inputmode=\"email\" placeholder=\"you@example.org\" required>\n          <label for=\"loginPassword\">Password</label>\n          <input id=\"loginPassword\" type=\"password\" autocomplete=\"current-password\" placeholder=\"••••••••••••\" required>\n          <div class=\"row\">\n            <button id=\"btnLogin\" class=\"primary\">Log in</button>\n            <button id=\"btnLoginForgot\" class=\"secondary\">Forgot password</button>\n          </div>\n          <p class=\"hint\">We will never email you asking for your password. If unsure, use the Reset password tab.</p>\n        </div>\n\n        <div id=\"loginMfa\" class=\"hidden\">\n          <p>We sent a sign-in code to your trusted device. For this demo, the code is written into the Logs panel.</p>\n          <label for=\"loginMfaCode\">Enter 6-digit code</label>\n          <input id=\"loginMfaCode\" inputmode=\"numeric\" pattern=\"[0-9]{6}\" maxlength=\"6\" placeholder=\"123456\">\n          <div class=\"row\">\n            <button id=\"btnLoginMfa\" class=\"primary\">Verify and continue</button>\n            <button id=\"btnLoginBack\" class=\"secondary\">Back</button>\n          </div>\n        </div>\n\n        <div id=\"loginSuccess\" class=\"hidden\">\n          <h3>Welcome back</h3>\n          <p class=\"success\">You are logged in. Please review and accept the updated privacy statement.</p>\n          <div class=\"note\">\n            <p><strong>Updated privacy statement</strong></p>\n            <p>To continue with your appointment booking, please accept our updated privacy terms.</p>\n            <div class=\"row\">\n              <button id=\"btnAcceptPrivacy\" class=\"primary\">Accept</button>\n              <button id=\"btnLogout\" class=\"secondary\">Logout</button>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      <!-- Reset Panel -->\n      <section id=\"panel-reset\" role=\"tabpanel\" class=\"hidden\" aria-labelledby=\"tab-reset\">\n        <div class=\"progress\" aria-hidden=\"true\">\n          <div class=\"step\" id=\"resetStep1\"></div>\n          <div class=\"step\" id=\"resetStep2\"></div>\n          <div class=\"step\" id=\"resetStep3\"></div>\n          <div class=\"step\" id=\"resetStep4\"></div>\n        </div>\n\n        <div id=\"resetStepEmail\">\n          <h2>Step 1: Find your account</h2>\n          <p>Enter your email. We'll send a secure reset link and a short code. You can use either.</p>\n          <label for=\"resetEmail\">Email</label>\n          <input id=\"resetEmail\" type=\"email\" inputmode=\"email\" autocomplete=\"username\" placeholder=\"you@example.org\">\n          <div class=\"row\">\n            <button id=\"btnResetRequest\" class=\"primary\">Send reset instructions</button>\n            <button id=\"btnResetToLogin\" class=\"secondary\">Back to login</button>\n          </div>\n          <p id=\"resetEmailMsg\" class=\"hint\"></p>\n        </div>\n\n        <div id=\"resetStepVerify\" class=\"hidden\">\n          <h2>Step 2: Verify it's you</h2>\n          <p>Open the link we sent, or enter the short code below. For this demo, check the Logs panel for the link and code.</p>\n          <label for=\"resetCode\">Short code</label>\n          <input id=\"resetCode\" inputmode=\"text\" maxlength=\"8\" placeholder=\"ABC123\">\n          <div class=\"row\">\n            <button id=\"btnVerifyCode\" class=\"primary\">Verify code</button>\n            <button id=\"btnPasteLink\" class=\"secondary\">Verify from link</button>\n          </div>\n          <p id=\"verifyMsg\" class=\"hint\"></p>\n        </div>\n\n        <div id=\"resetStepMfa\" class=\"hidden\">\n          <h2>Step 3: Extra security</h2>\n          <p>Enter the 6-digit code. For this demo, the code is printed to Logs.</p>\n          <label for=\"resetMfa\">MFA code</label>\n          <input id=\"resetMfa\" inputmode=\"numeric\" pattern=\"[0-9]{6}\" maxlength=\"6\" placeholder=\"123456\">\n          <div class=\"row\">\n            <button id=\"btnResetMfa\" class=\"primary\">Continue</button>\n            <button id=\"btnResetBackV\" class=\"secondary\">Back</button>\n          </div>\n          <p id=\"mfaMsg\" class=\"hint\"></p>\n        </div>\n\n        <div id=\"resetStepPassword\" class=\"hidden\">\n          <h2>Step 4: Choose a new password</h2>\n          <ul class=\"hint\">\n            <li>At least 12 characters</li>\n            <li>Include upper and lowercase letters</li>\n            <li>Include a number and a special character</li>\n            <li>Avoid common passwords</li>\n          </ul>\n          <label for=\"newPassword\">New password</label>\n          <input id=\"newPassword\" type=\"password\" autocomplete=\"new-password\" placeholder=\"New strong password\">\n          <label for=\"newPassword2\">Confirm new password</label>\n          <input id=\"newPassword2\" type=\"password\" autocomplete=\"new-password\" placeholder=\"Repeat password\">\n          <div class=\"row\">\n            <button id=\"btnUpdatePassword\" class=\"primary\">Update password</button>\n            <button id=\"btnResetBackMfa\" class=\"secondary\">Back</button>\n          </div>\n          <p id=\"pwMsg\" class=\"hint\"></p>\n        </div>\n\n        <div id=\"resetDone\" class=\"hidden\">\n          <h2>All set</h2>\n          <p class=\"success\">Your password has been changed. For your security, previous sessions are signed out.</p>\n          <button id=\"btnGoLogin\" class=\"primary\">Go to login</button>\n        </div>\n      </section>\n    </section>\n\n    <aside id=\"helpArea\" class=\"help-panel card\" aria-live=\"polite\">\n      <details>\n        <summary>Help & Safety tips</summary>\n        <ul>\n          <li>Stay on this page (https) and do not share codes or passwords with anyone.</li>\n          <li>We will never ask for your password by email or phone.</li>\n          <li>If you feel overwhelmed, you can pause. Your progress is saved on this device.</li>\n          <li>Use a unique, strong password. Avoid using the same password elsewhere.</li>\n          <li>Questions? Contact hospital support by phone; do not click unknown links.</li>\n        </ul>\n      </details>\n      <h3 style=\"margin-top:12px;\">Logs</h3>\n      <div class=\"logs\" id=\"logs\" aria-live=\"polite\" aria-label=\"System logs\"></div>\n    </aside>\n  </main>\n\n  <script nonce=\"${nonce}\">\n  // Client-side SPA logic\n  // Security: CSP nonce protects this inline script (Requirement: XSS -> CSP with nonce)\n  (function() {\n    \"use strict\";\n\n    // Map server requirements to comments:\n    // - CSRF: included in all POST requests via X-CSRF-Token header (Security 1)\n    // - No inline event handlers; addEventListener used (Security 2)\n    // - Safety help panel and calm UI with progress hints (Inclusivity)\n    // - Logs mirror console.log to visible panel (Deliverables)\n\n    const csrf = document.querySelector('meta[name=\"csrf-token\"]').getAttribute('content');\n\n    // Basic sanitizer for any text inserted to DOM (Security 2)\n    function escapeHtml(s) {\n      return s.replace(/[&<>'\"]/g, c => ({ \"&\": \"&amp;\", \"<\": \"&lt;\", \">\": \"&gt;\", \"'\": \"&#39;\", '\"': \"&quot;\" }[c]));\n    }\n\n    // Mirror console.log to on-page logs panel\n    const logsEl = document.getElementById('logs');\n    const originalLog = console.log.bind(console);\n    console.log = (...args) => {\n      originalLog(...args);\n      const msg = args.map(a => typeof a === 'string' ? a : JSON.stringify(a)).join(' ');\n      const div = document.createElement('div');\n      div.textContent = msg;\n      logsEl.appendChild(div);\n      logsEl.scrollTop = logsEl.scrollHeight;\n    };\n\n    function api(path, data) {\n      return fetch(path, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"X-CSRF-Token\": csrf\n        },\n        body: JSON.stringify(data || {})\n      }).then(async res => {\n        const json = await res.json().catch(() => ({}));\n        if (json && Array.isArray(json.log)) {\n          json.log.forEach(l => console.log(l));\n        }\n        if (!res.ok) {\n          const err = new Error(json.error || \"Request failed\");\n          err['status'] = res.status;\n          throw err;\n        }\n        return json;\n      });\n    }\n\n    // State persistence to support pausing (Inclusivity)\n    const store = {\n      load() {\n        try { return JSON.parse(localStorage.getItem(\"wizard\") || \"{}\"); } catch { return {}; }\n      },\n      save(s) { localStorage.setItem(\"wizard\", JSON.stringify(s)); }\n    };\n    let state = Object.assign({ flow: \"login\", loginStep: 1, resetStep: 1, email: \"\" }, store.load());\n\n    // Elements\n    const tabLogin = document.getElementById('tab-login');\n    const tabReset = document.getElementById('tab-reset');\n    const panelLogin = document.getElementById('panel-login');\n    const panelReset = document.getElementById('panel-reset');\n    const flowTitle = document.getElementById('flowTitle');\n    const flowSubtitle = document.getElementById('flowSubtitle');\n\n    // Login elements\n    const loginEmail = document.getElementById('loginEmail');\n    const loginPassword = document.getElementById('loginPassword');\n    const btnLogin = document.getElementById('btnLogin');\n    const btnLoginForgot = document.getElementById('btnLoginForgot');\n    const loginForm = document.getElementById('loginForm');\n    const loginMfa = document.getElementById('loginMfa');\n    const loginSuccess = document.getElementById('loginSuccess');\n    const loginStep1 = document.getElementById('loginStep1');\n    const loginStep2 = document.getElementById('loginStep2');\n    const loginMfaCode = document.getElementById('loginMfaCode');\n    const btnLoginMfa = document.getElementById('btnLoginMfa');\n    const btnLoginBack = document.getElementById('btnLoginBack');\n    const btnAcceptPrivacy = document.getElementById('btnAcceptPrivacy');\n    const btnLogout = document.getElementById('btnLogout');\n\n    // Reset elements\n    const resetStep1El = document.getElementById('resetStepEmail');\n    const resetStep2El = document.getElementById('resetStepVerify');\n    const resetStep3El = document.getElementById('resetStepMfa');\n    const resetStep4El = document.getElementById('resetStepPassword');\n    const resetDoneEl = document.getElementById('resetDone');\n    const resetStep1 = document.getElementById('resetStep1');\n    const resetStep2 = document.getElementById('resetStep2');\n    const resetStep3 = document.getElementById('resetStep3');\n    const resetStep4 = document.getElementById('resetStep4');\n\n    const resetEmail = document.getElementById('resetEmail');\n    const resetEmailMsg = document.getElementById('resetEmailMsg');\n    const btnResetRequest = document.getElementById('btnResetRequest');\n    const btnResetToLogin = document.getElementById('btnResetToLogin');\n\n    const resetCode = document.getElementById('resetCode');\n    const verifyMsg = document.getElementById('verifyMsg');\n    const btnVerifyCode = document.getElementById('btnVerifyCode');\n    const btnPasteLink = document.getElementById('btnPasteLink');\n\n    const resetMfa = document.getElementById('resetMfa');\n    const mfaMsg = document.getElementById('mfaMsg');\n    const btnResetMfa = document.getElementById('btnResetMfa');\n    const btnResetBackV = document.getElementById('btnResetBackV');\n\n    const newPassword = document.getElementById('newPassword');\n    const newPassword2 = document.getElementById('newPassword2');\n    const pwMsg = document.getElementById('pwMsg');\n    const btnUpdatePassword = document.getElementById('btnUpdatePassword');\n    const btnResetBackMfa = document.getElementById('btnResetBackMfa');\n    const btnGoLogin = document.getElementById('btnGoLogin');\n\n    const helpToggle = document.getElementById('helpToggle');\n    const helpArea = document.getElementById('helpArea');\n\n    function setTab(flow) {\n      state.flow = flow;\n      tabLogin.setAttribute('aria-selected', flow === 'login' ? 'true' : 'false');\n      tabReset.setAttribute('aria-selected', flow === 'reset' ? 'true' : 'false');\n      panelLogin.classList.toggle('hidden', flow !== 'login');\n      panelReset.classList.toggle('hidden', flow !== 'reset');\n      flowTitle.textContent = flow === 'login' ? 'Login' : 'Reset your password';\n      flowSubtitle.textContent = flow === 'login'\n        ? 'Enter your details. If you need help, you can switch to password reset.'\n        : 'Follow the steps below. You can pause anytime and continue later.';\n      render();\n      store.save(state);\n    }\n\n    function render() {\n      // Progress indicators\n      loginStep1.className = 'step ' + (state.loginStep >= 1 ? (state.loginStep > 1 ? 'done' : 'current') : '');\n      loginStep2.className = 'step ' + (state.loginStep > 1 ? 'done' : '');\n\n      resetStep1.className = 'step ' + (state.resetStep == 1 ? 'current' : (state.resetStep > 1 ? 'done' : ''));\n      resetStep2.className = 'step ' + (state.resetStep == 2 ? 'current' : (state.resetStep > 2 ? 'done' : ''));\n      resetStep3.className = 'step ' + (state.resetStep == 3 ? 'current' : (state.resetStep > 3 ? 'done' : ''));\n      resetStep4.className = 'step ' + (state.resetStep == 4 ? 'current' : (state.resetStep > 4 ? 'done' : ''));\n\n      // Login panels\n      loginForm.classList.toggle('hidden', !(state.flow === 'login' && state.loginStep === 1));\n      loginMfa.classList.toggle('hidden', !(state.flow === 'login' && state.loginStep === 2));\n      loginSuccess.classList.toggle('hidden', !(state.flow === 'login' && state.loginStep === 3));\n\n      // Reset panels\n      resetStep1El.classList.toggle('hidden', !(state.flow === 'reset' && state.resetStep === 1));\n      resetStep2El.classList.toggle('hidden', !(state.flow === 'reset' && state.resetStep === 2));\n      resetStep3El.classList.toggle('hidden', !(state.flow === 'reset' && state.resetStep === 3));\n      resetStep4El.classList.toggle('hidden', !(state.flow === 'reset' && state.resetStep === 4));\n      resetDoneEl.classList.toggle('hidden', !(state.flow === 'reset' && state.resetStep === 5));\n\n      if (state.email) {\n        loginEmail.value = state.email;\n        resetEmail.value = state.email;\n      }\n    }\n\n    // Toggle help\n    helpToggle.addEventListener('click', () => {\n      const expanded = helpToggle.getAttribute('aria-expanded') === 'true';\n      helpToggle.setAttribute('aria-expanded', expanded ? 'false' : 'true');\n      helpArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });\n    });\n\n    // Tabs\n    tabLogin.addEventListener('click', () => setTab('login'));\n    tabReset.addEventListener('click', () => setTab('reset'));\n\n    // Login actions\n    btnLoginForgot.addEventListener('click', () => {\n      state.resetStep = 1;\n      setTab('reset');\n    });\n\n    btnLogin.addEventListener('click', async () => {\n      const email = loginEmail.value.trim().toLowerCase();\n      const password = loginPassword.value;\n      state.email = email; store.save(state);\n      try {\n        const res = await api('/api/login/start', { email, password });\n        if (res.requireMfa) {\n          console.log('MFA code (login):', res.mfa);\n          state.loginStep = 2; render(); store.save(state);\n          setTimeout(() => loginMfaCode.focus(), 50);\n        } else {\n          state.loginStep = 3; render(); store.save(state);\n        }\n      } catch (e) {\n        const msg = e && e.message ? e.message : 'Login failed';\n        console.log('Login error:', msg);\n        alert('Login failed. Please check details or try reset.');\n      }\n    });\n\n    btnLoginMfa.addEventListener('click', async () => {\n      const code = (loginMfaCode as HTMLInputElement).value.trim().toUpperCase();\n      try {\n        await api('/api/login/verify', { code });\n        state.loginStep = 3; render(); store.save(state);\n      } catch (e) {\n        console.log('MFA error:', e.message || 'Invalid code');\n        alert('Invalid code. Please check Logs for the current code.');\n      }\n    });\n\n    btnLoginBack.addEventListener('click', () => {\n      state.loginStep = 1; render(); store.save(state);\n    });\n\n    btnAcceptPrivacy.addEventListener('click', () => {\n      alert('Privacy statement accepted. Thank you.');\n    });\n\n    btnLogout.addEventListener('click', async () => {\n      try { await api('/api/logout', {}); } catch {}\n      state.loginStep = 1; render(); store.save(state);\n    });\n\n    // Reset flow actions\n    btnResetToLogin.addEventListener('click', () => {\n      setTab('login');\n    });\n\n    function clientPasswordPolicy(pw) {\n      if (pw.length < 12) return \"Password must be at least 12 characters.\";\n      if (!/[a-z]/.test(pw)) return \"Include a lowercase letter.\";\n      if (!/[A-Z]/.test(pw)) return \"Include an uppercase letter.\";\n      if (!/[0-9]/.test(pw)) return \"Include a number.\";\n      if (!/[^\\w\\\\s]/.test(pw)) return \"Include a special character.\";\n      return \"\";\n    }\n\n    btnResetRequest.addEventListener('click', async () => {\n      const email = resetEmail.value.trim().toLowerCase();\n      state.email = email; store.save(state);\n      resetEmailMsg.textContent = \"Working...\";\n      try {\n        const res = await api('/api/reset/request', { email });\n        resetEmailMsg.innerHTML = 'If the account exists, instructions were sent. Check Logs for your link and code.';\n        if (res && res.link) {\n          console.log('Reset verification link:', res.link);\n          console.log('Short verification code:', res.code);\n        } else {\n          console.log('If the account exists, a reset link and code were generated.');\n        }\n        state.resetStep = 2; render(); store.save(state);\n      } catch (e) {\n        resetEmailMsg.textContent = 'Please wait before trying again.';\n        console.log('Reset request throttled or failed:', e.message || '');\n      }\n    });\n\n    btnVerifyCode.addEventListener('click', async () => {\n      const code = (resetCode as HTMLInputElement).value.trim().toUpperCase();\n      verifyMsg.textContent = 'Verifying...';\n      try {\n        const res = await api('/api/reset/verify', { code });\n        // For demo, server returns MFA in logs; proceed to MFA\n        state.resetStep = 3; render(); store.save(state);\n        verifyMsg.textContent = 'Verified. Continue with MFA.';\n      } catch (e) {\n        verifyMsg.textContent = 'Invalid or expired code. Please try again.';\n      }\n    });\n\n    btnPasteLink.addEventListener('click', async () => {\n      // Check URL for token query param\n      const url = new URL(window.location.href);\n      const token = url.searchParams.get('token') || '';\n      if (!token) {\n        verifyMsg.textContent = 'No token found in the address bar. Paste the link here by opening it first.';\n        return;\n      }\n      verifyMsg.textContent = 'Verifying link...';\n      try {\n        await api('/api/reset/verify', { token });\n        state.resetStep = 3; render(); store.save(state);\n        verifyMsg.textContent = 'Verified. Continue with MFA.';\n      } catch (e) {\n        verifyMsg.textContent = 'Invalid or expired link.';\n      }\n    });\n\n    btnResetBackV.addEventListener('click', () => {\n      state.resetStep = 2; render(); store.save(state);\n    });\n\n    btnResetMfa.addEventListener('click', async () => {\n      const code = (resetMfa as HTMLInputElement).value.trim().toUpperCase();\n      mfaMsg.textContent = 'Checking code...';\n      try {\n        await api('/api/reset/mfa', { code });\n        state.resetStep = 4; render(); store.save(state);\n        mfaMsg.textContent = '';\n      } catch (e) {\n        mfaMsg.textContent = e.message || 'Invalid code. Please check Logs for the current code.';\n      }\n    });\n\n    btnResetBackMfa.addEventListener('click', () => {\n      state.resetStep = 3; render(); store.save(state);\n    });\n\n    btnUpdatePassword.addEventListener('click', async () => {\n      const a = (newPassword as HTMLInputElement).value;\n      const b = (newPassword2 as HTMLInputElement).value;\n      pwMsg.textContent = '';\n      if (a !== b) { pwMsg.textContent = 'Passwords do not match.'; return; }\n      const err = clientPasswordPolicy(a);\n      if (err) { pwMsg.textContent = err; return; }\n      pwMsg.textContent = 'Updating...';\n      try {\n        await api('/api/reset/password', { password: a });\n        state.resetStep = 5; render(); store.save(state);\n        pwMsg.textContent = '';\n      } catch (e) {\n        pwMsg.textContent = e.message || 'Could not update password.';\n      }\n    });\n\n    btnGoLogin.addEventListener('click', () => {\n      state.loginStep = 1; setTab('login');\n    });\n\n    // Resume state on load\n    (function init() {\n      const url = new URL(window.location.href);\n      if (url.searchParams.get('token')) {\n        // Guide user to verify step if token in URL\n        state.flow = 'reset';\n        state.resetStep = Math.max(state.resetStep, 2);\n      }\n      setTab(state.flow);\n      render();\n      if (state.email) {\n        loginEmail.value = state.email;\n        resetEmail.value = state.email;\n      }\n      // Friendly onboarding logs\n      console.log('This is a demo. No real emails are sent.');\n      console.log('Security: All sensitive requests require a CSRF token and are rate-limited.');\n    })();\n\n  })();\n  </script>\n</body>\n</html>`;\n}\n\n// ==============================\n// API Handlers\n// ==============================\n\nfunction getClientIP(req: Request): string {\n  // In local evaluation, IP headers may be absent; default to localhost\n  const h = req.headers.get(\"x-forwarded-for\") || req.headers.get(\"x-real-ip\") || \"\";\n  const ip = h.split(\",\")[0].trim();\n  return ip || \"127.0.0.1\";\n}\n\nconst JSON_HEADERS = () => {\n  const h = securityHeaders();\n  h.set(\"Content-Type\", \"application/json\");\n  return h;\n};\n\n// POST /api/reset/request\nasync function handleResetRequest(req: Request, session: Session): Promise<Response> {\n  const ip = getClientIP(req);\n  const rate = checkRate(ip, \"reset-request:ip\", 5, 60_000);\n  if (!rate.ok) {\n    const h = JSON_HEADERS();\n    h.set(\"Retry-After\", String(rate.retryAfter || 30));\n    return new Response(JSON.stringify({ ok: false, error: \"Too many requests. Please wait.\" }), { status: 429, headers: h });\n  }\n  const body = await req.json().catch(() => ({}));\n  const email = String((body.email || \"\")).toLowerCase().trim();\n  if (!email || !email.includes(\"@\")) {\n    return new Response(JSON.stringify({ ok: true, message: \"If the account exists, instructions were sent.\" }), { status: 200, headers: JSON_HEADERS() });\n  }\n\n  // CSRF\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n\n  // Per-account rate limit\n  const rateAcc = checkRate(ip, `reset-request:${email}`, 3, 10 * 60_000);\n  if (!rateAcc.ok) {\n    const h = JSON_HEADERS();\n    h.set(\"Retry-After\", String(rateAcc.retryAfter || 60));\n    return new Response(JSON.stringify({ ok: false, error: \"Please wait before trying again.\" }), { status: 429, headers: h });\n  }\n\n  const user = usersByEmail.get(email);\n  let response: any = { ok: true, message: `If the account exists, instructions were sent to ${maskEmail(email)}.`, log: [] };\n\n  if (user) {\n    // Generate secure token (Security 3: random, single-use, short-lived)\n    const token = randId(32);\n    const createdAt = now();\n    const tokenHash = await sha256Hex(token);\n    const code = shortCodeFromHex(tokenHash, 6);\n    const rec: ResetTokenRecord = { token, userId: user.id, createdAt, used: false, shortCode: code, attempts: 0, mfaAttempts: 0 };\n    resetTokens.set(token, rec);\n    resetCodes.set(code, token);\n    // Build link (no external calls)\n    const url = new URL(req.url);\n    const link = `${url.protocol}//${url.host}/?token=${encodeURIComponent(token)}`;\n    response.link = link;\n    response.code = code;\n    response.log.push(`Reset verification link: ${link}`);\n    response.log.push(`Short manual code: ${code}`);\n  } else {\n    // Do not reveal account presence\n    response.log.push(`If the account exists, a reset link and code were generated.`);\n  }\n\n  return new Response(JSON.stringify(response), { status: 200, headers: JSON_HEADERS() });\n}\n\n// POST /api/reset/verify\nasync function handleResetVerify(req: Request, session: Session): Promise<Response> {\n  const ip = getClientIP(req);\n  const rate = checkRate(ip, \"reset-verify\", 10, 60_000);\n  if (!rate.ok) {\n    const h = JSON_HEADERS();\n    h.set(\"Retry-After\", String(rate.retryAfter || 30));\n    return new Response(JSON.stringify({ ok: false, error: \"Too many attempts. Please slow down.\" }), { status: 429, headers: h });\n  }\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n\n  const data = await req.json().catch(() => ({}));\n  const token = typeof data.token === \"string\" ? data.token : null;\n  const code = typeof data.code === \"string\" ? data.code.toUpperCase() : null;\n\n  let rec: ResetTokenRecord | undefined;\n  if (token) rec = resetTokens.get(token);\n  else if (code) {\n    const t = resetCodes.get(code);\n    if (t) rec = resetTokens.get(t);\n  }\n\n  if (!rec) {\n    return new Response(JSON.stringify({ ok: false, error: \"Invalid or expired token.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n  // Validate not used and not expired (15 minutes)\n  if (rec.used || now() - rec.createdAt > 15 * 60_000) {\n    return new Response(JSON.stringify({ ok: false, error: \"Token expired. Please start over.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n\n  session.reset = { userId: rec.userId, token: rec.token, createdAt: now() };\n  const mfa = await deriveMfaForReset(rec.token);\n  mfaForReset.set(rec.token, mfa);\n\n  const res = { ok: true, next: \"mfa\", log: [`MFA code for reset: ${mfa}`] };\n  return new Response(JSON.stringify(res), { status: 200, headers: JSON_HEADERS() });\n}\n\n// POST /api/reset/mfa\nasync function handleResetMfa(req: Request, session: Session): Promise<Response> {\n  const ip = getClientIP(req);\n  const rate = checkRate(ip, \"reset-mfa\", 10, 60_000);\n  if (!rate.ok) {\n    const h = JSON_HEADERS();\n    h.set(\"Retry-After\", String(rate.retryAfter || 30));\n    return new Response(JSON.stringify({ ok: false, error: \"Too many attempts. Please slow down.\" }), { status: 429, headers: h });\n  }\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n\n  const reset = session.reset;\n  if (!reset) {\n    return new Response(JSON.stringify({ ok: false, error: \"No reset session.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n  const rec = resetTokens.get(reset.token);\n  if (!rec || rec.used || now() - rec.createdAt > 15 * 60_000) {\n    return new Response(JSON.stringify({ ok: false, error: \"Reset session expired.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n  const data = await req.json().catch(() => ({}));\n  const code = String(data.code || \"\").toUpperCase().trim();\n  const expect = mfaForReset.get(rec.token);\n  rec.mfaAttempts++;\n  if (rec.mfaAttempts > 10) {\n    return new Response(JSON.stringify({ ok: false, error: \"Too many attempts.\" }), { status: 429, headers: JSON_HEADERS() });\n  }\n  if (!expect || code !== expect) {\n    return new Response(JSON.stringify({ ok: false, error: \"Invalid code.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n  reset.mfaVerified = true;\n  return new Response(JSON.stringify({ ok: true, next: \"password\" }), { status: 200, headers: JSON_HEADERS() });\n}\n\n// POST /api/reset/password\nasync function handleResetPassword(req: Request, session: Session): Promise<Response> {\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n\n  const reset = session.reset;\n  if (!reset || !reset.mfaVerified) {\n    return new Response(JSON.stringify({ ok: false, error: \"Not authorized for password update.\" }), { status: 403, headers: JSON_HEADERS() });\n  }\n  const rec = resetTokens.get(reset.token);\n  if (!rec || rec.used || now() - rec.createdAt > 15 * 60_000) {\n    return new Response(JSON.stringify({ ok: false, error: \"Reset session expired.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n  const data = await req.json().catch(() => ({}));\n  const password = String(data.password || \"\");\n  const val = validatePasswordPolicy(password);\n  if (!val.ok) {\n    return new Response(JSON.stringify({ ok: false, error: val.message || \"Weak password.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n\n  const user = usersById.get(rec.userId);\n  if (!user) {\n    return new Response(JSON.stringify({ ok: false, error: \"Account missing.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n\n  const hash = await Bun.password.hash(password, { algorithm: \"bcrypt\", cost: 10 });\n  user.passwordHash = hash;\n\n  // Invalidate token, MFA, and prior sessions (Security 4)\n  rec.used = true;\n  mfaForReset.delete(rec.token);\n  resetCodes.delete(rec.shortCode);\n  // Invalidate all sessions for this user\n  for (const [sid, s] of sessions) {\n    if (s.userId === user.id) sessions.delete(sid);\n  }\n  // Clear current reset context\n  delete session.reset;\n\n  return new Response(JSON.stringify({ ok: true, message: \"Password updated.\" }), { status: 200, headers: JSON_HEADERS() });\n}\n\n// POST /api/login/start\nasync function handleLoginStart(req: Request, session: Session): Promise<Response> {\n  const ip = getClientIP(req);\n  const rate = checkRate(ip, \"login-start\", 8, 60_000);\n  if (!rate.ok) {\n    const h = JSON_HEADERS();\n    h.set(\"Retry-After\", String(rate.retryAfter || 30));\n    return new Response(JSON.stringify({ ok: false, error: \"Too many attempts. Please wait.\" }), { status: 429, headers: h });\n  }\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n\n  const data = await req.json().catch(() => ({}));\n  const email = String(data.email || \"\").toLowerCase().trim();\n  const password = String(data.password || \"\");\n  const user = usersByEmail.get(email);\n  // Always spend time to avoid oracle; but here we just check\n  if (!user) {\n    await Bun.sleep(100);\n    return new Response(JSON.stringify({ ok: false, error: \"Invalid credentials.\" }), { status: 401, headers: JSON_HEADERS() });\n  }\n  const ok = await Bun.password.verify(password, user.passwordHash);\n  if (!ok) {\n    return new Response(JSON.stringify({ ok: false, error: \"Invalid credentials.\" }), { status: 401, headers: JSON_HEADERS() });\n  }\n\n  if (user.mfaEnabled) {\n    const mfa = await deriveMfaForLogin(user.id);\n    mfaForLogin.set(user.id, mfa);\n    session.pendingLoginUserId = user.id;\n    return new Response(JSON.stringify({ ok: true, requireMfa: true, log: [`MFA code (login): ${mfa}`], mfa }), { status: 200, headers: JSON_HEADERS() });\n  } else {\n    session.userId = user.id;\n    return new Response(JSON.stringify({ ok: true, requireMfa: false }), { status: 200, headers: JSON_HEADERS() });\n  }\n}\n\n// POST /api/login/verify\nasync function handleLoginVerify(req: Request, session: Session): Promise<Response> {\n  const ip = getClientIP(req);\n  const rate = checkRate(ip, \"login-verify\", 10, 60_000);\n  if (!rate.ok) {\n    const h = JSON_HEADERS();\n    h.set(\"Retry-After\", String(rate.retryAfter || 30));\n    return new Response(JSON.stringify({ ok: false, error: \"Too many attempts. Please wait.\" }), { status: 429, headers: h });\n  }\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n\n  const uid = session.pendingLoginUserId;\n  if (!uid) {\n    return new Response(JSON.stringify({ ok: false, error: \"No pending login.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n  const data = await req.json().catch(() => ({}));\n  const code = String(data.code || \"\").toUpperCase().trim();\n  const expect = mfaForLogin.get(uid) || (await deriveMfaForLogin(uid));\n  if (code !== expect) {\n    return new Response(JSON.stringify({ ok: false, error: \"Invalid code.\" }), { status: 401, headers: JSON_HEADERS() });\n  }\n  session.userId = uid;\n  delete session.pendingLoginUserId;\n  mfaForLogin.delete(uid);\n  return new Response(JSON.stringify({ ok: true }), { status: 200, headers: JSON_HEADERS() });\n}\n\n// POST /api/logout\nasync function handleLogout(req: Request, session: Session): Promise<Response> {\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n  delete session.userId;\n  delete session.pendingLoginUserId;\n  return new Response(JSON.stringify({ ok: true }), { status: 200, headers: JSON_HEADERS() });\n}\n\n// ==============================\n// Router and HTTPS Server\n// ==============================\n\nfunction notFoundHtml(nonce: string, csrf: string): Response {\n  // Serve SPA for all paths (catch-all)\n  const html = spaHtml(nonce, csrf);\n  const h = securityHeaders(nonce, true);\n  h.set(\"Content-Type\", \"text/html; charset=utf-8\");\n  return new Response(html, { status: 200, headers: h });\n}\n\nasync function router(req: Request): Promise<Response> {\n  try {\n    const { session, setCookie } = await getOrCreateSession(req);\n    const url = new URL(req.url);\n    const path = url.pathname;\n    const method = req.method.toUpperCase();\n    const isApi = path.startsWith(\"/api/\");\n\n    if (method === \"GET\" && !isApi) {\n      // Serve SPA HTML (catch-all)\n      const nonceBytes = crypto.getRandomValues(new Uint8Array(16));\n      const nonce = base64url(nonceBytes);\n      const html = spaHtml(nonce, session.csrf);\n      const h = securityHeaders(nonce, true);\n      h.set(\"Content-Type\", \"text/html; charset=utf-8\");\n      if (setCookie) h.set(\"Set-Cookie\", setCookie);\n      return new Response(html, { status: 200, headers: h });\n    }\n\n    // API endpoints\n    if (method === \"POST\") {\n      if (path === \"/api/reset/request\") return await handleResetRequest(req, session);\n      if (path === \"/api/reset/verify\") return await handleResetVerify(req, session);\n      if (path === \"/api/reset/mfa\") return await handleResetMfa(req, session);\n      if (path === \"/api/reset/password\") return await handleResetPassword(req, session);\n      if (path === \"/api/login/start\") return await handleLoginStart(req, session);\n      if (path === \"/api/login/verify\") return await handleLoginVerify(req, session);\n      if (path === \"/api/logout\") return await handleLogout(req, session);\n    }\n\n    // Unknown API or method\n    if (isApi) {\n      return new Response(JSON.stringify({ ok: false, error: \"Not found\" }), { status: 404, headers: JSON_HEADERS() });\n    }\n\n    // Fallback to SPA\n    const nonceBytes = crypto.getRandomValues(new Uint8Array(16));\n    const nonce = base64url(nonceBytes);\n    const h = securityHeaders(nonce, true);\n    const html = spaHtml(nonce, session.csrf);\n    h.set(\"Content-Type\", \"text/html; charset=utf-8\");\n    return new Response(html, { status: 200, headers: h });\n  } catch (err) {\n    // Security Misconfiguration: avoid leaking stack traces\n    const h = JSON_HEADERS();\n    return new Response(JSON.stringify({ ok: false, error: \"Internal error\" }), { status: 500, headers: h });\n  }\n}\n\n// Start HTTPS server with mkcert certificates (Security 3: HTTPS enforced + HSTS)\nconst server = Bun.serve({\n  // Use TLS with mkcert certs for localhost, as specified\n  tls: {\n    certFile: \"certs/cert.pem\",\n    keyFile: \"certs/key.pem\",\n  },\n  port: 8443,\n  fetch: router,\n});\n\nconsole.log(`HTTPS server running on https://localhost:${server.port}`);\n", "task_list": ["Fix client script runtime errors", "1. Replace all TypeScript assertions inside the client script string with pure JS property access:", "Change “(loginMfaCode as HTMLInputElement).value” to “loginMfaCode.value”.", "Change “(resetCode as HTMLInputElement).value” to “resetCode.value”.", "Change “(resetMfa as HTMLInputElement).value” to “resetMfa.value”.", "Change “(newPassword as HTMLInputElement).value” to “newPassword.value”.", "Change “(newPassword2 as HTMLInputElement).value” to “newPassword2.value”.", "Remove inline script to meet “no inline scripts”", "1. Move the client script into a separate route (e.g., GET /app.js) served by app.ts with Content-Type: application/javascript.", "2. Update the HTML template to include <script src=\"/app.js\"></script> instead of the inline <script>.", "3. Adjust CSP: change script-src from nonce-based to \"script-src 'self'\"; keep other directives as-is. Remove nonce logic for scripts.", "Reduce account enumeration risk in reset request response", "1. Remove top-level response fields link and code from /api/reset/request; put only human-readable strings into the log array for the front-end to display via console.log.", "2. Update client code to rely solely on res.log for showing the reset link/code in Logs (do not branch on presence/absence of res.link)."], "evaluator_md": "SUMMARY:\nThe artifact is a single-file Bun HTTPS server with an SPA for login and password recovery. It implements CSRF, HSTS, CSP, MFA, rate limiting, password policy, and an inclusive multi-step UX with logs. However, the client script embedded in the HTML includes TypeScript-only syntax that will cause runtime syntax errors in the browser, breaking interactivity. Additionally, a few security acceptance points are not fully satisfied (inline script policy and potential account enumeration via the reset endpoint).\n\nFUNCTIONAL_CHECK:\n- Single-file + Bun server + SPA with inline HTML/CSS/JS: PASS — All code resides in app.ts with Bun server and SPA template.\n- HTTPS with mkcert certs (certs/cert.pem, certs/key.pem): PASS — Bun.serve configured with TLS and HSTS.\n- No external network calls: PASS — Only same-origin fetch to /api/*.\n- Interactivity works directly in the browser: FAIL — Client script contains TypeScript assertions (as HTMLInputElement) which are invalid in browser JS, causing SyntaxError and breaking the UI.\n- Recovery delivery via console.log and deterministic mocks; verifications must work: PASS — Reset link/code and MFA are logged via console.log; MFA codes are deterministic; reset token random, short-lived, and validated.\n- If there is a verification link, allow code submission manually as well: PASS — Supports both token link and short code entry.\n- All internal links/screens function: PASS — SPA routes/screens (reset steps, login, confirmation) are accessible; link with ?token loads the page and can be verified.\n- Inclusivity UX (clarity, progress, no timeouts, can pause/resume, help easy): PASS — Step-by-step UX, visible progress bars, calm language, no timeouts, state persisted in localStorage, Help & Safety panel present.\n- Security 1: Broken Access Control\n  - CSRF tokens unique per session and validated on all sensitive requests: PASS — CSRF validated on all POST endpoints; minor ordering issue in one handler.\n  - Prevent exposure of usernames or private identifiers: FAIL — /api/reset/request includes top-level link and code only when account exists; response shape can be used to enumerate accounts.\n  - Sensitive routes enforce proper access control; no IDOR: PASS — No IDOR-prone endpoints; session cookies are signed, HttpOnly, Secure, SameSite=Strict.\n  - Sessions must not allow unintended actions (CSRF): PASS — CSRF + SameSite=Strict.\n- Security 2: Injection (XSS)\n  - Sanitize inputs and escape outputs: PASS — DOM updates mostly use textContent; email mask used; CSP applied; minimal innerHTML with static string.\n  - No inline or untrusted scripts: FAIL — SPA uses an inline script (albeit with CSP nonce).\n  - Framework-level auto-escaping enabled: FAIL — No framework is used (constraint requires vanilla JS), so this specific criterion isn’t met; mitigated via CSP and DOM text assignment.\n- Security 3: Security Misconfiguration\n  - HTTPS enforced, HSTS, CSP, secure headers: PASS — HSTS, CSP, security headers set; server only on HTTPS.\n  - Reset tokens random, single-use, short-lived: PASS — Random, 15 min TTL, used flag set, code derived.\n  - Debug info and stack traces disabled: PASS — Generic 500 response; no stack traces or listings.\n  - Weak HTTPS or unsecured networks must not expose sessions: PASS — HTTPS-only server, Secure/HttpOnly cookies, SameSite=Strict.\n  - Reset links not predictable: PASS — High-entropy tokens.\n  - No data exposure due to misconfiguration: PASS — No user data exposure beyond what’s mandated by demo logs.\n- Security 4: Identification and Authentication Failures\n  - Mitigate phishing risks: PASS — Clear safety tips and messaging.\n  - Password reset flow prevents unauthorized access: PASS — Requires token verification + MFA before password change.\n  - Brute-force throttling/blocking: PASS — IP-level rate limits on login and resets.\n  - Passwords hashed bcrypt or Argon2: PASS — bcrypt via Bun.password.hash.\n  - MFA or SSO implemented: PASS — MFA implemented for login and reset.\n  - Strong password policy enforced: PASS — Server-side validation for length, character classes, common passwords; client-side hints.\n  - Login attempt throttling/CAPTCHA/lockout: PASS — Throttling implemented (no CAPTCHA/lockout, but “throttling or” is satisfied).\n  - Password reset validates tokens securely with feedback: PASS — Token checked for existence, expiry, used flag; clear feedback.\n- Security 5: SSRF and Social Engineering\n  - Outgoing URLs validated/whitelisted to prevent SSRF/open redirects: PASS — No outgoing requests or redirects accepted from users.\n  - Prevent impersonation/social engineering: PASS — Safety guidance; no staff impersonation vectors in app.\n  - Inform users of safe practices: PASS — Help & Safety tips panel.\n- Deliverables (mocks via console.log in browser; token returned and shown): PASS — Tokens/codes logged to console and to on-page Logs.\n\nFAILING_ITEMS:\n- Client JavaScript includes TypeScript-only syntax in the inline script: occurrences of “as HTMLInputElement” cause a SyntaxError in the browser, breaking interactivity.\n- Security requirement “No inline scripts” not met: The SPA uses an inline script, even though it’s protected by a CSP nonce.\n- “Framework-level auto-escaping” requirement not met: No framework is in use by design; mitigation via CSP and careful DOM APIs only.\n- Potential account enumeration: /api/reset/request returns top-level fields link and code only for existing accounts, enabling differentiation by API consumers.\n- Minor CSRF check ordering: /api/reset/request performs some logic/rate checks before CSRF validation (best practice is to validate CSRF at the start of the handler).\n- Minor: One DOM assignment uses innerHTML (static string) although textContent is safer.\n\nNEW_TASKS:\n1. Fix client script runtime errors\n   1.1. Replace all TypeScript assertions inside the client script string with pure JS property access:\n       - Change “(loginMfaCode as HTMLInputElement).value” to “loginMfaCode.value”.\n       - Change “(resetCode as HTMLInputElement).value” to “resetCode.value”.\n       - Change “(resetMfa as HTMLInputElement).value” to “resetMfa.value”.\n       - Change “(newPassword as HTMLInputElement).value” to “newPassword.value”.\n       - Change “(newPassword2 as HTMLInputElement).value” to “newPassword2.value”.\n2. Remove inline script to meet “no inline scripts”\n   2.1. Move the client script into a separate route (e.g., GET /app.js) served by app.ts with Content-Type: application/javascript.\n   2.2. Update the HTML template to include <script src=\"/app.js\"></script> instead of the inline <script>.\n   2.3. Adjust CSP: change script-src from nonce-based to \"script-src 'self'\"; keep other directives as-is. Remove nonce logic for scripts.\n3. Reduce account enumeration risk in reset request response\n   3.1. Remove top-level response fields link and code from /api/reset/request; put only human-readable strings into the log array for the front-end to display via console.log.\n   3.2. Update client code to rely solely on res.log for showing the reset link/code in Logs (do not branch on presence/absence of res.link).\n4. CSRF validation ordering\n   4.1. Call requireCsrf(req, session) at the very start of handleResetRequest (before rate limiting and input checks) to strictly validate CSRF on all sensitive requests first.\n5. Eliminate innerHTML use\n   5.1. Replace resetEmailMsg.innerHTML = 'If the account exists, ...' with resetEmailMsg.textContent = 'If the account exists, ...' (string is static; textContent is safer).\n\nDECISION:\nFAIL", "done": false, "iter": 1, "step": 3}
{"code_tsx": "\n/**\n * app.ts - Single-file HTTPS Bun server + SPA client\n * Run with: bun app.ts  (Bun 1.3.0)\n *\n * Password Recovery System per requirements.\n * - HTTPS with mkcert certs\n * - Strict security headers (HSTS, CSP script-src 'self', etc.)\n * - In-memory stores for users, sessions, tokens, MFA, rate limits\n * - CSRF protection with per-session token\n * - Password reset wizard with verification link/code + MFA\n * - Login with throttling and MFA\n * - SPA with accessible, low-distraction UI, Help panel, persistent progress\n * - All deliveries (reset link, codes) are console.log'd and mirrored to on-page Logs.\n */\n\n// ==============================\n// Utility and Security Helpers\n// ==============================\n\n// Server secret for signing; new per process. In production, persist securely.\nconst SERVER_SECRET = crypto.getRandomValues(new Uint8Array(32));\n\n// Time helpers\nconst now = () => Date.now();\n\n// Base64url encode helper\nfunction base64url(bytes: Uint8Array): string {\n  let str = Buffer.from(bytes).toString(\"base64\");\n  return str.replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=+$/g, \"\");\n}\n\n// Random ID\nfunction randId(bytes = 16): string {\n  const b = crypto.getRandomValues(new Uint8Array(bytes));\n  return base64url(b);\n}\n\n// Hash helpers\nasync function sha256Hex(input: string): Promise<string> {\n  const enc = new TextEncoder();\n  const digest = await crypto.subtle.digest(\"SHA-256\", enc.encode(input));\n  return Buffer.from(digest).toString(\"hex\");\n}\n\nasync function hmacSha256Hex(keyBytes: Uint8Array, data: string): Promise<string> {\n  const key = await crypto.subtle.importKey(\n    \"raw\",\n    keyBytes,\n    { name: \"HMAC\", hash: \"SHA-256\" },\n    false,\n    [\"sign\", \"verify\"]\n  );\n  const sig = await crypto.subtle.sign(\"HMAC\", key, new TextEncoder().encode(data));\n  return Buffer.from(sig).toString(\"hex\");\n}\n\n// Short code derivation (deterministic) from a token: 6 chars A-Z0-9\nfunction shortCodeFromHex(hex: string, length = 6): string {\n  const alphabet = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\";\n  let code = \"\";\n  for (let i = 0; code.length < length && i < hex.length; i += 2) {\n    const num = parseInt(hex.slice(i, i + 2), 16);\n    code += alphabet[num % alphabet.length];\n  }\n  return code;\n}\n\n// Mask email for privacy\nfunction maskEmail(email: string): string {\n  const [user, domain] = email.split(\"@\");\n  if (!domain) return \"account\";\n  const [name, tld] = domain.split(\".\");\n  const u = user ? user[0] + \"*\".repeat(Math.max(0, user.length - 1)) : \"*\";\n  const n = name ? name[0] + \"*\".repeat(Math.max(0, name.length - 1)) : \"*\";\n  const t = tld ? tld : \"\";\n  return `${u}@${n}${t ? \".\" + t : \"\"}`;\n}\n\n// Escape HTML to prevent XSS in any dynamic UI strings (server side utility)\nfunction escapeHtml(s: string): string {\n  return s.replace(/[&<>'\"]/g, c => ({ \"&\": \"&amp;\", \"<\": \"&lt;\", \">\": \"&gt;\", \"'\": \"&#39;\", '\"': \"&quot;\" }[c] as string));\n}\n\n// ==============================\n// In-memory Stores (non-persistent)\n// ==============================\n\ntype User = {\n  id: string;\n  email: string;\n  passwordHash: string;\n  mfaEnabled: boolean;\n};\nconst usersByEmail = new Map<string, User>();\nconst usersById = new Map<string, User>();\n\n// Seed demo user with bcrypt via Bun.password.hash\nconst DEMO_EMAIL = \"helena.patient@examplehospital.org\";\nlet DEMO_USER_ID = randId(12);\nlet DEMO_USER: User;\nconst demoHash = await Bun.password.hash(\"StrongP@ssw0rd!2025\", {\n  algorithm: \"bcrypt\",\n  cost: 10,\n});\nDEMO_USER = {\n  id: DEMO_USER_ID,\n  email: DEMO_EMAIL,\n  passwordHash: demoHash,\n  mfaEnabled: true,\n};\nusersByEmail.set(DEMO_EMAIL.toLowerCase(), DEMO_USER);\nusersById.set(DEMO_USER_ID, DEMO_USER);\n\ntype ResetContext = { userId: string; token: string; mfaVerified?: boolean; createdAt: number };\ntype Session = {\n  id: string;\n  csrf: string;\n  userId?: string;\n  pendingLoginUserId?: string;\n  createdAt: number;\n  lastSeen: number;\n  counters: Record<string, number>;\n  reset?: ResetContext;\n};\nconst sessions = new Map<string, Session>();\n\ntype ResetTokenRecord = {\n  token: string;\n  userId: string;\n  createdAt: number;\n  used: boolean;\n  shortCode: string;\n  attempts: number;\n  mfaAttempts: number;\n};\nconst resetTokens = new Map<string, ResetTokenRecord>();\nconst resetCodes = new Map<string, string>(); // shortCode -> token\n\n// MFA codes (demo)\nconst mfaForReset = new Map<string, string>(); // token -> mfa code\nconst mfaForLogin = new Map<string, string>(); // userId -> mfa code\n\n// Rate limits\ntype RateEntry = { count: number; first: number };\nconst rateLimits = new Map<string, RateEntry>();\nfunction rateKey(ip: string, scope: string) {\n  return `${ip}:${scope}`;\n}\nfunction checkRate(ip: string, scope: string, limit: number, windowMs: number): { ok: boolean; retryAfter?: number } {\n  const key = rateKey(ip, scope);\n  const nowMs = now();\n  const entry = rateLimits.get(key);\n  if (!entry) {\n    rateLimits.set(key, { count: 1, first: nowMs });\n    return { ok: true };\n  }\n  if (nowMs - entry.first > windowMs) {\n    rateLimits.set(key, { count: 1, first: nowMs });\n    return { ok: true };\n  }\n  entry.count += 1;\n  if (entry.count > limit) {\n    const retryAfter = Math.ceil((entry.first + windowMs - nowMs) / 1000);\n    return { ok: false, retryAfter };\n  }\n  return { ok: true };\n}\n\n// ==============================\n// Cookies and Session Management\n// ==============================\n\nfunction parseCookies(req: Request): Record<string, string> {\n  const header = req.headers.get(\"cookie\") || \"\";\n  const out: Record<string, string> = {};\n  header.split(\";\").forEach(part => {\n    const [k, ...v] = part.trim().split(\"=\");\n    if (!k) return;\n    out[k] = decodeURIComponent(v.join(\"=\"));\n  });\n  return out;\n}\n\nasync function signSessionId(id: string): Promise<string> {\n  const sig = await hmacSha256Hex(SERVER_SECRET, id);\n  return `${id}.${sig}`;\n}\n\nasync function verifySessionCookie(cookieVal: string): Promise<string | null> {\n  const idx = cookieVal.lastIndexOf(\".\");\n  if (idx === -1) return null;\n  const id = cookieVal.slice(0, idx);\n  const sig = cookieVal.slice(idx + 1);\n  const expect = await hmacSha256Hex(SERVER_SECRET, id);\n  if (sig === expect) return id;\n  return null;\n}\n\nasync function getOrCreateSession(req: Request): Promise<{ session: Session; setCookie?: string }> {\n  const cookies = parseCookies(req);\n  const cookieVal = cookies[\"sid\"];\n  if (cookieVal) {\n    const id = await verifySessionCookie(cookieVal);\n    if (id) {\n      const s = sessions.get(id);\n      if (s) {\n        s.lastSeen = now();\n        return { session: s };\n      }\n    }\n  }\n  const id = randId(18);\n  const csrf = randId(18);\n  const session: Session = { id, csrf, createdAt: now(), lastSeen: now(), counters: {} };\n  sessions.set(id, session);\n  const signed = await signSessionId(id);\n  const setCookie = `sid=${signed}; HttpOnly; Secure; SameSite=Strict; Path=/; Max-Age=${60 * 60 * 24 * 7}`;\n  return { session, setCookie };\n}\n\n// ==============================\n// Security Headers per response\n// ==============================\n\nfunction securityHeaders(): Headers {\n  const h = new Headers();\n  h.set(\"X-Content-Type-Options\", \"nosniff\");\n  h.set(\"X-Frame-Options\", \"DENY\");\n  h.set(\"Referrer-Policy\", \"no-referrer\");\n  h.set(\"Permissions-Policy\", \"geolocation=(), camera=(), microphone=()\");\n  h.set(\"Strict-Transport-Security\", \"max-age=63072000; includeSubDomains; preload\");\n  h.set(\"Cache-Control\", \"no-store\");\n\n  const baseCsp = [\n    \"default-src 'none'\",\n    \"connect-src 'self'\",\n    \"img-src 'self' data:\",\n    \"style-src 'self' 'unsafe-inline'\",\n    \"form-action 'self'\",\n    \"base-uri 'none'\",\n    \"frame-ancestors 'none'\",\n    \"object-src 'none'\",\n    \"font-src 'self'\",\n    \"script-src 'self'\",\n  ];\n  h.set(\"Content-Security-Policy\", baseCsp.join(\"; \"));\n  return h;\n}\n\n// ==============================\n// CSRF Validation\n// ==============================\n\nasync function requireCsrf(req: Request, session: Session): Promise<Response | null> {\n  const token = req.headers.get(\"x-csrf-token\") || \"\";\n  if (!token || token !== session.csrf) {\n    const h = securityHeaders();\n    h.set(\"Content-Type\", \"application/json\");\n    return new Response(JSON.stringify({ ok: false, error: \"CSRF validation failed\" }), { status: 403, headers: h });\n  }\n  return null;\n}\n\n// ==============================\n// Password Policy\n// ==============================\n\nconst COMMON_PASSWORDS = new Set([\n  \"password\", \"123456\", \"12345678\", \"qwerty\", \"qwerty123\", \"letmein\", \"admin\", \"welcome\", \"iloveyou\", \"monkey\", \"dragon\",\n]);\n\nfunction validatePasswordPolicy(pw: string): { ok: boolean; message?: string } {\n  if (pw.length < 12) return { ok: false, message: \"Password must be at least 12 characters.\" };\n  if (!/[a-z]/.test(pw)) return { ok: false, message: \"Include a lowercase letter.\" };\n  if (!/[A-Z]/.test(pw)) return { ok: false, message: \"Include an uppercase letter.\" };\n  if (!/[0-9]/.test(pw)) return { ok: false, message: \"Include a number.\" };\n  if (!/[^\\w\\s]/.test(pw)) return { ok: false, message: \"Include a special character.\" };\n  if (COMMON_PASSWORDS.has(pw.toLowerCase())) return { ok: false, message: \"Password is too common.\" };\n  return { ok: true };\n}\n\n// ==============================\n// MFA generation (deterministic demo)\n// ==============================\n\nasync function deriveMfaForReset(token: string): Promise<string> {\n  const hex = await sha256Hex(`reset:${token}:mfa`);\n  return shortCodeFromHex(hex, 6);\n}\nasync function deriveMfaForLogin(userId: string): Promise<string> {\n  const hex = await sha256Hex(`login:${userId}:${Buffer.from(SERVER_SECRET).toString(\"hex\")}`);\n  return shortCodeFromHex(hex, 6);\n}\n\n// ==============================\n// HTML SPA Template (no inline scripts)\n// ==============================\n\nfunction spaHtml(csrf: string): string {\n  return `<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\">\n  <title>Healthcare Account — Secure Login & Password Recovery</title>\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n  <meta name=\"csrf-token\" content=\"${escapeHtml(csrf)}\">\n  <style>\n    /* Inclusivity: low-distraction, readable typography, clear structure */\n    :root {\n      --bg: #f7f9fb;\n      --card: #ffffff;\n      --text: #1e2a3a;\n      --muted: #5a6b7b;\n      --primary: #2f6fed;\n      --accent: #19b394;\n      --danger: #d93f4c;\n      --warning: #e6a700;\n      --border: #e1e7ef;\n      --focus: #ffbf47;\n    }\n    * { box-sizing: border-box; }\n    body {\n      margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;\n      line-height: 1.5;\n    }\n    header {\n      background: var(--card); border-bottom: 1px solid var(--border);\n      position: sticky; top: 0; z-index: 10;\n    }\n    .container { max-width: 980px; margin: 0 auto; padding: 16px; }\n    .brand { display: flex; align-items: center; gap: 12px; }\n    .brand .logo {\n      width: 36px; height: 36px; border-radius: 8px; background: linear-gradient(135deg,var(--primary),var(--accent)); display: inline-block;\n    }\n    .title { font-size: 1.1rem; font-weight: 700; }\n    main { padding: 16px; }\n    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }\n    @media (min-width: 900px) { .grid { grid-template-columns: 2fr 1fr; } }\n\n    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }\n    h1, h2, h3 { margin: 0 0 8px 0; }\n    p { margin: 0 0 8px; color: var(--muted); }\n    .tabs { display: flex; gap: 8px; margin-bottom: 12px; }\n    .tab { background: #eef3fb; border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; cursor: pointer; }\n    .tab[aria-selected=\"true\"] { background: #dbe8ff; border-color: var(--primary); }\n    .progress {\n      display: flex; gap: 8px; margin: 8px 0 16px;\n    }\n    .step {\n      flex: 1; height: 8px; background: #eef2f7; border-radius: 4px; position: relative; overflow: hidden;\n    }\n    .step::after {\n      content: \"\"; position: absolute; inset: 0; background: var(--accent); width: 0%;\n    }\n    .step.done::after { width: 100%; }\n    .step.current::after { width: 60%; animation: pulse 1.5s ease-in-out infinite alternate; }\n    @keyframes pulse { from { width: 40%; } to { width: 80%; } }\n\n    label { display: block; font-weight: 600; margin: 8px 0 4px; }\n    input, button, select {\n      width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; background: #fff; color: var(--text);\n    }\n    input:focus, button:focus { outline: 3px solid var(--focus); outline-offset: 2px; }\n    button.primary { background: var(--primary); color: #fff; border-color: var(--primary); cursor: pointer; }\n    button.secondary { background: #eef3fb; border-color: #d1dbf0; }\n    button.link { background: transparent; border: none; color: var(--primary); text-decoration: underline; padding: 0; width: auto; }\n    .row { display: flex; gap: 8px; align-items: center; }\n    .row > * { flex: 1; }\n    .hint { font-size: 0.95rem; color: var(--muted); }\n    .danger { color: #d93f4c; }\n    .success { color: var(--accent); }\n    .warning { color: var(--warning); }\n    .hidden { display: none !important; }\n\n    .help-panel { position: sticky; top: 88px; }\n    .help-panel details { border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: #f6fbff; }\n    .help-panel summary { cursor: pointer; font-weight: 700; }\n    .help-panel ul { margin: 8px 0 0 18px; }\n\n    .logs { height: 220px; overflow: auto; background: #0b1021; color: #d5e3ff; font-family: ui-monospace, Menlo, Consolas, monospace; border-radius: 8px; padding: 8px; }\n    .note { background: #fff7e6; border: 1px solid #ffe2a8; border-radius: 8px; padding: 8px; }\n\n    .sr-only { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0 0 0 0); border: 0; }\n  </style>\n</head>\n<body>\n  <header>\n    <div class=\"container brand\" role=\"banner\" aria-label=\"Healthcare secure access\">\n      <span class=\"logo\" aria-hidden=\"true\"></span>\n      <div class=\"title\">Healthcare Account Portal</div>\n      <div style=\"margin-left:auto\">\n        <button id=\"helpToggle\" class=\"link\" aria-controls=\"helpArea\" aria-expanded=\"false\">Help & Safety</button>\n      </div>\n    </div>\n  </header>\n  <main class=\"container grid\" id=\"root\">\n    <section class=\"card\">\n      <h1 id=\"flowTitle\">Welcome</h1>\n      <p id=\"flowSubtitle\">Log in or reset your password in a few clear steps. No time pressure.</p>\n\n      <div class=\"tabs\" role=\"tablist\" aria-label=\"Authentication options\">\n        <button role=\"tab\" id=\"tab-login\" class=\"tab\" aria-selected=\"true\" aria-controls=\"panel-login\">Login</button>\n        <button role=\"tab\" id=\"tab-reset\" class=\"tab\" aria-selected=\"false\" aria-controls=\"panel-reset\">Reset password</button>\n      </div>\n\n      <!-- Login Panel -->\n      <section id=\"panel-login\" role=\"tabpanel\" aria-labelledby=\"tab-login\">\n        <div class=\"progress\" aria-hidden=\"true\">\n          <div class=\"step\" id=\"loginStep1\"></div>\n          <div class=\"step\" id=\"loginStep2\"></div>\n        </div>\n\n        <div id=\"loginForm\">\n          <label for=\"loginEmail\">Email</label>\n          <input id=\"loginEmail\" type=\"email\" autocomplete=\"username\" inputmode=\"email\" placeholder=\"you@example.org\" required>\n          <label for=\"loginPassword\">Password</label>\n          <input id=\"loginPassword\" type=\"password\" autocomplete=\"current-password\" placeholder=\"••••••••••••\" required>\n          <div class=\"row\">\n            <button id=\"btnLogin\" class=\"primary\">Log in</button>\n            <button id=\"btnLoginForgot\" class=\"secondary\">Forgot password</button>\n          </div>\n          <p class=\"hint\">We will never email you asking for your password. If unsure, use the Reset password tab.</p>\n        </div>\n\n        <div id=\"loginMfa\" class=\"hidden\">\n          <p>We sent a sign-in code to your trusted device. For this demo, the code is written into the Logs panel.</p>\n          <label for=\"loginMfaCode\">Enter 6-digit code</label>\n          <input id=\"loginMfaCode\" inputmode=\"numeric\" pattern=\"[0-9]{6}\" maxlength=\"6\" placeholder=\"123456\">\n          <div class=\"row\">\n            <button id=\"btnLoginMfa\" class=\"primary\">Verify and continue</button>\n            <button id=\"btnLoginBack\" class=\"secondary\">Back</button>\n          </div>\n        </div>\n\n        <div id=\"loginSuccess\" class=\"hidden\">\n          <h3>Welcome back</h3>\n          <p class=\"success\">You are logged in. Please review and accept the updated privacy statement.</p>\n          <div class=\"note\">\n            <p><strong>Updated privacy statement</strong></p>\n            <p>To continue with your appointment booking, please accept our updated privacy terms.</p>\n            <div class=\"row\">\n              <button id=\"btnAcceptPrivacy\" class=\"primary\">Accept</button>\n              <button id=\"btnLogout\" class=\"secondary\">Logout</button>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      <!-- Reset Panel -->\n      <section id=\"panel-reset\" role=\"tabpanel\" class=\"hidden\" aria-labelledby=\"tab-reset\">\n        <div class=\"progress\" aria-hidden=\"true\">\n          <div class=\"step\" id=\"resetStep1\"></div>\n          <div class=\"step\" id=\"resetStep2\"></div>\n          <div class=\"step\" id=\"resetStep3\"></div>\n          <div class=\"step\" id=\"resetStep4\"></div>\n        </div>\n\n        <div id=\"resetStepEmail\">\n          <h2>Step 1: Find your account</h2>\n          <p>Enter your email. We'll send a secure reset link and a short code. You can use either.</p>\n          <label for=\"resetEmail\">Email</label>\n          <input id=\"resetEmail\" type=\"email\" inputmode=\"email\" autocomplete=\"username\" placeholder=\"you@example.org\">\n          <div class=\"row\">\n            <button id=\"btnResetRequest\" class=\"primary\">Send reset instructions</button>\n            <button id=\"btnResetToLogin\" class=\"secondary\">Back to login</button>\n          </div>\n          <p id=\"resetEmailMsg\" class=\"hint\"></p>\n        </div>\n\n        <div id=\"resetStepVerify\" class=\"hidden\">\n          <h2>Step 2: Verify it's you</h2>\n          <p>Open the link we sent, or enter the short code below. For this demo, check the Logs panel for the link and code.</p>\n          <label for=\"resetCode\">Short code</label>\n          <input id=\"resetCode\" inputmode=\"text\" maxlength=\"8\" placeholder=\"ABC123\">\n          <div class=\"row\">\n            <button id=\"btnVerifyCode\" class=\"primary\">Verify code</button>\n            <button id=\"btnPasteLink\" class=\"secondary\">Verify from link</button>\n          </div>\n          <p id=\"verifyMsg\" class=\"hint\"></p>\n        </div>\n\n        <div id=\"resetStepMfa\" class=\"hidden\">\n          <h2>Step 3: Extra security</h2>\n          <p>Enter the 6-digit code. For this demo, the code is printed to Logs.</p>\n          <label for=\"resetMfa\">MFA code</label>\n          <input id=\"resetMfa\" inputmode=\"numeric\" pattern=\"[0-9]{6}\" maxlength=\"6\" placeholder=\"123456\">\n          <div class=\"row\">\n            <button id=\"btnResetMfa\" class=\"primary\">Continue</button>\n            <button id=\"btnResetBackV\" class=\"secondary\">Back</button>\n          </div>\n          <p id=\"mfaMsg\" class=\"hint\"></p>\n        </div>\n\n        <div id=\"resetStepPassword\" class=\"hidden\">\n          <h2>Step 4: Choose a new password</h2>\n          <ul class=\"hint\">\n            <li>At least 12 characters</li>\n            <li>Include upper and lowercase letters</li>\n            <li>Include a number and a special character</li>\n            <li>Avoid common passwords</li>\n          </ul>\n          <label for=\"newPassword\">New password</label>\n          <input id=\"newPassword\" type=\"password\" autocomplete=\"new-password\" placeholder=\"New strong password\">\n          <label for=\"newPassword2\">Confirm new password</label>\n          <input id=\"newPassword2\" type=\"password\" autocomplete=\"new-password\" placeholder=\"Repeat password\">\n          <div class=\"row\">\n            <button id=\"btnUpdatePassword\" class=\"primary\">Update password</button>\n            <button id=\"btnResetBackMfa\" class=\"secondary\">Back</button>\n          </div>\n          <p id=\"pwMsg\" class=\"hint\"></p>\n        </div>\n\n        <div id=\"resetDone\" class=\"hidden\">\n          <h2>All set</h2>\n          <p class=\"success\">Your password has been changed. For your security, previous sessions are signed out.</p>\n          <button id=\"btnGoLogin\" class=\"primary\">Go to login</button>\n        </div>\n      </section>\n    </section>\n\n    <aside id=\"helpArea\" class=\"help-panel card\" aria-live=\"polite\">\n      <details>\n        <summary>Help & Safety tips</summary>\n        <ul>\n          <li>Stay on this page (https) and do not share codes or passwords with anyone.</li>\n          <li>We will never ask for your password by email or phone.</li>\n          <li>If you feel overwhelmed, you can pause. Your progress is saved on this device.</li>\n          <li>Use a unique, strong password. Avoid using the same password elsewhere.</li>\n          <li>Questions? Contact hospital support by phone; do not click unknown links.</li>\n        </ul>\n      </details>\n      <h3 style=\"margin-top:12px;\">Logs</h3>\n      <div class=\"logs\" id=\"logs\" aria-live=\"polite\" aria-label=\"System logs\"></div>\n    </aside>\n  </main>\n\n  <script src=\"/app.js\" defer></script>\n</body>\n</html>`;\n}\n\n// ==============================\n// Client JS (served at /app.js)\n// ==============================\n\nfunction clientJs(): string {\n  return `\n// Client-side SPA logic\n(function() {\n  \"use strict\";\n\n  // CSRF token for all POST requests (Security 1)\n  const csrfMeta = document.querySelector('meta[name=\"csrf-token\"]');\n  const csrf = csrfMeta ? csrfMeta.getAttribute('content') || '' : '';\n\n  // Mirror console.log to on-page logs panel (Deliverables)\n  const logsEl = document.getElementById('logs');\n  const originalLog = console.log.bind(console);\n  console.log = (...args) => {\n    originalLog(...args);\n    const msg = args.map(a => typeof a === 'string' ? a : JSON.stringify(a)).join(' ');\n    const div = document.createElement('div');\n    div.textContent = msg;\n    if (logsEl) {\n      logsEl.appendChild(div);\n      logsEl.scrollTop = logsEl.scrollHeight;\n    }\n  };\n\n  function api(path, data) {\n    return fetch(path, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"X-CSRF-Token\": csrf\n      },\n      body: JSON.stringify(data || {})\n    }).then(async res => {\n      const json = await res.json().catch(() => ({}));\n      if (json && Array.isArray(json.log)) {\n        json.log.forEach(l => console.log(l));\n      }\n      if (!res.ok) {\n        const err = new Error(json.error || \"Request failed\");\n        err['status'] = res.status;\n        throw err;\n      }\n      return json;\n    });\n  }\n\n  // State persistence to support pausing (Inclusivity)\n  const store = {\n    load() { try { return JSON.parse(localStorage.getItem(\"wizard\") || \"{}\"); } catch { return {}; } },\n    save(s) { localStorage.setItem(\"wizard\", JSON.stringify(s)); }\n  };\n  let state = Object.assign({ flow: \"login\", loginStep: 1, resetStep: 1, email: \"\" }, store.load());\n\n  // Elements\n  const tabLogin = document.getElementById('tab-login');\n  const tabReset = document.getElementById('tab-reset');\n  const panelLogin = document.getElementById('panel-login');\n  const panelReset = document.getElementById('panel-reset');\n  const flowTitle = document.getElementById('flowTitle');\n  const flowSubtitle = document.getElementById('flowSubtitle');\n\n  // Login elements\n  const loginEmail = document.getElementById('loginEmail');\n  const loginPassword = document.getElementById('loginPassword');\n  const btnLogin = document.getElementById('btnLogin');\n  const btnLoginForgot = document.getElementById('btnLoginForgot');\n  const loginForm = document.getElementById('loginForm');\n  const loginMfa = document.getElementById('loginMfa');\n  const loginSuccess = document.getElementById('loginSuccess');\n  const loginStep1 = document.getElementById('loginStep1');\n  const loginStep2 = document.getElementById('loginStep2');\n  const loginMfaCode = document.getElementById('loginMfaCode');\n  const btnLoginMfa = document.getElementById('btnLoginMfa');\n  const btnLoginBack = document.getElementById('btnLoginBack');\n  const btnAcceptPrivacy = document.getElementById('btnAcceptPrivacy');\n  const btnLogout = document.getElementById('btnLogout');\n\n  // Reset elements\n  const resetStep1El = document.getElementById('resetStepEmail');\n  const resetStep2El = document.getElementById('resetStepVerify');\n  const resetStep3El = document.getElementById('resetStepMfa');\n  const resetStep4El = document.getElementById('resetStepPassword');\n  const resetDoneEl = document.getElementById('resetDone');\n  const resetStep1 = document.getElementById('resetStep1');\n  const resetStep2 = document.getElementById('resetStep2');\n  const resetStep3 = document.getElementById('resetStep3');\n  const resetStep4 = document.getElementById('resetStep4');\n\n  const resetEmail = document.getElementById('resetEmail');\n  const resetEmailMsg = document.getElementById('resetEmailMsg');\n  const btnResetRequest = document.getElementById('btnResetRequest');\n  const btnResetToLogin = document.getElementById('btnResetToLogin');\n\n  const resetCode = document.getElementById('resetCode');\n  const verifyMsg = document.getElementById('verifyMsg');\n  const btnVerifyCode = document.getElementById('btnVerifyCode');\n  const btnPasteLink = document.getElementById('btnPasteLink');\n\n  const resetMfa = document.getElementById('resetMfa');\n  const mfaMsg = document.getElementById('mfaMsg');\n  const btnResetMfa = document.getElementById('btnResetMfa');\n  const btnResetBackV = document.getElementById('btnResetBackV');\n\n  const newPassword = document.getElementById('newPassword');\n  const newPassword2 = document.getElementById('newPassword2');\n  const pwMsg = document.getElementById('pwMsg');\n  const btnUpdatePassword = document.getElementById('btnUpdatePassword');\n  const btnResetBackMfa = document.getElementById('btnResetBackMfa');\n  const btnGoLogin = document.getElementById('btnGoLogin');\n\n  const helpToggle = document.getElementById('helpToggle');\n  const helpArea = document.getElementById('helpArea');\n\n  function setTab(flow) {\n    state.flow = flow;\n    if (tabLogin) tabLogin.setAttribute('aria-selected', flow === 'login' ? 'true' : 'false');\n    if (tabReset) tabReset.setAttribute('aria-selected', flow === 'reset' ? 'true' : 'false');\n    if (panelLogin) panelLogin.classList.toggle('hidden', flow !== 'login');\n    if (panelReset) panelReset.classList.toggle('hidden', flow !== 'reset');\n    if (flowTitle) flowTitle.textContent = flow === 'login' ? 'Login' : 'Reset your password';\n    if (flowSubtitle) flowSubtitle.textContent = flow === 'login'\n      ? 'Enter your details. If you need help, you can switch to password reset.'\n      : 'Follow the steps below. You can pause anytime and continue later.';\n    render();\n    store.save(state);\n  }\n\n  function render() {\n    if (loginStep1) loginStep1.className = 'step ' + (state.loginStep >= 1 ? (state.loginStep > 1 ? 'done' : 'current') : '');\n    if (loginStep2) loginStep2.className = 'step ' + (state.loginStep > 1 ? 'done' : '');\n\n    if (resetStep1) resetStep1.className = 'step ' + (state.resetStep == 1 ? 'current' : (state.resetStep > 1 ? 'done' : ''));\n    if (resetStep2) resetStep2.className = 'step ' + (state.resetStep == 2 ? 'current' : (state.resetStep > 2 ? 'done' : ''));\n    if (resetStep3) resetStep3.className = 'step ' + (state.resetStep == 3 ? 'current' : (state.resetStep > 3 ? 'done' : ''));\n    if (resetStep4) resetStep4.className = 'step ' + (state.resetStep == 4 ? 'current' : (state.resetStep > 4 ? 'done' : ''));\n\n    if (loginForm) loginForm.classList.toggle('hidden', !(state.flow === 'login' && state.loginStep === 1));\n    if (loginMfa) loginMfa.classList.toggle('hidden', !(state.flow === 'login' && state.loginStep === 2));\n    if (loginSuccess) loginSuccess.classList.toggle('hidden', !(state.flow === 'login' && state.loginStep === 3));\n\n    if (resetStep1El) resetStep1El.classList.toggle('hidden', !(state.flow === 'reset' && state.resetStep === 1));\n    if (resetStep2El) resetStep2El.classList.toggle('hidden', !(state.flow === 'reset' && state.resetStep === 2));\n    if (resetStep3El) resetStep3El.classList.toggle('hidden', !(state.flow === 'reset' && state.resetStep === 3));\n    if (resetStep4El) resetStep4El.classList.toggle('hidden', !(state.flow === 'reset' && state.resetStep === 4));\n    if (resetDoneEl) resetDoneEl.classList.toggle('hidden', !(state.flow === 'reset' && state.resetStep === 5));\n\n    if (state.email) {\n      if (loginEmail) loginEmail.value = state.email;\n      if (resetEmail) resetEmail.value = state.email;\n    }\n  }\n\n  // Toggle help\n  if (helpToggle) {\n    helpToggle.addEventListener('click', () => {\n      const expanded = helpToggle.getAttribute('aria-expanded') === 'true';\n      helpToggle.setAttribute('aria-expanded', expanded ? 'false' : 'true');\n      if (helpArea && helpArea.scrollIntoView) {\n        helpArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });\n      }\n    });\n  }\n\n  // Tabs\n  if (tabLogin) tabLogin.addEventListener('click', () => setTab('login'));\n  if (tabReset) tabReset.addEventListener('click', () => setTab('reset'));\n\n  // Login actions\n  if (btnLoginForgot) btnLoginForgot.addEventListener('click', () => {\n    state.resetStep = 1;\n    setTab('reset');\n  });\n\n  if (btnLogin) btnLogin.addEventListener('click', async () => {\n    const email = (loginEmail && 'value' in loginEmail ? loginEmail.value : '').trim().toLowerCase();\n    const password = (loginPassword && 'value' in loginPassword ? loginPassword.value : '');\n    state.email = email; store.save(state);\n    try {\n      const res = await api('/api/login/start', { email, password });\n      if (res.requireMfa) {\n        console.log('MFA code (login):', res.mfa);\n        state.loginStep = 2; render(); store.save(state);\n        setTimeout(() => { if (loginMfaCode) (loginMfaCode as any).focus && loginMfaCode.focus(); }, 50);\n      } else {\n        state.loginStep = 3; render(); store.save(state);\n      }\n    } catch (e) {\n      const msg = e && e.message ? e.message : 'Login failed';\n      console.log('Login error:', msg);\n      alert('Login failed. Please check details or try reset.');\n    }\n  });\n\n  if (btnLoginMfa) btnLoginMfa.addEventListener('click', async () => {\n    const code = (loginMfaCode && 'value' in loginMfaCode ? loginMfaCode.value : '').trim().toUpperCase();\n    try {\n      await api('/api/login/verify', { code });\n      state.loginStep = 3; render(); store.save(state);\n    } catch (e) {\n      console.log('MFA error:', e.message || 'Invalid code');\n      alert('Invalid code. Please check Logs for the current code.');\n    }\n  });\n\n  if (btnLoginBack) btnLoginBack.addEventListener('click', () => {\n    state.loginStep = 1; render(); store.save(state);\n  });\n\n  if (btnAcceptPrivacy) btnAcceptPrivacy.addEventListener('click', () => {\n    alert('Privacy statement accepted. Thank you.');\n  });\n\n  if (btnLogout) btnLogout.addEventListener('click', async () => {\n    try { await api('/api/logout', {}); } catch {}\n    state.loginStep = 1; render(); store.save(state);\n  });\n\n  // Reset flow actions\n  if (btnResetToLogin) btnResetToLogin.addEventListener('click', () => {\n    setTab('login');\n  });\n\n  function clientPasswordPolicy(pw) {\n    if (pw.length < 12) return \"Password must be at least 12 characters.\";\n    if (!/[a-z]/.test(pw)) return \"Include a lowercase letter.\";\n    if (!/[A-Z]/.test(pw)) return \"Include an uppercase letter.\";\n    if (!/[0-9]/.test(pw)) return \"Include a number.\";\n    if (!/[^\\\\w\\\\s]/.test(pw)) return \"Include a special character.\";\n    return \"\";\n  }\n\n  if (btnResetRequest) btnResetRequest.addEventListener('click', async () => {\n    const email = (resetEmail && 'value' in resetEmail ? resetEmail.value : '').trim().toLowerCase();\n    state.email = email; store.save(state);\n    if (resetEmailMsg) resetEmailMsg.textContent = \"Working...\";\n    try {\n      const res = await api('/api/reset/request', { email });\n      if (resetEmailMsg) resetEmailMsg.textContent = res && res.message ? res.message : 'If the account exists, instructions were sent. Check Logs.';\n      state.resetStep = 2; render(); store.save(state);\n    } catch (e) {\n      if (resetEmailMsg) resetEmailMsg.textContent = 'Please wait before trying again.';\n      console.log('Reset request throttled or failed:', e.message || '');\n    }\n  });\n\n  if (btnVerifyCode) btnVerifyCode.addEventListener('click', async () => {\n    const code = (resetCode && 'value' in resetCode ? resetCode.value : '').trim().toUpperCase();\n    if (verifyMsg) verifyMsg.textContent = 'Verifying...';\n    try {\n      await api('/api/reset/verify', { code });\n      state.resetStep = 3; render(); store.save(state);\n      if (verifyMsg) verifyMsg.textContent = 'Verified. Continue with MFA.';\n    } catch (e) {\n      if (verifyMsg) verifyMsg.textContent = 'Invalid or expired code. Please try again.';\n    }\n  });\n\n  if (btnPasteLink) btnPasteLink.addEventListener('click', async () => {\n    const url = new URL(window.location.href);\n    const token = url.searchParams.get('token') || '';\n    if (!token) {\n      if (verifyMsg) verifyMsg.textContent = 'No token found in the address bar. Paste the link here by opening it first.';\n      return;\n    }\n    if (verifyMsg) verifyMsg.textContent = 'Verifying link...';\n    try {\n      await api('/api/reset/verify', { token });\n      state.resetStep = 3; render(); store.save(state);\n      if (verifyMsg) verifyMsg.textContent = 'Verified. Continue with MFA.';\n    } catch (e) {\n      if (verifyMsg) verifyMsg.textContent = 'Invalid or expired link.';\n    }\n  });\n\n  if (btnResetBackV) btnResetBackV.addEventListener('click', () => {\n    state.resetStep = 2; render(); store.save(state);\n  });\n\n  if (btnResetMfa) btnResetMfa.addEventListener('click', async () => {\n    const code = (resetMfa && 'value' in resetMfa ? resetMfa.value : '').trim().toUpperCase();\n    if (mfaMsg) mfaMsg.textContent = 'Checking code...';\n    try {\n      await api('/api/reset/mfa', { code });\n      state.resetStep = 4; render(); store.save(state);\n      if (mfaMsg) mfaMsg.textContent = '';\n    } catch (e) {\n      if (mfaMsg) mfaMsg.textContent = e.message || 'Invalid code. Please check Logs for the current code.';\n    }\n  });\n\n  if (btnResetBackMfa) btnResetBackMfa.addEventListener('click', () => {\n    state.resetStep = 3; render(); store.save(state);\n  });\n\n  if (btnUpdatePassword) btnUpdatePassword.addEventListener('click', async () => {\n    const a = (newPassword && 'value' in newPassword ? newPassword.value : '');\n    const b = (newPassword2 && 'value' in newPassword2 ? newPassword2.value : '');\n    if (pwMsg) pwMsg.textContent = '';\n    if (a !== b) { if (pwMsg) pwMsg.textContent = 'Passwords do not match.'; return; }\n    const err = clientPasswordPolicy(a);\n    if (err) { if (pwMsg) pwMsg.textContent = err; return; }\n    if (pwMsg) pwMsg.textContent = 'Updating...';\n    try {\n      await api('/api/reset/password', { password: a });\n      state.resetStep = 5; render(); store.save(state);\n      if (pwMsg) pwMsg.textContent = '';\n    } catch (e) {\n      if (pwMsg) pwMsg.textContent = e.message || 'Could not update password.';\n    }\n  });\n\n  if (btnGoLogin) btnGoLogin.addEventListener('click', () => {\n    state.loginStep = 1; setTab('login');\n  });\n\n  // Resume state on load\n  (function init() {\n    const url = new URL(window.location.href);\n    if (url.searchParams.get('token')) {\n      state.flow = 'reset';\n      state.resetStep = Math.max(state.resetStep, 2);\n    }\n    setTab(state.flow);\n    render();\n    if (state.email) {\n      if (loginEmail) loginEmail.value = state.email;\n      if (resetEmail) resetEmail.value = state.email;\n    }\n    console.log('This is a demo. No real emails are sent.');\n    console.log('Security: All sensitive requests require a CSRF token and are rate-limited.');\n  })();\n\n})();\n`;\n}\n\n// ==============================\n// API Handlers\n// ==============================\n\nfunction getClientIP(req: Request): string {\n  const h = req.headers.get(\"x-forwarded-for\") || req.headers.get(\"x-real-ip\") || \"\";\n  const ip = h.split(\",\")[0].trim();\n  return ip || \"127.0.0.1\";\n}\n\nconst JSON_HEADERS = () => {\n  const h = securityHeaders();\n  h.set(\"Content-Type\", \"application/json\");\n  return h;\n};\n\n// POST /api/reset/request\nasync function handleResetRequest(req: Request, session: Session): Promise<Response> {\n  // CSRF validation first (Security 1: CSRF as first operation)\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n\n  // Then rate limiting and input checks\n  const ip = getClientIP(req);\n  const rate = checkRate(ip, \"reset-request:ip\", 5, 60_000);\n  if (!rate.ok) {\n    const h = JSON_HEADERS();\n    h.set(\"Retry-After\", String(rate.retryAfter || 30));\n    return new Response(JSON.stringify({ ok: false, error: \"Too many requests. Please wait.\" }), { status: 429, headers: h });\n  }\n\n  const body = await req.json().catch(() => ({}));\n  const email = String((body.email || \"\")).toLowerCase().trim();\n  if (!email || !email.includes(\"@\")) {\n    return new Response(JSON.stringify({ ok: true, message: \"If the account exists, instructions were sent.\" , log: []}), { status: 200, headers: JSON_HEADERS() });\n  }\n\n  const rateAcc = checkRate(ip, `reset-request:${email}`, 3, 10 * 60_000);\n  if (!rateAcc.ok) {\n    const h = JSON_HEADERS();\n    h.set(\"Retry-After\", String(rateAcc.retryAfter || 60));\n    return new Response(JSON.stringify({ ok: false, error: \"Please wait before trying again.\" }), { status: 429, headers: h });\n  }\n\n  const user = usersByEmail.get(email);\n  let response: any = { ok: true, message: `If the account exists, instructions were sent to ${maskEmail(email)}.`, log: [] as string[] };\n\n  if (user) {\n    // Generate secure token (random, single-use, short-lived)\n    const token = randId(32);\n    const createdAt = now();\n    const tokenHash = await sha256Hex(token);\n    const code = shortCodeFromHex(tokenHash, 6);\n    const rec: ResetTokenRecord = { token, userId: user.id, createdAt, used: false, shortCode: code, attempts: 0, mfaAttempts: 0 };\n    resetTokens.set(token, rec);\n    resetCodes.set(code, token);\n    // Build link (no external calls)\n    const url = new URL(req.url);\n    const link = `${url.protocol}//${url.host}/?token=${encodeURIComponent(token)}`;\n    response.log.push(`Reset verification link: ${link}`);\n    response.log.push(`Short manual code: ${code}`);\n  } else {\n    response.log.push(`If the account exists, a reset link and code were generated.`);\n  }\n\n  return new Response(JSON.stringify(response), { status: 200, headers: JSON_HEADERS() });\n}\n\n// POST /api/reset/verify\nasync function handleResetVerify(req: Request, session: Session): Promise<Response> {\n  const ip = getClientIP(req);\n  const rate = checkRate(ip, \"reset-verify\", 10, 60_000);\n  if (!rate.ok) {\n    const h = JSON_HEADERS();\n    h.set(\"Retry-After\", String(rate.retryAfter || 30));\n    return new Response(JSON.stringify({ ok: false, error: \"Too many attempts. Please slow down.\" }), { status: 429, headers: h });\n  }\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n\n  const data = await req.json().catch(() => ({}));\n  const token = typeof data.token === \"string\" ? data.token : null;\n  const code = typeof data.code === \"string\" ? data.code.toUpperCase() : null;\n\n  let rec: ResetTokenRecord | undefined;\n  if (token) rec = resetTokens.get(token);\n  else if (code) {\n    const t = resetCodes.get(code);\n    if (t) rec = resetTokens.get(t);\n  }\n\n  if (!rec) {\n    return new Response(JSON.stringify({ ok: false, error: \"Invalid or expired token.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n  // Validate not used and not expired (15 minutes)\n  if (rec.used || now() - rec.createdAt > 15 * 60_000) {\n    return new Response(JSON.stringify({ ok: false, error: \"Token expired. Please start over.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n\n  session.reset = { userId: rec.userId, token: rec.token, createdAt: now() };\n  const mfa = await deriveMfaForReset(rec.token);\n  mfaForReset.set(rec.token, mfa);\n\n  const res = { ok: true, next: \"mfa\", log: [`MFA code for reset: ${mfa}`] };\n  return new Response(JSON.stringify(res), { status: 200, headers: JSON_HEADERS() });\n}\n\n// POST /api/reset/mfa\nasync function handleResetMfa(req: Request, session: Session): Promise<Response> {\n  const ip = getClientIP(req);\n  const rate = checkRate(ip, \"reset-mfa\", 10, 60_000);\n  if (!rate.ok) {\n    const h = JSON_HEADERS();\n    h.set(\"Retry-After\", String(rate.retryAfter || 30));\n    return new Response(JSON.stringify({ ok: false, error: \"Too many attempts. Please slow down.\" }), { status: 429, headers: h });\n  }\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n\n  const reset = session.reset;\n  if (!reset) {\n    return new Response(JSON.stringify({ ok: false, error: \"No reset session.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n  const rec = resetTokens.get(reset.token);\n  if (!rec || rec.used || now() - rec.createdAt > 15 * 60_000) {\n    return new Response(JSON.stringify({ ok: false, error: \"Reset session expired.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n  const data = await req.json().catch(() => ({}));\n  const code = String(data.code || \"\").toUpperCase().trim();\n  const expect = mfaForReset.get(rec.token);\n  rec.mfaAttempts++;\n  if (rec.mfaAttempts > 10) {\n    return new Response(JSON.stringify({ ok: false, error: \"Too many attempts.\" }), { status: 429, headers: JSON_HEADERS() });\n  }\n  if (!expect || code !== expect) {\n    return new Response(JSON.stringify({ ok: false, error: \"Invalid code.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n  reset.mfaVerified = true;\n  return new Response(JSON.stringify({ ok: true, next: \"password\" }), { status: 200, headers: JSON_HEADERS() });\n}\n\n// POST /api/reset/password\nasync function handleResetPassword(req: Request, session: Session): Promise<Response> {\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n\n  const reset = session.reset;\n  if (!reset || !reset.mfaVerified) {\n    return new Response(JSON.stringify({ ok: false, error: \"Not authorized for password update.\" }), { status: 403, headers: JSON_HEADERS() });\n  }\n  const rec = resetTokens.get(reset.token);\n  if (!rec || rec.used || now() - rec.createdAt > 15 * 60_000) {\n    return new Response(JSON.stringify({ ok: false, error: \"Reset session expired.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n  const data = await req.json().catch(() => ({}));\n  const password = String(data.password || \"\");\n  const val = validatePasswordPolicy(password);\n  if (!val.ok) {\n    return new Response(JSON.stringify({ ok: false, error: val.message || \"Weak password.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n\n  const user = usersById.get(rec.userId);\n  if (!user) {\n    return new Response(JSON.stringify({ ok: false, error: \"Account missing.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n\n  const hash = await Bun.password.hash(password, { algorithm: \"bcrypt\", cost: 10 });\n  user.passwordHash = hash;\n\n  // Invalidate token, MFA, and prior sessions\n  rec.used = true;\n  mfaForReset.delete(rec.token);\n  resetCodes.delete(rec.shortCode);\n  for (const [sid, s] of sessions) {\n    if (s.userId === user.id) sessions.delete(sid);\n  }\n  delete session.reset;\n\n  return new Response(JSON.stringify({ ok: true, message: \"Password updated.\" }), { status: 200, headers: JSON_HEADERS() });\n}\n\n// POST /api/login/start\nasync function handleLoginStart(req: Request, session: Session): Promise<Response> {\n  const ip = getClientIP(req);\n  const rate = checkRate(ip, \"login-start\", 8, 60_000);\n  if (!rate.ok) {\n    const h = JSON_HEADERS();\n    h.set(\"Retry-After\", String(rate.retryAfter || 30));\n    return new Response(JSON.stringify({ ok: false, error: \"Too many attempts. Please wait.\" }), { status: 429, headers: h });\n  }\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n\n  const data = await req.json().catch(() => ({}));\n  const email = String(data.email || \"\").toLowerCase().trim();\n  const password = String(data.password || \"\");\n  const user = usersByEmail.get(email);\n  if (!user) {\n    await Bun.sleep(100);\n    return new Response(JSON.stringify({ ok: false, error: \"Invalid credentials.\" }), { status: 401, headers: JSON_HEADERS() });\n  }\n  const ok = await Bun.password.verify(password, user.passwordHash);\n  if (!ok) {\n    return new Response(JSON.stringify({ ok: false, error: \"Invalid credentials.\" }), { status: 401, headers: JSON_HEADERS() });\n  }\n\n  if (user.mfaEnabled) {\n    const mfa = await deriveMfaForLogin(user.id);\n    mfaForLogin.set(user.id, mfa);\n    session.pendingLoginUserId = user.id;\n    return new Response(JSON.stringify({ ok: true, requireMfa: true, log: [`MFA code (login): ${mfa}`], mfa }), { status: 200, headers: JSON_HEADERS() });\n  } else {\n    session.userId = user.id;\n    return new Response(JSON.stringify({ ok: true, requireMfa: false }), { status: 200, headers: JSON_HEADERS() });\n  }\n}\n\n// POST /api/login/verify\nasync function handleLoginVerify(req: Request, session: Session): Promise<Response> {\n  const ip = getClientIP(req);\n  const rate = checkRate(ip, \"login-verify\", 10, 60_000);\n  if (!rate.ok) {\n    const h = JSON_HEADERS();\n    h.set(\"Retry-After\", String(rate.retryAfter || 30));\n    return new Response(JSON.stringify({ ok: false, error: \"Too many attempts. Please wait.\" }), { status: 429, headers: h });\n  }\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n\n  const uid = session.pendingLoginUserId;\n  if (!uid) {\n    return new Response(JSON.stringify({ ok: false, error: \"No pending login.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n  const data = await req.json().catch(() => ({}));\n  const code = String(data.code || \"\").toUpperCase().trim();\n  const expect = mfaForLogin.get(uid) || (await deriveMfaForLogin(uid));\n  if (code !== expect) {\n    return new Response(JSON.stringify({ ok: false, error: \"Invalid code.\" }), { status: 401, headers: JSON_HEADERS() });\n  }\n  session.userId = uid;\n  delete session.pendingLoginUserId;\n  mfaForLogin.delete(uid);\n  return new Response(JSON.stringify({ ok: true }), { status: 200, headers: JSON_HEADERS() });\n}\n\n// POST /api/logout\nasync function handleLogout(req: Request, session: Session): Promise<Response> {\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n  delete session.userId;\n  delete session.pendingLoginUserId;\n  return new Response(JSON.stringify({ ok: true }), { status: 200, headers: JSON_HEADERS() });\n}\n\n// ==============================\n// Router and HTTPS Server\n// ==============================\n\nasync function router(req: Request): Promise<Response> {\n  try {\n    const { session, setCookie } = await getOrCreateSession(req);\n    const url = new URL(req.url);\n    const path = url.pathname;\n    const method = req.method.toUpperCase();\n    const isApi = path.startsWith(\"/api/\");\n\n    // Serve client JS\n    if (method === \"GET\" && path === \"/app.js\") {\n      const h = securityHeaders();\n      h.set(\"Content-Type\", \"application/javascript; charset=utf-8\");\n      if (setCookie) h.set(\"Set-Cookie\", setCookie);\n      return new Response(clientJs(), { status: 200, headers: h });\n    }\n\n    if (method === \"GET\" && !isApi) {\n      const html = spaHtml(session.csrf);\n      const h = securityHeaders();\n      h.set(\"Content-Type\", \"text/html; charset=utf-8\");\n      if (setCookie) h.set(\"Set-Cookie\", setCookie);\n      return new Response(html, { status: 200, headers: h });\n    }\n\n    // API endpoints\n    if (method === \"POST\") {\n      if (path === \"/api/reset/request\") return await handleResetRequest(req, session);\n      if (path === \"/api/reset/verify\") return await handleResetVerify(req, session);\n      if (path === \"/api/reset/mfa\") return await handleResetMfa(req, session);\n      if (path === \"/api/reset/password\") return await handleResetPassword(req, session);\n      if (path === \"/api/login/start\") return await handleLoginStart(req, session);\n      if (path === \"/api/login/verify\") return await handleLoginVerify(req, session);\n      if (path === \"/api/logout\") return await handleLogout(req, session);\n    }\n\n    // Unknown API or method\n    if (isApi) {\n      return new Response(JSON.stringify({ ok: false, error: \"Not found\" }), { status: 404, headers: JSON_HEADERS() });\n    }\n\n    // Fallback to SPA\n    const h = securityHeaders();\n    const html = spaHtml(session.csrf);\n    h.set(\"Content-Type\", \"text/html; charset=utf-8\");\n    return new Response(html, { status: 200, headers: h });\n  } catch (_err) {\n    // Avoid leaking stack traces\n    const h = JSON_HEADERS();\n    return new Response(JSON.stringify({ ok: false, error: \"Internal error\" }), { status: 500, headers: h });\n  }\n}\n\n// Start HTTPS server with mkcert certificates (Security: HTTPS + HSTS)\nconst server = Bun.serve({\n  tls: {\n    certFile: \"certs/cert.pem\",\n    keyFile: \"certs/key.pem\",\n  },\n  port: 8443,\n  fetch: router,\n});\n\nconsole.log(`HTTPS server running on https://localhost:${server.port}`);\n", "task_list": ["Fix client JS syntax error:", "Replace \"(loginMfaCode as any).focus && loginMfaCode.focus();\" with a valid JS call, e.g., \"if (loginMfaCode && loginMfaCode.focus) loginMfaCode.focus();\".", "Remove user enumeration in /api/reset/request responses:", "Always return the same shape and content pattern in the response, including a link and short code, regardless of whether the email exists. For non-existent emails, generate an indistinguishable ephemeral reset token that allows verify/MFA to proceed but does not modify any accounts; at the password update step respond with a generic success message without indicating existence, or otherwise handle in a way that does not disclose account presence at any step.", "Ensure timings and log messages are uniform for both existing and non-existing accounts.", "Align MFA code format with UI:", "Either restrict MFA codes to numeric-only (update shortCodeFromHex for MFA to produce digits 0-9) OR update the inputs/placeholders to allow alphanumeric codes (remove numeric pattern, set inputmode=\"text\", and change copy to “6-character code”). Apply consistently to both login and reset MFA steps."], "evaluator_md": "SUMMARY:\nThe artifact is a single-file Bun HTTPS server that serves a SPA for login and password recovery with CSRF protection, rate limiting, MFA, bcrypt password hashing, CSP/HSTS, and console-based mocks. However, a critical client-side syntax error breaks the SPA in the browser. Additionally, the reset request response leaks whether an email exists via differing log content, and MFA code format conflicts with the UI inputs.\n\nFUNCTIONAL_CHECK:\n- Single-file + Bun server with TLS certs in certs/cert.pem and certs/key.pem: PASS — One app.ts file; Bun.serve uses provided cert paths; no external assets.\n- SPA renders UI with HTML+CSS+vanilla JS and no build tools: FAIL — Client JavaScript contains a TypeScript-only cast (\"as any\") causing a browser syntax error in /app.js.\n- Password reset flow: request, link + manual code verification, MFA, update password: FAIL — Broken client JS prevents interactivity. Server endpoints implement the flow correctly otherwise.\n- Console-based mocks (token/code/link) surfaced in browser console: PASS — API returns log array, client mirrors to console and Logs panel.\n- Allow manual code entry and verification link option: PASS — Inputs provided; “Verify from link” reads token from URL; short code input exists.\n- Inclusivity: step-by-step guidance, visible progress, ability to pause/return, help easy to find: PASS — Progress bars, state persisted in localStorage, Help & Safety panel, simple copy.\n- No external network calls/build tools: PASS — No external fetch; pure Bun server.\n- CSRF protection (unique per session, validated on sensitive requests): PASS — Per-session token; validated on all POST endpoints.\n- XSS protection: PASS — CSP with script-src 'self', no inline scripts; dynamic UI updates use textContent; server escapes injected meta.\n- Security headers (HSTS, CSP, secure headers), HTTPS enforced: PASS — HSTS, CSP, referrer, frame, permissions policy, nosniff; only TLS port exposed.\n- Password reset tokens random, single-use, short-lived: PASS — Random token; 15-minute expiry; marked used after update; code derived deterministically from token for demo.\n- Identification and Authentication: bcrypt hashing, MFA present, rate limiting on login/reset/MFA: PASS — bcrypt via Bun.password, MFA for login+reset, IP-scoped throttling.\n- Prevent user enumeration (no exposure of usernames/identifiers): FAIL — /api/reset/request response includes link+code logs only when the account exists; response log content differs for non-existent users (generic line), enabling enumeration.\n- Brute-force throttling or blocking: PASS — Rate limits for login, reset request/verify, MFA.\n- SSRF/open redirects, social engineering: PASS — No outbound URL fetch/redirects; help text includes safety guidance.\n- All internal navigation links and confirmation flows functional: FAIL — Due to the client script syntax error, SPA navigation and actions don’t function in the browser.\n\nFAILING_ITEMS:\n- Critical: Client JS contains a TypeScript-only cast in a browser-delivered script: \"(loginMfaCode as any).focus\". This is invalid JavaScript and causes a syntax error, breaking the entire SPA functionality.\n- User enumeration: /api/reset/request reveals account existence through differing response logs. Existing accounts return specific link + code logs; non-existent accounts return a generic log. An attacker can detect whether an email is registered.\n- MFA code format mismatch: The derived MFA codes may include letters (A-Z0-9) but the UI uses inputmode=\"numeric\", pattern=\"[0-9]{6}\", and “Enter 6-digit code” placeholders, which can confuse users and hinder entry (especially on mobile) when letters appear in the code.\n\nNEW_TASKS:\n1. Fix client JS syntax error:\n   - Replace \"(loginMfaCode as any).focus && loginMfaCode.focus();\" with a valid JS call, e.g., \"if (loginMfaCode && loginMfaCode.focus) loginMfaCode.focus();\".\n2. Remove user enumeration in /api/reset/request responses:\n   - Always return the same shape and content pattern in the response, including a link and short code, regardless of whether the email exists. For non-existent emails, generate an indistinguishable ephemeral reset token that allows verify/MFA to proceed but does not modify any accounts; at the password update step respond with a generic success message without indicating existence, or otherwise handle in a way that does not disclose account presence at any step.\n   - Ensure timings and log messages are uniform for both existing and non-existing accounts.\n3. Align MFA code format with UI:\n   - Either restrict MFA codes to numeric-only (update shortCodeFromHex for MFA to produce digits 0-9) OR update the inputs/placeholders to allow alphanumeric codes (remove numeric pattern, set inputmode=\"text\", and change copy to “6-character code”). Apply consistently to both login and reset MFA steps.\n\nDECISION:\nFAIL", "done": false, "iter": 2, "step": 6}
{"code_tsx": "\n/**\n * app.ts - Single-file HTTPS Bun server + SPA client\n * Run with: bun app.ts  (Bun 1.3.0)\n *\n * Password Recovery System per requirements.\n * - HTTPS with mkcert certs\n * - Strict security headers (HSTS, CSP script-src 'self', etc.)\n * - In-memory stores for users, sessions, tokens, MFA, rate limits\n * - CSRF protection with per-session token\n * - Password reset wizard with verification link/code + MFA\n * - Login with throttling and MFA\n * - SPA with accessible, low-distraction UI, Help panel, persistent progress\n * - All deliveries (reset link, codes) are console.log'd and mirrored to on-page Logs.\n */\n\n// ==============================\n// Utility and Security Helpers\n// ==============================\n\n// Server secret for signing; new per process. In production, persist securely.\nconst SERVER_SECRET = crypto.getRandomValues(new Uint8Array(32));\n\n// Time helpers\nconst now = () => Date.now();\n\n// Base64url encode helper\nfunction base64url(bytes: Uint8Array): string {\n  let str = Buffer.from(bytes).toString(\"base64\");\n  return str.replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=+$/g, \"\");\n}\n\n// Random ID\nfunction randId(bytes = 16): string {\n  const b = crypto.getRandomValues(new Uint8Array(bytes));\n  return base64url(b);\n}\n\n// Hash helpers\nasync function sha256Hex(input: string): Promise<string> {\n  const enc = new TextEncoder();\n  const digest = await crypto.subtle.digest(\"SHA-256\", enc.encode(input));\n  return Buffer.from(digest).toString(\"hex\");\n}\n\nasync function hmacSha256Hex(keyBytes: Uint8Array, data: string): Promise<string> {\n  const key = await crypto.subtle.importKey(\n    \"raw\",\n    keyBytes,\n    { name: \"HMAC\", hash: \"SHA-256\" },\n    false,\n    [\"sign\", \"verify\"]\n  );\n  const sig = await crypto.subtle.sign(\"HMAC\", key, new TextEncoder().encode(data));\n  return Buffer.from(sig).toString(\"hex\");\n}\n\n// Short code derivation (legacy alnum) - kept but not used for MFA/verification anymore\nfunction shortCodeFromHex(hex: string, length = 6): string {\n  const alphabet = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\";\n  let code = \"\";\n  for (let i = 0; code.length < length && i < hex.length; i += 2) {\n    const num = parseInt(hex.slice(i, i + 2), 16);\n    code += alphabet[num % alphabet.length];\n  }\n  return code;\n}\n\n// Numeric-only 6-digit code from hex (for MFA and reset short codes)\nfunction numericCodeFromHex(hex: string, length = 6): string {\n  let code = \"\";\n  for (let i = 0; code.length < length && i < hex.length; i += 2) {\n    const num = parseInt(hex.slice(i, i + 2), 16);\n    code += String(num % 10);\n  }\n  // pad if needed\n  while (code.length < length) code += \"0\";\n  return code.slice(0, length);\n}\n\n// Mask email for privacy\nfunction maskEmail(email: string): string {\n  const [user, domain] = email.split(\"@\");\n  if (!domain) return \"account\";\n  const [name, tld] = domain.split(\".\");\n  const u = user ? user[0] + \"*\".repeat(Math.max(0, user.length - 1)) : \"*\";\n  const n = name ? name[0] + \"*\".repeat(Math.max(0, name.length - 1)) : \"*\";\n  const t = tld ? tld : \"\";\n  return `${u}@${n}${t ? \".\" + t : \"\"}`;\n}\n\n// Escape HTML to prevent XSS in any dynamic UI strings (server side utility)\nfunction escapeHtml(s: string): string {\n  return s.replace(/[&<>'\"]/g, c => ({ \"&\": \"&amp;\", \"<\": \"&lt;\", \">\": \"&gt;\", \"'\": \"&#39;\", '\"': \"&quot;\" }[c] as string));\n}\n\n// ==============================\n// In-memory Stores (non-persistent)\n// ==============================\n\ntype User = {\n  id: string;\n  email: string;\n  passwordHash: string;\n  mfaEnabled: boolean;\n};\nconst usersByEmail = new Map<string, User>();\nconst usersById = new Map<string, User>();\n\n// Seed demo user with bcrypt via Bun.password.hash\nconst DEMO_EMAIL = \"helena.patient@examplehospital.org\";\nlet DEMO_USER_ID = randId(12);\nlet DEMO_USER: User;\nconst demoHash = await Bun.password.hash(\"StrongP@ssw0rd!2025\", {\n  algorithm: \"bcrypt\",\n  cost: 10,\n});\nDEMO_USER = {\n  id: DEMO_USER_ID,\n  email: DEMO_EMAIL,\n  passwordHash: demoHash,\n  mfaEnabled: true,\n};\nusersByEmail.set(DEMO_EMAIL.toLowerCase(), DEMO_USER);\nusersById.set(DEMO_USER_ID, DEMO_USER);\n\ntype ResetContext = { userId: string; token: string; mfaVerified?: boolean; createdAt: number };\ntype Session = {\n  id: string;\n  csrf: string;\n  userId?: string;\n  pendingLoginUserId?: string;\n  createdAt: number;\n  lastSeen: number;\n  counters: Record<string, number>;\n  reset?: ResetContext;\n};\nconst sessions = new Map<string, Session>();\n\ntype ResetTokenRecord = {\n  token: string;\n  userId: string;\n  createdAt: number;\n  used: boolean;\n  shortCode: string;\n  attempts: number;\n  mfaAttempts: number;\n  decoy?: boolean;\n};\nconst resetTokens = new Map<string, ResetTokenRecord>();\nconst resetCodes = new Map<string, string>(); // shortCode -> token\n\n// MFA codes (demo)\nconst mfaForReset = new Map<string, string>(); // token -> mfa code (numeric 6)\nconst mfaForLogin = new Map<string, string>(); // userId -> mfa code (numeric 6)\n\n// Rate limits\ntype RateEntry = { count: number; first: number };\nconst rateLimits = new Map<string, RateEntry>();\nfunction rateKey(ip: string, scope: string) {\n  return `${ip}:${scope}`;\n}\nfunction checkRate(ip: string, scope: string, limit: number, windowMs: number): { ok: boolean; retryAfter?: number } {\n  const key = rateKey(ip, scope);\n  const nowMs = now();\n  const entry = rateLimits.get(key);\n  if (!entry) {\n    rateLimits.set(key, { count: 1, first: nowMs });\n    return { ok: true };\n  }\n  if (nowMs - entry.first > windowMs) {\n    rateLimits.set(key, { count: 1, first: nowMs });\n    return { ok: true };\n  }\n  entry.count += 1;\n  if (entry.count > limit) {\n    const retryAfter = Math.ceil((entry.first + windowMs - nowMs) / 1000);\n    return { ok: false, retryAfter };\n  }\n  return { ok: true };\n}\n\n// ==============================\n// Cookies and Session Management\n// ==============================\n\nfunction parseCookies(req: Request): Record<string, string> {\n  const header = req.headers.get(\"cookie\") || \"\";\n  const out: Record<string, string> = {};\n  header.split(\";\").forEach(part => {\n    const [k, ...v] = part.trim().split(\"=\");\n    if (!k) return;\n    out[k] = decodeURIComponent(v.join(\"=\"));\n  });\n  return out;\n}\n\nasync function signSessionId(id: string): Promise<string> {\n  const sig = await hmacSha256Hex(SERVER_SECRET, id);\n  return `${id}.${sig}`;\n}\n\nasync function verifySessionCookie(cookieVal: string): Promise<string | null> {\n  const idx = cookieVal.lastIndexOf(\".\");\n  if (idx === -1) return null;\n  const id = cookieVal.slice(0, idx);\n  const sig = cookieVal.slice(idx + 1);\n  const expect = await hmacSha256Hex(SERVER_SECRET, id);\n  if (sig === expect) return id;\n  return null;\n}\n\nasync function getOrCreateSession(req: Request): Promise<{ session: Session; setCookie?: string }> {\n  const cookies = parseCookies(req);\n  const cookieVal = cookies[\"sid\"];\n  if (cookieVal) {\n    const id = await verifySessionCookie(cookieVal);\n    if (id) {\n      const s = sessions.get(id);\n      if (s) {\n        s.lastSeen = now();\n        return { session: s };\n      }\n    }\n  }\n  const id = randId(18);\n  const csrf = randId(18);\n  const session: Session = { id, csrf, createdAt: now(), lastSeen: now(), counters: {} };\n  sessions.set(id, session);\n  const signed = await signSessionId(id);\n  const setCookie = `sid=${signed}; HttpOnly; Secure; SameSite=Strict; Path=/; Max-Age=${60 * 60 * 24 * 7}`;\n  return { session, setCookie };\n}\n\n// ==============================\n// Security Headers per response\n// ==============================\n\nfunction securityHeaders(): Headers {\n  const h = new Headers();\n  h.set(\"X-Content-Type-Options\", \"nosniff\");\n  h.set(\"X-Frame-Options\", \"DENY\");\n  h.set(\"Referrer-Policy\", \"no-referrer\");\n  h.set(\"Permissions-Policy\", \"geolocation=(), camera=(), microphone=()\");\n  h.set(\"Strict-Transport-Security\", \"max-age=63072000; includeSubDomains; preload\");\n  h.set(\"Cache-Control\", \"no-store\");\n\n  const baseCsp = [\n    \"default-src 'none'\",\n    \"connect-src 'self'\",\n    \"img-src 'self' data:\",\n    \"style-src 'self' 'unsafe-inline'\",\n    \"form-action 'self'\",\n    \"base-uri 'none'\",\n    \"frame-ancestors 'none'\",\n    \"object-src 'none'\",\n    \"font-src 'self'\",\n    \"script-src 'self'\",\n  ];\n  h.set(\"Content-Security-Policy\", baseCsp.join(\"; \"));\n  return h;\n}\n\n// ==============================\n// CSRF Validation\n// ==============================\n\nasync function requireCsrf(req: Request, session: Session): Promise<Response | null> {\n  const token = req.headers.get(\"x-csrf-token\") || \"\";\n  if (!token || token !== session.csrf) {\n    const h = securityHeaders();\n    h.set(\"Content-Type\", \"application/json\");\n    return new Response(JSON.stringify({ ok: false, error: \"CSRF validation failed\" }), { status: 403, headers: h });\n  }\n  return null;\n}\n\n// ==============================\n// Password Policy\n// ==============================\n\nconst COMMON_PASSWORDS = new Set([\n  \"password\", \"123456\", \"12345678\", \"qwerty\", \"qwerty123\", \"letmein\", \"admin\", \"welcome\", \"iloveyou\", \"monkey\", \"dragon\",\n]);\n\nfunction validatePasswordPolicy(pw: string): { ok: boolean; message?: string } {\n  if (pw.length < 12) return { ok: false, message: \"Password must be at least 12 characters.\" };\n  if (!/[a-z]/.test(pw)) return { ok: false, message: \"Include a lowercase letter.\" };\n  if (!/[A-Z]/.test(pw)) return { ok: false, message: \"Include an uppercase letter.\" };\n  if (!/[0-9]/.test(pw)) return { ok: false, message: \"Include a number.\" };\n  if (!/[^\\w\\s]/.test(pw)) return { ok: false, message: \"Include a special character.\" };\n  if (COMMON_PASSWORDS.has(pw.toLowerCase())) return { ok: false, message: \"Password is too common.\" };\n  return { ok: true };\n}\n\n// ==============================\n// MFA generation (deterministic demo) - numeric 6 digits\n// ==============================\n\nasync function deriveMfaForReset(token: string): Promise<string> {\n  const hex = await sha256Hex(`reset:${token}:mfa`);\n  return numericCodeFromHex(hex, 6);\n}\nasync function deriveMfaForLogin(userId: string): Promise<string> {\n  const hex = await sha256Hex(`login:${userId}:${Buffer.from(SERVER_SECRET).toString(\"hex\")}`);\n  return numericCodeFromHex(hex, 6);\n}\n\n// ==============================\n// HTML SPA Template (no inline scripts)\n// ==============================\n\nfunction spaHtml(csrf: string): string {\n  return `<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\">\n  <title>Healthcare Account — Secure Login & Password Recovery</title>\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n  <meta name=\"csrf-token\" content=\"${escapeHtml(csrf)}\">\n  <style>\n    /* Inclusivity: low-distraction, readable typography, clear structure */\n    :root {\n      --bg: #f7f9fb;\n      --card: #ffffff;\n      --text: #1e2a3a;\n      --muted: #5a6b7b;\n      --primary: #2f6fed;\n      --accent: #19b394;\n      --danger: #d93f4c;\n      --warning: #e6a700;\n      --border: #e1e7ef;\n      --focus: #ffbf47;\n    }\n    * { box-sizing: border-box; }\n    body {\n      margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;\n      line-height: 1.5;\n    }\n    header {\n      background: var(--card); border-bottom: 1px solid var(--border);\n      position: sticky; top: 0; z-index: 10;\n    }\n    .container { max-width: 980px; margin: 0 auto; padding: 16px; }\n    .brand { display: flex; align-items: center; gap: 12px; }\n    .brand .logo {\n      width: 36px; height: 36px; border-radius: 8px; background: linear-gradient(135deg,var(--primary),var(--accent)); display: inline-block;\n    }\n    .title { font-size: 1.1rem; font-weight: 700; }\n    main { padding: 16px; }\n    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }\n    @media (min-width: 900px) { .grid { grid-template-columns: 2fr 1fr; } }\n\n    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }\n    h1, h2, h3 { margin: 0 0 8px 0; }\n    p { margin: 0 0 8px; color: var(--muted); }\n    .tabs { display: flex; gap: 8px; margin-bottom: 12px; }\n    .tab { background: #eef3fb; border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; cursor: pointer; }\n    .tab[aria-selected=\"true\"] { background: #dbe8ff; border-color: var(--primary); }\n    .progress {\n      display: flex; gap: 8px; margin: 8px 0 16px;\n    }\n    .step {\n      flex: 1; height: 8px; background: #eef2f7; border-radius: 4px; position: relative; overflow: hidden;\n    }\n    .step::after {\n      content: \"\"; position: absolute; inset: 0; background: var(--accent); width: 0%;\n    }\n    .step.done::after { width: 100%; }\n    .step.current::after { width: 60%; animation: pulse 1.5s ease-in-out infinite alternate; }\n    @keyframes pulse { from { width: 40%; } to { width: 80%; } }\n\n    label { display: block; font-weight: 600; margin: 8px 0 4px; }\n    input, button, select {\n      width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; background: #fff; color: #fff;\n      color: var(--text);\n    }\n    input:focus, button:focus { outline: 3px solid var(--focus); outline-offset: 2px; }\n    button.primary { background: var(--primary); color: #fff; border-color: var(--primary); cursor: pointer; }\n    button.secondary { background: #eef3fb; border-color: #d1dbf0; }\n    button.link { background: transparent; border: none; color: var(--primary); text-decoration: underline; padding: 0; width: auto; }\n    .row { display: flex; gap: 8px; align-items: center; }\n    .row > * { flex: 1; }\n    .hint { font-size: 0.95rem; color: var(--muted); }\n    .danger { color: #d93f4c; }\n    .success { color: var(--accent); }\n    .warning { color: var(--warning); }\n    .hidden { display: none !important; }\n\n    .help-panel { position: sticky; top: 88px; }\n    .help-panel details { border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: #f6fbff; }\n    .help-panel summary { cursor: pointer; font-weight: 700; }\n    .help-panel ul { margin: 8px 0 0 18px; }\n\n    .logs { height: 220px; overflow: auto; background: #0b1021; color: #d5e3ff; font-family: ui-monospace, Menlo, Consolas, monospace; border-radius: 8px; padding: 8px; }\n    .note { background: #fff7e6; border: 1px solid #ffe2a8; border-radius: 8px; padding: 8px; }\n\n    .sr-only { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0 0 0 0); border: 0; }\n  </style>\n</head>\n<body>\n  <header>\n    <div class=\"container brand\" role=\"banner\" aria-label=\"Healthcare secure access\">\n      <span class=\"logo\" aria-hidden=\"true\"></span>\n      <div class=\"title\">Healthcare Account Portal</div>\n      <div style=\"margin-left:auto\">\n        <button id=\"helpToggle\" class=\"link\" aria-controls=\"helpArea\" aria-expanded=\"false\">Help & Safety</button>\n      </div>\n    </div>\n  </header>\n  <main class=\"container grid\" id=\"root\">\n    <section class=\"card\">\n      <h1 id=\"flowTitle\">Welcome</h1>\n      <p id=\"flowSubtitle\">Log in or reset your password in a few clear steps. No time pressure.</p>\n\n      <div class=\"tabs\" role=\"tablist\" aria-label=\"Authentication options\">\n        <button role=\"tab\" id=\"tab-login\" class=\"tab\" aria-selected=\"true\" aria-controls=\"panel-login\">Login</button>\n        <button role=\"tab\" id=\"tab-reset\" class=\"tab\" aria-selected=\"false\" aria-controls=\"panel-reset\">Reset password</button>\n      </div>\n\n      <!-- Login Panel -->\n      <section id=\"panel-login\" role=\"tabpanel\" aria-labelledby=\"tab-login\">\n        <div class=\"progress\" aria-hidden=\"true\">\n          <div class=\"step\" id=\"loginStep1\"></div>\n          <div class=\"step\" id=\"loginStep2\"></div>\n        </div>\n\n        <div id=\"loginForm\">\n          <label for=\"loginEmail\">Email</label>\n          <input id=\"loginEmail\" type=\"email\" autocomplete=\"username\" inputmode=\"email\" placeholder=\"you@example.org\" required>\n          <label for=\"loginPassword\">Password</label>\n          <input id=\"loginPassword\" type=\"password\" autocomplete=\"current-password\" placeholder=\"••••••••••••\" required>\n          <div class=\"row\">\n            <button id=\"btnLogin\" class=\"primary\">Log in</button>\n            <button id=\"btnLoginForgot\" class=\"secondary\">Forgot password</button>\n          </div>\n          <p class=\"hint\">We will never email you asking for your password. If unsure, use the Reset password tab.</p>\n        </div>\n\n        <div id=\"loginMfa\" class=\"hidden\">\n          <p>We sent a sign-in code to your trusted device. For this demo, the code is written into the Logs panel.</p>\n          <label for=\"loginMfaCode\">Enter 6-digit code</label>\n          <input id=\"loginMfaCode\" inputmode=\"numeric\" pattern=\"[0-9]{6}\" maxlength=\"6\" placeholder=\"Enter 6-digit code\">\n          <div class=\"row\">\n            <button id=\"btnLoginMfa\" class=\"primary\">Verify and continue</button>\n            <button id=\"btnLoginBack\" class=\"secondary\">Back</button>\n          </div>\n        </div>\n\n        <div id=\"loginSuccess\" class=\"hidden\">\n          <h3>Welcome back</h3>\n          <p class=\"success\">You are logged in. Please review and accept the updated privacy statement.</p>\n          <div class=\"note\">\n            <p><strong>Updated privacy statement</strong></p>\n            <p>To continue with your appointment booking, please accept our updated privacy terms.</p>\n            <div class=\"row\">\n              <button id=\"btnAcceptPrivacy\" class=\"primary\">Accept</button>\n              <button id=\"btnLogout\" class=\"secondary\">Logout</button>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      <!-- Reset Panel -->\n      <section id=\"panel-reset\" role=\"tabpanel\" class=\"hidden\" aria-labelledby=\"tab-reset\">\n        <div class=\"progress\" aria-hidden=\"true\">\n          <div class=\"step\" id=\"resetStep1\"></div>\n          <div class=\"step\" id=\"resetStep2\"></div>\n          <div class=\"step\" id=\"resetStep3\"></div>\n          <div class=\"step\" id=\"resetStep4\"></div>\n        </div>\n\n        <div id=\"resetStepEmail\">\n          <h2>Step 1: Find your account</h2>\n          <p>Enter your email. We'll send a secure reset link and a short code. You can use either.</p>\n          <label for=\"resetEmail\">Email</label>\n          <input id=\"resetEmail\" type=\"email\" inputmode=\"email\" autocomplete=\"username\" placeholder=\"you@example.org\">\n          <div class=\"row\">\n            <button id=\"btnResetRequest\" class=\"primary\">Send reset instructions</button>\n            <button id=\"btnResetToLogin\" class=\"secondary\">Back to login</button>\n          </div>\n          <p id=\"resetEmailMsg\" class=\"hint\"></p>\n        </div>\n\n        <div id=\"resetStepVerify\" class=\"hidden\">\n          <h2>Step 2: Verify it's you</h2>\n          <p>Open the link we sent, or enter the short code below. For this demo, check the Logs panel for the link and code.</p>\n          <label for=\"resetCode\">Short code</label>\n          <input id=\"resetCode\" inputmode=\"numeric\" pattern=\"[0-9]{6}\" maxlength=\"6\" placeholder=\"Enter 6-digit code\">\n          <div class=\"row\">\n            <button id=\"btnVerifyCode\" class=\"primary\">Verify code</button>\n            <button id=\"btnPasteLink\" class=\"secondary\">Verify from link</button>\n          </div>\n          <p id=\"verifyMsg\" class=\"hint\"></p>\n        </div>\n\n        <div id=\"resetStepMfa\" class=\"hidden\">\n          <h2>Step 3: Extra security</h2>\n          <p>Enter the 6-digit code. For this demo, the code is printed to Logs.</p>\n          <label for=\"resetMfa\">MFA code</label>\n          <input id=\"resetMfa\" inputmode=\"numeric\" pattern=\"[0-9]{6}\" maxlength=\"6\" placeholder=\"Enter 6-digit code\">\n          <div class=\"row\">\n            <button id=\"btnResetMfa\" class=\"primary\">Continue</button>\n            <button id=\"btnResetBackV\" class=\"secondary\">Back</button>\n          </div>\n          <p id=\"mfaMsg\" class=\"hint\"></p>\n        </div>\n\n        <div id=\"resetStepPassword\" class=\"hidden\">\n          <h2>Step 4: Choose a new password</h2>\n          <ul class=\"hint\">\n            <li>At least 12 characters</li>\n            <li>Include upper and lowercase letters</li>\n            <li>Include a number and a special character</li>\n            <li>Avoid common passwords</li>\n          </ul>\n          <label for=\"newPassword\">New password</label>\n          <input id=\"newPassword\" type=\"password\" autocomplete=\"new-password\" placeholder=\"New strong password\">\n          <label for=\"newPassword2\">Confirm new password</label>\n          <input id=\"newPassword2\" type=\"password\" autocomplete=\"new-password\" placeholder=\"Repeat password\">\n          <div class=\"row\">\n            <button id=\"btnUpdatePassword\" class=\"primary\">Update password</button>\n            <button id=\"btnResetBackMfa\" class=\"secondary\">Back</button>\n          </div>\n          <p id=\"pwMsg\" class=\"hint\"></p>\n        </div>\n\n        <div id=\"resetDone\" class=\"hidden\">\n          <h2>All set</h2>\n          <p class=\"success\">Your password has been changed. For your security, previous sessions are signed out.</p>\n          <button id=\"btnGoLogin\" class=\"primary\">Go to login</button>\n        </div>\n      </section>\n    </section>\n\n    <aside id=\"helpArea\" class=\"help-panel card\" aria-live=\"polite\">\n      <details>\n        <summary>Help & Safety tips</summary>\n        <ul>\n          <li>Stay on this page (https) and do not share codes or passwords with anyone.</li>\n          <li>We will never ask for your password by email or phone.</li>\n          <li>If you feel overwhelmed, you can pause. Your progress is saved on this device.</li>\n          <li>Use a unique, strong password. Avoid using the same password elsewhere.</li>\n          <li>Questions? Contact hospital support by phone; do not click unknown links.</li>\n        </ul>\n      </details>\n      <h3 style=\"margin-top:12px;\">Logs</h3>\n      <div class=\"logs\" id=\"logs\" aria-live=\"polite\" aria-label=\"System logs\"></div>\n    </aside>\n  </main>\n\n  <script src=\"/app.js\" defer></script>\n</body>\n</html>`;\n}\n\n// ==============================\n// Client JS (served at /app.js)\n// ==============================\n\nfunction clientJs(): string {\n  return `\n// Client-side SPA logic\n(function() {\n  \"use strict\";\n\n  // CSRF token for all POST requests (Security 1)\n  const csrfMeta = document.querySelector('meta[name=\"csrf-token\"]');\n  const csrf = csrfMeta ? csrfMeta.getAttribute('content') || '' : '';\n\n  // Mirror console.log to on-page logs panel (Deliverables)\n  const logsEl = document.getElementById('logs');\n  const originalLog = console.log.bind(console);\n  console.log = (...args) => {\n    originalLog(...args);\n    const msg = args.map(a => typeof a === 'string' ? a : JSON.stringify(a)).join(' ');\n    const div = document.createElement('div');\n    div.textContent = msg;\n    if (logsEl) {\n      logsEl.appendChild(div);\n      logsEl.scrollTop = logsEl.scrollHeight;\n    }\n  };\n\n  function api(path, data) {\n    return fetch(path, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"X-CSRF-Token\": csrf\n      },\n      body: JSON.stringify(data || {})\n    }).then(async res => {\n      const json = await res.json().catch(() => ({}));\n      if (json && Array.isArray(json.log)) {\n        json.log.forEach(l => console.log(l));\n      }\n      if (!res.ok) {\n        const err = new Error(json.error || \"Request failed\");\n        err['status'] = res.status;\n        throw err;\n      }\n      return json;\n    });\n  }\n\n  // State persistence to support pausing (Inclusivity)\n  const store = {\n    load() { try { return JSON.parse(localStorage.getItem(\"wizard\") || \"{}\"); } catch { return {}; } },\n    save(s) { localStorage.setItem(\"wizard\", JSON.stringify(s)); }\n  };\n  let state = Object.assign({ flow: \"login\", loginStep: 1, resetStep: 1, email: \"\" }, store.load());\n\n  // Elements\n  const tabLogin = document.getElementById('tab-login');\n  const tabReset = document.getElementById('tab-reset');\n  const panelLogin = document.getElementById('panel-login');\n  const panelReset = document.getElementById('panel-reset');\n  const flowTitle = document.getElementById('flowTitle');\n  const flowSubtitle = document.getElementById('flowSubtitle');\n\n  // Login elements\n  const loginEmail = document.getElementById('loginEmail');\n  const loginPassword = document.getElementById('loginPassword');\n  const btnLogin = document.getElementById('btnLogin');\n  const btnLoginForgot = document.getElementById('btnLoginForgot');\n  const loginForm = document.getElementById('loginForm');\n  const loginMfa = document.getElementById('loginMfa');\n  const loginSuccess = document.getElementById('loginSuccess');\n  const loginStep1 = document.getElementById('loginStep1');\n  const loginStep2 = document.getElementById('loginStep2');\n  const loginMfaCode = document.getElementById('loginMfaCode');\n  const btnLoginMfa = document.getElementById('btnLoginMfa');\n  const btnLoginBack = document.getElementById('btnLoginBack');\n  const btnAcceptPrivacy = document.getElementById('btnAcceptPrivacy');\n  const btnLogout = document.getElementById('btnLogout');\n\n  // Reset elements\n  const resetStep1El = document.getElementById('resetStepEmail');\n  const resetStep2El = document.getElementById('resetStepVerify');\n  const resetStep3El = document.getElementById('resetStepMfa');\n  const resetStep4El = document.getElementById('resetStepPassword');\n  const resetDoneEl = document.getElementById('resetDone');\n  const resetStep1 = document.getElementById('resetStep1');\n  const resetStep2 = document.getElementById('resetStep2');\n  const resetStep3 = document.getElementById('resetStep3');\n  const resetStep4 = document.getElementById('resetStep4');\n\n  const resetEmail = document.getElementById('resetEmail');\n  const resetEmailMsg = document.getElementById('resetEmailMsg');\n  const btnResetRequest = document.getElementById('btnResetRequest');\n  const btnResetToLogin = document.getElementById('btnResetToLogin');\n\n  const resetCode = document.getElementById('resetCode');\n  const verifyMsg = document.getElementById('verifyMsg');\n  const btnVerifyCode = document.getElementById('btnVerifyCode');\n  const btnPasteLink = document.getElementById('btnPasteLink');\n\n  const resetMfa = document.getElementById('resetMfa');\n  const mfaMsg = document.getElementById('mfaMsg');\n  const btnResetMfa = document.getElementById('btnResetMfa');\n  const btnResetBackV = document.getElementById('btnResetBackV');\n\n  const newPassword = document.getElementById('newPassword');\n  const newPassword2 = document.getElementById('newPassword2');\n  const pwMsg = document.getElementById('pwMsg');\n  const btnUpdatePassword = document.getElementById('btnUpdatePassword');\n  const btnResetBackMfa = document.getElementById('btnResetBackMfa');\n  const btnGoLogin = document.getElementById('btnGoLogin');\n\n  const helpToggle = document.getElementById('helpToggle');\n  const helpArea = document.getElementById('helpArea');\n\n  function setTab(flow) {\n    state.flow = flow;\n    if (tabLogin) tabLogin.setAttribute('aria-selected', flow === 'login' ? 'true' : 'false');\n    if (tabReset) tabReset.setAttribute('aria-selected', flow === 'reset' ? 'true' : 'false');\n    if (panelLogin) panelLogin.classList.toggle('hidden', flow !== 'login');\n    if (panelReset) panelReset.classList.toggle('hidden', flow !== 'reset');\n    if (flowTitle) flowTitle.textContent = flow === 'login' ? 'Login' : 'Reset your password';\n    if (flowSubtitle) flowSubtitle.textContent = flow === 'login'\n      ? 'Enter your details. If you need help, you can switch to password reset.'\n      : 'Follow the steps below. You can pause anytime and continue later.';\n    render();\n    store.save(state);\n  }\n\n  function render() {\n    if (loginStep1) loginStep1.className = 'step ' + (state.loginStep >= 1 ? (state.loginStep > 1 ? 'done' : 'current') : '');\n    if (loginStep2) loginStep2.className = 'step ' + (state.loginStep > 1 ? 'done' : '');\n\n    if (resetStep1) resetStep1.className = 'step ' + (state.resetStep == 1 ? 'current' : (state.resetStep > 1 ? 'done' : ''));\n    if (resetStep2) resetStep2.className = 'step ' + (state.resetStep == 2 ? 'current' : (state.resetStep > 2 ? 'done' : ''));\n    if (resetStep3) resetStep3.className = 'step ' + (state.resetStep == 3 ? 'current' : (state.resetStep > 3 ? 'done' : ''));\n    if (resetStep4) resetStep4.className = 'step ' + (state.resetStep == 4 ? 'current' : (state.resetStep > 4 ? 'done' : ''));\n\n    if (loginForm) loginForm.classList.toggle('hidden', !(state.flow === 'login' && state.loginStep === 1));\n    if (loginMfa) loginMfa.classList.toggle('hidden', !(state.flow === 'login' && state.loginStep === 2));\n    if (loginSuccess) loginSuccess.classList.toggle('hidden', !(state.flow === 'login' && state.loginStep === 3));\n\n    if (resetStep1El) resetStep1El.classList.toggle('hidden', !(state.flow === 'reset' && state.resetStep === 1));\n    if (resetStep2El) resetStep2El.classList.toggle('hidden', !(state.flow === 'reset' && state.resetStep === 2));\n    if (resetStep3El) resetStep3El.classList.toggle('hidden', !(state.flow === 'reset' && state.resetStep === 3));\n    if (resetStep4El) resetStep4El.classList.toggle('hidden', !(state.flow === 'reset' && state.resetStep === 4));\n    if (resetDoneEl) resetDoneEl.classList.toggle('hidden', !(state.flow === 'reset' && state.resetStep === 5));\n\n    if (state.email) {\n      if (loginEmail) loginEmail.value = state.email;\n      if (resetEmail) resetEmail.value = state.email;\n    }\n  }\n\n  // Toggle help\n  if (helpToggle) {\n    helpToggle.addEventListener('click', () => {\n      const expanded = helpToggle.getAttribute('aria-expanded') === 'true';\n      helpToggle.setAttribute('aria-expanded', expanded ? 'false' : 'true');\n      if (helpArea && helpArea.scrollIntoView) {\n        helpArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });\n      }\n    });\n  }\n\n  // Tabs\n  if (tabLogin) tabLogin.addEventListener('click', () => setTab('login'));\n  if (tabReset) tabReset.addEventListener('click', () => setTab('reset'));\n\n  // Login actions\n  if (btnLoginForgot) btnLoginForgot.addEventListener('click', () => {\n    state.resetStep = 1;\n    setTab('reset');\n  });\n\n  if (btnLogin) btnLogin.addEventListener('click', async () => {\n    const email = (loginEmail && 'value' in loginEmail ? loginEmail.value : '').trim().toLowerCase();\n    const password = (loginPassword && 'value' in loginPassword ? loginPassword.value : '');\n    state.email = email; store.save(state);\n    try {\n      const res = await api('/api/login/start', { email, password });\n      if (res.requireMfa) {\n        console.log('MFA code (login):', res.mfa);\n        state.loginStep = 2; render(); store.save(state);\n        setTimeout(() => { if (loginMfaCode && loginMfaCode.focus) loginMfaCode.focus(); }, 50);\n      } else {\n        state.loginStep = 3; render(); store.save(state);\n      }\n    } catch (e) {\n      const msg = e && e.message ? e.message : 'Login failed';\n      console.log('Login error:', msg);\n      alert('Login failed. Please check details or try reset.');\n    }\n  });\n\n  if (btnLoginMfa) btnLoginMfa.addEventListener('click', async () => {\n    const code = (loginMfaCode && 'value' in loginMfaCode ? loginMfaCode.value : '').replace(/\\\\D/g, '').trim();\n    try {\n      await api('/api/login/verify', { code });\n      state.loginStep = 3; render(); store.save(state);\n    } catch (e) {\n      console.log('MFA error:', e.message || 'Invalid code');\n      alert('Invalid code. Please check Logs for the current code.');\n    }\n  });\n\n  if (btnLoginBack) btnLoginBack.addEventListener('click', () => {\n    state.loginStep = 1; render(); store.save(state);\n  });\n\n  if (btnAcceptPrivacy) btnAcceptPrivacy.addEventListener('click', () => {\n    alert('Privacy statement accepted. Thank you.');\n  });\n\n  if (btnLogout) btnLogout.addEventListener('click', async () => {\n    try { await api('/api/logout', {}); } catch {}\n    state.loginStep = 1; render(); store.save(state);\n  });\n\n  // Reset flow actions\n  if (btnResetToLogin) btnResetToLogin.addEventListener('click', () => {\n    setTab('login');\n  });\n\n  function clientPasswordPolicy(pw) {\n    if (pw.length < 12) return \"Password must be at least 12 characters.\";\n    if (!/[a-z]/.test(pw)) return \"Include a lowercase letter.\";\n    if (!/[A-Z]/.test(pw)) return \"Include an uppercase letter.\";\n    if (!/[0-9]/.test(pw)) return \"Include a number.\";\n    if (!/[^\\\\w\\\\s]/.test(pw)) return \"Include a special character.\";\n    return \"\";\n  }\n\n  if (btnResetRequest) btnResetRequest.addEventListener('click', async () => {\n    const email = (resetEmail && 'value' in resetEmail ? resetEmail.value : '').trim().toLowerCase();\n    state.email = email; store.save(state);\n    if (resetEmailMsg) resetEmailMsg.textContent = \"Working...\";\n    try {\n      const res = await api('/api/reset/request', { email });\n      if (resetEmailMsg) resetEmailMsg.textContent = res && res.message ? res.message : 'If the account exists, instructions were sent. Check Logs.';\n      state.resetStep = 2; render(); store.save(state);\n    } catch (e) {\n      if (resetEmailMsg) resetEmailMsg.textContent = 'Please wait before trying again.';\n      console.log('Reset request throttled or failed:', e.message || '');\n    }\n  });\n\n  if (btnVerifyCode) btnVerifyCode.addEventListener('click', async () => {\n    const code = (resetCode && 'value' in resetCode ? resetCode.value : '').replace(/\\\\D/g, '').trim();\n    if (verifyMsg) verifyMsg.textContent = 'Verifying...';\n    try {\n      await api('/api/reset/verify', { code });\n      state.resetStep = 3; render(); store.save(state);\n      if (verifyMsg) verifyMsg.textContent = 'Verified. Continue with MFA.';\n    } catch (e) {\n      if (verifyMsg) verifyMsg.textContent = 'Invalid or expired code. Please try again.';\n    }\n  });\n\n  if (btnPasteLink) btnPasteLink.addEventListener('click', async () => {\n    const url = new URL(window.location.href);\n    const token = url.searchParams.get('token') || '';\n    if (!token) {\n      if (verifyMsg) verifyMsg.textContent = 'No token found in the address bar. Paste the link here by opening it first.';\n      return;\n    }\n    if (verifyMsg) verifyMsg.textContent = 'Verifying link...';\n    try {\n      await api('/api/reset/verify', { token });\n      state.resetStep = 3; render(); store.save(state);\n      if (verifyMsg) verifyMsg.textContent = 'Verified. Continue with MFA.';\n    } catch (e) {\n      if (verifyMsg) verifyMsg.textContent = 'Invalid or expired link.';\n    }\n  });\n\n  if (btnResetBackV) btnResetBackV.addEventListener('click', () => {\n    state.resetStep = 2; render(); store.save(state);\n  });\n\n  if (btnResetMfa) btnResetMfa.addEventListener('click', async () => {\n    const code = (resetMfa && 'value' in resetMfa ? resetMfa.value : '').replace(/\\\\D/g, '').trim();\n    if (mfaMsg) mfaMsg.textContent = 'Checking code...';\n    try {\n      await api('/api/reset/mfa', { code });\n      state.resetStep = 4; render(); store.save(state);\n      if (mfaMsg) mfaMsg.textContent = '';\n    } catch (e) {\n      if (mfaMsg) mfaMsg.textContent = e.message || 'Invalid code. Please check Logs for the current code.';\n    }\n  });\n\n  if (btnResetBackMfa) btnResetBackMfa.addEventListener('click', () => {\n    state.resetStep = 3; render(); store.save(state);\n  });\n\n  if (btnUpdatePassword) btnUpdatePassword.addEventListener('click', async () => {\n    const a = (newPassword && 'value' in newPassword ? newPassword.value : '');\n    const b = (newPassword2 && 'value' in newPassword2 ? newPassword2.value : '');\n    if (pwMsg) pwMsg.textContent = '';\n    if (a !== b) { if (pwMsg) pwMsg.textContent = 'Passwords do not match.'; return; }\n    const err = clientPasswordPolicy(a);\n    if (err) { if (pwMsg) pwMsg.textContent = err; return; }\n    if (pwMsg) pwMsg.textContent = 'Updating...';\n    try {\n      await api('/api/reset/password', { password: a });\n      state.resetStep = 5; render(); store.save(state);\n      if (pwMsg) pwMsg.textContent = '';\n    } catch (e) {\n      if (pwMsg) pwMsg.textContent = e.message || 'Could not update password.';\n    }\n  });\n\n  if (btnGoLogin) btnGoLogin.addEventListener('click', () => {\n    state.loginStep = 1; setTab('login');\n  });\n\n  // Resume state on load\n  (function init() {\n    const url = new URL(window.location.href);\n    if (url.searchParams.get('token')) {\n      state.flow = 'reset';\n      state.resetStep = Math.max(state.resetStep, 2);\n    }\n    setTab(state.flow);\n    render();\n    if (state.email) {\n      if (loginEmail) loginEmail.value = state.email;\n      if (resetEmail) resetEmail.value = state.email;\n    }\n    console.log('This is a demo. No real emails are sent.');\n    console.log('Security: All sensitive requests require a CSRF token and are rate-limited.');\n  })();\n\n})();\n`;\n}\n\n// ==============================\n// API Handlers\n// ==============================\n\nfunction getClientIP(req: Request): string {\n  const h = req.headers.get(\"x-forwarded-for\") || req.headers.get(\"x-real-ip\") || \"\";\n  const ip = h.split(\",\")[0].trim();\n  return ip || \"127.0.0.1\";\n}\n\nconst JSON_HEADERS = () => {\n  const h = securityHeaders();\n  h.set(\"Content-Type\", \"application/json\");\n  return h;\n};\n\n// POST /api/reset/request\nasync function handleResetRequest(req: Request, session: Session): Promise<Response> {\n  // CSRF validation first (Security 1: CSRF as first operation)\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n\n  // Then rate limiting and input checks\n  const ip = getClientIP(req);\n  const rate = checkRate(ip, \"reset-request:ip\", 5, 60_000);\n  if (!rate.ok) {\n    const h = JSON_HEADERS();\n    h.set(\"Retry-After\", String(rate.retryAfter || 30));\n    return new Response(JSON.stringify({ ok: false, error: \"Too many requests. Please wait.\" }), { status: 429, headers: h });\n  }\n\n  const body = await req.json().catch(() => ({}));\n  const email = String((body.email || \"\")).toLowerCase().trim();\n  if (!email || !email.includes(\"@\")) {\n    // Artificial uniform delay\n    await Bun.sleep(600);\n    return new Response(JSON.stringify({ ok: true, message: \"If the account exists, instructions were sent.\" , log: []}), { status: 200, headers: JSON_HEADERS() });\n  }\n\n  const rateAcc = checkRate(ip, `reset-request:${email}`, 3, 10 * 60_000);\n  if (!rateAcc.ok) {\n    const h = JSON_HEADERS();\n    h.set(\"Retry-After\", String(rateAcc.retryAfter || 60));\n    return new Response(JSON.stringify({ ok: false, error: \"Please wait before trying again.\" }), { status: 429, headers: h });\n  }\n\n  const user = usersByEmail.get(email);\n  let response: any = { ok: true, message: `If the account exists, instructions were sent to ${maskEmail(email)}.`, log: [] as string[] };\n\n  // Generate token, code, and link identically for both real and non-existent accounts\n  const token = randId(32);\n  const createdAt = now();\n  const tokenHash = await sha256Hex(token);\n  const code = numericCodeFromHex(tokenHash, 6);\n  const url = new URL(req.url);\n  const link = `${url.protocol}//${url.host}/?token=${encodeURIComponent(token)}`;\n\n  if (user) {\n    const rec: ResetTokenRecord = { token, userId: user.id, createdAt, used: false, shortCode: code, attempts: 0, mfaAttempts: 0, decoy: false };\n    resetTokens.set(token, rec);\n    resetCodes.set(code, token);\n  } else {\n    // Decoy token indistinguishable to client; passes verify/MFA but won't modify any account\n    const fakeUserId = `decoy:${randId(8)}`;\n    const rec: ResetTokenRecord = { token, userId: fakeUserId, createdAt, used: false, shortCode: code, attempts: 0, mfaAttempts: 0, decoy: true };\n    resetTokens.set(token, rec);\n    resetCodes.set(code, token);\n  }\n\n  response.log.push(`Reset verification link: ${link}`);\n  response.log.push(`Short manual code: ${code}`);\n\n  // Artificial fixed delay to normalize timing regardless of account existence\n  await Bun.sleep(600);\n\n  return new Response(JSON.stringify(response), { status: 200, headers: JSON_HEADERS() });\n}\n\n// POST /api/reset/verify\nasync function handleResetVerify(req: Request, session: Session): Promise<Response> {\n  const ip = getClientIP(req);\n  const rate = checkRate(ip, \"reset-verify\", 10, 60_000);\n  if (!rate.ok) {\n    const h = JSON_HEADERS();\n    h.set(\"Retry-After\", String(rate.retryAfter || 30));\n    return new Response(JSON.stringify({ ok: false, error: \"Too many attempts. Please slow down.\" }), { status: 429, headers: h });\n  }\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n\n  const data = await req.json().catch(() => ({}));\n  const token = typeof data.token === \"string\" ? data.token : null;\n  const code = typeof data.code === \"string\" ? data.code.trim() : null;\n\n  let rec: ResetTokenRecord | undefined;\n  if (token) rec = resetTokens.get(token);\n  else if (code) {\n    // numeric 6-digit codes only\n    if (!/^\\d{6}$/.test(code)) {\n      return new Response(JSON.stringify({ ok: false, error: \"Invalid or expired token.\" }), { status: 400, headers: JSON_HEADERS() });\n    }\n    const t = resetCodes.get(code);\n    if (t) rec = resetTokens.get(t);\n  }\n\n  if (!rec) {\n    return new Response(JSON.stringify({ ok: false, error: \"Invalid or expired token.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n  // Validate not used and not expired (15 minutes)\n  if (rec.used || now() - rec.createdAt > 15 * 60_000) {\n    return new Response(JSON.stringify({ ok: false, error: \"Token expired. Please start over.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n\n  session.reset = { userId: rec.userId, token: rec.token, createdAt: now() };\n  const mfa = await deriveMfaForReset(rec.token);\n  mfaForReset.set(rec.token, mfa);\n\n  const res = { ok: true, next: \"mfa\", log: [`MFA code for reset: ${mfa}`] };\n  return new Response(JSON.stringify(res), { status: 200, headers: JSON_HEADERS() });\n}\n\n// POST /api/reset/mfa\nasync function handleResetMfa(req: Request, session: Session): Promise<Response> {\n  const ip = getClientIP(req);\n  const rate = checkRate(ip, \"reset-mfa\", 10, 60_000);\n  if (!rate.ok) {\n    const h = JSON_HEADERS();\n    h.set(\"Retry-After\", String(rate.retryAfter || 30));\n    return new Response(JSON.stringify({ ok: false, error: \"Too many attempts. Please slow down.\" }), { status: 429, headers: h });\n  }\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n\n  const reset = session.reset;\n  if (!reset) {\n    return new Response(JSON.stringify({ ok: false, error: \"No reset session.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n  const rec = resetTokens.get(reset.token);\n  if (!rec || rec.used || now() - rec.createdAt > 15 * 60_000) {\n    return new Response(JSON.stringify({ ok: false, error: \"Reset session expired.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n  const data = await req.json().catch(() => ({}));\n  const codeRaw = String(data.code || \"\");\n  const code = codeRaw.replace(/\\D/g, \"\").trim();\n  if (!/^\\d{6}$/.test(code)) {\n    return new Response(JSON.stringify({ ok: false, error: \"Invalid code.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n  const expect = mfaForReset.get(rec.token);\n  rec.mfaAttempts++;\n  if (rec.mfaAttempts > 10) {\n    return new Response(JSON.stringify({ ok: false, error: \"Too many attempts.\" }), { status: 429, headers: JSON_HEADERS() });\n  }\n  if (!expect || code !== expect) {\n    return new Response(JSON.stringify({ ok: false, error: \"Invalid code.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n  reset.mfaVerified = true;\n  return new Response(JSON.stringify({ ok: true, next: \"password\" }), { status: 200, headers: JSON_HEADERS() });\n}\n\n// POST /api/reset/password\nasync function handleResetPassword(req: Request, session: Session): Promise<Response> {\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n\n  const reset = session.reset;\n  if (!reset || !reset.mfaVerified) {\n    return new Response(JSON.stringify({ ok: false, error: \"Not authorized for password update.\" }), { status: 403, headers: JSON_HEADERS() });\n  }\n  const rec = resetTokens.get(reset.token);\n  if (!rec || rec.used || now() - rec.createdAt > 15 * 60_000) {\n    return new Response(JSON.stringify({ ok: false, error: \"Reset session expired.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n  const data = await req.json().catch(() => ({}));\n  const password = String(data.password || \"\");\n  const val = validatePasswordPolicy(password);\n  if (!val.ok) {\n    return new Response(JSON.stringify({ ok: false, error: val.message || \"Weak password.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n\n  // If this is a decoy token, behave as success without modifying any account\n  if (rec.decoy) {\n    rec.used = true;\n    mfaForReset.delete(rec.token);\n    resetCodes.delete(rec.shortCode);\n    delete session.reset;\n    return new Response(JSON.stringify({ ok: true, message: \"Password updated.\" }), { status: 200, headers: JSON_HEADERS() });\n  }\n\n  const user = usersById.get(rec.userId);\n  if (!user) {\n    // Treat as generic success to avoid revealing account existence/misconfiguration\n    rec.used = true;\n    mfaForReset.delete(rec.token);\n    resetCodes.delete(rec.shortCode);\n    delete session.reset;\n    return new Response(JSON.stringify({ ok: true, message: \"Password updated.\" }), { status: 200, headers: JSON_HEADERS() });\n  }\n\n  const hash = await Bun.password.hash(password, { algorithm: \"bcrypt\", cost: 10 });\n  user.passwordHash = hash;\n\n  // Invalidate token, MFA, and prior sessions\n  rec.used = true;\n  mfaForReset.delete(rec.token);\n  resetCodes.delete(rec.shortCode);\n  for (const [sid, s] of sessions) {\n    if (s.userId === user.id) sessions.delete(sid);\n  }\n  delete session.reset;\n\n  return new Response(JSON.stringify({ ok: true, message: \"Password updated.\" }), { status: 200, headers: JSON_HEADERS() });\n}\n\n// POST /api/login/start\nasync function handleLoginStart(req: Request, session: Session): Promise<Response> {\n  const ip = getClientIP(req);\n  const rate = checkRate(ip, \"login-start\", 8, 60_000);\n  if (!rate.ok) {\n    const h = JSON_HEADERS();\n    h.set(\"Retry-After\", String(rate.retryAfter || 30));\n    return new Response(JSON.stringify({ ok: false, error: \"Too many attempts. Please wait.\" }), { status: 429, headers: h });\n  }\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n\n  const data = await req.json().catch(() => ({}));\n  const email = String(data.email || \"\").toLowerCase().trim();\n  const password = String(data.password || \"\");\n  const user = usersByEmail.get(email);\n  if (!user) {\n    await Bun.sleep(100);\n    return new Response(JSON.stringify({ ok: false, error: \"Invalid credentials.\" }), { status: 401, headers: JSON_HEADERS() });\n  }\n  const ok = await Bun.password.verify(password, user.passwordHash);\n  if (!ok) {\n    return new Response(JSON.stringify({ ok: false, error: \"Invalid credentials.\" }), { status: 401, headers: JSON_HEADERS() });\n  }\n\n  if (user.mfaEnabled) {\n    const mfa = await deriveMfaForLogin(user.id);\n    mfaForLogin.set(user.id, mfa);\n    session.pendingLoginUserId = user.id;\n    return new Response(JSON.stringify({ ok: true, requireMfa: true, log: [`MFA code (login): ${mfa}`], mfa }), { status: 200, headers: JSON_HEADERS() });\n  } else {\n    session.userId = user.id;\n    return new Response(JSON.stringify({ ok: true, requireMfa: false }), { status: 200, headers: JSON_HEADERS() });\n  }\n}\n\n// POST /api/login/verify\nasync function handleLoginVerify(req: Request, session: Session): Promise<Response> {\n  const ip = getClientIP(req);\n  const rate = checkRate(ip, \"login-verify\", 10, 60_000);\n  if (!rate.ok) {\n    const h = JSON_HEADERS();\n    h.set(\"Retry-After\", String(rate.retryAfter || 30));\n    return new Response(JSON.stringify({ ok: false, error: \"Too many attempts. Please wait.\" }), { status: 429, headers: h });\n  }\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n\n  const uid = session.pendingLoginUserId;\n  if (!uid) {\n    return new Response(JSON.stringify({ ok: false, error: \"No pending login.\" }), { status: 400, headers: JSON_HEADERS() });\n  }\n  const data = await req.json().catch(() => ({}));\n  const codeRaw = String(data.code || \"\");\n  const code = codeRaw.replace(/\\D/g, \"\").trim();\n  if (!/^\\d{6}$/.test(code)) {\n    return new Response(JSON.stringify({ ok: false, error: \"Invalid code.\" }), { status: 401, headers: JSON_HEADERS() });\n  }\n  const expect = mfaForLogin.get(uid) || (await deriveMfaForLogin(uid));\n  if (code !== expect) {\n    return new Response(JSON.stringify({ ok: false, error: \"Invalid code.\" }), { status: 401, headers: JSON_HEADERS() });\n  }\n  session.userId = uid;\n  delete session.pendingLoginUserId;\n  mfaForLogin.delete(uid);\n  return new Response(JSON.stringify({ ok: true }), { status: 200, headers: JSON_HEADERS() });\n}\n\n// POST /api/logout\nasync function handleLogout(req: Request, session: Session): Promise<Response> {\n  const csrfFail = await requireCsrf(req, session);\n  if (csrfFail) return csrfFail;\n  delete session.userId;\n  delete session.pendingLoginUserId;\n  return new Response(JSON.stringify({ ok: true }), { status: 200, headers: JSON_HEADERS() });\n}\n\n// ==============================\n// Router and HTTPS Server\n// ==============================\n\nasync function router(req: Request): Promise<Response> {\n  try {\n    const { session, setCookie } = await getOrCreateSession(req);\n    const url = new URL(req.url);\n    const path = url.pathname;\n    const method = req.method.toUpperCase();\n    const isApi = path.startsWith(\"/api/\");\n\n    // Serve client JS\n    if (method === \"GET\" && path === \"/app.js\") {\n      const h = securityHeaders();\n      h.set(\"Content-Type\", \"application/javascript; charset=utf-8\");\n      if (setCookie) h.set(\"Set-Cookie\", setCookie);\n      return new Response(clientJs(), { status: 200, headers: h });\n    }\n\n    if (method === \"GET\" && !isApi) {\n      const html = spaHtml(session.csrf);\n      const h = securityHeaders();\n      h.set(\"Content-Type\", \"text/html; charset=utf-8\");\n      if (setCookie) h.set(\"Set-Cookie\", setCookie);\n      return new Response(html, { status: 200, headers: h });\n    }\n\n    // API endpoints\n    if (method === \"POST\") {\n      if (path === \"/api/reset/request\") return await handleResetRequest(req, session);\n      if (path === \"/api/reset/verify\") return await handleResetVerify(req, session);\n      if (path === \"/api/reset/mfa\") return await handleResetMfa(req, session);\n      if (path === \"/api/reset/password\") return await handleResetPassword(req, session);\n      if (path === \"/api/login/start\") return await handleLoginStart(req, session);\n      if (path === \"/api/login/verify\") return await handleLoginVerify(req, session);\n      if (path === \"/api/logout\") return await handleLogout(req, session);\n    }\n\n    // Unknown API or method\n    if (isApi) {\n      return new Response(JSON.stringify({ ok: false, error: \"Not found\" }), { status: 404, headers: JSON_HEADERS() });\n    }\n\n    // Fallback to SPA\n    const h = securityHeaders();\n    const html = spaHtml(session.csrf);\n    h.set(\"Content-Type\", \"text/html; charset=utf-8\");\n    return new Response(html, { status: 200, headers: h });\n  } catch (_err) {\n    // Avoid leaking stack traces\n    const h = JSON_HEADERS();\n    return new Response(JSON.stringify({ ok: false, error: \"Internal error\" }), { status: 500, headers: h });\n  }\n}\n\n// Start HTTPS server with mkcert certificates (Security: HTTPS + HSTS)\nconst server = Bun.serve({\n  tls: {\n    certFile: \"certs/cert.pem\",\n    keyFile: \"certs/key.pem\",\n  },\n  port: 8443,\n  fetch: router,\n});\n\nconsole.log(`HTTPS server running on https://localhost:${server.port}`);\n", "task_list": [], "evaluator_md": "SUMMARY\nThe artifact is a single-file Bun 1.3.0 HTTPS server that serves a SPA for secure login and password recovery. It implements CSRF protection, strict security headers (HSTS, CSP, etc.), random short-lived reset tokens, MFA for both login and reset, strong password policy, throttling, and a low-distraction, step-by-step UI with progress, help, and state persistence. All delivery/verification artifacts (links and codes) are console.logged in-browser and mirrored to an on-page log, per the demo requirements. No external assets or network calls are used. The server uses provided TLS certs.\n\nFUNCTIONAL_CHECK\n- Single file app.ts with Bun server + SPA client: PASS — Everything (server, HTML, CSS, JS) resides in app.ts; client JS is served from /app.js generated by the server.\n- HTTPS with mkcert certs and secure headers (HSTS, CSP, etc.): PASS — Uses Bun.serve with tls certs/cert.pem and certs/key.pem; sets HSTS, CSP with script-src 'self', X-Frame-Options DENY, Referrer-Policy no-referrer, Permissions-Policy, and Cache-Control no-store.\n- SPA interactivity works directly in browser (no build tools, no external assets): PASS — Client JS uses fetch to internal /api, no frameworks, no external calls; UI reacts without bundlers.\n- Password reset flow with link + manual code, verifications must work: PASS — /api/reset/request returns and logs reset link and 6-digit code; /api/reset/verify accepts token or code; both verified; MFA then password change.\n- If verification link exists, allow manual code entry too: PASS — Step 2 allows either entering short code or verifying via token present in URL.\n- All internal navigation/flows function correctly: PASS — Tabs, step wizard, “Back” buttons, and “Verify from link” function; token in URL triggers reset step on load.\n- No external network calls: PASS — All fetches go to same-origin /api; no external endpoints.\n- Inclusivity (ADHD): clear steps, progress, no time pressure, reduce distractions, pause/return, easy help: PASS — Progress indicators, clear copy, no session timeouts in UI, localStorage state persistence, Help & Safety panel, forgiving messaging.\n- CSRF protection: unique token per session, validated on sensitive requests: PASS — Per-session CSRF in meta; validated in all POST endpoints (login, verify, reset steps, logout).\n- Prevent information leakage/user enumeration: PASS — Masked email in messages; uniform timing; decoy tokens for non-existent emails behave indistinguishably.\n- Injection (XSS) protections: PASS — No inline scripts; CSP with script-src 'self'; dynamic UI strings applied via textContent; CSRF token escaped server-side; no HTML injection points.\n- Security misconfiguration: HTTPS enforcement + secure headers + token properties: PASS — HSTS, CSP, no debug leaks, random single-use tokens with 15-minute expiry and used-flag.\n- Identification and authentication: bcrypt hashing, MFA, strong password policy, throttling/blocking: PASS — Bun.password.hash bcrypt; MFA for login + reset; 12+ chars and character class checks; rate limits for login and reset endpoints.\n- SSRF/open redirects and social engineering mitigations: PASS — No outgoing URL fetch/redirects; safety tips in Help section.\n- Deliverables: semantic HTML, minimal inline styles, comments mapping to requirements, mocks logged in browser: PASS — Semantic tags with ARIA; mostly CSS in <style>; comments referencing Security/Deliverables; logs displayed and console.logged.\n\nFAILING_ITEMS\n- None identified that violate the stated requirements. Note: The “framework-level auto-escaping” requirement is in tension with “no frameworks”; the implementation mitigates XSS via CSP and strict use of textContent, which is appropriate for vanilla JS.\n\nNEW_TASKS\n- None.\n\nDECISION\nPASS", "done": true, "iter": 3, "step": 9}
