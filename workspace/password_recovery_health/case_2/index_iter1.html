
<!doctype html>
<!--
  Password Recovery System — Requirements (Single-Page, Client-Only, Mocked)

  Purpose:
    - Provide a fully client-side password recovery flow in one HTML file for academic AI evaluation.
    - All "delivery" and verification are simulated in-browser via console.log and deterministic mock values.

  Use-case (Helena):
    - Helena (67) needs to reset a forgotten strong password to access her healthcare account and accept updated privacy conditions.
    - This single-page app walks her through requesting a recovery code, verifying it, and setting a new password.

  Deliverables:
    - One file: index.html
    - Semantic HTML, inline CSS & JS
    - Comments mapping code to this spec
    - No build step, no network requests, no external servers

  Flow steps implemented below:
    1) Recovery Request: identifier input (email/username), validation, deterministic mock code generation, simulate delivery via console.log.
    2) Code Verification: enter code, compare to deterministic value, show success/error, manage keyboard focus, aria-live updates.
    3) Set New Password: validate strength (length + character variety) and confirm match.
    4) Success: show clear success message, simulate confirmation via console.log.
    - A Restart action resets in-memory state and returns to step 1.
-->
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Password Recovery — Client-only Demo</title>
  <style>
    /* Inline CSS — Clear, readable layout (per Deliverables) */
    :root {
      --bg: #f7f7fb;
      --panel: #ffffff;
      --text: #1a1a1a;
      --muted: #555;
      --primary: #2457f5;
      --primary-contrast: #fff;
      --border: #e1e1ea;
      --error: #b00020;
      --success: #0b7a0b;
      --focus: #5a9;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    header {
      background: #0f172a;
      color: #e2e8f0;
      padding: 1rem;
      border-bottom: 4px solid #1e293b;
    }
    header h1 {
      margin: 0;
      font-size: 1.25rem;
    }
    main {
      max-width: 720px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    h2 {
      margin-top: 0;
      font-size: 1.25rem;
    }
    p.help {
      color: var(--muted);
      margin-top: 0.25rem;
    }
    form {
      margin-top: 1rem;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="tel"] {
      width: 100%;
      padding: 0.65rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      background: #fff;
      color: var(--text);
    }
    input[aria-invalid="true"] {
      border-color: var(--error);
      outline-color: var(--error);
    }
    .row {
      margin-bottom: 1rem;
    }
    .actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 0.5rem;
    }
    button {
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 999px;
      background: var(--primary);
      color: var(--primary-contrast);
      font-weight: 600;
      cursor: pointer;
    }
    button.secondary {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    button.link {
      background: transparent;
      color: var(--primary);
      border: none;
      padding: 0.25rem 0.25rem;
    }
    button:focus-visible, a:focus-visible, input:focus-visible {
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }
    .status {
      margin-top: 0.5rem;
      min-height: 1.25rem;
      font-size: 0.95rem;
    }
    .status.error { color: var(--error); }
    .status.success { color: var(--success); }
    .requirements {
      margin: 0.25rem 0 0.75rem 0;
      font-size: 0.95rem;
      color: var(--muted);
    }
    .footer-note {
      margin-top: 1rem;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .center {
      text-align: center;
    }
    .big-check {
      font-size: 3rem;
      line-height: 1;
      margin: 0.25rem 0 0.5rem;
      color: var(--success);
    }
    [hidden] { display: none !important; }
  </style>
</head>
<body>
  <!-- Header with clear title -->
  <header>
    <h1>Password Recovery — Client-only Mock</h1>
  </header>

  <main id="app" role="main">
    <!-- Section: Step 1 — Recovery Request (per Flow step 1) -->
    <section id="step-request" class="panel" aria-labelledby="request-title">
      <h2 id="request-title" tabindex="-1">Recover your account</h2>
      <p class="help" id="request-help">
        Enter your email or username to receive a 6‑digit recovery code. This demo runs entirely in your browser; no real emails/SMS are sent.
      </p>

      <form id="form-request" novalidate>
        <div class="row">
          <label for="identifier">Email or username</label>
          <input id="identifier" name="identifier" type="text" inputmode="email"
                 autocomplete="username" required
                 aria-describedby="request-help request-status"
                 aria-invalid="false" />
        </div>
        <div class="actions">
          <button type="submit" id="btn-request">Send recovery code</button>
          <button type="button" class="secondary" id="btn-reset-app" aria-describedby="restart-hint">Restart</button>
          <span id="restart-hint" class="help">Clears state and returns to this step.</span>
        </div>
        <div id="request-status" class="status" aria-live="polite" role="status"></div>
      </form>
    </section>

    <!-- Section: Step 2 — Code Verification (per Flow step 2) -->
    <section id="step-verify" class="panel" aria-labelledby="verify-title" hidden>
      <h2 id="verify-title" tabindex="-1">Enter your recovery code</h2>
      <p class="help" id="verify-help">
        A 6‑digit code was "sent" to your registered contact method (simulation). Check your console to see the mocked code delivery.
      </p>

      <form id="form-verify" novalidate>
        <div class="row">
          <label for="code">6‑digit code</label>
          <input id="code" name="code" type="tel" inputmode="numeric" pattern="[0-9]{6}" maxlength="6"
                 autocomplete="one-time-code"
                 aria-describedby="verify-help verify-status"
                 aria-invalid="false" required />
        </div>
        <div class="actions">
          <button type="submit" id="btn-verify">Verify code</button>
          <button type="button" class="secondary" id="btn-resend">Resend code (mock)</button>
          <button type="button" class="link" id="btn-change-id">Use different identifier</button>
        </div>
        <div id="verify-status" class="status" aria-live="polite" role="status"></div>
      </form>
    </section>

    <!-- Section: Step 3 — New Password (per Flow step 3) -->
    <section id="step-reset" class="panel" aria-labelledby="reset-title" hidden>
      <h2 id="reset-title" tabindex="-1">Set a new password</h2>
      <p class="help">Choose a strong password. You'll use this to access your healthcare account.</p>

      <form id="form-reset" novalidate>
        <div class="row">
          <label for="password">New password</label>
          <input id="password" name="password" type="password"
                 autocomplete="new-password" required
                 aria-describedby="pw-req reset-status"
                 aria-invalid="false" />
          <div id="pw-req" class="requirements">
            Must be at least 10 characters and include at least one uppercase, one lowercase, one number, and one symbol.
          </div>
        </div>
        <div class="row">
          <label for="confirm">Confirm new password</label>
          <input id="confirm" name="confirm" type="password"
                 autocomplete="new-password" required
                 aria-describedby="reset-status"
                 aria-invalid="false" />
        </div>
        <div class="actions">
          <button type="submit" id="btn-set">Save new password</button>
          <button type="button" class="link" id="btn-back-verify">Back to code</button>
        </div>
        <div id="reset-status" class="status" aria-live="polite" role="status"></div>
      </form>
    </section>

    <!-- Section: Step 4 — Success (per Flow step 4) -->
    <section id="step-done" class="panel center" aria-labelledby="done-title" hidden>
      <div class="big-check" aria-hidden="true">✓</div>
      <h2 id="done-title" tabindex="-1">Password reset complete</h2>
      <p class="help">Your password has been updated. You can now log in and accept the updated privacy statement.</p>
      <div class="actions" style="justify-content:center">
        <button type="button" id="btn-restart" class="secondary">Start over</button>
      </div>
      <p class="footer-note">
        This is a client-only mock. No information left your browser.
      </p>
    </section>

    <p class="footer-note center">
      Note: All actions are simulated locally. Open your browser console to see mock delivery and confirmation logs.
    </p>
  </main>

  <script>
    /*
      Inline JS — All logic runs entirely in-browser (per Deliverables)

      Deterministic mock values (per Requirements):
        - We generate a 6-digit recovery code from the user-provided identifier using the FNV-1a 32-bit hash.
        - Steps:
            1) Normalize identifier (trim, lowercase).
            2) Compute FNV-1a hash → unsigned 32-bit integer.
            3) code = (hash % 1_000_000), zero-padded to 6 digits.
        - This guarantees the same identifier always yields the same code within a session (deterministic and mockable).

      Simulated delivery/verification:
        - "Sending" the code is implemented as console.log with a structured message.
        - Verification compares the entered code against the deterministic mock value in memory.
        - On success, we log a mock confirmation via console.log.

      Accessibility and SPA behavior:
        - Sections are shown/hidden without reloading; focus is moved to the next step's heading or primary input.
        - Status messages use aria-live regions for screen readers.
    */

    // -------------- Utilities (mapping to Flow and Accessibility) --------------
    const qs = sel => document.querySelector(sel);
    const stepEls = {
      request: qs('#step-request'),
      verify: qs('#step-verify'),
      reset: qs('#step-reset'),
      done: qs('#step-done')
    };

    function showStep(name) {
      for (const key in stepEls) {
        stepEls[key].hidden = key !== name;
      }
      // Manage focus for keyboard and assistive tech:
      const step = stepEls[name];
      // Prefer focusing the section's heading; fallback to the first focusable input/button
      const heading = step.querySelector('h2');
      if (heading) {
        heading.focus();
      } else {
        const focusable = step.querySelector('input, button, [tabindex]:not([tabindex="-1"])');
        if (focusable) focusable.focus();
      }
    }

    // Basic string helpers
    const norm = (s) => (s || '').trim().toLowerCase();

    // Basic validation helpers
    function isValidEmail(v) {
      // Simple email pattern (not exhaustive, acceptable for client-side hinting)
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
      return re.test(v);
    }
    function isValidUsername(v) {
      // Letters, numbers, underscore/hyphen, 3-32 chars
      const re = /^[a-zA-Z0-9_-]{3,32}$/;
      return re.test(v);
    }

    // FNV-1a hash (32-bit, unsigned)
    function fnv1a(str) {
      let hash = 0x811c9dc5; // 2166136261
      for (let i = 0; i < str.length; i++) {
        hash ^= str.charCodeAt(i);
        hash = (hash >>> 0) * 0x01000193; // 16777619
        hash >>>= 0;
      }
      return hash >>> 0;
    }

    // Deterministic 6-digit code from identifier (documented above)
    function codeFromIdentifier(identifier) {
      const id = norm(identifier);
      const hash = fnv1a(id);
      const six = (hash % 1000000) >>> 0;
      return six.toString().padStart(6, '0');
    }

    // Password strength check — length and character variety
    function validatePassword(pw) {
      const issues = [];
      if (!pw || pw.length < 10) issues.push('At least 10 characters.');
      if (!/[a-z]/.test(pw)) issues.push('At least one lowercase letter.');
      if (!/[A-Z]/.test(pw)) issues.push('At least one uppercase letter.');
      if (!/[0-9]/.test(pw)) issues.push('At least one number.');
      if (!/[^A-Za-z0-9]/.test(pw)) issues.push('At least one symbol.');
      return { ok: issues.length === 0, issues };
    }

    // -------------- In-memory State (per Requirements) --------------
    const state = {
      identifier: null,
      code: null,
      verified: false
    };

    // -------------- DOM bindings --------------
    const els = {
      // Step 1
      formRequest: qs('#form-request'),
      inputIdentifier: qs('#identifier'),
      statusRequest: qs('#request-status'),
      btnResetApp: qs('#btn-reset-app'),
      // Step 2
      formVerify: qs('#form-verify'),
      inputCode: qs('#code'),
      statusVerify: qs('#verify-status'),
      btnResend: qs('#btn-resend'),
      btnChangeId: qs('#btn-change-id'),
      // Step 3
      formReset: qs('#form-reset'),
      inputPw: qs('#password'),
      inputConfirm: qs('#confirm'),
      statusReset: qs('#reset-status'),
      btnBackVerify: qs('#btn-back-verify'),
      // Step 4
      btnRestart: qs('#btn-restart')
    };

    // -------------- Step Handlers --------------

    // Step 1: Request
    els.formRequest.addEventListener('submit', (e) => {
      e.preventDefault();
      clearStatus(els.statusRequest);
      const raw = els.inputIdentifier.value || '';
      const trimmed = raw.trim();
      const emailLike = isValidEmail(trimmed);
      const userLike = isValidUsername(trimmed);

      if (!trimmed) {
        invalidate(els.inputIdentifier, els.statusRequest, 'Please enter an email or username.');
        return;
      }
      if (!emailLike && !userLike) {
        invalidate(els.inputIdentifier, els.statusRequest, 'Enter a valid email (user@example.com) or username (3–32 letters/numbers).');
        return;
      }

      // Valid identifier — store state and generate deterministic code
      const idNorm = trimmed;
      const code = codeFromIdentifier(idNorm);
      state.identifier = idNorm;
      state.code = code;
      state.verified = false;

      // Simulate delivery — console.log (per Requirements)
      console.log('[Mock Delivery] Recovery code for identifier "%s" is: %s', state.identifier, state.code);

      // UX feedback
      setStatus(els.statusRequest, 'success', 'Recovery code generated and sent (mock). Check the console for details.');
      // Progress to verification after a short tick for SR to announce status
      setTimeout(() => {
        // Clear code input and status
        els.inputCode.value = '';
        clearInvalid(els.inputCode);
        clearStatus(els.statusVerify);
        showStep('verify');
        els.inputCode.focus();
      }, 150);
    });

    els.btnResetApp.addEventListener('click', () => restart());

    // Step 2: Verify
    els.formVerify.addEventListener('submit', (e) => {
      e.preventDefault();
      clearStatus(els.statusVerify);

      if (!state.identifier || !state.code) {
        setStatus(els.statusVerify, 'error', 'Session expired or not initialized. Please start over.');
        return;
      }

      const entered = (els.inputCode.value || '').trim();
      if (!/^\d{6}$/.test(entered)) {
        invalidate(els.inputCode, els.statusVerify, 'Enter the 6‑digit code.');
        return;
      }
      if (entered !== state.code) {
        invalidate(els.inputCode, els.statusVerify, 'That code is not correct. Please try again.');
        return;
      }

      // Verified!
      state.verified = true;
      console.log('[Mock Verification] Code verified for "%s". Proceed to password reset.', state.identifier);

      setStatus(els.statusVerify, 'success', 'Code verified. You may now set a new password.');
      setTimeout(() => {
        els.inputPw.value = '';
        els.inputConfirm.value = '';
        clearInvalid(els.inputPw);
        clearInvalid(els.inputConfirm);
        clearStatus(els.statusReset);
        showStep('reset');
        els.inputPw.focus();
      }, 150);
    });

    els.btnResend.addEventListener('click', () => {
      if (!state.identifier) {
        setStatus(els.statusVerify, 'error', 'No identifier set. Please start over.');
        return;
      }
      // Reuse deterministic code; simulate re-delivery
      console.log('[Mock Delivery] Resent recovery code for "%s": %s', state.identifier, state.code);
      setStatus(els.statusVerify, 'success', 'Code resent (mock). Check the console.');
      els.inputCode.focus();
    });

    els.btnChangeId.addEventListener('click', () => {
      showStep('request');
      els.inputIdentifier.focus();
    });

    // Step 3: Reset password
    els.formReset.addEventListener('submit', (e) => {
      e.preventDefault();
      clearStatus(els.statusReset);

      if (!state.verified) {
        setStatus(els.statusReset, 'error', 'You must verify a code before setting a new password.');
        return;
      }

      const pw = els.inputPw.value || '';
      const cf = els.inputConfirm.value || '';
      const check = validatePassword(pw);

      if (!check.ok) {
        invalidate(els.inputPw, els.statusReset, 'Please strengthen your password: ' + check.issues.join(' '));
        return;
      }
      if (pw !== cf) {
        invalidate(els.inputConfirm, els.statusReset, 'Passwords do not match.');
        return;
      }

      // Success — simulate saving via console.log
      console.log('[Mock Confirmation] Password reset completed for "%s".', state.identifier);

      // Clear sensitive fields and proceed
      els.inputPw.value = '';
      els.inputConfirm.value = '';
      setStatus(els.statusReset, 'success', 'Your password has been updated.');
      setTimeout(() => {
        showStep('done');
      }, 150);
    });

    els.btnBackVerify.addEventListener('click', () => {
      showStep('verify');
      els.inputCode.focus();
    });

    // Step 4: Restart
    if (els.btnRestart) {
      els.btnRestart.addEventListener('click', () => restart());
    }

    // -------------- Status & Validation helpers --------------
    function setStatus(el, type, msg) {
      el.textContent = msg;
      el.classList.remove('error', 'success');
      if (type === 'error') el.classList.add('error');
      if (type === 'success') el.classList.add('success');
    }
    function clearStatus(el) {
      el.textContent = '';
      el.classList.remove('error', 'success');
    }
    function invalidate(input, statusEl, message) {
      input.setAttribute('aria-invalid', 'true');
      setStatus(statusEl, 'error', message);
      input.focus();
    }
    function clearInvalid(input) {
      input.setAttribute('aria-invalid', 'false');
    }

    // -------------- Restart / Reset state --------------
    function restart() {
      // Clear state
      state.identifier = null;
      state.code = null;
      state.verified = false;
      // Clear forms
      els.inputIdentifier.value = '';
      els.inputCode.value = '';
      els.inputPw.value = '';
      els.inputConfirm.value = '';
      // Clear validation and statuses
      clearInvalid(els.inputIdentifier);
      clearInvalid(els.inputCode);
      clearInvalid(els.inputPw);
      clearInvalid(els.inputConfirm);
      clearStatus(els.statusRequest);
      clearStatus(els.statusVerify);
      clearStatus(els.statusReset);
      // Go to first step
      showStep('request');
      els.inputIdentifier.focus();
      console.log('[Mock] App restarted; state cleared.');
    }

    // -------------- Initialize --------------
    // Show initial step and focus identifier for keyboard users
    document.addEventListener('DOMContentLoaded', () => {
      showStep('request');
      els.inputIdentifier.focus();
    });
  </script>
</body>
</html>
