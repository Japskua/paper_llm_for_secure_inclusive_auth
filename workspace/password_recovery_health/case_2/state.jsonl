{"code_html": "\n<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\">\n  <title>Password Recovery (Mock, Client-Only)</title>\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n  <!--\n    Password Recovery System — Single-Page, Client-Only, Mocked\n\n    Spec Mapping (Purpose, Use-case, Deliverables, Mocking):\n    - Purpose: Provide a self-contained, browser-only password recovery flow for evaluation. Not for production.\n    - Use-case: Helena (67, heart disease, ADHD) needs to reset her strong password to log in and accept updated privacy conditions to allow hospital staff to book an appointment.\n    - Deliverables: One index.html (this file) using semantic HTML, inline CSS & JS. No build step. Sections are commented to map to the spec.\n    - Mocking: Delivery and verification are simulated through deterministic code generation and console.log outputs. No servers or external calls.\n\n    Developer testing note:\n    - Open this file in any modern browser (no server needed).\n    - Step 1: Enter an email or username, press Continue. The deterministic 6‑digit code is generated from your input and logged in the console.\n    - Step 2: Enter or paste the 6-digit code from the console to verify. Use \"Resend Code\" to log the same code again.\n    - Step 3: Enter a new password meeting the rules and confirm it. On success, a confirmation screen appears, and the console logs a success message with the user identifier.\n    - Observe mocked outputs in DevTools console.\n  -->\n  <style>\n    /* === Accessibility & Layout CSS (High contrast, readable typography, single-column, visible focus) === */\n    :root {\n      --bg: #ffffff;\n      --fg: #111111;\n      --muted: #555555;\n      --primary: #0b5fff;\n      --danger: #b00020;\n      --success: #137333;\n      --surface: #f5f7fb;\n      --border: #d0d7e2;\n      --focus: #ff9900;\n      --font-size-base: 18px; /* readable typography */\n      --radius: 10px;\n      --space: 16px;\n    }\n    html, body {\n      margin: 0;\n      padding: 0;\n      background: var(--bg);\n      color: var(--fg);\n      font-family: system-ui, -apple-system, Segoe UI, Roboto, \"Helvetica Neue\", Arial, \"Noto Sans\", \"Apple Color Emoji\", \"Segoe UI Emoji\", \"Segoe UI Symbol\";\n      font-size: var(--font-size-base);\n      line-height: 1.5;\n    }\n    header, main, footer {\n      max-width: 720px;\n      margin: 0 auto;\n      padding: 16px;\n    }\n    header {\n      padding-top: 24px;\n      padding-bottom: 8px;\n    }\n    h1, h2, h3 {\n      line-height: 1.2;\n      margin: 0 0 12px;\n    }\n    p {\n      margin: 0 0 12px;\n    }\n    .card {\n      background: var(--surface);\n      border: 1px solid var(--border);\n      border-radius: var(--radius);\n      padding: 16px;\n    }\n    .progress {\n      font-weight: 600;\n      color: var(--muted);\n      margin-bottom: 8px;\n    }\n    label {\n      font-weight: 600;\n      display: block;\n      margin-bottom: 6px;\n    }\n    input[type=\"text\"],\n    input[type=\"email\"],\n    input[type=\"password\"],\n    input[type=\"tel\"] {\n      width: 100%;\n      padding: 12px;\n      font-size: 1rem;\n      border-radius: 8px;\n      border: 2px solid var(--border);\n      background: #fff;\n      color: var(--fg);\n      box-sizing: border-box;\n    }\n    input:focus-visible, button:focus-visible, a:focus-visible {\n      outline: 3px solid var(--focus);\n      outline-offset: 2px;\n    }\n    .helper {\n      color: var(--muted);\n      font-size: 0.95rem;\n      margin-top: 4px;\n    }\n    .error {\n      color: var(--danger);\n      margin-top: 8px;\n      font-weight: 600;\n    }\n    .success {\n      color: var(--success);\n      margin-top: 8px;\n      font-weight: 600;\n    }\n    .actions {\n      display: flex;\n      gap: 12px;\n      flex-wrap: wrap;\n      margin-top: 12px;\n    }\n    button {\n      background: var(--primary);\n      color: #fff;\n      border: none;\n      border-radius: 8px;\n      padding: 12px 16px;\n      font-size: 1rem;\n      cursor: pointer;\n    }\n    button.secondary {\n      background: transparent;\n      color: var(--primary);\n      border: 2px solid var(--primary);\n    }\n    button.linklike {\n      background: transparent;\n      color: var(--primary);\n      border: none;\n      padding: 8px 0;\n      text-decoration: underline;\n    }\n    .sr-only {\n      position: absolute;\n      width: 1px; height: 1px;\n      padding: 0; margin: -1px;\n      overflow: hidden; clip: rect(0,0,0,0);\n      border: 0;\n    }\n    .checklist {\n      list-style: none;\n      padding-left: 0;\n      margin: 8px 0 0;\n    }\n    .checklist li {\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      margin: 4px 0;\n    }\n    .check {\n      width: 1.1em;\n      height: 1.1em;\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n      border-radius: 4px;\n      border: 2px solid var(--border);\n      font-weight: 800;\n      font-size: 0.85em;\n      background: #fff;\n      color: transparent;\n    }\n    .check.pass {\n      border-color: var(--success);\n      background: #e9f6ee;\n      color: var(--success);\n    }\n    .field-row {\n      margin: 12px 0;\n    }\n    .inline {\n      display: inline-flex;\n      align-items: center;\n      gap: 8px;\n    }\n    .toggle-visibility {\n      background: transparent;\n      color: var(--primary);\n      border: none;\n      padding: 6px 8px;\n      cursor: pointer;\n      text-decoration: underline;\n    }\n    .masked-contact {\n      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, \"Liberation Mono\", monospace;\n      background: #fff;\n      border: 1px dashed var(--border);\n      padding: 6px 8px;\n      border-radius: 6px;\n      display: inline-block;\n    }\n    .footer-note {\n      color: var(--muted);\n      font-size: 0.95rem;\n      margin-top: 8px;\n    }\n    /* Responsive single-column is default. Ensure adequate spacing. */\n    .spacer { height: 8px; }\n  </style>\n</head>\n<body>\n  <!-- === Header (Semantic) === -->\n  <header role=\"banner\">\n    <h1 id=\"app-title\">Reset your password</h1>\n    <p class=\"footer-note\">\n      This is a fully client-side, mocked recovery demo for evaluation purposes only.\n    </p>\n  </header>\n\n  <!-- === Main (Flow Steps) === -->\n  <main id=\"app\" role=\"main\" aria-labelledby=\"app-title\">\n    <div id=\"progress\" class=\"progress\" aria-live=\"polite\">Step 1 of 3</div>\n\n    <!-- Global aria-live for announcements (errors and confirmations) -->\n    <div id=\"live-region\" class=\"sr-only\" aria-live=\"polite\"></div>\n\n    <!-- Step 1: Identify account -->\n    <section id=\"step1\" class=\"card\" role=\"region\" aria-labelledby=\"step1-title\">\n      <!-- Spec mapping: Step 1 form with labels, helper text, accessible submit; validate required and email format; errors via aria-live -->\n      <h2 id=\"step1-title\">Find your account</h2>\n      <p>Enter your email address or username to receive a verification code.</p>\n      <form id=\"form-step1\" novalidate>\n        <div class=\"field-row\">\n          <label for=\"identifier\">Email or Username</label>\n          <input id=\"identifier\" name=\"identifier\" type=\"text\" placeholder=\"e.g., helena@example.com or helena67\"\n                 autocomplete=\"username\" required aria-describedby=\"id-helper id-error\">\n          <div id=\"id-helper\" class=\"helper\">We will send a 6-digit code to your contact on file. No emails are sent in this demo.</div>\n          <div id=\"id-error\" class=\"error\" aria-live=\"polite\"></div>\n        </div>\n        <div class=\"actions\">\n          <button id=\"btn-step1\" type=\"submit\">Continue</button>\n        </div>\n      </form>\n    </section>\n\n    <!-- Step 2: Code verification -->\n    <section id=\"step2\" class=\"card\" role=\"region\" aria-labelledby=\"step2-title\" hidden>\n      <!-- Spec mapping: Step 2 with progress indicator, masked contact, code input accepting typing or paste, errors via aria-live -->\n      <h2 id=\"step2-title\">Enter verification code</h2>\n      <p>We sent a 6-digit code to:</p>\n      <p class=\"masked-contact\" id=\"contact-mask\">••••</p>\n      <div class=\"spacer\"></div>\n      <form id=\"form-step2\" novalidate>\n        <div class=\"field-row\">\n          <label for=\"code\">6-digit code</label>\n          <input id=\"code\" name=\"code\" inputmode=\"numeric\" autocomplete=\"one-time-code\"\n                 placeholder=\"123456\" pattern=\"\\\\d{6}\" maxlength=\"6\" aria-describedby=\"code-helper code-error\">\n          <div id=\"code-helper\" class=\"helper\">Type or paste the 6 digits. Only numbers are accepted.</div>\n          <div id=\"code-error\" class=\"error\" aria-live=\"polite\"></div>\n        </div>\n        <div class=\"actions\">\n          <button id=\"btn-verify\" type=\"submit\">Verify Code</button>\n          <button id=\"btn-resend\" type=\"button\" class=\"secondary\">Resend Code</button>\n        </div>\n        <div id=\"resend-msg\" class=\"success\" aria-live=\"polite\" aria-atomic=\"true\"></div>\n      </form>\n    </section>\n\n    <!-- Step 3: Set new password -->\n    <section id=\"step3\" class=\"card\" role=\"region\" aria-labelledby=\"step3-title\" hidden>\n      <!-- Spec mapping: Step 3 with password + confirm, show/hide toggle, strength guidance, live checklist, require confirm match -->\n      <h2 id=\"step3-title\">Create a new password</h2>\n      <p>Choose a strong password that you haven't used with this account before.</p>\n      <form id=\"form-step3\" novalidate>\n        <div class=\"field-row\">\n          <label for=\"new-password\">New password</label>\n          <div class=\"inline\" style=\"width:100%\">\n            <input id=\"new-password\" name=\"new-password\" type=\"password\" autocomplete=\"new-password\"\n                   aria-describedby=\"pw-helper pw-req pw-error\" required>\n            <button type=\"button\" id=\"toggle-pw\" class=\"toggle-visibility\" aria-controls=\"new-password\">Show</button>\n          </div>\n          <div id=\"pw-helper\" class=\"helper\">Your password must meet all of the following:</div>\n          <ul id=\"pw-req\" class=\"checklist\" aria-live=\"polite\" aria-atomic=\"false\">\n            <li><span id=\"rule-length\" class=\"check\" aria-hidden=\"true\">✓</span><span>At least 12 characters</span></li>\n            <li><span id=\"rule-upper\" class=\"check\" aria-hidden=\"true\">✓</span><span>Contains an uppercase letter (A–Z)</span></li>\n            <li><span id=\"rule-lower\" class=\"check\" aria-hidden=\"true\">✓</span><span>Contains a lowercase letter (a–z)</span></li>\n            <li><span id=\"rule-number\" class=\"check\" aria-hidden=\"true\">✓</span><span>Contains a number (0–9)</span></li>\n            <li><span id=\"rule-symbol\" class=\"check\" aria-hidden=\"true\">✓</span><span>Contains a symbol (!@#$…)</span></li>\n          </ul>\n          <div id=\"pw-error\" class=\"error\" aria-live=\"polite\"></div>\n        </div>\n\n        <div class=\"field-row\">\n          <label for=\"confirm-password\">Confirm new password</label>\n          <div class=\"inline\" style=\"width:100%\">\n            <input id=\"confirm-password\" name=\"confirm-password\" type=\"password\" autocomplete=\"new-password\"\n                   aria-describedby=\"confirm-error\" required>\n            <button type=\"button\" id=\"toggle-confirm\" class=\"toggle-visibility\" aria-controls=\"confirm-password\">Show</button>\n          </div>\n          <div id=\"confirm-error\" class=\"error\" aria-live=\"polite\"></div>\n        </div>\n\n        <div class=\"actions\">\n          <button id=\"btn-reset\" type=\"submit\" disabled>Reset password</button>\n        </div>\n      </form>\n    </section>\n\n    <!-- Done: Confirmation -->\n    <section id=\"done\" class=\"card\" role=\"region\" aria-labelledby=\"done-title\" hidden>\n      <!-- Spec mapping: Confirmation with next steps; console success logged -->\n      <h2 id=\"done-title\">Password updated</h2>\n      <p>Your password has been reset successfully.</p>\n      <ul>\n        <li>You can now sign in with your new password.</li>\n        <li>After signing in, please review and accept the updated privacy conditions so hospital staff can assist with booking your appointment.</li>\n      </ul>\n      <p class=\"footer-note\">Tip: For memory support, consider using a password manager. Avoid writing passwords where others might see them.</p>\n      <div class=\"actions\">\n        <button type=\"button\" id=\"btn-restart\" class=\"secondary\">Start over</button>\n      </div>\n    </section>\n  </main>\n\n  <!-- === Footer (Semantic) === -->\n  <footer role=\"contentinfo\">\n    <p class=\"footer-note\">\n      Mocked client-side demo. No data is transmitted. Console shows simulated delivery and verification.\n    </p>\n  </footer>\n\n  <script>\n    // === JS: Single-file client-only app state and handlers ===\n    // Spec mapping (Mocking): Deterministic code generation and console.log simulate delivery/verification.\n    // Spec mapping (In-page state): URL hash reflects step; state restored from sessionStorage on reload.\n    (function () {\n      'use strict';\n\n      // App state model kept in-memory and mirrored to sessionStorage\n      const defaultState = { step: 1, identifier: '', contactMask: '', code: '' };\n      let appState = loadState() || { ...defaultState };\n\n      // Element refs\n      const sections = {\n        step1: document.getElementById('step1'),\n        step2: document.getElementById('step2'),\n        step3: document.getElementById('step3'),\n        done: document.getElementById('done')\n      };\n      const progressEl = document.getElementById('progress');\n      const liveRegion = document.getElementById('live-region');\n      // Step 1\n      const form1 = document.getElementById('form-step1');\n      const idInput = document.getElementById('identifier');\n      const idError = document.getElementById('id-error');\n      const btn1 = document.getElementById('btn-step1');\n      // Step 2\n      const form2 = document.getElementById('form-step2');\n      const codeInput = document.getElementById('code');\n      const codeError = document.getElementById('code-error');\n      const contactMaskEl = document.getElementById('contact-mask');\n      const btnVerify = document.getElementById('btn-verify');\n      const btnResend = document.getElementById('btn-resend');\n      const resendMsg = document.getElementById('resend-msg');\n      // Step 3\n      const form3 = document.getElementById('form-step3');\n      const newPw = document.getElementById('new-password');\n      const confirmPw = document.getElementById('confirm-password');\n      const togglePw = document.getElementById('toggle-pw');\n      const toggleConfirm = document.getElementById('toggle-confirm');\n      const pwError = document.getElementById('pw-error');\n      const confirmError = document.getElementById('confirm-error');\n      const btnReset = document.getElementById('btn-reset');\n      const ruleEls = {\n        length: document.getElementById('rule-length'),\n        upper: document.getElementById('rule-upper'),\n        lower: document.getElementById('rule-lower'),\n        number: document.getElementById('rule-number'),\n        symbol: document.getElementById('rule-symbol')\n      };\n      // Done\n      const btnRestart = document.getElementById('btn-restart');\n\n      // Initialize: restore from hash + session state\n      initFromHashOrDefault();\n\n      // === Event wiring ===\n      form1.addEventListener('submit', onSubmitStep1);\n      form2.addEventListener('submit', onSubmitStep2);\n      btnResend.addEventListener('click', onResend);\n      codeInput.addEventListener('input', onCodeInput);\n      codeInput.addEventListener('paste', onCodePaste);\n      form3.addEventListener('submit', onSubmitStep3);\n      newPw.addEventListener('input', onPasswordInput);\n      confirmPw.addEventListener('input', onConfirmInput);\n      togglePw.addEventListener('click', () => toggleVisibility(newPw, togglePw));\n      toggleConfirm.addEventListener('click', () => toggleVisibility(confirmPw, toggleConfirm));\n      btnRestart.addEventListener('click', () => {\n        appState = { ...defaultState };\n        saveState();\n        setStep(1);\n      });\n      window.addEventListener('hashchange', onHashChange);\n\n      // === Functions (Spec mapping: Mocking, Validation, Navigation, Accessibility) ===\n\n      // Hash and state bootstrap\n      function initFromHashOrDefault() {\n        const targetStep = parseStepFromHash();\n        const stored = loadState();\n        if (stored) appState = stored;\n        if (Number.isInteger(targetStep) && targetStep >= 1 && targetStep <= 4) {\n          // Ensure prerequisites exist for deeper steps\n          if (targetStep === 1) setStep(1);\n          else if (targetStep === 2 && appState.identifier) setStep(2);\n          else if (targetStep === 3 && appState.identifier) setStep(3);\n          else if (targetStep === 4 && appState.identifier) setStep(4);\n          else setStep(1);\n        } else {\n          setStep(appState.step || 1);\n        }\n      }\n\n      function onHashChange() {\n        const targetStep = parseStepFromHash();\n        if (!Number.isInteger(targetStep)) return;\n        // Only allow forward navigation if we have required state\n        if (targetStep === 1) setStep(1);\n        if (targetStep === 2 && appState.identifier) setStep(2);\n        if (targetStep === 3 && appState.identifier) setStep(3);\n        if (targetStep === 4 && appState.identifier) setStep(4);\n      }\n\n      function parseStepFromHash() {\n        const h = location.hash.replace('#', '');\n        switch (h) {\n          case 'step1': return 1;\n          case 'step2': return 2;\n          case 'step3': return 3;\n          case 'done': return 4;\n          default: return null;\n        }\n      }\n\n      function updateHash() {\n        const map = { 1: 'step1', 2: 'step2', 3: 'step3', 4: 'done' };\n        const hash = '#' + map[appState.step];\n        if (location.hash !== hash) {\n          history.replaceState(null, '', hash);\n        }\n      }\n\n      function setStep(stepNumber) {\n        appState.step = stepNumber;\n        saveState();\n        updateHash();\n        // Toggle sections\n        sections.step1.hidden = stepNumber !== 1;\n        sections.step2.hidden = stepNumber !== 2;\n        sections.step3.hidden = stepNumber !== 3;\n        sections.done.hidden = stepNumber !== 4;\n        // Update progress text\n        if (stepNumber >= 1 && stepNumber <= 3) {\n          progressEl.textContent = `Step ${stepNumber} of 3`;\n          progressEl.hidden = false;\n        } else {\n          progressEl.hidden = true;\n        }\n        // On step entry, manage content and focus\n        switch (stepNumber) {\n          case 1:\n            announce('');\n            idError.textContent = '';\n            focusHeadingOrField('step1-title', idInput);\n            break;\n          case 2:\n            // Populate masked contact\n            appState.contactMask = appState.contactMask || maskContact(appState.identifier);\n            contactMaskEl.textContent = appState.contactMask;\n            codeInput.value = '';\n            codeError.textContent = '';\n            resendMsg.textContent = '';\n            // On step change, \"send\" mock code deterministically\n            appState.code = generateCode(appState.identifier);\n            saveState();\n            mockDeliverCode(appState.identifier, appState.code, appState.contactMask);\n            // Focus\n            focusHeadingOrField('step2-title', codeInput);\n            break;\n          case 3:\n            newPw.value = '';\n            confirmPw.value = '';\n            pwError.textContent = '';\n            confirmError.textContent = '';\n            btnReset.disabled = true;\n            updateChecklist('');\n            focusHeadingOrField('step3-title', newPw);\n            break;\n          case 4:\n            focusHeadingOrField('done-title', null);\n            break;\n        }\n      }\n\n      // Step 1: Submit\n      function onSubmitStep1(e) {\n        e.preventDefault();\n        idError.textContent = '';\n        const raw = (idInput.value || '').trim();\n        const err = validateIdentifier(raw);\n        if (err) {\n          idError.textContent = err;\n          announce(err);\n          idInput.focus();\n          return;\n        }\n        appState.identifier = raw;\n        appState.contactMask = maskContact(raw);\n        appState.code = generateCode(raw);\n        saveState();\n        // Mock: \"send\" recovery code\n        mockDeliverCode(appState.identifier, appState.code, appState.contactMask);\n        setStep(2);\n      }\n\n      // Step 2: Input and submit\n      function onCodeInput(e) {\n        // Filter to digits only\n        const digits = (e.target.value || '').replace(/\\D+/g, '').slice(0, 6);\n        if (digits !== e.target.value) e.target.value = digits;\n        codeError.textContent = '';\n      }\n      function onCodePaste(e) {\n        const text = (e.clipboardData || window.clipboardData).getData('text') || '';\n        const digits = text.replace(/\\D+/g, '').slice(0, 6);\n        if (digits) {\n          e.preventDefault();\n          codeInput.value = digits;\n        }\n      }\n      function onSubmitStep2(e) {\n        e.preventDefault();\n        codeError.textContent = '';\n        const val = (codeInput.value || '').trim();\n        if (!/^\\d{6}$/.test(val)) {\n          const msg = 'Enter the 6-digit code.';\n          codeError.textContent = msg;\n          announce(msg);\n          codeInput.focus();\n          return;\n        }\n        const expected = appState.code || generateCode(appState.identifier);\n        if (val !== expected) {\n          const msg = 'That code is not correct. Try again, or resend the code.';\n          codeError.textContent = msg;\n          announce(msg);\n          codeInput.focus();\n          return;\n        }\n        setStep(3);\n      }\n      function onResend() {\n        resendMsg.textContent = 'Code resent. Please check the console output.';\n        announce('A new code has been resent.');\n        const code = appState.code || generateCode(appState.identifier);\n        mockDeliverCode(appState.identifier, code, appState.contactMask, /*resend*/true);\n      }\n\n      // Step 3: Password rules\n      function onPasswordInput() {\n        const pwd = newPw.value || '';\n        updateChecklist(pwd);\n        pwError.textContent = '';\n        // Enable submit only when all rules pass and confirm matches\n        btnReset.disabled = !(allRulesPass(pwd) && passwordsMatch());\n      }\n      function onConfirmInput() {\n        confirmError.textContent = '';\n        btnReset.disabled = !(allRulesPass(newPw.value || '') && passwordsMatch());\n      }\n      function passwordsMatch() {\n        return (newPw.value || '') === (confirmPw.value || '');\n      }\n      function allRulesPass(pwd) {\n        return pwd.length >= 12 &&\n               /[A-Z]/.test(pwd) &&\n               /[a-z]/.test(pwd) &&\n               /\\d/.test(pwd) &&\n               /[^A-Za-z0-9]/.test(pwd);\n      }\n      function updateChecklist(pwd) {\n        const rules = {\n          length: (pwd.length >= 12),\n          upper: (/[A-Z]/.test(pwd)),\n          lower: (/[a-z]/.test(pwd)),\n          number: (/\\d/.test(pwd)),\n          symbol: (/[^A-Za-z0-9]/.test(pwd))\n        };\n        Object.keys(rules).forEach(key => {\n          ruleEls[key].classList.toggle('pass', !!rules[key]);\n          ruleEls[key].setAttribute('aria-label', rules[key] ? 'Pass' : 'Fail');\n        });\n        // Show live feedback if user typed but rules not met\n        if (pwd && !allRulesPass(pwd)) {\n          pwError.textContent = 'Password does not meet all requirements.';\n        } else {\n          pwError.textContent = '';\n        }\n        // Confirm mismatch feedback\n        if (confirmPw.value && !passwordsMatch()) {\n          confirmError.textContent = 'Passwords do not match.';\n        } else {\n          confirmError.textContent = '';\n        }\n      }\n\n      // Step 3: Submit\n      function onSubmitStep3(e) {\n        e.preventDefault();\n        const pwd = newPw.value || '';\n        const confirm = confirmPw.value || '';\n        let localError = '';\n        if (!allRulesPass(pwd)) {\n          localError = 'Password does not meet all requirements.';\n          pwError.textContent = localError;\n          announce(localError);\n          newPw.focus();\n          return;\n        }\n        if (pwd !== confirm) {\n          localError = 'Passwords do not match.';\n          confirmError.textContent = localError;\n          announce(localError);\n          confirmPw.focus();\n          return;\n        }\n        // Mock success\n        console.log(`Mock: Password reset SUCCESS for identifier '${appState.identifier}'.`);\n        setStep(4);\n      }\n\n      // Utilities\n      function validateIdentifier(input) {\n        if (!input) return 'Please enter your email or username.';\n        if (input.includes('@')) {\n          // Simple email format check\n          const emailOk = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(input);\n          if (!emailOk) return 'Please enter a valid email address.';\n        } else {\n          // Username: at least 3 characters\n          if (input.length < 3) return 'Please enter a valid username (3 or more characters).';\n        }\n        return '';\n      }\n\n      function maskContact(identifier) {\n        if (identifier.includes('@')) {\n          const [local, domain] = identifier.split('@');\n          const maskedLocal = maskMiddle(local);\n          const domainParts = domain.split('.');\n          const domainName = domainParts[0] || '';\n          const domainTld = domainParts.slice(1).join('.') || '';\n          const maskedDomain = maskMiddle(domainName);\n          return `${maskedLocal}@${maskedDomain}${domainTld ? '.' + domainTld : ''}`;\n        } else {\n          return maskMiddle(identifier);\n        }\n      }\n\n      function maskMiddle(str) {\n        if (str.length <= 2) return str[0] + '•'.repeat(Math.max(0, str.length - 1));\n        const first = str[0];\n        const last = str[str.length - 1];\n        return `${first}${'•'.repeat(Math.max(1, str.length - 2))}${last}`;\n      }\n\n      // Deterministic 6-digit code generator (Spec mapping: Mocking)\n      function generateCode(identifier) {\n        let hash = 0;\n        const prime = 1315423911;\n        for (let i = 0; i < identifier.length; i++) {\n          hash ^= ((hash << 5) + identifier.charCodeAt(i) + (hash >> 2));\n        }\n        hash ^= prime;\n        const code = Math.abs(hash) % 1000000;\n        return String(code).padStart(6, '0');\n      }\n\n      // Mock delivery via console.log\n      function mockDeliverCode(identifier, code, mask, isResend = false) {\n        const action = isResend ? 'RESEND' : 'SEND';\n        console.log(`Mock ${action}: Recovery code for '${identifier}' is ${code} (to ${mask})`);\n        announce(isResend ? 'A new code has been resent.' : 'A verification code has been sent.');\n      }\n\n      // Accessibility: Live region announcer\n      function announce(message) {\n        if (!message) {\n          liveRegion.textContent = '';\n          return;\n        }\n        liveRegion.textContent = message;\n      }\n\n      // Toggle show/hide password\n      function toggleVisibility(inputEl, toggleBtn) {\n        const isPassword = inputEl.type === 'password';\n        inputEl.type = isPassword ? 'text' : 'password';\n        toggleBtn.textContent = isPassword ? 'Hide' : 'Show';\n      }\n\n      // Focus management on step change\n      function focusHeadingOrField(headingId, fieldEl) {\n        const heading = document.getElementById(headingId);\n        if (heading) {\n          heading.setAttribute('tabindex', '-1');\n          heading.focus();\n          // Cleanup tabindex after focus\n          setTimeout(() => heading.removeAttribute('tabindex'), 0);\n        }\n        if (fieldEl) {\n          setTimeout(() => fieldEl.focus(), 50);\n        }\n      }\n\n      // State persistence\n      function saveState() {\n        try {\n          sessionStorage.setItem('recoveryState', JSON.stringify(appState));\n        } catch (_) {}\n      }\n      function loadState() {\n        try {\n          const raw = sessionStorage.getItem('recoveryState');\n          return raw ? JSON.parse(raw) : null;\n        } catch (_) {\n          return null;\n        }\n      }\n\n      // Keyboard: Enter to submit is default via forms; tab order follows DOM.\n    })();\n  </script>\n</body>\n</html>\n", "task_list": ["Add a visually hidden status text element per rule and update it as rules change.", "Example markup per list item:", "<li><span class=\"check\" aria-hidden=\"true\">✓</span><span>At least 12 characters</span><span id=\"rule-length-status\" class=\"sr-only\">Not met</span></li>", "In updateChecklist(), set the corresponding -status element text to \"Met\" or \"Not met\" and leave the UL as aria-live=\"polite\" so changes are announced."], "evaluator_md": "SUMMARY\nThe artifact is a single-file, client-only password recovery flow that closely follows the stated requirements. It implements a 3-step process with deterministic, mocked code delivery and verification via console.log, clear validations, and an accessible, single-column UI with visible focus, larger base font size, and focus management. One accessibility gap remains: screen readers are not informed when password rule checks pass/fail in real time due to aria-hidden usage on the checklist icons. Minor cleanup is also identified but does not affect core functionality.\n\nFUNCTIONAL_CHECK\n- AC1 — Single deliverable, inline CSS & JS, semantic HTML, comment mapping to spec: PASS\n  Justification: One index.html file with header/main/footer/section semantics, inline styles/scripts, and comments mapping to spec sections.\n\n- AC2 — Client-only; no backend or external network calls: PASS\n  Justification: No fetch/XHR; logic entirely in browser; mocking via console.log.\n\n- AC3 — Deterministic mocking: code generation and “delivery” via console.log: PASS\n  Justification: generateCode(identifier) is deterministic; mockDeliverCode logs code and mask.\n\n- AC4 — 3-step flow plus confirmation screen: PASS\n  Justification: Step 1 identify, Step 2 code, Step 3 new password, then confirmation.\n\n- AC5 — Identifier input validates email or username with accessible feedback: PASS\n  Justification: validateIdentifier enforces email pattern or username length; errors shown via aria-live and aria-describedby; focus returns to field.\n\n- AC6 — Contact masking displayed to user: PASS\n  Justification: maskContact/maskMiddle produce masked email/username and display in Step 2.\n\n- AC7 — 6-digit code generation and resend logs the same code: PASS\n  Justification: Deterministic code stored in appState; resend uses same code and logs via console.\n\n- AC8 — Code entry accepts only digits, supports paste, enforces 6 digits, accessible errors: PASS\n  Justification: input filtering and paste handler strip non-digits; JS validation enforces /^\\d{6}$/; errors via aria-live; helper text provided.\n\n- AC9 — Progress indication (Step X of 3): PASS\n  Justification: Updates on step changes and hides on completion.\n\n- AC10 — Password rules enforced with live checklist; confirm match; show/hide toggles: PASS\n  Justification: Rules: length 12+, upper, lower, number, symbol; dynamic checklist; mismatch error; toggles for visibility.\n\n- AC11 — Submit disabled until requirements met and passwords match: PASS\n  Justification: btnReset disabled until allRulesPass and passwordsMatch.\n\n- AC12 — Accessibility basics for forms and navigation: PASS\n  Justification: Labels, aria-describedby for helpers/errors, global live region for announcements, focus management to headings/fields, visible focus, adequate font size, single-column layout, keyboard-friendly controls.\n\n- AC13 — Screen-reader perceivable feedback for live password rule changes: FAIL\n  Justification: Checklist “check” icons are aria-hidden and only receive aria-label updates; because they are aria-hidden, SR users will not hear pass/fail state changes. The UL is aria-live, but no text nodes change that SR can perceive.\n\n- AC14 — Confirmation behavior and console success log: PASS\n  Justification: Confirmation screen appears; console logs success; “Start over” resets state.\n\nFAILING_ITEMS\n- Password rule checklist a11y: Pass/fail state changes are not announced to screen readers because the “check” spans are aria-hidden and only their classes/aria-label are updated. No perceptible text updates exist within the aria-live region for SR users.\n\nNEW_TASKS\n1) Make password rule state changes perceivable to screen readers:\n   - Add a visually hidden status text element per rule and update it as rules change.\n   - Example markup per list item:\n     - <li><span class=\"check\" aria-hidden=\"true\">✓</span><span>At least 12 characters</span><span id=\"rule-length-status\" class=\"sr-only\">Not met</span></li>\n   - In updateChecklist(), set the corresponding -status element text to \"Met\" or \"Not met\" and leave the UL as aria-live=\"polite\" so changes are announced.\n2) Remove aria-hidden=\"true\" from the “check” icon spans if you intend to use aria-label on them; or keep aria-hidden on icons and rely solely on the new status text in each LI. Do not use aria-label on aria-hidden elements.\n\nDECISION\nFAIL", "done": false, "iter": 1, "step": 3}
{"code_html": "\n<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\">\n  <title>Password Recovery (Mock, Client-Only)</title>\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n  <!--\n    Password Recovery System — Single-Page, Client-Only, Mocked\n\n    Spec Mapping (Purpose, Use-case, Deliverables, Mocking):\n    - Purpose: Provide a self-contained, browser-only password recovery flow for evaluation. Not for production.\n    - Use-case: Helena (67, heart disease, ADHD) needs to reset her strong password to log in and accept updated privacy conditions to allow hospital staff to book an appointment.\n    - Deliverables: One index.html (this file) using semantic HTML, inline CSS & JS. No build step. Sections are commented to map to the spec.\n    - Mocking: Delivery and verification are simulated through deterministic code generation and console.log outputs. No servers or external calls.\n\n    Developer testing note:\n    - Open this file in any modern browser (no server needed).\n    - Step 1: Enter an email or username, press Continue. The deterministic 6‑digit code is generated from your input and logged in the console.\n    - Step 2: Enter or paste the 6-digit code from the console to verify. Use \"Resend Code\" to log the same code again.\n    - Step 3: Enter a new password meeting the rules and confirm it. On success, a confirmation screen appears, and the console logs a success message with the user identifier.\n    - Observe mocked outputs in DevTools console.\n  -->\n  <style>\n    /* === Accessibility & Layout CSS (High contrast, readable typography, single-column, visible focus) === */\n    :root {\n      --bg: #ffffff;\n      --fg: #111111;\n      --muted: #555555;\n      --primary: #0b5fff;\n      --danger: #b00020;\n      --success: #137333;\n      --surface: #f5f7fb;\n      --border: #d0d7e2;\n      --focus: #ff9900;\n      --font-size-base: 18px; /* readable typography */\n      --radius: 10px;\n      --space: 16px;\n    }\n    html, body {\n      margin: 0;\n      padding: 0;\n      background: var(--bg);\n      color: var(--fg);\n      font-family: system-ui, -apple-system, Segoe UI, Roboto, \"Helvetica Neue\", Arial, \"Noto Sans\", \"Apple Color Emoji\", \"Segoe UI Emoji\", \"Segoe UI Symbol\";\n      font-size: var(--font-size-base);\n      line-height: 1.5;\n    }\n    header, main, footer {\n      max-width: 720px;\n      margin: 0 auto;\n      padding: 16px;\n    }\n    header {\n      padding-top: 24px;\n      padding-bottom: 8px;\n    }\n    h1, h2, h3 {\n      line-height: 1.2;\n      margin: 0 0 12px;\n    }\n    p {\n      margin: 0 0 12px;\n    }\n    .card {\n      background: var(--surface);\n      border: 1px solid var(--border);\n      border-radius: var(--radius);\n      padding: 16px;\n    }\n    .progress {\n      font-weight: 600;\n      color: var(--muted);\n      margin-bottom: 8px;\n    }\n    label {\n      font-weight: 600;\n      display: block;\n      margin-bottom: 6px;\n    }\n    input[type=\"text\"],\n    input[type=\"email\"],\n    input[type=\"password\"],\n    input[type=\"tel\"] {\n      width: 100%;\n      padding: 12px;\n      font-size: 1rem;\n      border-radius: 8px;\n      border: 2px solid var(--border);\n      background: #fff;\n      color: var(--fg);\n      box-sizing: border-box;\n    }\n    input:focus-visible, button:focus-visible, a:focus-visible {\n      outline: 3px solid var(--focus);\n      outline-offset: 2px;\n    }\n    .helper {\n      color: var(--muted);\n      font-size: 0.95rem;\n      margin-top: 4px;\n    }\n    .error {\n      color: var(--danger);\n      margin-top: 8px;\n      font-weight: 600;\n    }\n    .success {\n      color: var(--success);\n      margin-top: 8px;\n      font-weight: 600;\n    }\n    .actions {\n      display: flex;\n      gap: 12px;\n      flex-wrap: wrap;\n      margin-top: 12px;\n    }\n    button {\n      background: var(--primary);\n      color: #fff;\n      border: none;\n      border-radius: 8px;\n      padding: 12px 16px;\n      font-size: 1rem;\n      cursor: pointer;\n    }\n    button.secondary {\n      background: transparent;\n      color: var(--primary);\n      border: 2px solid var(--primary);\n    }\n    button.linklike {\n      background: transparent;\n      color: var(--primary);\n      border: none;\n      padding: 8px 0;\n      text-decoration: underline;\n    }\n    .sr-only {\n      position: absolute;\n      width: 1px; height: 1px;\n      padding: 0; margin: -1px;\n      overflow: hidden; clip: rect(0,0,0,0);\n      border: 0;\n    }\n    .checklist {\n      list-style: none;\n      padding-left: 0;\n      margin: 8px 0 0;\n    }\n    .checklist li {\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      margin: 4px 0;\n    }\n    .check {\n      width: 1.1em;\n      height: 1.1em;\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n      border-radius: 4px;\n      border: 2px solid var(--border);\n      font-weight: 800;\n      font-size: 0.85em;\n      background: #fff;\n      color: transparent;\n    }\n    .check.pass {\n      border-color: var(--success);\n      background: #e9f6ee;\n      color: var(--success);\n    }\n    .field-row {\n      margin: 12px 0;\n    }\n    .inline {\n      display: inline-flex;\n      align-items: center;\n      gap: 8px;\n    }\n    .toggle-visibility {\n      background: transparent;\n      color: var(--primary);\n      border: none;\n      padding: 6px 8px;\n      cursor: pointer;\n      text-decoration: underline;\n    }\n    .masked-contact {\n      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, \"Liberation Mono\", monospace;\n      background: #fff;\n      border: 1px dashed var(--border);\n      padding: 6px 8px;\n      border-radius: 6px;\n      display: inline-block;\n    }\n    .footer-note {\n      color: var(--muted);\n      font-size: 0.95rem;\n      margin-top: 8px;\n    }\n    /* Responsive single-column is default. Ensure adequate spacing. */\n    .spacer { height: 8px; }\n  </style>\n</head>\n<body>\n  <!-- === Header (Semantic) === -->\n  <header role=\"banner\">\n    <h1 id=\"app-title\">Reset your password</h1>\n    <p class=\"footer-note\">\n      This is a fully client-side, mocked recovery demo for evaluation purposes only.\n    </p>\n  </header>\n\n  <!-- === Main (Flow Steps) === -->\n  <main id=\"app\" role=\"main\" aria-labelledby=\"app-title\">\n    <div id=\"progress\" class=\"progress\" aria-live=\"polite\">Step 1 of 3</div>\n\n    <!-- Global aria-live for announcements (errors and confirmations) -->\n    <div id=\"live-region\" class=\"sr-only\" aria-live=\"polite\"></div>\n\n    <!-- Step 1: Identify account -->\n    <section id=\"step1\" class=\"card\" role=\"region\" aria-labelledby=\"step1-title\">\n      <!-- Spec mapping: Step 1 form with labels, helper text, accessible submit; validate required and email format; errors via aria-live -->\n      <h2 id=\"step1-title\">Find your account</h2>\n      <p>Enter your email address or username to receive a verification code.</p>\n      <form id=\"form-step1\" novalidate>\n        <div class=\"field-row\">\n          <label for=\"identifier\">Email or Username</label>\n          <input id=\"identifier\" name=\"identifier\" type=\"text\" placeholder=\"e.g., helena@example.com or helena67\"\n                 autocomplete=\"username\" required aria-describedby=\"id-helper id-error\">\n          <div id=\"id-helper\" class=\"helper\">We will send a 6-digit code to your contact on file. No emails are sent in this demo.</div>\n          <div id=\"id-error\" class=\"error\" aria-live=\"polite\"></div>\n        </div>\n        <div class=\"actions\">\n          <button id=\"btn-step1\" type=\"submit\">Continue</button>\n        </div>\n      </form>\n    </section>\n\n    <!-- Step 2: Code verification -->\n    <section id=\"step2\" class=\"card\" role=\"region\" aria-labelledby=\"step2-title\" hidden>\n      <!-- Spec mapping: Step 2 with progress indicator, masked contact, code input accepting typing or paste, errors via aria-live -->\n      <h2 id=\"step2-title\">Enter verification code</h2>\n      <p>We sent a 6-digit code to:</p>\n      <p class=\"masked-contact\" id=\"contact-mask\">••••</p>\n      <div class=\"spacer\"></div>\n      <form id=\"form-step2\" novalidate>\n        <div class=\"field-row\">\n          <label for=\"code\">6-digit code</label>\n          <input id=\"code\" name=\"code\" inputmode=\"numeric\" autocomplete=\"one-time-code\"\n                 placeholder=\"123456\" pattern=\"\\\\d{6}\" maxlength=\"6\" aria-describedby=\"code-helper code-error\">\n          <div id=\"code-helper\" class=\"helper\">Type or paste the 6 digits. Only numbers are accepted.</div>\n          <div id=\"code-error\" class=\"error\" aria-live=\"polite\"></div>\n        </div>\n        <div class=\"actions\">\n          <button id=\"btn-verify\" type=\"submit\">Verify Code</button>\n          <button id=\"btn-resend\" type=\"button\" class=\"secondary\">Resend Code</button>\n        </div>\n        <div id=\"resend-msg\" class=\"success\" aria-live=\"polite\" aria-atomic=\"true\"></div>\n      </form>\n    </section>\n\n    <!-- Step 3: Set new password -->\n    <section id=\"step3\" class=\"card\" role=\"region\" aria-labelledby=\"step3-title\" hidden>\n      <!-- Spec mapping: Step 3 with password + confirm, show/hide toggle, strength guidance, live checklist, require confirm match -->\n      <h2 id=\"step3-title\">Create a new password</h2>\n      <p>Choose a strong password that you haven't used with this account before.</p>\n      <form id=\"form-step3\" novalidate>\n        <div class=\"field-row\">\n          <label for=\"new-password\">New password</label>\n          <div class=\"inline\" style=\"width:100%\">\n            <input id=\"new-password\" name=\"new-password\" type=\"password\" autocomplete=\"new-password\"\n                   aria-describedby=\"pw-helper pw-req pw-error\" required>\n            <button type=\"button\" id=\"toggle-pw\" class=\"toggle-visibility\" aria-controls=\"new-password\">Show</button>\n          </div>\n          <div id=\"pw-helper\" class=\"helper\">Your password must meet all of the following:</div>\n          <!-- Spec mapping (A11y task): Checklist has aria-live=\"polite\" and each rule contains a decorative check icon and an SR-only status text -->\n          <ul id=\"pw-req\" class=\"checklist\" aria-live=\"polite\" aria-atomic=\"false\">\n            <li>\n              <span id=\"rule-length\" class=\"check\" aria-hidden=\"true\">✓</span>\n              <span>At least 12 characters</span>\n              <span id=\"rule-length-status\" class=\"sr-only\">Not met</span>\n            </li>\n            <li>\n              <span id=\"rule-upper\" class=\"check\" aria-hidden=\"true\">✓</span>\n              <span>Contains an uppercase letter (A–Z)</span>\n              <span id=\"rule-upper-status\" class=\"sr-only\">Not met</span>\n            </li>\n            <li>\n              <span id=\"rule-lower\" class=\"check\" aria-hidden=\"true\">✓</span>\n              <span>Contains a lowercase letter (a–z)</span>\n              <span id=\"rule-lower-status\" class=\"sr-only\">Not met</span>\n            </li>\n            <li>\n              <span id=\"rule-number\" class=\"check\" aria-hidden=\"true\">✓</span>\n              <span>Contains a number (0–9)</span>\n              <span id=\"rule-number-status\" class=\"sr-only\">Not met</span>\n            </li>\n            <li>\n              <span id=\"rule-symbol\" class=\"check\" aria-hidden=\"true\">✓</span>\n              <span>Contains a symbol (!@#$…)</span>\n              <span id=\"rule-symbol-status\" class=\"sr-only\">Not met</span>\n            </li>\n          </ul>\n          <div id=\"pw-error\" class=\"error\" aria-live=\"polite\"></div>\n        </div>\n\n        <div class=\"field-row\">\n          <label for=\"confirm-password\">Confirm new password</label>\n          <div class=\"inline\" style=\"width:100%\">\n            <input id=\"confirm-password\" name=\"confirm-password\" type=\"password\" autocomplete=\"new-password\"\n                   aria-describedby=\"confirm-error\" required>\n            <button type=\"button\" id=\"toggle-confirm\" class=\"toggle-visibility\" aria-controls=\"confirm-password\">Show</button>\n          </div>\n          <div id=\"confirm-error\" class=\"error\" aria-live=\"polite\"></div>\n        </div>\n\n        <div class=\"actions\">\n          <button id=\"btn-reset\" type=\"submit\" disabled>Reset password</button>\n        </div>\n      </form>\n    </section>\n\n    <!-- Done: Confirmation -->\n    <section id=\"done\" class=\"card\" role=\"region\" aria-labelledby=\"done-title\" hidden>\n      <!-- Spec mapping: Confirmation with next steps; console success logged -->\n      <h2 id=\"done-title\">Password updated</h2>\n      <p>Your password has been reset successfully.</p>\n      <ul>\n        <li>You can now sign in with your new password.</li>\n        <li>After signing in, please review and accept the updated privacy conditions so hospital staff can assist with booking your appointment.</li>\n      </ul>\n      <p class=\"footer-note\">Tip: For memory support, consider using a password manager. Avoid writing passwords where others might see them.</p>\n      <div class=\"actions\">\n        <button type=\"button\" id=\"btn-restart\" class=\"secondary\">Start over</button>\n      </div>\n    </section>\n  </main>\n\n  <!-- === Footer (Semantic) === -->\n  <footer role=\"contentinfo\">\n    <p class=\"footer-note\">\n      Mocked client-side demo. No data is transmitted. Console shows simulated delivery and verification.\n    </p>\n  </footer>\n\n  <script>\n    // === JS: Single-file client-only app state and handlers ===\n    // Spec mapping (Mocking): Deterministic code generation and console.log simulate delivery/verification.\n    // Spec mapping (In-page state): URL hash reflects step; state restored from sessionStorage on reload.\n    (function () {\n      'use strict';\n\n      // App state model kept in-memory and mirrored to sessionStorage\n      const defaultState = { step: 1, identifier: '', contactMask: '', code: '' };\n      let appState = loadState() || { ...defaultState };\n\n      // Element refs\n      const sections = {\n        step1: document.getElementById('step1'),\n        step2: document.getElementById('step2'),\n        step3: document.getElementById('step3'),\n        done: document.getElementById('done')\n      };\n      const progressEl = document.getElementById('progress');\n      const liveRegion = document.getElementById('live-region');\n      // Step 1\n      const form1 = document.getElementById('form-step1');\n      const idInput = document.getElementById('identifier');\n      const idError = document.getElementById('id-error');\n      const btn1 = document.getElementById('btn-step1');\n      // Step 2\n      const form2 = document.getElementById('form-step2');\n      const codeInput = document.getElementById('code');\n      const codeError = document.getElementById('code-error');\n      const contactMaskEl = document.getElementById('contact-mask');\n      const btnVerify = document.getElementById('btn-verify');\n      const btnResend = document.getElementById('btn-resend');\n      const resendMsg = document.getElementById('resend-msg');\n      // Step 3\n      const form3 = document.getElementById('form-step3');\n      const newPw = document.getElementById('new-password');\n      const confirmPw = document.getElementById('confirm-password');\n      const togglePw = document.getElementById('toggle-pw');\n      const toggleConfirm = document.getElementById('toggle-confirm');\n      const pwError = document.getElementById('pw-error');\n      const confirmError = document.getElementById('confirm-error');\n      const btnReset = document.getElementById('btn-reset');\n      const ruleEls = {\n        length: document.getElementById('rule-length'),\n        upper: document.getElementById('rule-upper'),\n        lower: document.getElementById('rule-lower'),\n        number: document.getElementById('rule-number'),\n        symbol: document.getElementById('rule-symbol')\n      };\n      // A11y: SR-only status elements for each rule (initially \"Not met\")\n      const ruleStatusEls = {\n        length: document.getElementById('rule-length-status'),\n        upper: document.getElementById('rule-upper-status'),\n        lower: document.getElementById('rule-lower-status'),\n        number: document.getElementById('rule-number-status'),\n        symbol: document.getElementById('rule-symbol-status')\n      };\n      // Done\n      const btnRestart = document.getElementById('btn-restart');\n\n      // Initialize: restore from hash + session state\n      initFromHashOrDefault();\n\n      // === Event wiring ===\n      form1.addEventListener('submit', onSubmitStep1);\n      form2.addEventListener('submit', onSubmitStep2);\n      btnResend.addEventListener('click', onResend);\n      codeInput.addEventListener('input', onCodeInput);\n      codeInput.addEventListener('paste', onCodePaste);\n      form3.addEventListener('submit', onSubmitStep3);\n      newPw.addEventListener('input', onPasswordInput);\n      confirmPw.addEventListener('input', onConfirmInput);\n      togglePw.addEventListener('click', () => toggleVisibility(newPw, togglePw));\n      toggleConfirm.addEventListener('click', () => toggleVisibility(confirmPw, toggleConfirm));\n      btnRestart.addEventListener('click', () => {\n        appState = { ...defaultState };\n        saveState();\n        setStep(1);\n      });\n      window.addEventListener('hashchange', onHashChange);\n\n      // === Functions (Spec mapping: Mocking, Validation, Navigation, Accessibility) ===\n\n      // Hash and state bootstrap\n      function initFromHashOrDefault() {\n        const targetStep = parseStepFromHash();\n        const stored = loadState();\n        if (stored) appState = stored;\n        if (Number.isInteger(targetStep) && targetStep >= 1 && targetStep <= 4) {\n          // Ensure prerequisites exist for deeper steps\n          if (targetStep === 1) setStep(1);\n          else if (targetStep === 2 && appState.identifier) setStep(2);\n          else if (targetStep === 3 && appState.identifier) setStep(3);\n          else if (targetStep === 4 && appState.identifier) setStep(4);\n          else setStep(1);\n        } else {\n          setStep(appState.step || 1);\n        }\n      }\n\n      function onHashChange() {\n        const targetStep = parseStepFromHash();\n        if (!Number.isInteger(targetStep)) return;\n        // Only allow forward navigation if we have required state\n        if (targetStep === 1) setStep(1);\n        if (targetStep === 2 && appState.identifier) setStep(2);\n        if (targetStep === 3 && appState.identifier) setStep(3);\n        if (targetStep === 4 && appState.identifier) setStep(4);\n      }\n\n      function parseStepFromHash() {\n        const h = location.hash.replace('#', '');\n        switch (h) {\n          case 'step1': return 1;\n          case 'step2': return 2;\n          case 'step3': return 3;\n          case 'done': return 4;\n          default: return null;\n        }\n      }\n\n      function updateHash() {\n        const map = { 1: 'step1', 2: 'step2', 3: 'step3', 4: 'done' };\n        const hash = '#' + map[appState.step];\n        if (location.hash !== hash) {\n          history.replaceState(null, '', hash);\n        }\n      }\n\n      function setStep(stepNumber) {\n        appState.step = stepNumber;\n        saveState();\n        updateHash();\n        // Toggle sections\n        sections.step1.hidden = stepNumber !== 1;\n        sections.step2.hidden = stepNumber !== 2;\n        sections.step3.hidden = stepNumber !== 3;\n        sections.done.hidden = stepNumber !== 4;\n        // Update progress text\n        if (stepNumber >= 1 && stepNumber <= 3) {\n          progressEl.textContent = `Step ${stepNumber} of 3`;\n          progressEl.hidden = false;\n        } else {\n          progressEl.hidden = true;\n        }\n        // On step entry, manage content and focus\n        switch (stepNumber) {\n          case 1:\n            announce('');\n            idError.textContent = '';\n            focusHeadingOrField('step1-title', idInput);\n            break;\n          case 2:\n            // Populate masked contact\n            appState.contactMask = appState.contactMask || maskContact(appState.identifier);\n            contactMaskEl.textContent = appState.contactMask;\n            codeInput.value = '';\n            codeError.textContent = '';\n            resendMsg.textContent = '';\n            // On step change, \"send\" mock code deterministically\n            appState.code = generateCode(appState.identifier);\n            saveState();\n            mockDeliverCode(appState.identifier, appState.code, appState.contactMask);\n            // Focus\n            focusHeadingOrField('step2-title', codeInput);\n            break;\n          case 3:\n            newPw.value = '';\n            confirmPw.value = '';\n            pwError.textContent = '';\n            confirmError.textContent = '';\n            btnReset.disabled = true;\n            updateChecklist('');\n            focusHeadingOrField('step3-title', newPw);\n            break;\n          case 4:\n            focusHeadingOrField('done-title', null);\n            break;\n        }\n      }\n\n      // Step 1: Submit\n      function onSubmitStep1(e) {\n        e.preventDefault();\n        idError.textContent = '';\n        const raw = (idInput.value || '').trim();\n        const err = validateIdentifier(raw);\n        if (err) {\n          idError.textContent = err;\n          announce(err);\n          idInput.focus();\n          return;\n        }\n        appState.identifier = raw;\n        appState.contactMask = maskContact(raw);\n        appState.code = generateCode(raw);\n        saveState();\n        // Mock: \"send\" recovery code\n        mockDeliverCode(appState.identifier, appState.code, appState.contactMask);\n        setStep(2);\n      }\n\n      // Step 2: Input and submit\n      function onCodeInput(e) {\n        // Filter to digits only\n        const digits = (e.target.value || '').replace(/\\D+/g, '').slice(0, 6);\n        if (digits !== e.target.value) e.target.value = digits;\n        codeError.textContent = '';\n      }\n      function onCodePaste(e) {\n        const text = (e.clipboardData || window.clipboardData).getData('text') || '';\n        const digits = text.replace(/\\D+/g, '').slice(0, 6);\n        if (digits) {\n          e.preventDefault();\n          codeInput.value = digits;\n        }\n      }\n      function onSubmitStep2(e) {\n        e.preventDefault();\n        codeError.textContent = '';\n        const val = (codeInput.value || '').trim();\n        if (!/^\\d{6}$/.test(val)) {\n          const msg = 'Enter the 6-digit code.';\n          codeError.textContent = msg;\n          announce(msg);\n          codeInput.focus();\n          return;\n        }\n        const expected = appState.code || generateCode(appState.identifier);\n        if (val !== expected) {\n          const msg = 'That code is not correct. Try again, or resend the code.';\n          codeError.textContent = msg;\n          announce(msg);\n          codeInput.focus();\n          return;\n        }\n        setStep(3);\n      }\n      function onResend() {\n        resendMsg.textContent = 'Code resent. Please check the console output.';\n        announce('A new code has been resent.');\n        const code = appState.code || generateCode(appState.identifier);\n        mockDeliverCode(appState.identifier, code, appState.contactMask, /*resend*/true);\n      }\n\n      // Step 3: Password rules\n      function onPasswordInput() {\n        const pwd = newPw.value || '';\n        updateChecklist(pwd);\n        pwError.textContent = '';\n        // Enable submit only when all rules pass and confirm matches\n        btnReset.disabled = !(allRulesPass(pwd) && passwordsMatch());\n      }\n      function onConfirmInput() {\n        confirmError.textContent = '';\n        btnReset.disabled = !(allRulesPass(newPw.value || '') && passwordsMatch());\n      }\n      function passwordsMatch() {\n        return (newPw.value || '') === (confirmPw.value || '');\n      }\n      function allRulesPass(pwd) {\n        return pwd.length >= 12 &&\n               /[A-Z]/.test(pwd) &&\n               /[a-z]/.test(pwd) &&\n               /\\d/.test(pwd) &&\n               /[^A-Za-z0-9]/.test(pwd);\n      }\n      // Spec mapping (A11y task): updateChecklist toggles visual state and updates SR-only status spans (\"Met\"/\"Not met\")\n      function updateChecklist(pwd) {\n        const rules = {\n          length: (pwd.length >= 12),\n          upper: (/[A-Z]/.test(pwd)),\n          lower: (/[a-z]/.test(pwd)),\n          number: (/\\d/.test(pwd)),\n          symbol: (/[^A-Za-z0-9]/.test(pwd))\n        };\n        Object.keys(rules).forEach(key => {\n          ruleEls[key].classList.toggle('pass', !!rules[key]);\n          // Update the SR-only status text; decorative check icon remains aria-hidden\n          if (ruleStatusEls[key]) {\n            ruleStatusEls[key].textContent = rules[key] ? 'Met' : 'Not met';\n          }\n        });\n        // Show live feedback if user typed but rules not met\n        if (pwd && !allRulesPass(pwd)) {\n          pwError.textContent = 'Password does not meet all requirements.';\n        } else {\n          pwError.textContent = '';\n        }\n        // Confirm mismatch feedback\n        if (confirmPw.value && !passwordsMatch()) {\n          confirmError.textContent = 'Passwords do not match.';\n        } else {\n          confirmError.textContent = '';\n        }\n      }\n\n      // Step 3: Submit\n      function onSubmitStep3(e) {\n        e.preventDefault();\n        const pwd = newPw.value || '';\n        const confirm = confirmPw.value || '';\n        let localError = '';\n        if (!allRulesPass(pwd)) {\n          localError = 'Password does not meet all requirements.';\n          pwError.textContent = localError;\n          announce(localError);\n          newPw.focus();\n          return;\n        }\n        if (pwd !== confirm) {\n          localError = 'Passwords do not match.';\n          confirmError.textContent = localError;\n          announce(localError);\n          confirmPw.focus();\n          return;\n        }\n        // Mock success\n        console.log(`Mock: Password reset SUCCESS for identifier '${appState.identifier}'.`);\n        setStep(4);\n      }\n\n      // Utilities\n      function validateIdentifier(input) {\n        if (!input) return 'Please enter your email or username.';\n        if (input.includes('@')) {\n          // Simple email format check\n          const emailOk = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(input);\n          if (!emailOk) return 'Please enter a valid email address.';\n        } else {\n          // Username: at least 3 characters\n          if (input.length < 3) return 'Please enter a valid username (3 or more characters).';\n        }\n        return '';\n      }\n\n      function maskContact(identifier) {\n        if (identifier.includes('@')) {\n          const [local, domain] = identifier.split('@');\n          const maskedLocal = maskMiddle(local);\n          const domainParts = domain.split('.');\n          const domainName = domainParts[0] || '';\n          const domainTld = domainParts.slice(1).join('.') || '';\n          const maskedDomain = maskMiddle(domainName);\n          return `${maskedLocal}@${maskedDomain}${domainTld ? '.' + domainTld : ''}`;\n        } else {\n          return maskMiddle(identifier);\n        }\n      }\n\n      function maskMiddle(str) {\n        if (str.length <= 2) return str[0] + '•'.repeat(Math.max(0, str.length - 1));\n        const first = str[0];\n        const last = str[str.length - 1];\n        return `${first}${'•'.repeat(Math.max(1, str.length - 2))}${last}`;\n      }\n\n      // Deterministic 6-digit code generator (Spec mapping: Mocking)\n      function generateCode(identifier) {\n        let hash = 0;\n        const prime = 1315423911;\n        for (let i = 0; i < identifier.length; i++) {\n          hash ^= ((hash << 5) + identifier.charCodeAt(i) + (hash >> 2));\n        }\n        hash ^= prime;\n        const code = Math.abs(hash) % 1000000;\n        return String(code).padStart(6, '0');\n      }\n\n      // Mock delivery via console.log\n      function mockDeliverCode(identifier, code, mask, isResend = false) {\n        const action = isResend ? 'RESEND' : 'SEND';\n        console.log(`Mock ${action}: Recovery code for '${identifier}' is ${code} (to ${mask})`);\n        announce(isResend ? 'A new code has been resent.' : 'A verification code has been sent.');\n      }\n\n      // Accessibility: Live region announcer\n      function announce(message) {\n        if (!message) {\n          liveRegion.textContent = '';\n          return;\n        }\n        liveRegion.textContent = message;\n      }\n\n      // Toggle show/hide password\n      function toggleVisibility(inputEl, toggleBtn) {\n        const isPassword = inputEl.type === 'password';\n        inputEl.type = isPassword ? 'text' : 'password';\n        toggleBtn.textContent = isPassword ? 'Hide' : 'Show';\n      }\n\n      // Focus management on step change\n      function focusHeadingOrField(headingId, fieldEl) {\n        const heading = document.getElementById(headingId);\n        if (heading) {\n          heading.setAttribute('tabindex', '-1');\n          heading.focus();\n          // Cleanup tabindex after focus\n          setTimeout(() => heading.removeAttribute('tabindex'), 0);\n        }\n        if (fieldEl) {\n          setTimeout(() => fieldEl.focus(), 50);\n        }\n      }\n\n      // State persistence\n      function saveState() {\n        try {\n          sessionStorage.setItem('recoveryState', JSON.stringify(appState));\n        } catch (_) {}\n      }\n      function loadState() {\n        try {\n          const raw = sessionStorage.getItem('recoveryState');\n          return raw ? JSON.parse(raw) : null;\n        } catch (_) {\n          return null;\n        }\n      }\n\n      // Keyboard: Enter to submit is default via forms; tab order follows DOM.\n    })();\n  </script>\n</body>\n</html>\n", "task_list": ["Add appState.verified (default false). Reset to false on restart and when re-entering Step 2.", "Set appState.verified = true only upon successful code verification in onSubmitStep2.", "In initFromHashOrDefault, onHashChange, and setStep, require appState.verified for Step 3 and Step 4. Example: allow step 3/4 only if identifier exists AND verified is true; otherwise redirect to Step 2.", "Change pattern attribute on #code to \"\\d{6}\" or remove the attribute since the form uses novalidate and JS enforces digits. Ensure no escaping issues in HTML.", "Update onResend() and mockDeliverCode() announcements to say “Code resent.” (do not say “new”).", "For Show/Hide password buttons, maintain aria-pressed reflecting state (true when visible), and keep button label synchronized with state."], "evaluator_md": "SUMMARY:\nThe single-file, client-only password recovery flow is well-structured, accessible, and largely meets the requirements. It includes semantic HTML, inline CSS/JS, deterministic code generation with console-based mocking, clear step-by-step UI, accessible error messaging, and inclusive design considerations for an older adult with ADHD. However, there is a functional gap: users can bypass code verification via hash navigation because steps 3 and 4 are only gated by presence of an identifier, not by successful verification. There are also minor accuracy and accessibility polish issues.\n\nFUNCTIONAL_CHECK:\n- AC1. Single deliverable: one index.html with inline CSS and JS, no build step required — PASS. One HTML file; all CSS/JS inline; no external dependencies or build required.\n- AC2. All logic browser-only; no network calls; mocking via console.log; deterministic code — PASS. Deterministic 6-digit code generation and console.log “SEND/RESEND”; no network usage.\n- AC3. Step 1 collects email/username with validation, helper text, accessible errors — PASS. Validation for email format/username length; aria-describedby and aria-live error region present.\n- AC4. After Step 1, a code is generated and “sent”; masked contact is displayed on Step 2 — PASS. maskContact used; console logs on Step 1 submit and Step 2 entry.\n- AC5. Step 2 enforces 6-digit numeric input with typing/paste; errors and resend logging same code — PASS (minor). JS filters digits and paste; custom validation; resend logs the same code. Minor wording: UI says “A new code has been resent” while the same code is used.\n- AC6. Cannot proceed to Step 3 unless correct code is entered — FAIL. Normal flow enforces this, but direct hash navigation (#step3 or #done) is allowed if identifier exists; no “verified” state gate.\n- AC7. Step 3 password rules: min 12, upper, lower, number, symbol; live checklist; confirm; submit enabled only when valid — PASS. Real-time checklist and disabled submit until all conditions met and match.\n- AC8. Show/hide password toggles available — PASS (minor). Functional; would be more accessible with aria-pressed reflecting state.\n- AC9. Success screen with clear next steps — PASS. Confirmation and guidance to review privacy conditions, restart option.\n- AC10. State and navigation: progress indicator; hash reflects step; restore after reload; prevent deep links without prerequisites — FAIL (partial). Hash and session storage work; deep-link gating only checks identifier, not verification, enabling step-skipping.\n- AC11. Accessibility: semantic landmarks, labels, aria-describedby, aria-live, visible focus, keyboard friendly — PASS (minor). Solid overall; minor improvements possible (toggle aria-pressed; dual-focus on heading+field is arguably noisy for some AT).\n- AC12. Inclusive UX for older adult with ADHD: readable type, high contrast, single column, clear copy, chunked steps, no timers — PASS. 18px base font, visible focus, single column, clear helper text and tips.\n- AC13. Spec mapping comments present — PASS. Clear comments mapping to spec and developer notes.\n- AC14. No sensitive operations; clear disclaimers that this is a mock, not for production — PASS. Prominent disclaimers in header/footer and comments.\n\nFAILING_ITEMS:\n- Step gating: Users can navigate directly to step 3 or done via URL hash if an identifier is present, bypassing code verification (no “verified” flag).\n- Hash-change/init gating logic only checks identifier for steps 3 and 4; does not require a verified state.\n- Minor accuracy: Resend announcement says “A new code has been resent.” while the same deterministic code is sent.\n- Minor robustness: code input’s pattern attribute is set to \"\\\\d{6}\" (double backslash). Although the form uses novalidate and JS handles validation, the native pattern is incorrect and misleading.\n- Minor accessibility polish: Show/Hide password buttons do not expose state via aria-pressed.\n\nNEW_TASKS:\n1) Introduce verified state\n   - Add appState.verified (default false). Reset to false on restart and when re-entering Step 2.\n   - Set appState.verified = true only upon successful code verification in onSubmitStep2.\n2) Gate steps by verification\n   - In initFromHashOrDefault, onHashChange, and setStep, require appState.verified for Step 3 and Step 4. Example: allow step 3/4 only if identifier exists AND verified is true; otherwise redirect to Step 2.\n3) Correct code input pattern or remove it\n   - Change pattern attribute on #code to \"\\d{6}\" or remove the attribute since the form uses novalidate and JS enforces digits. Ensure no escaping issues in HTML.\n4) Fix resend messaging for accuracy\n   - Update onResend() and mockDeliverCode() announcements to say “Code resent.” (do not say “new”).\n5) Enhance toggle accessibility\n   - For Show/Hide password buttons, maintain aria-pressed reflecting state (true when visible), and keep button label synchronized with state.\n\nDECISION:\nFAIL", "done": false, "iter": 2, "step": 6}
{"code_html": "\n<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\">\n  <title>Password Recovery (Mock, Client-Only)</title>\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n  <!--\n    Password Recovery System — Single-Page, Client-Only, Mocked\n\n    Spec Mapping (Purpose, Use-case, Deliverables, Mocking):\n    - Purpose: Provide a self-contained, browser-only password recovery flow for evaluation. Not for production.\n    - Use-case: Helena (67, heart disease, ADHD) needs to reset her strong password to log in and accept updated privacy conditions to allow hospital staff to book an appointment.\n    - Deliverables: One index.html (this file) using semantic HTML, inline CSS & JS. No build step. Sections are commented to map to the spec.\n    - Mocking: Delivery and verification are simulated through deterministic code generation and console.log outputs. No servers or external calls.\n\n    Developer testing note:\n    - Open this file in any modern browser (no server needed).\n    - Step 1: Enter an email or username, press Continue. The deterministic 6‑digit code is generated from your input and logged in the console.\n    - Step 2: Enter or paste the 6-digit code from the console to verify. Use \"Resend Code\" to log the same code again.\n    - Step 3: Enter a new password meeting the rules and confirm it. On success, a confirmation screen appears, and the console logs a success message with the user identifier.\n    - Observe mocked outputs in DevTools console.\n  -->\n  <style>\n    /* === Accessibility & Layout CSS (High contrast, readable typography, single-column, visible focus) === */\n    :root {\n      --bg: #ffffff;\n      --fg: #111111;\n      --muted: #555555;\n      --primary: #0b5fff;\n      --danger: #b00020;\n      --success: #137333;\n      --surface: #f5f7fb;\n      --border: #d0d7e2;\n      --focus: #ff9900;\n      --font-size-base: 18px; /* readable typography */\n      --radius: 10px;\n      --space: 16px;\n    }\n    html, body {\n      margin: 0;\n      padding: 0;\n      background: var(--bg);\n      color: var(--fg);\n      font-family: system-ui, -apple-system, Segoe UI, Roboto, \"Helvetica Neue\", Arial, \"Noto Sans\", \"Apple Color Emoji\", \"Segoe UI Emoji\", \"Segoe UI Symbol\";\n      font-size: var(--font-size-base);\n      line-height: 1.5;\n    }\n    header, main, footer {\n      max-width: 720px;\n      margin: 0 auto;\n      padding: 16px;\n    }\n    header {\n      padding-top: 24px;\n      padding-bottom: 8px;\n    }\n    h1, h2, h3 {\n      line-height: 1.2;\n      margin: 0 0 12px;\n    }\n    p {\n      margin: 0 0 12px;\n    }\n    .card {\n      background: var(--surface);\n      border: 1px solid var(--border);\n      border-radius: var(--radius);\n      padding: 16px;\n    }\n    .progress {\n      font-weight: 600;\n      color: var(--muted);\n      margin-bottom: 8px;\n    }\n    label {\n      font-weight: 600;\n      display: block;\n      margin-bottom: 6px;\n    }\n    input[type=\"text\"],\n    input[type=\"email\"],\n    input[type=\"password\"],\n    input[type=\"tel\"] {\n      width: 100%;\n      padding: 12px;\n      font-size: 1rem;\n      border-radius: 8px;\n      border: 2px solid var(--border);\n      background: #fff;\n      color: var(--fg);\n      box-sizing: border-box;\n    }\n    input:focus-visible, button:focus-visible, a:focus-visible {\n      outline: 3px solid var(--focus);\n      outline-offset: 2px;\n    }\n    .helper {\n      color: var(--muted);\n      font-size: 0.95rem;\n      margin-top: 4px;\n    }\n    .error {\n      color: var(--danger);\n      margin-top: 8px;\n      font-weight: 600;\n    }\n    .success {\n      color: var(--success);\n      margin-top: 8px;\n      font-weight: 600;\n    }\n    .actions {\n      display: flex;\n      gap: 12px;\n      flex-wrap: wrap;\n      margin-top: 12px;\n    }\n    button {\n      background: var(--primary);\n      color: #fff;\n      border: none;\n      border-radius: 8px;\n      padding: 12px 16px;\n      font-size: 1rem;\n      cursor: pointer;\n    }\n    button.secondary {\n      background: transparent;\n      color: var(--primary);\n      border: 2px solid var(--primary);\n    }\n    button.linklike {\n      background: transparent;\n      color: var(--primary);\n      border: none;\n      padding: 8px 0;\n      text-decoration: underline;\n    }\n    .sr-only {\n      position: absolute;\n      width: 1px; height: 1px;\n      padding: 0; margin: -1px;\n      overflow: hidden; clip: rect(0,0,0,0);\n      border: 0;\n    }\n    .checklist {\n      list-style: none;\n      padding-left: 0;\n      margin: 8px 0 0;\n    }\n    .checklist li {\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      margin: 4px 0;\n    }\n    .check {\n      width: 1.1em;\n      height: 1.1em;\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n      border-radius: 4px;\n      border: 2px solid var(--border);\n      font-weight: 800;\n      font-size: 0.85em;\n      background: #fff;\n      color: transparent;\n    }\n    .check.pass {\n      border-color: var(--success);\n      background: #e9f6ee;\n      color: var(--success);\n    }\n    .field-row {\n      margin: 12px 0;\n    }\n    .inline {\n      display: inline-flex;\n      align-items: center;\n      gap: 8px;\n    }\n    .toggle-visibility {\n      background: transparent;\n      color: var(--primary);\n      border: none;\n      padding: 6px 8px;\n      cursor: pointer;\n      text-decoration: underline;\n    }\n    .masked-contact {\n      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, \"Liberation Mono\", monospace;\n      background: #fff;\n      border: 1px dashed var(--border);\n      padding: 6px 8px;\n      border-radius: 6px;\n      display: inline-block;\n    }\n    .footer-note {\n      color: var(--muted);\n      font-size: 0.95rem;\n      margin-top: 8px;\n    }\n    /* Responsive single-column is default. Ensure adequate spacing. */\n    .spacer { height: 8px; }\n  </style>\n</head>\n<body>\n  <!-- === Header (Semantic) === -->\n  <header role=\"banner\">\n    <h1 id=\"app-title\">Reset your password</h1>\n    <p class=\"footer-note\">\n      This is a fully client-side, mocked recovery demo for evaluation purposes only.\n    </p>\n  </header>\n\n  <!-- === Main (Flow Steps) === -->\n  <main id=\"app\" role=\"main\" aria-labelledby=\"app-title\">\n    <div id=\"progress\" class=\"progress\" aria-live=\"polite\">Step 1 of 3</div>\n\n    <!-- Global aria-live for announcements (errors and confirmations) -->\n    <div id=\"live-region\" class=\"sr-only\" aria-live=\"polite\"></div>\n\n    <!-- Step 1: Identify account -->\n    <section id=\"step1\" class=\"card\" role=\"region\" aria-labelledby=\"step1-title\">\n      <!-- Spec mapping: Step 1 form with labels, helper text, accessible submit; validate required and email format; errors via aria-live -->\n      <h2 id=\"step1-title\">Find your account</h2>\n      <p>Enter your email address or username to receive a verification code.</p>\n      <form id=\"form-step1\" novalidate>\n        <div class=\"field-row\">\n          <label for=\"identifier\">Email or Username</label>\n          <input id=\"identifier\" name=\"identifier\" type=\"text\" placeholder=\"e.g., helena@example.com or helena67\"\n                 autocomplete=\"username\" required aria-describedby=\"id-helper id-error\">\n          <div id=\"id-helper\" class=\"helper\">We will send a 6-digit code to your contact on file. No emails are sent in this demo.</div>\n          <div id=\"id-error\" class=\"error\" aria-live=\"polite\"></div>\n        </div>\n        <div class=\"actions\">\n          <button id=\"btn-step1\" type=\"submit\">Continue</button>\n        </div>\n      </form>\n    </section>\n\n    <!-- Step 2: Code verification -->\n    <section id=\"step2\" class=\"card\" role=\"region\" aria-labelledby=\"step2-title\" hidden>\n      <!-- Spec mapping: Step 2 with progress indicator, masked contact, code input accepting typing or paste, errors via aria-live -->\n      <h2 id=\"step2-title\">Enter verification code</h2>\n      <p>We sent a 6-digit code to:</p>\n      <p class=\"masked-contact\" id=\"contact-mask\">••••</p>\n      <div class=\"spacer\"></div>\n      <form id=\"form-step2\" novalidate>\n        <div class=\"field-row\">\n          <label for=\"code\">6-digit code</label>\n          <input id=\"code\" name=\"code\" inputmode=\"numeric\" autocomplete=\"one-time-code\"\n                 placeholder=\"123456\" pattern=\"\\d{6}\" maxlength=\"6\" aria-describedby=\"code-helper code-error\">\n          <div id=\"code-helper\" class=\"helper\">Type or paste the 6 digits. Only numbers are accepted.</div>\n          <div id=\"code-error\" class=\"error\" aria-live=\"polite\"></div>\n        </div>\n        <div class=\"actions\">\n          <button id=\"btn-verify\" type=\"submit\">Verify Code</button>\n          <button id=\"btn-resend\" type=\"button\" class=\"secondary\">Resend Code</button>\n        </div>\n        <div id=\"resend-msg\" class=\"success\" aria-live=\"polite\" aria-atomic=\"true\"></div>\n      </form>\n    </section>\n\n    <!-- Step 3: Set new password -->\n    <section id=\"step3\" class=\"card\" role=\"region\" aria-labelledby=\"step3-title\" hidden>\n      <!-- Spec mapping: Step 3 with password + confirm, show/hide toggle, strength guidance, live checklist, require confirm match -->\n      <h2 id=\"step3-title\">Create a new password</h2>\n      <p>Choose a strong password that you haven't used with this account before.</p>\n      <form id=\"form-step3\" novalidate>\n        <div class=\"field-row\">\n          <label for=\"new-password\">New password</label>\n          <div class=\"inline\" style=\"width:100%\">\n            <input id=\"new-password\" name=\"new-password\" type=\"password\" autocomplete=\"new-password\"\n                   aria-describedby=\"pw-helper pw-req pw-error\" required>\n            <button type=\"button\" id=\"toggle-pw\" class=\"toggle-visibility\" aria-controls=\"new-password\" aria-pressed=\"false\">Show</button>\n          </div>\n          <div id=\"pw-helper\" class=\"helper\">Your password must meet all of the following:</div>\n          <!-- Spec mapping (A11y task): Checklist has aria-live=\"polite\" and each rule contains a decorative check icon and an SR-only status text -->\n          <ul id=\"pw-req\" class=\"checklist\" aria-live=\"polite\" aria-atomic=\"false\">\n            <li>\n              <span id=\"rule-length\" class=\"check\" aria-hidden=\"true\">✓</span>\n              <span>At least 12 characters</span>\n              <span id=\"rule-length-status\" class=\"sr-only\">Not met</span>\n            </li>\n            <li>\n              <span id=\"rule-upper\" class=\"check\" aria-hidden=\"true\">✓</span>\n              <span>Contains an uppercase letter (A–Z)</span>\n              <span id=\"rule-upper-status\" class=\"sr-only\">Not met</span>\n            </li>\n            <li>\n              <span id=\"rule-lower\" class=\"check\" aria-hidden=\"true\">✓</span>\n              <span>Contains a lowercase letter (a–z)</span>\n              <span id=\"rule-lower-status\" class=\"sr-only\">Not met</span>\n            </li>\n            <li>\n              <span id=\"rule-number\" class=\"check\" aria-hidden=\"true\">✓</span>\n              <span>Contains a number (0–9)</span>\n              <span id=\"rule-number-status\" class=\"sr-only\">Not met</span>\n            </li>\n            <li>\n              <span id=\"rule-symbol\" class=\"check\" aria-hidden=\"true\">✓</span>\n              <span>Contains a symbol (!@#$…)</span>\n              <span id=\"rule-symbol-status\" class=\"sr-only\">Not met</span>\n            </li>\n          </ul>\n          <div id=\"pw-error\" class=\"error\" aria-live=\"polite\"></div>\n        </div>\n\n        <div class=\"field-row\">\n          <label for=\"confirm-password\">Confirm new password</label>\n          <div class=\"inline\" style=\"width:100%\">\n            <input id=\"confirm-password\" name=\"confirm-password\" type=\"password\" autocomplete=\"new-password\"\n                   aria-describedby=\"confirm-error\" required>\n            <button type=\"button\" id=\"toggle-confirm\" class=\"toggle-visibility\" aria-controls=\"confirm-password\" aria-pressed=\"false\">Show</button>\n          </div>\n          <div id=\"confirm-error\" class=\"error\" aria-live=\"polite\"></div>\n        </div>\n\n        <div class=\"actions\">\n          <button id=\"btn-reset\" type=\"submit\" disabled>Reset password</button>\n        </div>\n      </form>\n    </section>\n\n    <!-- Done: Confirmation -->\n    <section id=\"done\" class=\"card\" role=\"region\" aria-labelledby=\"done-title\" hidden>\n      <!-- Spec mapping: Confirmation with next steps; console success logged -->\n      <h2 id=\"done-title\">Password updated</h2>\n      <p>Your password has been reset successfully.</p>\n      <ul>\n        <li>You can now sign in with your new password.</li>\n        <li>After signing in, please review and accept the updated privacy conditions so hospital staff can assist with booking your appointment.</li>\n      </ul>\n      <p class=\"footer-note\">Tip: For memory support, consider using a password manager. Avoid writing passwords where others might see them.</p>\n      <div class=\"actions\">\n        <button type=\"button\" id=\"btn-restart\" class=\"secondary\">Start over</button>\n      </div>\n    </section>\n  </main>\n\n  <!-- === Footer (Semantic) === -->\n  <footer role=\"contentinfo\">\n    <p class=\"footer-note\">\n      Mocked client-side demo. No data is transmitted. Console shows simulated delivery and verification.\n    </p>\n  </footer>\n\n  <script>\n    // === JS: Single-file client-only app state and handlers ===\n    // Spec mapping (Mocking): Deterministic code generation and console.log simulate delivery/verification.\n    // Spec mapping (In-page state): URL hash reflects step; state restored from sessionStorage on reload.\n    (function () {\n      'use strict';\n\n      // App state model kept in-memory and mirrored to sessionStorage\n      // Spec mapping (State & Security gating): Add verified flag to gate steps 3/4.\n      const defaultState = { step: 1, identifier: '', contactMask: '', code: '', verified: false };\n      let appState = loadState() || { ...defaultState };\n      if (typeof appState.verified !== 'boolean') appState.verified = false; // normalize state from older sessions\n\n      // Element refs\n      const sections = {\n        step1: document.getElementById('step1'),\n        step2: document.getElementById('step2'),\n        step3: document.getElementById('step3'),\n        done: document.getElementById('done')\n      };\n      const progressEl = document.getElementById('progress');\n      const liveRegion = document.getElementById('live-region');\n      // Step 1\n      const form1 = document.getElementById('form-step1');\n      const idInput = document.getElementById('identifier');\n      const idError = document.getElementById('id-error');\n      const btn1 = document.getElementById('btn-step1');\n      // Step 2\n      const form2 = document.getElementById('form-step2');\n      const codeInput = document.getElementById('code');\n      const codeError = document.getElementById('code-error');\n      const contactMaskEl = document.getElementById('contact-mask');\n      const btnVerify = document.getElementById('btn-verify');\n      const btnResend = document.getElementById('btn-resend');\n      const resendMsg = document.getElementById('resend-msg');\n      // Step 3\n      const form3 = document.getElementById('form-step3');\n      const newPw = document.getElementById('new-password');\n      const confirmPw = document.getElementById('confirm-password');\n      const togglePw = document.getElementById('toggle-pw');\n      const toggleConfirm = document.getElementById('toggle-confirm');\n      const pwError = document.getElementById('pw-error');\n      const confirmError = document.getElementById('confirm-error');\n      const btnReset = document.getElementById('btn-reset');\n      const ruleEls = {\n        length: document.getElementById('rule-length'),\n        upper: document.getElementById('rule-upper'),\n        lower: document.getElementById('rule-lower'),\n        number: document.getElementById('rule-number'),\n        symbol: document.getElementById('rule-symbol')\n      };\n      // A11y: SR-only status elements for each rule (initially \"Not met\")\n      const ruleStatusEls = {\n        length: document.getElementById('rule-length-status'),\n        upper: document.getElementById('rule-upper-status'),\n        lower: document.getElementById('rule-lower-status'),\n        number: document.getElementById('rule-number-status'),\n        symbol: document.getElementById('rule-symbol-status')\n      };\n      // Done\n      const btnRestart = document.getElementById('btn-restart');\n\n      // Initialize: restore from hash + session state\n      initFromHashOrDefault();\n\n      // === Event wiring ===\n      form1.addEventListener('submit', onSubmitStep1);\n      form2.addEventListener('submit', onSubmitStep2);\n      btnResend.addEventListener('click', onResend);\n      codeInput.addEventListener('input', onCodeInput);\n      codeInput.addEventListener('paste', onCodePaste);\n      form3.addEventListener('submit', onSubmitStep3);\n      newPw.addEventListener('input', onPasswordInput);\n      confirmPw.addEventListener('input', onConfirmInput);\n      togglePw.addEventListener('click', () => toggleVisibility(newPw, togglePw));\n      toggleConfirm.addEventListener('click', () => toggleVisibility(confirmPw, toggleConfirm));\n      btnRestart.addEventListener('click', () => {\n        // Spec mapping (Flow restart): Reset verified to false.\n        appState = { ...defaultState };\n        saveState();\n        setStep(1);\n      });\n      window.addEventListener('hashchange', onHashChange);\n\n      // === Functions (Spec mapping: Mocking, Validation, Navigation, Accessibility) ===\n\n      // Hash and state bootstrap with gating\n      function initFromHashOrDefault() {\n        const targetStep = parseStepFromHash();\n        const stored = loadState();\n        if (stored) appState = stored;\n        if (typeof appState.verified !== 'boolean') appState.verified = false;\n\n        if (Number.isInteger(targetStep) && targetStep >= 1 && targetStep <= 4) {\n          if (targetStep === 1) {\n            setStep(1);\n          } else if (targetStep === 2) {\n            appState.identifier ? setStep(2) : setStep(1);\n          } else if (targetStep === 3 || targetStep === 4) {\n            if (appState.identifier && appState.verified) {\n              setStep(targetStep);\n            } else if (appState.identifier) {\n              setStep(2); // Spec mapping (Gating): redirect to Step 2 if not verified\n            } else {\n              setStep(1);\n            }\n          }\n        } else {\n          setStep(appState.step || 1);\n        }\n      }\n\n      function onHashChange() {\n        const targetStep = parseStepFromHash();\n        if (!Number.isInteger(targetStep)) return;\n        // Spec mapping (Gating on hash navigation): Steps 3/4 require identifier + verified\n        if (targetStep === 1) {\n          setStep(1);\n        } else if (targetStep === 2) {\n          appState.identifier ? setStep(2) : setStep(1);\n        } else if (targetStep === 3 || targetStep === 4) {\n          if (appState.identifier && appState.verified) {\n            setStep(targetStep);\n          } else if (appState.identifier) {\n            setStep(2);\n          } else {\n            setStep(1);\n          }\n        }\n      }\n\n      function parseStepFromHash() {\n        const h = location.hash.replace('#', '');\n        switch (h) {\n          case 'step1': return 1;\n          case 'step2': return 2;\n          case 'step3': return 3;\n          case 'done': return 4;\n          default: return null;\n        }\n      }\n\n      function updateHash() {\n        const map = { 1: 'step1', 2: 'step2', 3: 'step3', 4: 'done' };\n        const hash = '#' + map[appState.step];\n        if (location.hash !== hash) {\n          history.replaceState(null, '', hash);\n        }\n      }\n\n      function setStep(stepNumber) {\n        // Spec mapping (Gating in step-setting): enforce prerequisites\n        if (stepNumber === 2 && !appState.identifier) {\n          stepNumber = 1;\n        }\n        if ((stepNumber === 3 || stepNumber === 4) && (!appState.identifier || !appState.verified)) {\n          stepNumber = 2; // redirect to Step 2 if not verified\n        }\n\n        appState.step = stepNumber;\n        saveState();\n        updateHash();\n        // Toggle sections\n        sections.step1.hidden = stepNumber !== 1;\n        sections.step2.hidden = stepNumber !== 2;\n        sections.step3.hidden = stepNumber !== 3;\n        sections.done.hidden = stepNumber !== 4;\n        // Update progress text\n        if (stepNumber >= 1 && stepNumber <= 3) {\n          progressEl.textContent = `Step ${stepNumber} of 3`;\n          progressEl.hidden = false;\n        } else {\n          progressEl.hidden = true;\n        }\n        // On step entry, manage content and focus\n        switch (stepNumber) {\n          case 1:\n            announce('');\n            idError.textContent = '';\n            focusHeadingOrField('step1-title', idInput);\n            break;\n          case 2:\n            // Spec mapping (Verification state): Reset verified when entering Step 2 (including via hash/back)\n            appState.verified = false;\n            saveState();\n            // Populate masked contact\n            appState.contactMask = appState.contactMask || maskContact(appState.identifier);\n            contactMaskEl.textContent = appState.contactMask;\n            codeInput.value = '';\n            codeError.textContent = '';\n            resendMsg.textContent = '';\n            // On step change, \"send\" mock code deterministically (same code every time)\n            appState.code = generateCode(appState.identifier);\n            saveState();\n            mockDeliverCode(appState.identifier, appState.code, appState.contactMask);\n            // Focus\n            focusHeadingOrField('step2-title', codeInput);\n            break;\n          case 3:\n            newPw.value = '';\n            confirmPw.value = '';\n            pwError.textContent = '';\n            confirmError.textContent = '';\n            btnReset.disabled = true;\n            updateChecklist('');\n            // Reset visibility toggles to default hidden state\n            if (newPw.type !== 'password') toggleVisibility(newPw, togglePw);\n            if (confirmPw.type !== 'password') toggleVisibility(confirmPw, toggleConfirm);\n            focusHeadingOrField('step3-title', newPw);\n            break;\n          case 4:\n            focusHeadingOrField('done-title', null);\n            break;\n        }\n      }\n\n      // Step 1: Submit\n      function onSubmitStep1(e) {\n        e.preventDefault();\n        idError.textContent = '';\n        const raw = (idInput.value || '').trim();\n        const err = validateIdentifier(raw);\n        if (err) {\n          idError.textContent = err;\n          announce(err);\n          idInput.focus();\n          return;\n        }\n        appState.identifier = raw;\n        appState.verified = false; // starting a new flow invalidates previous verification\n        appState.contactMask = maskContact(raw);\n        appState.code = generateCode(raw);\n        saveState();\n        // Mock: \"send\" recovery code\n        mockDeliverCode(appState.identifier, appState.code, appState.contactMask);\n        setStep(2);\n      }\n\n      // Step 2: Input and submit\n      function onCodeInput(e) {\n        // Filter to digits only\n        const digits = (e.target.value || '').replace(/\\D+/g, '').slice(0, 6);\n        if (digits !== e.target.value) e.target.value = digits;\n        codeError.textContent = '';\n      }\n      function onCodePaste(e) {\n        const text = (e.clipboardData || window.clipboardData).getData('text') || '';\n        const digits = text.replace(/\\D+/g, '').slice(0, 6);\n        if (digits) {\n          e.preventDefault();\n          codeInput.value = digits;\n        }\n      }\n      function onSubmitStep2(e) {\n        e.preventDefault();\n        codeError.textContent = '';\n        const val = (codeInput.value || '').trim();\n        if (!/^\\d{6}$/.test(val)) {\n          const msg = 'Enter the 6-digit code.';\n          codeError.textContent = msg;\n          announce(msg);\n          appState.verified = false; // keep unverified on invalid input\n          saveState();\n          codeInput.focus();\n          return;\n        }\n        const expected = appState.code || generateCode(appState.identifier);\n        if (val !== expected) {\n          const msg = 'That code is not correct. Try again, or resend the code.';\n          codeError.textContent = msg;\n          announce(msg);\n          appState.verified = false; // keep unverified on failed verification\n          saveState();\n          codeInput.focus();\n          return;\n        }\n        // Success: mark verified\n        appState.verified = true;\n        saveState();\n        setStep(3);\n      }\n      function onResend() {\n        resendMsg.textContent = 'Code resent. Please check the console output.';\n        announce('Code resent.');\n        const code = appState.code || generateCode(appState.identifier);\n        mockDeliverCode(appState.identifier, code, appState.contactMask, /*resend*/true);\n      }\n\n      // Step 3: Password rules\n      function onPasswordInput() {\n        const pwd = newPw.value || '';\n        updateChecklist(pwd);\n        pwError.textContent = '';\n        // Enable submit only when all rules pass and confirm matches\n        btnReset.disabled = !(allRulesPass(pwd) && passwordsMatch());\n      }\n      function onConfirmInput() {\n        confirmError.textContent = '';\n        btnReset.disabled = !(allRulesPass(newPw.value || '') && passwordsMatch());\n      }\n      function passwordsMatch() {\n        return (newPw.value || '') === (confirmPw.value || '');\n      }\n      function allRulesPass(pwd) {\n        return pwd.length >= 12 &&\n               /[A-Z]/.test(pwd) &&\n               /[a-z]/.test(pwd) &&\n               /\\d/.test(pwd) &&\n               /[^A-Za-z0-9]/.test(pwd);\n      }\n      // Spec mapping (A11y task): updateChecklist toggles visual state and updates SR-only status spans (\"Met\"/\"Not met\")\n      function updateChecklist(pwd) {\n        const rules = {\n          length: (pwd.length >= 12),\n          upper: (/[A-Z]/.test(pwd)),\n          lower: (/[a-z]/.test(pwd)),\n          number: (/\\d/.test(pwd)),\n          symbol: (/[^A-Za-z0-9]/.test(pwd))\n        };\n        Object.keys(rules).forEach(key => {\n          ruleEls[key].classList.toggle('pass', !!rules[key]);\n          // Update the SR-only status text; decorative check icon remains aria-hidden\n          if (ruleStatusEls[key]) {\n            ruleStatusEls[key].textContent = rules[key] ? 'Met' : 'Not met';\n          }\n        });\n        // Show live feedback if user typed but rules not met\n        if (pwd && !allRulesPass(pwd)) {\n          pwError.textContent = 'Password does not meet all requirements.';\n        } else {\n          pwError.textContent = '';\n        }\n        // Confirm mismatch feedback\n        if (confirmPw.value && !passwordsMatch()) {\n          confirmError.textContent = 'Passwords do not match.';\n        } else {\n          confirmError.textContent = '';\n        }\n      }\n\n      // Step 3: Submit\n      function onSubmitStep3(e) {\n        e.preventDefault();\n        const pwd = newPw.value || '';\n        const confirm = confirmPw.value || '';\n        let localError = '';\n        if (!allRulesPass(pwd)) {\n          localError = 'Password does not meet all requirements.';\n          pwError.textContent = localError;\n          announce(localError);\n          newPw.focus();\n          return;\n        }\n        if (pwd !== confirm) {\n          localError = 'Passwords do not match.';\n          confirmError.textContent = localError;\n          announce(localError);\n          confirmPw.focus();\n          return;\n        }\n        // Mock success\n        console.log(`Mock: Password reset SUCCESS for identifier '${appState.identifier}'.`);\n        setStep(4);\n      }\n\n      // Utilities\n      function validateIdentifier(input) {\n        if (!input) return 'Please enter your email or username.';\n        if (input.includes('@')) {\n          // Simple email format check\n          const emailOk = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(input);\n          if (!emailOk) return 'Please enter a valid email address.';\n        } else {\n          // Username: at least 3 characters\n          if (input.length < 3) return 'Please enter a valid username (3 or more characters).';\n        }\n        return '';\n      }\n\n      function maskContact(identifier) {\n        if (identifier.includes('@')) {\n          const [local, domain] = identifier.split('@');\n          const maskedLocal = maskMiddle(local);\n          const domainParts = domain.split('.');\n          const domainName = domainParts[0] || '';\n          const domainTld = domainParts.slice(1).join('.') || '';\n          const maskedDomain = maskMiddle(domainName);\n          return `${maskedLocal}@${maskedDomain}${domainTld ? '.' + domainTld : ''}`;\n        } else {\n          return maskMiddle(identifier);\n        }\n      }\n\n      function maskMiddle(str) {\n        if (str.length <= 2) return (str[0] || '') + '•'.repeat(Math.max(0, str.length - 1));\n        const first = str[0];\n        const last = str[str.length - 1];\n        return `${first}${'•'.repeat(Math.max(1, str.length - 2))}${last}`;\n      }\n\n      // Deterministic 6-digit code generator (Spec mapping: Mocking)\n      function generateCode(identifier) {\n        let hash = 0;\n        const prime = 1315423911;\n        for (let i = 0; i < identifier.length; i++) {\n          hash ^= ((hash << 5) + identifier.charCodeAt(i) + (hash >> 2));\n        }\n        hash ^= prime;\n        const code = Math.abs(hash) % 1000000;\n        return String(code).padStart(6, '0');\n      }\n\n      // Mock delivery via console.log\n      function mockDeliverCode(identifier, code, mask, isResend = false) {\n        const action = isResend ? 'RESEND' : 'SEND';\n        console.log(`Mock ${action}: Recovery code for '${identifier}' is ${code} (to ${mask})`);\n        announce(isResend ? 'Code resent.' : 'Code sent.');\n      }\n\n      // Accessibility: Live region announcer\n      function announce(message) {\n        if (!message) {\n          liveRegion.textContent = '';\n          return;\n        }\n        liveRegion.textContent = message;\n      }\n\n      // Toggle show/hide password\n      // Spec mapping (A11y): Keep label in sync and toggle aria-pressed to reflect visibility\n      function toggleVisibility(inputEl, toggleBtn) {\n        const isPassword = inputEl.type === 'password';\n        inputEl.type = isPassword ? 'text' : 'password';\n        toggleBtn.textContent = isPassword ? 'Hide' : 'Show';\n        toggleBtn.setAttribute('aria-pressed', isPassword ? 'true' : 'false');\n      }\n\n      // Focus management on step change\n      function focusHeadingOrField(headingId, fieldEl) {\n        const heading = document.getElementById(headingId);\n        if (heading) {\n          heading.setAttribute('tabindex', '-1');\n          heading.focus();\n          // Cleanup tabindex after focus\n          setTimeout(() => heading.removeAttribute('tabindex'), 0);\n        }\n        if (fieldEl) {\n          setTimeout(() => fieldEl.focus(), 50);\n        }\n      }\n\n      // State persistence\n      function saveState() {\n        try {\n          sessionStorage.setItem('recoveryState', JSON.stringify(appState));\n        } catch (_) {}\n      }\n      function loadState() {\n        try {\n          const raw = sessionStorage.getItem('recoveryState');\n          return raw ? JSON.parse(raw) : null;\n        } catch (_) {\n          return null;\n        }\n      }\n\n      // Keyboard: Enter to submit is default via forms; tab order follows DOM.\n    })();\n  </script>\n</body>\n</html>\n", "task_list": ["Darken --primary or use darker text on primary buttons so white text reaches ≥4.5:1 contrast.", "Ensure secondary button text color on white background meets ≥4.5:1 (e.g., adjust --primary or use a darker variant for text/border).", "For #toggle-pw, set aria-label to “Show new password” and toggle to “Hide new password” when pressed.", "For #toggle-confirm, set aria-label to “Show confirm password” and toggle to “Hide confirm password” when pressed.", "identifier, code, new-password, confirm-password: set aria-invalid=\"true\" on validation failure; remove or set to \"false\" on success."], "evaluator_md": "SUMMARY\nThe single-file mock password recovery flow is well-implemented, accessible, and faithful to the requirements: it’s fully client-side, deterministic, includes clear spec-mapped comments, and provides a 3-step flow with gating, masking, and console-based mocking. Most functional and UX aspects are solid, including good accessibility patterns. A few accessibility details likely required by acceptance criteria need adjustment: button color contrast appears to miss WCAG AA, and the password visibility toggles should have clearer accessible names. Adding aria-invalid on error would further improve SR feedback.\n\nFUNCTIONAL_CHECK\n- AC1: Single self-contained file (index.html) with inline CSS and JS — PASS\n  - One HTML file; all styles and scripts inline; no build step.\n- AC2: Semantic structure with labeled regions — PASS\n  - Uses header, main, footer, sections with role=region and aria-labelledby; properly labeled form fields.\n- AC3: Spec-mapped comments present — PASS\n  - Clear comments mapping each section to the spec.\n- AC4: Client-only; mocking via console; no network calls — PASS\n  - Deterministic mock delivery via console.log; no external calls or APIs.\n- AC5: Deterministic 6-digit code, consistent on resend — PASS\n  - generateCode(identifier) is deterministic; resend logs same code.\n- AC6: Step 1: Accepts email or username; validates and errors via aria-live — PASS\n  - Email format check or username length; errors surfaced; clear helper text.\n- AC7: Step 2: Displays masked contact derived from input — PASS\n  - Masking for email and username implemented; displayed in UI.\n- AC8: Step 2: Code input supports numeric-only and paste; validates 6 digits — PASS\n  - Input filtering to digits, paste handling, pattern, and JS validation with useful error.\n- AC9: Resend re-logs code and informs user — PASS\n  - Resend logs, shows message, and announces via live region.\n- AC10: Step gating and URL hash navigation with safeguards — PASS\n  - Steps 3/4 gated by identifier + verified; hash changes enforced.\n- AC11: Progress indicator with updates and accessibility — PASS\n  - “Step X of 3” with aria-live=polite; hidden on completion.\n- AC12: Step 3: Password policy enforced (12+, upper, lower, number, symbol) — PASS\n  - Live checklist with rule updates; submit disabled until all pass and match.\n- AC13: Confirm password must match; error surfaced — PASS\n  - Mismatch messages and disabling logic present.\n- AC14: Password visibility toggles with state feedback — PARTIAL PASS\n  - Functionally correct with aria-pressed; however, accessible name is generic (“Show/Hide”) and does not specify which field, which may not meet AC for explicit control naming.\n- AC15: Completion screen and restart flow — PASS\n  - Success screen, console success log, and a restart button reset state.\n- AC16: State persistence across reloads with sessionStorage and hash — PASS\n  - State loaded/saved; gating preserved on reload; hash synced.\n- AC17: Clear “mock/demo only” disclosures — PASS\n  - Disclosures in header, footer, and helper text.\n- AC18: Accessibility: labels, descriptions, live regions, focus management, keyboard-only — PASS\n  - aria-describedby for help/errors, aria-live regions, strong focus outline, heading/field focus on step change.\n- AC19: Inclusive design for older adult and ADHD (readability, simple single-column, helpers) — PASS\n  - 18px base font, single-column layout, plain language, clear steps.\n- AC20: Color contrast meets WCAG AA for text and interactive elements — FAIL\n  - Primary button (#0b5fff) with white text likely < 4.5:1; secondary button text (#0b5fff) on white also likely < 4.5:1.\n- AC21: Inputs reflect invalid state to assistive tech (aria-invalid) — FAIL\n  - Errors shown but aria-invalid not applied/cleared on fields.\n\nFAILING_ITEMS\n- Primary and secondary button color contrast likely below WCAG AA (4.5:1) for normal-sized text.\n- Password visibility toggle buttons use generic labels (“Show/Hide”) without explicit accessible naming tied to the field; may be ambiguous to screen readers.\n- Inputs do not set aria-invalid=\"true\" when errors are present (identifier, code, new password, confirm password).\n\nNEW_TASKS\n1) Increase color contrast for interactive elements to meet WCAG AA:\n   - Darken --primary or use darker text on primary buttons so white text reaches ≥4.5:1 contrast.\n   - Ensure secondary button text color on white background meets ≥4.5:1 (e.g., adjust --primary or use a darker variant for text/border).\n2) Add explicit accessible names to password visibility toggles:\n   - For #toggle-pw, set aria-label to “Show new password” and toggle to “Hide new password” when pressed.\n   - For #toggle-confirm, set aria-label to “Show confirm password” and toggle to “Hide confirm password” when pressed.\n3) Apply aria-invalid to inputs when errors are shown and remove it when resolved:\n   - identifier, code, new-password, confirm-password: set aria-invalid=\"true\" on validation failure; remove or set to \"false\" on success.\n\nDECISION\nFAIL", "done": false, "iter": 3, "step": 9}
{"code_html": "\n<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\">\n  <title>Password Recovery (Mock, Client-Only)</title>\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n  <!--\n    Password Recovery System — Single-Page, Client-Only, Mocked\n\n    Spec Mapping (Purpose, Use-case, Deliverables, Mocking):\n    - Purpose: Provide a self-contained, browser-only password recovery flow for evaluation. Not for production.\n    - Use-case: Helena (67, heart disease, ADHD) needs to reset her strong password to log in and accept updated privacy conditions to allow hospital staff to book an appointment.\n    - Deliverables: One index.html (this file) using semantic HTML, inline CSS & JS. No build step. Sections are commented to map to the spec.\n    - Mocking: Delivery and verification are simulated through deterministic code generation and console.log outputs. No servers or external calls.\n\n    Developer testing note:\n    - Open this file in any modern browser (no server needed).\n    - Step 1: Enter an email or username, press Continue. The deterministic 6‑digit code is generated from your input and logged in the console.\n    - Step 2: Enter or paste the 6-digit code from the console to verify. Use \"Resend Code\" to log the same code again.\n    - Step 3: Enter a new password meeting the rules and confirm it. On success, a confirmation screen appears, and the console logs a success message with the user identifier.\n    - Observe mocked outputs in DevTools console.\n  -->\n  <style>\n    /* === Accessibility & Layout CSS (High contrast, readable typography, single-column, visible focus) === */\n    :root {\n      --bg: #ffffff;\n      --fg: #111111;\n      --muted: #555555;\n      /* Spec mapping (A11y contrast): Primary color updated to ensure ≥4.5:1 contrast with white text and as text on white */\n      --primary: #0D47A1; /* Contrast vs white ~8:1; satisfies requirements for primary and secondary usage */\n      --danger: #b00020;\n      --success: #137333;\n      --surface: #f5f7fb;\n      --border: #d0d7e2;\n      --focus: #ff9900;\n      --font-size-base: 18px; /* readable typography */\n      --radius: 10px;\n      --space: 16px;\n    }\n    html, body {\n      margin: 0;\n      padding: 0;\n      background: var(--bg);\n      color: var(--fg);\n      font-family: system-ui, -apple-system, Segoe UI, Roboto, \"Helvetica Neue\", Arial, \"Noto Sans\", \"Apple Color Emoji\", \"Segoe UI Emoji\", \"Segoe UI Symbol\";\n      font-size: var(--font-size-base);\n      line-height: 1.5;\n    }\n    header, main, footer {\n      max-width: 720px;\n      margin: 0 auto;\n      padding: 16px;\n    }\n    header {\n      padding-top: 24px;\n      padding-bottom: 8px;\n    }\n    h1, h2, h3 {\n      line-height: 1.2;\n      margin: 0 0 12px;\n    }\n    p {\n      margin: 0 0 12px;\n    }\n    .card {\n      background: var(--surface);\n      border: 1px solid var(--border);\n      border-radius: var(--radius);\n      padding: 16px;\n    }\n    .progress {\n      font-weight: 600;\n      color: var(--muted);\n      margin-bottom: 8px;\n    }\n    label {\n      font-weight: 600;\n      display: block;\n      margin-bottom: 6px;\n    }\n    input[type=\"text\"],\n    input[type=\"email\"],\n    input[type=\"password\"],\n    input[type=\"tel\"] {\n      width: 100%;\n      padding: 12px;\n      font-size: 1rem;\n      border-radius: 8px;\n      border: 2px solid var(--border);\n      background: #fff;\n      color: var(--fg);\n      box-sizing: border-box;\n    }\n    input:focus-visible, button:focus-visible, a:focus-visible {\n      outline: 3px solid var(--focus);\n      outline-offset: 2px;\n    }\n    .helper {\n      color: var(--muted);\n      font-size: 0.95rem;\n      margin-top: 4px;\n    }\n    .error {\n      color: var(--danger);\n      margin-top: 8px;\n      font-weight: 600;\n    }\n    .success {\n      color: var(--success);\n      margin-top: 8px;\n      font-weight: 600;\n    }\n    .actions {\n      display: flex;\n      gap: 12px;\n      flex-wrap: wrap;\n      margin-top: 12px;\n    }\n    button {\n      background: var(--primary);\n      color: #fff; /* Primary action text on --primary background (≥4.5:1 contrast) */\n      border: none;\n      border-radius: 8px;\n      padding: 12px 16px;\n      font-size: 1rem;\n      cursor: pointer;\n    }\n    button.secondary {\n      background: transparent;\n      color: var(--primary); /* Secondary action text on white (≥4.5:1 contrast) */\n      border: 2px solid var(--primary); /* Border also meets contrast on white */\n    }\n    button.linklike {\n      background: transparent;\n      color: var(--primary);\n      border: none;\n      padding: 8px 0;\n      text-decoration: underline;\n    }\n    .sr-only {\n      position: absolute;\n      width: 1px; height: 1px;\n      padding: 0; margin: -1px;\n      overflow: hidden; clip: rect(0,0,0,0);\n      border: 0;\n    }\n    .checklist {\n      list-style: none;\n      padding-left: 0;\n      margin: 8px 0 0;\n    }\n    .checklist li {\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      margin: 4px 0;\n    }\n    .check {\n      width: 1.1em;\n      height: 1.1em;\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n      border-radius: 4px;\n      border: 2px solid var(--border);\n      font-weight: 800;\n      font-size: 0.85em;\n      background: #fff;\n      color: transparent;\n    }\n    .check.pass {\n      border-color: var(--success);\n      background: #e9f6ee;\n      color: var(--success);\n    }\n    .field-row {\n      margin: 12px 0;\n    }\n    .inline {\n      display: inline-flex;\n      align-items: center;\n      gap: 8px;\n    }\n    .toggle-visibility {\n      background: transparent;\n      color: var(--primary);\n      border: none;\n      padding: 6px 8px;\n      cursor: pointer;\n      text-decoration: underline;\n    }\n    .masked-contact {\n      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, \"Liberation Mono\", monospace;\n      background: #fff;\n      border: 1px dashed var(--border);\n      padding: 6px 8px;\n      border-radius: 6px;\n      display: inline-block;\n    }\n    .footer-note {\n      color: var(--muted);\n      font-size: 0.95rem;\n      margin-top: 8px;\n    }\n    /* Responsive single-column is default. Ensure adequate spacing. */\n    .spacer { height: 8px; }\n  </style>\n</head>\n<body>\n  <!-- === Header (Semantic) === -->\n  <header role=\"banner\">\n    <h1 id=\"app-title\">Reset your password</h1>\n    <p class=\"footer-note\">\n      This is a fully client-side, mocked recovery demo for evaluation purposes only.\n    </p>\n  </header>\n\n  <!-- === Main (Flow Steps) === -->\n  <main id=\"app\" role=\"main\" aria-labelledby=\"app-title\">\n    <div id=\"progress\" class=\"progress\" aria-live=\"polite\">Step 1 of 3</div>\n\n    <!-- Global aria-live for announcements (errors and confirmations) -->\n    <div id=\"live-region\" class=\"sr-only\" aria-live=\"polite\"></div>\n\n    <!-- Step 1: Identify account -->\n    <section id=\"step1\" class=\"card\" role=\"region\" aria-labelledby=\"step1-title\">\n      <!-- Spec mapping: Step 1 form with labels, helper text, accessible submit; validate required and email format; errors via aria-live -->\n      <h2 id=\"step1-title\">Find your account</h2>\n      <p>Enter your email address or username to receive a verification code.</p>\n      <form id=\"form-step1\" novalidate>\n        <div class=\"field-row\">\n          <label for=\"identifier\">Email or Username</label>\n          <input id=\"identifier\" name=\"identifier\" type=\"text\" placeholder=\"e.g., helena@example.com or helena67\"\n                 autocomplete=\"username\" required aria-describedby=\"id-helper id-error\">\n          <div id=\"id-helper\" class=\"helper\">We will send a 6-digit code to your contact on file. No emails are sent in this demo.</div>\n          <div id=\"id-error\" class=\"error\" aria-live=\"polite\"></div>\n        </div>\n        <div class=\"actions\">\n          <button id=\"btn-step1\" type=\"submit\">Continue</button>\n        </div>\n      </form>\n    </section>\n\n    <!-- Step 2: Code verification -->\n    <section id=\"step2\" class=\"card\" role=\"region\" aria-labelledby=\"step2-title\" hidden>\n      <!-- Spec mapping: Step 2 with progress indicator, masked contact, code input accepting typing or paste, errors via aria-live -->\n      <h2 id=\"step2-title\">Enter verification code</h2>\n      <p>We sent a 6-digit code to:</p>\n      <p class=\"masked-contact\" id=\"contact-mask\">••••</p>\n      <div class=\"spacer\"></div>\n      <form id=\"form-step2\" novalidate>\n        <div class=\"field-row\">\n          <label for=\"code\">6-digit code</label>\n          <input id=\"code\" name=\"code\" inputmode=\"numeric\" autocomplete=\"one-time-code\"\n                 placeholder=\"123456\" pattern=\"\\d{6}\" maxlength=\"6\" aria-describedby=\"code-helper code-error\">\n          <div id=\"code-helper\" class=\"helper\">Type or paste the 6 digits. Only numbers are accepted.</div>\n          <div id=\"code-error\" class=\"error\" aria-live=\"polite\"></div>\n        </div>\n        <div class=\"actions\">\n          <button id=\"btn-verify\" type=\"submit\">Verify Code</button>\n          <button id=\"btn-resend\" type=\"button\" class=\"secondary\">Resend Code</button>\n        </div>\n        <div id=\"resend-msg\" class=\"success\" aria-live=\"polite\" aria-atomic=\"true\"></div>\n      </form>\n    </section>\n\n    <!-- Step 3: Set new password -->\n    <section id=\"step3\" class=\"card\" role=\"region\" aria-labelledby=\"step3-title\" hidden>\n      <!-- Spec mapping: Step 3 with password + confirm, show/hide toggle, strength guidance, live checklist, require confirm match -->\n      <h2 id=\"step3-title\">Create a new password</h2>\n      <p>Choose a strong password that you haven't used with this account before.</p>\n      <form id=\"form-step3\" novalidate>\n        <div class=\"field-row\">\n          <label for=\"new-password\">New password</label>\n          <div class=\"inline\" style=\"width:100%\">\n            <input id=\"new-password\" name=\"new-password\" type=\"password\" autocomplete=\"new-password\"\n                   aria-describedby=\"pw-helper pw-req pw-error\" required>\n            <!-- Spec mapping (A11y toggles): Initial aria-label reflects masked state -->\n            <button type=\"button\" id=\"toggle-pw\" class=\"toggle-visibility\" aria-controls=\"new-password\" aria-pressed=\"false\" aria-label=\"Show new password\">Show</button>\n          </div>\n          <div id=\"pw-helper\" class=\"helper\">Your password must meet all of the following:</div>\n          <!-- Spec mapping (A11y task): Checklist has aria-live=\"polite\" and each rule contains a decorative check icon and an SR-only status text -->\n          <ul id=\"pw-req\" class=\"checklist\" aria-live=\"polite\" aria-atomic=\"false\">\n            <li>\n              <span id=\"rule-length\" class=\"check\" aria-hidden=\"true\">✓</span>\n              <span>At least 12 characters</span>\n              <span id=\"rule-length-status\" class=\"sr-only\">Not met</span>\n            </li>\n            <li>\n              <span id=\"rule-upper\" class=\"check\" aria-hidden=\"true\">✓</span>\n              <span>Contains an uppercase letter (A–Z)</span>\n              <span id=\"rule-upper-status\" class=\"sr-only\">Not met</span>\n            </li>\n            <li>\n              <span id=\"rule-lower\" class=\"check\" aria-hidden=\"true\">✓</span>\n              <span>Contains a lowercase letter (a–z)</span>\n              <span id=\"rule-lower-status\" class=\"sr-only\">Not met</span>\n            </li>\n            <li>\n              <span id=\"rule-number\" class=\"check\" aria-hidden=\"true\">✓</span>\n              <span>Contains a number (0–9)</span>\n              <span id=\"rule-number-status\" class=\"sr-only\">Not met</span>\n            </li>\n            <li>\n              <span id=\"rule-symbol\" class=\"check\" aria-hidden=\"true\">✓</span>\n              <span>Contains a symbol (!@#$…)</span>\n              <span id=\"rule-symbol-status\" class=\"sr-only\">Not met</span>\n            </li>\n          </ul>\n          <div id=\"pw-error\" class=\"error\" aria-live=\"polite\"></div>\n        </div>\n\n        <div class=\"field-row\">\n          <label for=\"confirm-password\">Confirm new password</label>\n          <div class=\"inline\" style=\"width:100%\">\n            <input id=\"confirm-password\" name=\"confirm-password\" type=\"password\" autocomplete=\"new-password\"\n                   aria-describedby=\"confirm-error\" required>\n            <!-- Spec mapping (A11y toggles): Initial aria-label reflects masked state -->\n            <button type=\"button\" id=\"toggle-confirm\" class=\"toggle-visibility\" aria-controls=\"confirm-password\" aria-pressed=\"false\" aria-label=\"Show confirm password\">Show</button>\n          </div>\n          <div id=\"confirm-error\" class=\"error\" aria-live=\"polite\"></div>\n        </div>\n\n        <div class=\"actions\">\n          <button id=\"btn-reset\" type=\"submit\" disabled>Reset password</button>\n        </div>\n      </form>\n    </section>\n\n    <!-- Done: Confirmation -->\n    <section id=\"done\" class=\"card\" role=\"region\" aria-labelledby=\"done-title\" hidden>\n      <!-- Spec mapping: Confirmation with next steps; console success logged -->\n      <h2 id=\"done-title\">Password updated</h2>\n      <p>Your password has been reset successfully.</p>\n      <ul>\n        <li>You can now sign in with your new password.</li>\n        <li>After signing in, please review and accept the updated privacy conditions so hospital staff can assist with booking your appointment.</li>\n      </ul>\n      <p class=\"footer-note\">Tip: For memory support, consider using a password manager. Avoid writing passwords where others might see them.</p>\n      <div class=\"actions\">\n        <button type=\"button\" id=\"btn-restart\" class=\"secondary\">Start over</button>\n      </div>\n    </section>\n  </main>\n\n  <!-- === Footer (Semantic) === -->\n  <footer role=\"contentinfo\">\n    <p class=\"footer-note\">\n      Mocked client-side demo. No data is transmitted. Console shows simulated delivery and verification.\n    </p>\n  </footer>\n\n  <script>\n    // === JS: Single-file client-only app state and handlers ===\n    // Spec mapping (Mocking): Deterministic code generation and console.log simulate delivery/verification.\n    // Spec mapping (In-page state): URL hash reflects step; state restored from sessionStorage on reload.\n    (function () {\n      'use strict';\n\n      // App state model kept in-memory and mirrored to sessionStorage\n      // Spec mapping (State & Security gating): Add verified flag to gate steps 3/4.\n      const defaultState = { step: 1, identifier: '', contactMask: '', code: '', verified: false };\n      let appState = loadState() || { ...defaultState };\n      if (typeof appState.verified !== 'boolean') appState.verified = false; // normalize state from older sessions\n\n      // Element refs\n      const sections = {\n        step1: document.getElementById('step1'),\n        step2: document.getElementById('step2'),\n        step3: document.getElementById('step3'),\n        done: document.getElementById('done')\n      };\n      const progressEl = document.getElementById('progress');\n      const liveRegion = document.getElementById('live-region');\n      // Step 1\n      const form1 = document.getElementById('form-step1');\n      const idInput = document.getElementById('identifier');\n      const idError = document.getElementById('id-error');\n      const btn1 = document.getElementById('btn-step1');\n      // Step 2\n      const form2 = document.getElementById('form-step2');\n      const codeInput = document.getElementById('code');\n      const codeError = document.getElementById('code-error');\n      const contactMaskEl = document.getElementById('contact-mask');\n      const btnVerify = document.getElementById('btn-verify');\n      const btnResend = document.getElementById('btn-resend');\n      const resendMsg = document.getElementById('resend-msg');\n      // Step 3\n      const form3 = document.getElementById('form-step3');\n      const newPw = document.getElementById('new-password');\n      const confirmPw = document.getElementById('confirm-password');\n      const togglePw = document.getElementById('toggle-pw');\n      const toggleConfirm = document.getElementById('toggle-confirm');\n      const pwError = document.getElementById('pw-error');\n      const confirmError = document.getElementById('confirm-error');\n      const btnReset = document.getElementById('btn-reset');\n      const ruleEls = {\n        length: document.getElementById('rule-length'),\n        upper: document.getElementById('rule-upper'),\n        lower: document.getElementById('rule-lower'),\n        number: document.getElementById('rule-number'),\n        symbol: document.getElementById('rule-symbol')\n      };\n      // A11y: SR-only status elements for each rule (initially \"Not met\")\n      const ruleStatusEls = {\n        length: document.getElementById('rule-length-status'),\n        upper: document.getElementById('rule-upper-status'),\n        lower: document.getElementById('rule-lower-status'),\n        number: document.getElementById('rule-number-status'),\n        symbol: document.getElementById('rule-symbol-status')\n      };\n      // Done\n      const btnRestart = document.getElementById('btn-restart');\n\n      // Initialize: restore from hash + session state\n      initFromHashOrDefault();\n\n      // === Event wiring ===\n      form1.addEventListener('submit', onSubmitStep1);\n      form2.addEventListener('submit', onSubmitStep2);\n      btnResend.addEventListener('click', onResend);\n      codeInput.addEventListener('input', onCodeInput);\n      codeInput.addEventListener('paste', onCodePaste);\n      form3.addEventListener('submit', onSubmitStep3);\n      newPw.addEventListener('input', onPasswordInput);\n      confirmPw.addEventListener('input', onConfirmInput);\n      togglePw.addEventListener('click', () => toggleVisibility(newPw, togglePw));\n      toggleConfirm.addEventListener('click', () => toggleVisibility(confirmPw, toggleConfirm));\n      btnRestart.addEventListener('click', () => {\n        // Spec mapping (Flow restart): Reset verified to false.\n        appState = { ...defaultState };\n        saveState();\n        setStep(1);\n      });\n      window.addEventListener('hashchange', onHashChange);\n\n      // Also update aria-invalid states as user edits identifier\n      idInput.addEventListener('input', () => {\n        const raw = (idInput.value || '').trim();\n        const err = validateIdentifier(raw);\n        if (!raw) {\n          idInput.removeAttribute('aria-invalid');\n          idError.textContent = '';\n        } else {\n          idInput.setAttribute('aria-invalid', err ? 'true' : 'false');\n          idError.textContent = '';\n        }\n      });\n\n      // === Functions (Spec mapping: Mocking, Validation, Navigation, Accessibility) ===\n\n      // Hash and state bootstrap with gating\n      function initFromHashOrDefault() {\n        const targetStep = parseStepFromHash();\n        const stored = loadState();\n        if (stored) appState = stored;\n        if (typeof appState.verified !== 'boolean') appState.verified = false;\n\n        if (Number.isInteger(targetStep) && targetStep >= 1 && targetStep <= 4) {\n          if (targetStep === 1) {\n            setStep(1);\n          } else if (targetStep === 2) {\n            appState.identifier ? setStep(2) : setStep(1);\n          } else if (targetStep === 3 || targetStep === 4) {\n            if (appState.identifier && appState.verified) {\n              setStep(targetStep);\n            } else if (appState.identifier) {\n              setStep(2); // Spec mapping (Gating): redirect to Step 2 if not verified\n            } else {\n              setStep(1);\n            }\n          }\n        } else {\n          setStep(appState.step || 1);\n        }\n      }\n\n      function onHashChange() {\n        const targetStep = parseStepFromHash();\n        if (!Number.isInteger(targetStep)) return;\n        // Spec mapping (Gating on hash navigation): Steps 3/4 require identifier + verified\n        if (targetStep === 1) {\n          setStep(1);\n        } else if (targetStep === 2) {\n          appState.identifier ? setStep(2) : setStep(1);\n        } else if (targetStep === 3 || targetStep === 4) {\n          if (appState.identifier && appState.verified) {\n            setStep(targetStep);\n          } else if (appState.identifier) {\n            setStep(2);\n          } else {\n            setStep(1);\n          }\n        }\n      }\n\n      function parseStepFromHash() {\n        const h = location.hash.replace('#', '');\n        switch (h) {\n          case 'step1': return 1;\n          case 'step2': return 2;\n          case 'step3': return 3;\n          case 'done': return 4;\n          default: return null;\n        }\n      }\n\n      function updateHash() {\n        const map = { 1: 'step1', 2: 'step2', 3: 'step3', 4: 'done' };\n        const hash = '#' + map[appState.step];\n        if (location.hash !== hash) {\n          history.replaceState(null, '', hash);\n        }\n      }\n\n      function setStep(stepNumber) {\n        // Spec mapping (Gating in step-setting): enforce prerequisites\n        if (stepNumber === 2 && !appState.identifier) {\n          stepNumber = 1;\n        }\n        if ((stepNumber === 3 || stepNumber === 4) && (!appState.identifier || !appState.verified)) {\n          stepNumber = 2; // redirect to Step 2 if not verified\n        }\n\n        appState.step = stepNumber;\n        saveState();\n        updateHash();\n        // Toggle sections\n        sections.step1.hidden = stepNumber !== 1;\n        sections.step2.hidden = stepNumber !== 2;\n        sections.step3.hidden = stepNumber !== 3;\n        sections.done.hidden = stepNumber !== 4;\n        // Update progress text\n        if (stepNumber >= 1 && stepNumber <= 3) {\n          progressEl.textContent = `Step ${stepNumber} of 3`;\n          progressEl.hidden = false;\n        } else {\n          progressEl.hidden = true;\n        }\n        // On step entry, manage content and focus\n        switch (stepNumber) {\n          case 1:\n            announce('');\n            idError.textContent = '';\n            idInput.removeAttribute('aria-invalid'); // A11y: clear invalid state on step entry\n            focusHeadingOrField('step1-title', idInput);\n            break;\n          case 2:\n            // Spec mapping (Verification state): Reset verified when entering Step 2 (including via hash/back)\n            appState.verified = false;\n            saveState();\n            // Populate masked contact\n            appState.contactMask = appState.contactMask || maskContact(appState.identifier);\n            contactMaskEl.textContent = appState.contactMask;\n            codeInput.value = '';\n            codeError.textContent = '';\n            codeInput.removeAttribute('aria-invalid'); // A11y: clear invalid state on entry\n            resendMsg.textContent = '';\n            // On step change, \"send\" mock code deterministically (same code every time)\n            appState.code = generateCode(appState.identifier);\n            saveState();\n            mockDeliverCode(appState.identifier, appState.code, appState.contactMask);\n            // Focus\n            focusHeadingOrField('step2-title', codeInput);\n            break;\n          case 3:\n            newPw.value = '';\n            confirmPw.value = '';\n            pwError.textContent = '';\n            confirmError.textContent = '';\n            newPw.removeAttribute('aria-invalid'); // A11y: clear invalid on entry\n            confirmPw.removeAttribute('aria-invalid');\n            btnReset.disabled = true;\n            updateChecklist('');\n            // Reset visibility toggles to default hidden state\n            if (newPw.type !== 'password') toggleVisibility(newPw, togglePw);\n            if (confirmPw.type !== 'password') toggleVisibility(confirmPw, toggleConfirm);\n            // Ensure aria-labels reflect masked state\n            togglePw.setAttribute('aria-label', 'Show new password');\n            toggleConfirm.setAttribute('aria-label', 'Show confirm password');\n            focusHeadingOrField('step3-title', newPw);\n            break;\n          case 4:\n            focusHeadingOrField('done-title', null);\n            break;\n        }\n      }\n\n      // Step 1: Submit\n      function onSubmitStep1(e) {\n        e.preventDefault();\n        idError.textContent = '';\n        const raw = (idInput.value || '').trim();\n        const err = validateIdentifier(raw);\n        if (err) {\n          idError.textContent = err;\n          announce(err);\n          idInput.setAttribute('aria-invalid', 'true'); // A11y: mark invalid on failure\n          idInput.focus();\n          return;\n        }\n        idInput.setAttribute('aria-invalid', 'false'); // A11y: valid state\n        appState.identifier = raw;\n        appState.verified = false; // starting a new flow invalidates previous verification\n        appState.contactMask = maskContact(raw);\n        appState.code = generateCode(raw);\n        saveState();\n        // Mock: \"send\" recovery code\n        mockDeliverCode(appState.identifier, appState.code, appState.contactMask);\n        setStep(2);\n      }\n\n      // Step 2: Input and submit\n      function onCodeInput(e) {\n        // Filter to digits only\n        const digits = (e.target.value || '').replace(/\\D+/g, '').slice(0, 6);\n        if (digits !== e.target.value) e.target.value = digits;\n        // A11y: Update aria-invalid based on basic pattern as user types\n        if (!digits) {\n          codeInput.removeAttribute('aria-invalid');\n        } else if (!/^\\d{6}$/.test(digits)) {\n          codeInput.setAttribute('aria-invalid', 'true');\n        } else {\n          codeInput.setAttribute('aria-invalid', 'false');\n        }\n        codeError.textContent = '';\n      }\n      function onCodePaste(e) {\n        const text = (e.clipboardData || window.clipboardData).getData('text') || '';\n        const digits = text.replace(/\\D+/g, '').slice(0, 6);\n        if (digits) {\n          e.preventDefault();\n          codeInput.value = digits;\n          // A11y: evaluate after paste\n          codeInput.setAttribute('aria-invalid', /^\\d{6}$/.test(digits) ? 'false' : 'true');\n        }\n      }\n      function onSubmitStep2(e) {\n        e.preventDefault();\n        codeError.textContent = '';\n        const val = (codeInput.value || '').trim();\n        if (!/^\\d{6}$/.test(val)) {\n          const msg = 'Enter the 6-digit code.';\n          codeError.textContent = msg;\n          announce(msg);\n          appState.verified = false; // keep unverified on invalid input\n          saveState();\n          codeInput.setAttribute('aria-invalid', 'true'); // A11y: invalid\n          codeInput.focus();\n          return;\n        }\n        const expected = appState.code || generateCode(appState.identifier);\n        if (val !== expected) {\n          const msg = 'That code is not correct. Try again, or resend the code.';\n          codeError.textContent = msg;\n          announce(msg);\n          appState.verified = false; // keep unverified on failed verification\n          saveState();\n          codeInput.setAttribute('aria-invalid', 'true'); // A11y: invalid on mismatch\n          codeInput.focus();\n          return;\n        }\n        // Success: mark verified\n        appState.verified = true;\n        saveState();\n        codeInput.setAttribute('aria-invalid', 'false'); // A11y: valid\n        setStep(3);\n      }\n      function onResend() {\n        resendMsg.textContent = 'Code resent. Please check the console output.';\n        announce('Code resent.');\n        const code = appState.code || generateCode(appState.identifier);\n        mockDeliverCode(appState.identifier, code, appState.contactMask, /*resend*/true);\n      }\n\n      // Step 3: Password rules\n      function onPasswordInput() {\n        const pwd = newPw.value || '';\n        updateChecklist(pwd);\n        pwError.textContent = '';\n        // A11y: aria-invalid for new password based on rules\n        if (!pwd) {\n          newPw.removeAttribute('aria-invalid');\n        } else {\n          newPw.setAttribute('aria-invalid', allRulesPass(pwd) ? 'false' : 'true');\n        }\n        // Enable submit only when all rules pass and confirm matches\n        btnReset.disabled = !(allRulesPass(pwd) && passwordsMatch());\n      }\n      function onConfirmInput() {\n        confirmError.textContent = '';\n        // A11y: aria-invalid for confirm based on match\n        const hasVal = !!(confirmPw.value || '');\n        if (!hasVal) {\n          confirmPw.removeAttribute('aria-invalid');\n        } else {\n          confirmPw.setAttribute('aria-invalid', passwordsMatch() ? 'false' : 'true');\n        }\n        btnReset.disabled = !(allRulesPass(newPw.value || '') && passwordsMatch());\n      }\n      function passwordsMatch() {\n        return (newPw.value || '') === (confirmPw.value || '');\n      }\n      function allRulesPass(pwd) {\n        return pwd.length >= 12 &&\n               /[A-Z]/.test(pwd) &&\n               /[a-z]/.test(pwd) &&\n               /\\d/.test(pwd) &&\n               /[^A-Za-z0-9]/.test(pwd);\n      }\n      // Spec mapping (A11y task): updateChecklist toggles visual state and updates SR-only status spans (\"Met\"/\"Not met\")\n      function updateChecklist(pwd) {\n        const rules = {\n          length: (pwd.length >= 12),\n          upper: (/[A-Z]/.test(pwd)),\n          lower: (/[a-z]/.test(pwd)),\n          number: (/\\d/.test(pwd)),\n          symbol: (/[^A-Za-z0-9]/.test(pwd))\n        };\n        Object.keys(rules).forEach(key => {\n          ruleEls[key].classList.toggle('pass', !!rules[key]);\n          // Update the SR-only status text; decorative check icon remains aria-hidden\n          if (ruleStatusEls[key]) {\n            ruleStatusEls[key].textContent = rules[key] ? 'Met' : 'Not met';\n          }\n        });\n        // Show live feedback if user typed but rules not met\n        if (pwd && !allRulesPass(pwd)) {\n          pwError.textContent = 'Password does not meet all requirements.';\n        } else {\n          pwError.textContent = '';\n        }\n        // Confirm mismatch feedback\n        if (confirmPw.value && !passwordsMatch()) {\n          confirmError.textContent = 'Passwords do not match.';\n          confirmPw.setAttribute('aria-invalid', 'true'); // A11y: invalid when mismatch\n        } else {\n          if (confirmPw.value) {\n            confirmPw.setAttribute('aria-invalid', 'false');\n          } else {\n            confirmPw.removeAttribute('aria-invalid');\n          }\n          confirmError.textContent = '';\n        }\n      }\n\n      // Step 3: Submit\n      function onSubmitStep3(e) {\n        e.preventDefault();\n        const pwd = newPw.value || '';\n        const confirm = confirmPw.value || '';\n        let localError = '';\n        if (!allRulesPass(pwd)) {\n          localError = 'Password does not meet all requirements.';\n          pwError.textContent = localError;\n          announce(localError);\n          newPw.setAttribute('aria-invalid', 'true'); // A11y: invalid\n          newPw.focus();\n          return;\n        } else {\n          newPw.setAttribute('aria-invalid', 'false');\n        }\n        if (pwd !== confirm) {\n          localError = 'Passwords do not match.';\n          confirmError.textContent = localError;\n          announce(localError);\n          confirmPw.setAttribute('aria-invalid', 'true'); // A11y: invalid\n          confirmPw.focus();\n          return;\n        } else {\n          confirmPw.setAttribute('aria-invalid', 'false');\n        }\n        // Mock success\n        console.log(`Mock: Password reset SUCCESS for identifier '${appState.identifier}'.`);\n        setStep(4);\n      }\n\n      // Utilities\n      function validateIdentifier(input) {\n        if (!input) return 'Please enter your email or username.';\n        if (input.includes('@')) {\n          // Simple email format check\n          const emailOk = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(input);\n          if (!emailOk) return 'Please enter a valid email address.';\n        } else {\n          // Username: at least 3 characters\n          if (input.length < 3) return 'Please enter a valid username (3 or more characters).';\n        }\n        return '';\n      }\n\n      function maskContact(identifier) {\n        if (identifier.includes('@')) {\n          const [local, domain] = identifier.split('@');\n          const maskedLocal = maskMiddle(local);\n          const domainParts = domain.split('.');\n          const domainName = domainParts[0] || '';\n          const domainTld = domainParts.slice(1).join('.') || '';\n          const maskedDomain = maskMiddle(domainName);\n          return `${maskedLocal}@${maskedDomain}${domainTld ? '.' + domainTld : ''}`;\n        } else {\n          return maskMiddle(identifier);\n        }\n      }\n\n      function maskMiddle(str) {\n        if (str.length <= 2) return (str[0] || '') + '•'.repeat(Math.max(0, str.length - 1));\n        const first = str[0];\n        const last = str[str.length - 1];\n        return `${first}${'•'.repeat(Math.max(1, str.length - 2))}${last}`;\n      }\n\n      // Deterministic 6-digit code generator (Spec mapping: Mocking)\n      function generateCode(identifier) {\n        let hash = 0;\n        const prime = 1315423911;\n        for (let i = 0; i < identifier.length; i++) {\n          hash ^= ((hash << 5) + identifier.charCodeAt(i) + (hash >> 2));\n        }\n        hash ^= prime;\n        const code = Math.abs(hash) % 1000000;\n        return String(code).padStart(6, '0');\n      }\n\n      // Mock delivery via console.log\n      function mockDeliverCode(identifier, code, mask, isResend = false) {\n        const action = isResend ? 'RESEND' : 'SEND';\n        console.log(`Mock ${action}: Recovery code for '${identifier}' is ${code} (to ${mask})`);\n        announce(isResend ? 'Code resent.' : 'Code sent.');\n      }\n\n      // Accessibility: Live region announcer\n      function announce(message) {\n        if (!message) {\n          liveRegion.textContent = '';\n          return;\n        }\n        liveRegion.textContent = message;\n      }\n\n      // Toggle show/hide password\n      // Spec mapping (A11y): Keep label in sync and toggle aria-pressed to reflect visibility\n      function toggleVisibility(inputEl, toggleBtn) {\n        const isPassword = inputEl.type === 'password';\n        inputEl.type = isPassword ? 'text' : 'password';\n        const visible = inputEl.type === 'text';\n        toggleBtn.textContent = visible ? 'Hide' : 'Show';\n        toggleBtn.setAttribute('aria-pressed', visible ? 'true' : 'false');\n        // Spec mapping (A11y toggles): Update aria-label per field and visibility\n        if (toggleBtn.id === 'toggle-pw') {\n          toggleBtn.setAttribute('aria-label', visible ? 'Hide new password' : 'Show new password');\n        } else if (toggleBtn.id === 'toggle-confirm') {\n          toggleBtn.setAttribute('aria-label', visible ? 'Hide confirm password' : 'Show confirm password');\n        }\n      }\n\n      // Focus management on step change\n      function focusHeadingOrField(headingId, fieldEl) {\n        const heading = document.getElementById(headingId);\n        if (heading) {\n          heading.setAttribute('tabindex', '-1');\n          heading.focus();\n          // Cleanup tabindex after focus\n          setTimeout(() => heading.removeAttribute('tabindex'), 0);\n        }\n        if (fieldEl) {\n          setTimeout(() => fieldEl.focus(), 50);\n        }\n      }\n\n      // State persistence\n      function saveState() {\n        try {\n          sessionStorage.setItem('recoveryState', JSON.stringify(appState));\n        } catch (_) {}\n      }\n      function loadState() {\n        try {\n          const raw = sessionStorage.getItem('recoveryState');\n          return raw ? JSON.parse(raw) : null;\n        } catch (_) {\n          return null;\n        }\n      }\n\n      // Keyboard: Enter to submit is default via forms; tab order follows DOM.\n    })();\n  </script>\n</body>\n</html>\n", "task_list": [], "evaluator_md": "SUMMARY\nThe provided index.html implements a complete, single‑file, client‑only password recovery flow with deterministic mocked delivery/verification. It uses semantic HTML with inline CSS/JS, strong accessibility considerations (labels, aria-live, focus management, visible focus, high contrast), clear step gating, and console-based mocking. The flow covers identification, code verification (with resend and paste support), and strong password setting with live checklist and show/hide toggles. It meets the stated functional, UX, and mocking requirements for evaluation.\n\nFUNCTIONAL_CHECK\n- AC01 Single deliverable: one index.html with inline CSS and JS — PASS\n  Justification: All markup, styles, and logic are in a single HTML file; no external assets or build step.\n- AC02 Client-only, no network; deterministic mocking via console — PASS\n  Justification: No network calls; code generation is deterministic from identifier; console.log simulates send/resend and success.\n- AC03 Step 1 Identify account: accepts email or username with validation — PASS\n  Justification: Field labeled, helper text present; email regex validation; username length≥3; errors via aria-live; enter submits.\n- AC04 Step 2 Code verification: 6-digit numeric input, paste-friendly, input filtering — PASS\n  Justification: inputmode=numeric, pattern, JS filters non-digits, paste digits-only slice(0,6); error messages and aria-invalid.\n- AC05 Masked contact is shown and resends show same deterministic code — PASS\n  Justification: maskContact() for emails/usernames; same generateCode() used for delivery and resend; message displayed and announced.\n- AC06 Gated navigation across steps (including hash/back/reload) — PASS\n  Justification: Hash parsing and sessionStorage state; cannot reach steps 3/4 without identifier+verified; progress persists on reload.\n- AC07 Progress indicator “Step X of 3” for steps 1–3 and hidden on completion — PASS\n  Justification: progressEl updates for steps 1–3, hidden for confirmation.\n- AC08 Accessibility: form labels, aria-describedby, aria-live for errors/success, aria-invalid states — PASS\n  Justification: All fields have labels; errors are in aria-live regions; inputs toggle aria-invalid appropriately; global live region exists.\n- AC09 Focus management and keyboard support — PASS\n  Justification: On step entry, headings are focused then fields; visible focus outline; forms submit via Enter; tab order is logical.\n- AC10 Password creation: strong rules with live checklist and SR-only status — PASS\n  Justification: Rules require 12+ chars, upper/lower/number/symbol; checklist updates visually and updates SR-only “Met/Not met”.\n- AC11 Show/Hide password toggles with proper ARIA — PASS\n  Justification: Toggles update type, text, aria-pressed, aria-label, and target via aria-controls for both fields.\n- AC12 Enable/disable submit appropriately — PASS\n  Justification: Reset button disabled until all rules pass and confirm matches; errors shown and announced on submit if invalid.\n- AC13 Inclusive, older-adult/ADHD-friendly UX (readable, high contrast, simple copy, single column, no timers) — PASS\n  Justification: 18px base font, high contrast colors, visible focus, single-column layout, simple wording, no time pressure; tip about password manager.\n- AC14 Spec mapping comments and evaluation disclaimers — PASS\n  Justification: File contains clear “Spec mapping” comments and disclaimers noting mocked behavior and evaluation usage.\n\nFAILING_ITEMS\n- None observed.\n\nNEW_TASKS\n- None.\n\nDECISION\nPASS", "done": true, "iter": 4, "step": 12}
