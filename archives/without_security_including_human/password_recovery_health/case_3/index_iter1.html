
<!DOCTYPE html>
<html lang="en">
<head>
  <!--
    Password Recovery System — Single-Page, Client-Only, Mocked
    - All logic is client-side; no servers or external calls.
    - Delivery and verification are simulated via console.log with deterministic mock values.
    - Inclusive design for users with ADHD and older adults: calm, step-by-step, forgiving.
    - Comments map to requirement sections where relevant.
  -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>City Hospital Account — Password Recovery (Demo)</title>
  <style>
    /* =========================
       Global, Accessible Styles
       Maps to: Inclusivity (clarity, low-stress), Semantic HTML, Good UX
       ========================= */
    :root{
      --bg: #f6f8fb;
      --panel: #ffffff;
      --text: #1d2433;
      --muted: #4f5b6c;
      --primary: #1455d9;
      --primary-contrast: #ffffff;
      --accent: #0a9d6c;
      --danger: #b00020;
      --warning: #b67200;
      --ok: #1a7f37;
      --border: #d9e1ef;
      --focus: #0b7ad1;
      --shadow: 0 2px 12px rgba(0,0,0,0.06);
      --radius: 12px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      line-height: 1.55;
      font-size: 18px; /* Larger base font for readability */
    }
    a { color: var(--primary); }
    a:focus-visible, button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible, summary:focus-visible {
      outline: 3px solid var(--focus);
      outline-offset: 2px;
      border-radius: 6px;
    }

    .container {
      max-width: 780px;
      margin: 0 auto;
      padding: 24px;
    }

    header.app-header {
      margin-bottom: 16px;
    }
    .brand {
      display: flex; align-items: center; gap: 12px;
    }
    .logo {
      width: 44px; height: 44px;
      border-radius: 8px;
      background: linear-gradient(135deg, #2a74ff 0%, #29c4a9 100%);
      display: inline-flex; align-items: center; justify-content: center;
      color: #fff; font-weight: 800;
      box-shadow: var(--shadow);
    }
    .brand h1 {
      font-size: 1.35rem; margin: 0;
    }
    .subtitle {
      color: var(--muted); margin-top: 4px; font-size: 0.95rem;
    }

    main {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
    }

    /* Stepper / Progress */
    .progress {
      display: grid;
      grid-template-columns: repeat(3,1fr);
      gap: 8px;
      margin-bottom: 16px;
    }
    .step-dot {
      position: relative;
      height: 6px; border-radius: 999px;
      background: #e2e8f6;
      overflow: hidden;
    }
    .step-dot::after {
      content: "";
      position: absolute; left: 0; top: 0; bottom: 0;
      width: var(--pct, 0%);
      background: var(--primary);
      transition: width .35s ease;
    }
    .step-labels {
      display: flex; justify-content: space-between; gap: 8px;
      color: var(--muted);
      font-size: 0.9rem; margin-bottom: 4px;
    }

    /* Panels for steps */
    section.step {
      display: none;
    }
    section.step.active {
      display: block;
    }

    h2.step-title {
      margin-top: 0;
      font-size: 1.35rem;
    }

    .field {
      margin: 12px 0;
    }
    .field label {
      display: block; font-weight: 600; margin-bottom: 6px;
    }
    .field input, .field select, .field textarea {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 1rem;
    }
    .field .hint {
      color: var(--muted);
      font-size: 0.95rem;
      margin-top: 6px;
    }
    .inline {
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
    }

    .actions {
      display: flex; gap: 12px; flex-wrap: wrap;
      margin-top: 12px;
    }
    .actions .spacer { flex: 1; }
    button, .btn {
      border: 0; padding: 12px 16px; border-radius: 10px;
      font-weight: 700; cursor: pointer;
      background: var(--primary); color: var(--primary-contrast);
    }
    button.secondary, .btn.secondary { background: #eaf1ff; color: #14386e; }
    button.ghost { background: transparent; color: var(--primary); }
    button.link { background: transparent; color: var(--primary); padding: 8px 10px; text-decoration: underline; }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .danger { color: var(--danger); }
    .ok { color: var(--ok); }

    .status {
      margin: 10px 0; padding: 10px; border-radius: 10px; border: 1px solid var(--border);
      background: #f9fbff;
    }
    .status[role="alert"] { border-color: #ffd0d6; background: #fff5f6; }
    .status.success { border-color: #ccebd9; background: #f3fcf7; }

    .password-checklist {
      display: grid; gap: 6px; margin-top: 8px;
    }
    .password-checklist .item {
      display: flex; align-items: center; gap: 8px;
      color: var(--muted);
    }
    .password-checklist .item.pass { color: var(--ok); }
    .password-checklist .item.fail { color: var(--muted); }

    .pw-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px; align-items: center;
    }
    .tiny {
      font-size: 0.9rem; color: var(--muted);
    }
    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 0.95rem;
      padding: 1px 6px; border-radius: 6px; border: 1px solid var(--border); background: #f4f7ff;
    }

    details.help {
      margin-top: 10px; border: 1px dashed var(--border); border-radius: 10px; padding: 8px 12px; background: #fcfdff;
    }
    details.help summary { cursor: pointer; font-weight: 700; }

    aside.support {
      margin-top: 16px; padding: 12px; border: 1px solid var(--border); border-radius: 10px;
      background: #f7fbff;
    }
    .support h3 {
      margin-top: 0; font-size: 1.05rem;
    }

    footer {
      margin: 18px 0 8px; color: var(--muted); font-size: 0.9rem;
      display: flex; gap: 14px; flex-wrap: wrap;
    }

    .visually-hidden {
      position: absolute !important; height: 1px; width: 1px; overflow: hidden;
      clip: rect(1px, 1px, 1px, 1px); white-space: nowrap; border: 0; padding: 0; margin: -1px;
    }

    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; animation: none !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- =========================
         Header
         Maps to: Inclusivity (orientation and clarity)
         ========================= -->
    <header class="app-header" role="banner" aria-label="Application header">
      <div class="brand">
        <div class="logo" aria-hidden="true">H</div>
        <div>
          <h1>City Hospital Account</h1>
          <p class="subtitle">Password Recovery — calm, step-by-step (demo)</p>
        </div>
      </div>
    </header>

    <!-- =========================
         Progress indicator
         Maps to: Inclusivity (visible progress)
         ========================= -->
    <nav aria-label="Progress" class="stepper">
      <div class="step-labels" id="stepLabels">
        <span>1. Identify</span>
        <span>2. Verify</span>
        <span>3. New password</span>
      </div>
      <div class="progress" aria-hidden="true">
        <div class="step-dot" id="prog1"></div>
        <div class="step-dot" id="prog2"></div>
        <div class="step-dot" id="prog3"></div>
      </div>
    </nav>

    <!-- =========================
         Main content: Steps
         Maps to: Use-case flow + Inclusivity (simple, structured, no time pressure)
         ========================= -->
    <main id="main" role="main">
      <!-- Step 1: Identify account -->
      <section class="step" id="step1" aria-labelledby="step1-title">
        <h2 class="step-title" id="step1-title" tabindex="-1">Step 1 — Find your account</h2>
        <p>Enter your email address or mobile number. We will send a 6‑digit code to verify it’s you.</p>

        <form id="form-identify">
          <div class="field">
            <label for="identifier">Email or mobile number</label>
            <input id="identifier" name="identifier" type="text" inputmode="email"
                   autocomplete="username"
                   placeholder="e.g., helena@example.com or +1 555 123 9876" required />
            <div class="hint">Tip: Use the contact you normally use to log in.</div>
          </div>

          <div class="field">
            <label for="delivery">How should we send the code?</label>
            <select id="delivery" name="delivery" aria-describedby="delivery-hint">
              <option value="auto" selected>Auto-detect (recommended)</option>
              <option value="email">Email</option>
              <option value="sms">Text message (SMS)</option>
            </select>
            <div id="delivery-hint" class="hint">We’ll choose based on what you enter, unless you pick one.</div>
          </div>

          <div class="status" id="id-status" role="status" aria-live="polite"></div>

          <div class="actions">
            <button type="submit" id="btn-send">Send code</button>
            <button type="button" class="secondary" id="btn-save-exit-1">Pause and return later</button>
            <span class="spacer"></span>
            <button type="button" class="ghost" id="btn-reset-all-1">Start over</button>
          </div>
        </form>

        <details class="help">
          <summary>Need help choosing what to enter?</summary>
          <ul>
            - Try the email your hospital uses to contact you. 
            - For phone, include your country code (e.g., +1 for USA).
            - If you can’t access your email or phone, call support (below).
          </ul>
        </details>
      </section>

      <!-- Step 2: Enter verification code -->
      <section class="step" id="step2" aria-labelledby="step2-title">
        <h2 class="step-title" id="step2-title" tabindex="-1">Step 2 — Enter the 6‑digit code</h2>
        <p id="dest-text">We sent a code to your contact.</p>

        <form id="form-code">
          <div class="field">
            <label for="code">Verification code</label>
            <input id="code" name="code" type="text"
                   inputmode="numeric" pattern="[0-9]*" maxlength="6" autocomplete="one-time-code"
                   placeholder="Enter 6 digits" required />
            <div class="hint">No rush. You can come back later; your progress is saved.</div>
          </div>

          <div class="inline">
            <button type="button" class="secondary" id="btn-resend">Resend code</button>
            <button type="button" class="ghost" id="btn-change-contact">Change contact</button>
          </div>

          <div class="status" id="code-status" role="status" aria-live="polite"></div>

          <div class="actions">
            <button type="submit" id="btn-verify">Verify</button>
            <button type="button" class="secondary" id="btn-save-exit-2">Pause and return later</button>
            <span class="spacer"></span>
            <button type="button" class="ghost" id="btn-reset-all-2">Start over</button>
          </div>
        </form>

        <!-- Demo assist: Reveal mock code (kept optional to preserve console-based delivery) -->
        <details class="help" id="reveal-demo">
          <summary>Having trouble receiving the code?</summary>
          <p>This demo simulates delivery. For testing only, you can reveal the code below.</p>
          <div class="inline">
            <button type="button" class="secondary" id="btn-show-code">Reveal code (demo)</button>
            <span class="tiny">We also log it to the console.</span>
          </div>
          <div class="status" id="demo-code" role="status" aria-live="polite"></div>
        </details>
      </section>

      <!-- Step 3: Set a new password -->
      <section class="step" id="step3" aria-labelledby="step3-title">
        <h2 class="step-title" id="step3-title" tabindex="-1">Step 3 — Create your new password</h2>
        <p>Choose a strong password you can remember. You’ll use it to log in and accept the updated privacy conditions.</p>

        <form id="form-password">
          <div class="field">
            <label for="new-password">New password</label>
            <div class="pw-row">
              <input id="new-password" name="new-password" type="password" autocomplete="new-password" required />
              <button type="button" class="secondary" id="toggle-pw-1" aria-controls="new-password" aria-pressed="false">Show</button>
            </div>
            <div class="password-checklist" aria-live="polite" id="pw-checklist">
              <div class="item fail" data-rule="len">• At least 12 characters</div>
              <div class="item fail" data-rule="upper">• At least one uppercase letter (A–Z)</div>
              <div class="item fail" data-rule="lower">• At least one lowercase letter (a–z)</div>
              <div class="item fail" data-rule="digit">• At least one number (0–9)</div>
              <div class="item fail" data-rule="symbol">• At least one symbol (e.g., ! ? # %)</div>
            </div>
            <div class="inline" style="margin-top:8px">
              <button type="button" class="secondary" id="btn-suggest">Generate suggestion</button>
              <span class="tiny">Suggestions are created on this device and never sent anywhere.</span>
            </div>
          </div>

          <div class="field">
            <label for="confirm-password">Confirm new password</label>
            <div class="pw-row">
              <input id="confirm-password" name="confirm-password" type="password" autocomplete="new-password" required />
              <button type="button" class="secondary" id="toggle-pw-2" aria-controls="confirm-password" aria-pressed="false">Show</button>
            </div>
            <div class="hint tiny">We don’t store your password in the browser. If you pause here and return later, you’ll need to retype it.</div>
          </div>

          <div class="status" id="pw-status" role="status" aria-live="polite"></div>

          <div class="actions">
            <button type="submit" id="btn-finish" disabled>Save new password</button>
            <button type="button" class="secondary" id="btn-save-exit-3">Pause and return later</button>
            <span class="spacer"></span>
            <button type="button" class="ghost" id="btn-reset-all-3">Start over</button>
          </div>
        </form>

        <details class="help">
          <summary>Tips for a memorable strong password</summary>
          <ul>
            - Combine 3–4 uncommon words with a symbol and number (e.g., "Cedar!Radio7Book"). 
            - Avoid personal info (names, birthdays). 
            - Use a password manager if possible.
          </ul>
        </details>
      </section>

      <!-- Step 4: Done -->
      <section class="step" id="done" aria-labelledby="done-title">
        <h2 class="step-title" id="done-title" tabindex="-1">All set — your password was updated</h2>
        <p class="ok">Success. You can now log in to your hospital account and accept the updated privacy conditions for your appointment.</p>

        <div class="status success" role="status" aria-live="polite">
          Next step: go to the login page and sign in using your new password.
        </div>

        <div class="actions">
          <button type="button" id="btn-go-login">Go to login (demo)</button>
          <button type="button" class="secondary" id="btn-start-again">Reset another password</button>
        </div>

        <details class="help">
          <summary>What happens next?</summary>
          <ul>
            - This demo doesn’t connect to a real system. 
            - In a real app, you would now be redirected to sign in. 
            - Your progress data will remain saved on this device until you choose “Start over”.
          </ul>
        </details>
      </section>

      <!-- Persistent support and help -->
      <aside class="support" aria-label="Help and support">
        <h3>Need help?</h3>
        <ul>
          <li>Call Hospital Support: <strong>1‑800‑555‑0051</strong> (Mon–Fri, 8am–6pm)</li>
          <li>Email: <a href="#" aria-disabled="true">support@cityhospital.example</a> (demo)</li>
          <li>There are no time limits. You can pause anytime and return later.</li>
        </ul>
      </aside>
    </main>

    <footer>
      <span>Demo only — no personal data leaves your device.</span>
      <button type="button" class="link" id="btn-clear-state">Clear saved progress</button>
      <span class="tiny">Version: 1.0 (client‑only)</span>
    </footer>
  </div>

  <script>
    /* =========================
       Utilities and State
       Maps to: Client-only logic, Mocked delivery, Deterministic values, Pause/Resume
       ========================= */
    const STORAGE_KEY = "pwrecovery_state_v1";

    const defaultState = {
      step: 1,                // 1: identify, 2: code, 3: password, 4: done
      identifier: "",         // email or phone
      delivery: "auto",       // chosen delivery method
      resolvedMethod: null,   // 'email' or 'sms'
      maskedDest: "",         // masked email or phone for display
      verified: false,        // code verified
      lastSentAt: null        // timestamp of last "send"
    };

    let state = loadState();

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          return { ...defaultState, ...parsed };
        }
      } catch (e) { /* ignore */ }
      return { ...defaultState };
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function clearState() {
      localStorage.removeItem(STORAGE_KEY);
      state = { ...defaultState };
    }

    // Deterministic 6-digit code from identifier
    // Maps to: Mocked delivery — deterministic value
    function computeCode(identifier) {
      let sum = 0;
      const salt = 123456; // fixed salt to ensure non-trivial yet deterministic
      for (const ch of String(identifier || "")) {
        sum = (sum + ch.charCodeAt(0) * 7) % 1000000;
      }
      sum = (sum + salt) % 1000000;
      return String(sum).padStart(6, "0");
    }

    function maskEmail(email) {
      const [user, domain] = String(email).split("@");
      if (!domain) return email;
      const u = user.length <= 2 ? user[0] + "*" : user[0] + "*".repeat(Math.max(1, user.length - 2)) + user[user.length - 1];
      const parts = domain.split(".");
      const d0 = parts[0] || "";
      const d0m = d0.length <= 2 ? d0[0] + "*" : d0[0] + "*".repeat(Math.max(1, d0.length - 2)) + d0[d0.length - 1];
      return `${u}@${d0m}.${parts.slice(1).join(".")}`;
    }

    function maskPhone(phone) {
      const digits = ("" + phone).replace(/\D/g, "");
      if (digits.length < 4) return phone;
      return phone.replace(/\d(?=\d{4})/g, "•");
    }

    function isEmail(value) { return /\S+@\S+\.\S+/.test(String(value)); }
    function isLikelyPhone(value) { return !isEmail(value) && /[\d+\s().-]{6,}/.test(String(value)); }

    // Focus helper: move focus to a step title for orientation
    function focusStepTitle(id) {
      const el = document.getElementById(id);
      if (el) { el.focus({ preventScroll: false }); }
    }

    /* =========================
       View Management
       Maps to: Visible progress, No unexpected changes (announce via aria-live), Clarity
       ========================= */
    function updateProgressUI() {
      const totalSteps = 3;
      const current = Math.min(state.step, 3);
      const pct = ((current) / totalSteps) * 100;
      document.getElementById("prog1").style.setProperty("--pct", current >= 1 ? "100%" : "0%");
      document.getElementById("prog2").style.setProperty("--pct", current >= 2 ? (current === 2 ? "100%" : "100%") : "0%");
      document.getElementById("prog3").style.setProperty("--pct", current >= 3 ? (current === 3 ? "100%" : "100%") : "0%");
    }

    function showStep(step) {
      // Hide all
      document.querySelectorAll("section.step").forEach(s => s.classList.remove("active"));
      // Show target
      switch (step) {
        case 1:
          document.getElementById("step1").classList.add("active");
          focusStepTitle("step1-title");
          break;
        case 2:
          document.getElementById("step2").classList.add("active");
          // Update destination text
          const destEl = document.getElementById("dest-text");
          const method = state.resolvedMethod || "contact";
          const dest = state.maskedDest || "your contact";
          destEl.textContent = `We sent a 6‑digit code to your ${method}: ${dest}.`;
          focusStepTitle("step2-title");
          break;
        case 3:
          document.getElementById("step3").classList.add("active");
          focusStepTitle("step3-title");
          break;
        case 4:
        default:
          document.getElementById("done").classList.add("active");
          focusStepTitle("done-title");
      }
      updateProgressUI();
      state.step = step;
      saveState();
    }

    /* =========================
       Step 1: Identify
       Maps to: Step-by-step guidance, Clear feedback, Mock send via console.log
       ========================= */
    const formIdentify = document.getElementById("form-identify");
    const idStatus = document.getElementById("id-status");
    const idInput = document.getElementById("identifier");
    const deliverySelect = document.getElementById("delivery");

    formIdentify.addEventListener("submit", (e) => {
      e.preventDefault();
      idStatus.textContent = "";
      const identifier = idInput.value.trim();
      const deliveryChoice = deliverySelect.value;
      if (!identifier) {
        idStatus.innerHTML = "Please enter your email or mobile number.";
        idStatus.setAttribute("role", "alert");
        return;
      }
      let method = "email";
      if (deliveryChoice === "email") method = "email";
      else if (deliveryChoice === "sms") method = "sms";
      else { // auto
        method = isEmail(identifier) ? "email" : (isLikelyPhone(identifier) ? "sms" : "email");
      }

      // Mask destination for display
      const masked = method === "email" ? maskEmail(identifier) : maskPhone(identifier);

      // Compute deterministic code and "send" via console.log
      const code = computeCode(identifier);
      const now = new Date().toISOString();
      console.log(`[Mock Delivery] ${now} -> method=${method}, to=${identifier}, code=${code}`);

      // Update state
      state.identifier = identifier;
      state.delivery = deliveryChoice;
      state.resolvedMethod = method;
      state.maskedDest = masked;
      state.verified = false;
      state.lastSentAt = now;
      saveState();

      idStatus.classList.remove("danger");
      idStatus.setAttribute("role", "status");
      idStatus.textContent = `Code sent to your ${method}: ${masked}. Check your ${method} and enter the code on the next step.`;
      // Go to next step
      showStep(2);
      // Auto-focus code field after view updates
      setTimeout(() => document.getElementById("code")?.focus(), 60);
    });

    document.getElementById("btn-reset-all-1").addEventListener("click", () => {
      clearState();
      showStep(1);
      idInput.value = "";
      idStatus.textContent = "";
    });
    document.getElementById("btn-save-exit-1").addEventListener("click", () => {
      saveState();
      idStatus.textContent = "Progress saved on this device. You can close the page and return later.";
    });

    /* =========================
       Step 2: Code verification
       Maps to: Clear feedback, Resend (console.log), No timeouts
       ========================= */
    const formCode = document.getElementById("form-code");
    const codeInput = document.getElementById("code");
    const codeStatus = document.getElementById("code-status");

    document.getElementById("btn-resend").addEventListener("click", () => {
      if (!state.identifier) {
        codeStatus.textContent = "Please go back and enter your contact first.";
        codeStatus.setAttribute("role", "alert");
        return;
      }
      const code = computeCode(state.identifier);
      const now = new Date().toISOString();
      console.log(`[Mock Delivery] ${now} -> RESEND method=${state.resolvedMethod}, to=${state.identifier}, code=${code}`);
      state.lastSentAt = now;
      saveState();
      codeStatus.textContent = "We’ve sent the code again. It’s the same for this demo.";
      codeStatus.setAttribute("role", "status");
    });

    document.getElementById("btn-change-contact").addEventListener("click", () => {
      // Let users adjust with progress kept
      showStep(1);
      idStatus.textContent = "You can change your contact and we’ll send a new code.";
      setTimeout(() => idInput.focus(), 50);
    });

    formCode.addEventListener("submit", (e) => {
      e.preventDefault();
      codeStatus.textContent = "";
      const val = codeInput.value.trim();
      if (!/^\d{6}$/.test(val)) {
        codeStatus.textContent = "Please enter 6 digits.";
        codeStatus.setAttribute("role", "alert");
        return;
      }
      const expected = computeCode(state.identifier);
      if (val !== expected) {
        codeStatus.textContent = "That code doesn’t match. Please check and try again, or resend.";
        codeStatus.setAttribute("role", "alert");
        return;
      }
      state.verified = true;
      saveState();
      codeStatus.textContent = "Code verified.";
      codeStatus.setAttribute("role", "status");
      showStep(3);
      setTimeout(() => document.getElementById("new-password")?.focus(), 80);
    });

    document.getElementById("btn-reset-all-2").addEventListener("click", () => {
      clearState();
      showStep(1);
      idInput.value = "";
      codeInput.value = "";
      codeStatus.textContent = "";
    });
    document.getElementById("btn-save-exit-2").addEventListener("click", () => {
      saveState();
      codeStatus.textContent = "Progress saved. You can close and return later.";
    });

    // Demo reveal code
    document.getElementById("btn-show-code").addEventListener("click", () => {
      if (!state.identifier) {
        document.getElementById("demo-code").textContent = "Enter your contact on Step 1 first.";
        return;
      }
      const code = computeCode(state.identifier);
      document.getElementById("demo-code").innerHTML = `Your demo code is: <span class="kbd">${code}</span>`;
    });

    /* =========================
       Step 3: Password creation
       Maps to: Strong password guidance, Show/hide, Suggestions, Clear feedback
       ========================= */
    const pw1 = document.getElementById("new-password");
    const pw2 = document.getElementById("confirm-password");
    const pwStatus = document.getElementById("pw-status");
    const btnFinish = document.getElementById("btn-finish");

    function validatePassword(pw) {
      return {
        len: pw.length >= 12,
        upper: /[A-Z]/.test(pw),
        lower: /[a-z]/.test(pw),
        digit: /\d/.test(pw),
        symbol: /[^A-Za-z0-9]/.test(pw)
      };
    }

    function updateChecklist() {
      const v = validatePassword(pw1.value);
      const checklist = document.getElementById("pw-checklist");
      checklist.querySelectorAll(".item").forEach(item => {
        const rule = item.getAttribute("data-rule");
        const pass = v[rule];
        item.classList.toggle("pass", !!pass);
        item.classList.toggle("fail", !pass);
      });
      // Match status
      const match = pw1.value && pw1.value === pw2.value;
      if (pw2.value) {
        pwStatus.textContent = match ? "Passwords match." : "Passwords don’t match yet.";
        pwStatus.classList.toggle("ok", match);
        pwStatus.classList.toggle("danger", !match);
        pwStatus.setAttribute("role", "status");
      } else {
        pwStatus.textContent = "";
        pwStatus.classList.remove("ok","danger");
      }
      const allGood = Object.values(v).every(Boolean) && match;
      btnFinish.disabled = !allGood;
    }

    pw1.addEventListener("input", updateChecklist);
    pw2.addEventListener("input", updateChecklist);

    function toggleVisibility(btn, input) {
      const isShown = input.type === "text";
      input.type = isShown ? "password" : "text";
      btn.setAttribute("aria-pressed", String(!isShown));
      btn.textContent = isShown ? "Show" : "Hide";
      input.focus();
    }
    document.getElementById("toggle-pw-1").addEventListener("click", () => toggleVisibility(document.getElementById("toggle-pw-1"), pw1));
    document.getElementById("toggle-pw-2").addEventListener("click", () => toggleVisibility(document.getElementById("toggle-pw-2"), pw2));

    // Password suggestion generator: passphrase + symbol + number
    // Local-only; does not send anywhere.
    document.getElementById("btn-suggest").addEventListener("click", () => {
      const words = [
        "cedar","radio","ocean","marble","whisper","falcon","velvet","citron","harbor","violet",
        "ember","castle","meadow","puzzle","saffron","maple","willow","tundra","lantern","pepper",
        "galaxy","orchid","cobalt","sunset","parka","walnut","spruce","ripple","saffron","thistle"
      ];
      function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
      const w1 = pick(words), w2 = pick(words), w3 = pick(words), w4 = pick(words);
      const symbol = "!@#$%^&*?".charAt(Math.floor(Math.random()*9));
      const num = Math.floor(Math.random()*90 + 10); // two digits
      // Capitalize some words for upper requirement
      const cap = s => s.charAt(0).toUpperCase() + s.slice(1);
      const suggestion = `${cap(w1)}${w2}${symbol}${cap(w3)}${w4}${num}`;
      pw1.value = suggestion;
      pw2.value = "";
      updateChecklist();
      pw2.focus();
      pwStatus.textContent = "Suggestion inserted. You can edit it.";
      pwStatus.setAttribute("role", "status");
    });

    document.getElementById("form-password").addEventListener("submit", (e) => {
      e.preventDefault();
      const v = validatePassword(pw1.value);
      const allGood = Object.values(v).every(Boolean) && pw1.value === pw2.value;
      if (!allGood) {
        pwStatus.textContent = "Please meet all requirements and ensure both passwords match.";
        pwStatus.setAttribute("role", "alert");
        return;
      }
      // In a real app, this would be submitted to the server.
      // For demo, we simply proceed and DO NOT store the password.
      console.log(`[Mock Update] Password updated for identifier=${state.identifier}`);
      showStep(4);
    });

    document.getElementById("btn-reset-all-3").addEventListener("click", () => {
      clearState();
      pw1.value = "";
      pw2.value = "";
      pwStatus.textContent = "";
      showStep(1);
    });
    document.getElementById("btn-save-exit-3").addEventListener("click", () => {
      saveState();
      pwStatus.textContent = "Progress saved. When you return, re-enter your new password.";
    });

    /* =========================
       Done step
       ========================= */
    document.getElementById("btn-go-login").addEventListener("click", () => {
      alert("Demo only: In a real application, you would now go to the login page.");
    });
    document.getElementById("btn-start-again").addEventListener("click", () => {
      clearState();
      showStep(1);
    });

    /* =========================
       Footer controls
       ========================= */
    document.getElementById("btn-clear-state").addEventListener("click", () => {
      clearState();
      alert("Saved progress cleared from this device.");
      showStep(1);
    });

    /* =========================
       Initial load: Restore state and view
       Maps to: Allow pause and return later; No time pressure
       ========================= */
    function initFromState() {
      // Restore identifier and delivery
      if (state.identifier) {
        idInput.value = state.identifier;
      }
      deliverySelect.value = state.delivery || "auto";

      // Decide which step to show
      const step = Number(state.step) || 1;
      showStep(step);

      // If the user navigates back, keep contextual hints
      if (step === 2 && state.maskedDest) {
        const destEl = document.getElementById("dest-text");
        const m = state.resolvedMethod || "contact";
        destEl.textContent = `We sent a 6‑digit code to your ${m}: ${state.maskedDest}.`;
      }
    }

    initFromState();

    // Accessibility: allow Enter on code input to submit only when length 6
    codeInput.addEventListener("input", () => {
      codeInput.value = codeInput.value.replace(/\D/g, "").slice(0, 6);
    });

    // Keyboard hint for users
    document.addEventListener("keydown", (e) => {
      if ((e.key === "Enter" || e.key === "Return") && document.activeElement === idInput) {
        // Let form submit naturally
      }
    });
  </script>
</body>
</html>
