{"code_tsx": "\n/**\n * app.ts\n * Single-file HTTPS Bun server + SPA implementing a secure, inclusive Password Recovery System.\n * Run with: bun app.ts\n *\n * Major sections include comments that map to Security and Inclusivity requirements.\n */\n\nconst CERT_PATH = \"certs/cert.pem\";\nconst KEY_PATH = \"certs/key.pem\";\n\n// ---------------------------- In-memory state (no persistence) ----------------------------\n// [Security: Identification & Authentication] Users store with bcrypt hashing via Bun.password\ntype User = {\n  id: string;\n  email: string;\n  username: string;\n  passwordHash: string;\n  mfaEnabled: boolean;\n};\n\nconst users = new Map<string, User>();\nconst userByEmail = new Map<string, string>();\nconst userByUsername = new Map<string, string>();\n\nconst createUser = async (id: string, email: string, username: string, plainPassword: string, mfaEnabled: boolean) => {\n  const passwordHash = await Bun.password.hash(plainPassword, { algorithm: \"bcrypt\", cost: 10 });\n  const user: User = { id, email: email.toLowerCase(), username: username.toLowerCase(), passwordHash, mfaEnabled };\n  users.set(id, user);\n  userByEmail.set(user.email, id);\n  userByUsername.set(user.username, id);\n};\n\n// Alex - initial account (fulfills \"include Alex\")\nawait createUser(\"u1\", \"alex@student.example.edu\", \"alex\", \"Start123!A\", true);\n\n// ---------------------------- Helpers ----------------------------\nfunction randomId(bytes = 16): string {\n  const arr = new Uint8Array(bytes);\n  crypto.getRandomValues(arr);\n  return Array.from(arr, (b) => b.toString(16).padStart(2, \"0\")).join(\"\");\n}\n\nfunction makeNonce(): string {\n  return randomId(16);\n}\n\nfunction now(): number {\n  return Date.now();\n}\n\nfunction escapeHtml(str: string): string {\n  return str\n    .replaceAll(\"&\", \"&amp;\")\n    .replaceAll(\"<\", \"&lt;\")\n    .replaceAll(\">\", \"&gt;\")\n    .replaceAll('\"', \"&quot;\")\n    .replaceAll(\"'\", \"&#39;\");\n}\n\n// [Security: Injection] Simple input sanitizers - used to normalize inputs; we don't reflect them.\nfunction sanitizeIdentifier(s: string): string {\n  return s.toLowerCase().trim().replace(/[^a-z0-9@._+\\-]/g, \"\").slice(0, 100);\n}\nfunction sanitizeEmail(s: string): string {\n  return s.toLowerCase().trim().replace(/[^a-z0-9@._+\\-]/g, \"\").slice(0, 200);\n}\nfunction sanitizeCode(s: string): string {\n  return s.trim().replace(/[^A-Za-z0-9\\-_.]/g, \"\").slice(0, 200);\n}\nfunction parseJSON<T = any>(body: string): T | null {\n  try {\n    return JSON.parse(body);\n  } catch {\n    return null;\n  }\n}\nfunction getCookieMap(req: Request): Record<string, string> {\n  const cookie = req.headers.get(\"cookie\") || \"\";\n  const map: Record<string, string> = {};\n  cookie.split(\";\").forEach((p) => {\n    const [k, v] = p.split(\"=\").map((s) => s?.trim());\n    if (k && v) map[k] = v;\n  });\n  return map;\n}\n\n// [Security: CSRF] Sessions with CSRF token\ntype Session = {\n  id: string;\n  csrf: string;\n  createdAt: number;\n  userId?: string;\n  authenticated?: boolean;\n  // Password reset context\n  resetPreviewToken?: string;\n  resetAllowed?: boolean;\n  resetUserId?: string | null;\n};\n\nconst sessions = new Map<string, Session>();\n\nfunction getOrCreateSession(sid?: string): Session {\n  if (sid && sessions.has(sid)) return sessions.get(sid)!;\n  const newId = randomId(24);\n  const csrf = randomId(24);\n  const s: Session = { id: newId, csrf, createdAt: now() };\n  sessions.set(newId, s);\n  return s;\n}\n\n// [Security: MFA] Deterministic 6-digit code per session (expires) + store\ntype MfaEntry = {\n  code: string;\n  expiresAt: number;\n  userId: string;\n};\nconst mfaCodes = new Map<string, MfaEntry>(); // key: sessionId\n\nfunction generateDeterministicCode(sessionId: string): string {\n  let sum = 0;\n  for (let i = 0; i < sessionId.length; i++) sum = (sum + sessionId.charCodeAt(i)) % 1000000;\n  return sum.toString().padStart(6, \"0\");\n}\n\n// [Security: Reset tokens] Single-use, short-lived\ntype ResetToken = {\n  token: string;\n  userId: string | null; // null to avoid user existence leak (sink)\n  createdAt: number;\n  expiresAt: number;\n  used: boolean;\n};\nconst resetTokens = new Map<string, ResetToken>();\n\n// [Security: Throttling] Simple fixed-window-ish limiter\nconst rateStore = new Map<string, number[]>();\nconst RATE_MAX = 5;\nconst RATE_WINDOW_MS = 60_000;\n\nfunction rateLimited(key: string): boolean {\n  const nowTs = now();\n  const arr = rateStore.get(key) || [];\n  const filtered = arr.filter((t) => nowTs - t < RATE_WINDOW_MS);\n  filtered.push(nowTs);\n  rateStore.set(key, filtered);\n  return filtered.length > RATE_MAX;\n}\n\n// [Security: Password policy]\nfunction passwordPolicyIssues(pw: string): string[] {\n  const issues: string[] = [];\n  if (pw.length < 10) issues.push(\"At least 10 characters\");\n  if (!/[a-z]/.test(pw)) issues.push(\"One lowercase letter\");\n  if (!/[A-Z]/.test(pw)) issues.push(\"One uppercase letter\");\n  if (!/[0-9]/.test(pw)) issues.push(\"One number\");\n  if (!/[^\\w\\s]/.test(pw)) issues.push(\"One symbol (e.g., !@#$)\");\n  return issues;\n}\n\n// ---------------------------- Security headers ----------------------------\n// [Security: Security Misconfiguration] HSTS, CSP, Referrer-Policy, X-Content-Type-Options, frame protections\nfunction makeSecurityHeaders(nonce: string): Headers {\n  const h = new Headers();\n  // Content Security Policy with strict defaults and nonced script/style\n  const csp = [\n    \"default-src 'none'\",\n    `script-src 'nonce-${nonce}'`,\n    `style-src 'nonce-${nonce}'`,\n    \"img-src 'self' data:\",\n    \"font-src 'self' data:\",\n    \"connect-src 'self'\",\n    \"base-uri 'none'\",\n    \"form-action 'self'\",\n    \"frame-ancestors 'none'\",\n    \"object-src 'none'\",\n    \"worker-src 'none'\",\n  ].join(\"; \");\n\n  h.set(\"Content-Security-Policy\", csp);\n  h.set(\"Referrer-Policy\", \"no-referrer\");\n  h.set(\"X-Content-Type-Options\", \"nosniff\");\n  h.set(\"Strict-Transport-Security\", \"max-age=63072000; includeSubDomains; preload\");\n  // X-Frame-Options is largely superseded by CSP frame-ancestors but include for defense in depth\n  h.set(\"X-Frame-Options\", \"DENY\");\n  // Disallow sniffing and caching of HTML/JSON\n  h.set(\"Cache-Control\", \"no-store\");\n  return h;\n}\n\n// Cookie builder for session id\nfunction sessionCookie(sid: string): string {\n  // [Security: CSRF] Secure, HttpOnly, SameSite=Strict\n  return `sid=${sid}; Path=/; Secure; HttpOnly; SameSite=Strict`;\n}\n\n// ---------------------------- HTML (SPA) ----------------------------\nfunction htmlPage(nonce: string): string {\n  // Minimal inline CSS and nonce-tagged JS only. All DOM updates use textContent (no HTML injection).\n  return `<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\">\n  <title>University Portal — Password & Login Help</title>\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n  <style nonce=\"${nonce}\">\n    /* Inclusivity: readable fonts, high contrast, spacing, no italics/all-caps */\n    :root {\n      --bg: #ffffff;\n      --fg: #111111;\n      --muted: #444;\n      --accent: #005fcc;\n      --ok: #116611;\n      --warn: #b35a00;\n      --err: #b00020;\n      --surface: #f6f8fa;\n    }\n    * { box-sizing: border-box; }\n    body {\n      margin: 0;\n      background: var(--bg);\n      color: var(--fg);\n      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;\n      line-height: 1.5;\n    }\n    header, footer {\n      padding: 12px 16px;\n      background: var(--surface);\n      border-bottom: 1px solid #e5e7eb;\n    }\n    header h1 {\n      margin: 0;\n      font-size: 1.25rem;\n      font-weight: 700;\n      letter-spacing: 0.2px;\n    }\n    main {\n      max-width: 900px;\n      margin: 0 auto;\n      padding: 16px;\n      display: grid;\n      grid-template-columns: 1fr 320px;\n      gap: 16px;\n    }\n    @media (max-width: 900px) {\n      main { grid-template-columns: 1fr; }\n    }\n    section#view {\n      background: var(--surface);\n      border: 1px solid #e5e7eb;\n      border-radius: 8px;\n      padding: 16px;\n    }\n    .toolbar {\n      display: flex;\n      gap: 8px;\n      align-items: center;\n      margin-bottom: 8px;\n    }\n    .toolbar button {\n      padding: 8px 10px;\n      font-size: 14px;\n    }\n    h2 {\n      margin: 8px 0 8px;\n      font-size: 1.2rem;\n    }\n    p, li { font-size: 1rem; }\n    ul.bullets { padding-left: 20px; }\n    label { display: block; margin: 10px 0 4px; font-weight: 600; }\n    input[type=\"text\"], input[type=\"email\"], input[type=\"password\"], input[type=\"number\"] {\n      width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid #d1d5db; font-size: 1rem;\n    }\n    input:focus { outline: 3px solid #cfe6ff; border-color: var(--accent); }\n    .row { display: flex; align-items: center; gap: 8px; }\n    .actions { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; }\n    button {\n      appearance: none; border: none; border-radius: 6px; padding: 10px 14px; background: var(--accent); color: #fff; cursor: pointer;\n      font-size: 1rem; font-weight: 600;\n    }\n    button.secondary { background: #6b7280; }\n    button.ghost { background: transparent; color: var(--accent); border: 1px solid var(--accent); }\n    small.help { color: var(--muted); display: block; margin-top: 4px; }\n    .msg { margin-top: 10px; padding: 10px; border-radius: 6px; }\n    .msg.ok { background: #e7f7ea; color: var(--ok); border: 1px solid #c7ebcd; }\n    .msg.err { background: #fde7ea; color: var(--err); border: 1px solid #f5c6cc; }\n    .msg.info { background: #eef6ff; color: #0b5394; border: 1px solid #cfe6ff; }\n    .hint { color: var(--muted); margin: 8px 0; }\n    .checklist { background: #fff; border: 1px solid #e5e7eb; border-radius: 6px; padding: 10px; }\n    .checklist li { margin: 4px 0; }\n    .okmark { color: var(--ok); }\n    .warnmark { color: var(--warn); }\n    .side {\n      background: #0a0a0a; color: #e5e7eb; border-radius: 8px; padding: 12px; min-height: 200px;\n    }\n    .logs {\n      background: #111; color: #9ef8b0; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;\n      border-radius: 6px; padding: 8px; height: 360px; overflow: auto; font-size: 12px;\n    }\n    a.link { color: var(--accent); text-decoration: underline; cursor: pointer; }\n    .badge { display: inline-block; background: #eef6ff; color: #0b5394; border: 1px solid #cfe6ff; padding: 2px 6px; border-radius: 999px; font-size: 12px; margin-left: 6px;}\n  </style>\n</head>\n<body>\n  <header>\n    <h1>University Portal — Password & Login Help <span class=\"badge\">Demo</span></h1>\n  </header>\n  <main>\n    <section id=\"view\" aria-live=\"polite\" aria-busy=\"false\">\n      <div class=\"toolbar\">\n        <button id=\"readAloudBtn\" class=\"ghost\" type=\"button\">Read aloud</button>\n        <button id=\"toLogin\" class=\"ghost\" type=\"button\">Go to Login</button>\n        <button id=\"toForgot\" class=\"ghost\" type=\"button\">Forgot Password</button>\n      </div>\n      <div id=\"content\">Loading…</div>\n    </section>\n    <aside class=\"side\">\n      <h2 style=\"margin-top:0\">Logs</h2>\n      <p class=\"hint\">Simulated deliveries (codes & links) appear here. You can test without opening DevTools.</p>\n      <div id=\"logs\" class=\"logs\" role=\"log\" aria-live=\"polite\"></div>\n    </aside>\n  </main>\n  <footer>\n    <small>Security: HTTPS only with HSTS; CSRF, CSP nonce, no inline handlers. Inclusive: plain language, clear steps, read-aloud.</small>\n  </footer>\n\n  <script nonce=\"${nonce}\">\n    (function(){\n      \"use strict\";\n      // [Security: CSP] All scripts are within this nonce-tagged block; no eval or inline handlers.\n      // [Inclusivity] Console logs mirrored to on-page panel.\n      const $ = (sel, root=document) => root.querySelector(sel);\n      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));\n      const logsEl = $(\"#logs\");\n      const originalLog = console.log.bind(console);\n      function log(...args){\n        originalLog(...args);\n        const msg = args.map(a => {\n          try { return typeof a === \"string\" ? a : JSON.stringify(a); } catch { return String(a); }\n        }).join(\" \");\n        const line = document.createElement(\"div\");\n        const ts = new Date().toISOString().split(\"T\")[1].replace(\"Z\",\"\");\n        line.textContent = \"[\"+ts+\"] \" + msg;\n        logsEl.appendChild(line);\n        logsEl.scrollTop = logsEl.scrollHeight;\n      }\n      console.log = log;\n\n      // App state\n      const state = {\n        csrf: \"\",\n        lastResetToken: \"\",\n        lastResetLink: \"\",\n        lastMfaCode: \"\",\n        mfaExpiresAt: 0,\n        resetExpiresAt: 0\n      };\n\n      // Fetch helper with CSRF\n      async function api(path, opts={}){\n        const o = Object.assign({ headers: {} }, opts);\n        o.headers[\"Content-Type\"] = \"application/json\";\n        if (state.csrf) o.headers[\"X-CSRF-Token\"] = state.csrf;\n        const res = await fetch(path, o);\n        const text = await res.text();\n        let data;\n        try { data = JSON.parse(text); } catch { data = {ok:false, message:\"Bad response\"}; }\n        return { status: res.status, data };\n      }\n\n      async function getCSRF(){\n        const res = await fetch(\"/api/csrf\", { method: \"GET\" });\n        const data = await res.json().catch(()=>({}));\n        if (data && data.csrf) state.csrf = data.csrf;\n      }\n\n      // Router\n      const view = $(\"#content\");\n      function navigate(hash){ location.hash = hash; }\n      window.addEventListener(\"hashchange\", render);\n      $(\"#toLogin\").addEventListener(\"click\", ()=>navigate(\"#/login\"));\n      $(\"#toForgot\").addEventListener(\"click\", ()=>navigate(\"#/forgot\"));\n\n      // Read aloud\n      const readBtn = $(\"#readAloudBtn\");\n      readBtn.addEventListener(\"click\", () => {\n        const synth = window.speechSynthesis;\n        if (synth.speaking) { synth.cancel(); return; }\n        const text = $(\"#content\").innerText;\n        const utter = new SpeechSynthesisUtterance(text);\n        utter.rate = 1;\n        synth.speak(utter);\n      });\n\n      // Views (all using textContent and createElement)\n      function clear(el){ while (el.firstChild) el.removeChild(el.firstChild); }\n\n      function labeledInput(labelText, type, id){\n        const frag = document.createDocumentFragment();\n        const label = document.createElement(\"label\");\n        label.htmlFor = id;\n        label.textContent = labelText;\n        const input = document.createElement(\"input\");\n        input.type = type; input.id = id; input.autocomplete = \"off\";\n        frag.appendChild(label); frag.appendChild(input);\n        return {frag, input, label};\n      }\n      function mkBtn(text, cls=\"\"){ const b = document.createElement(\"button\"); b.type=\"button\"; if (cls) b.className=cls; b.textContent=text; return b; }\n      function help(text){ const s = document.createElement(\"small\"); s.className=\"help\"; s.textContent = text; return s; }\n      function msg(text, kind=\"info\"){ const d = document.createElement(\"div\"); d.className = \"msg \" + kind; d.textContent = text; return d; }\n\n      function addCopyButton(getText){\n        const btn = mkBtn(\"Copy\", \"secondary\");\n        btn.addEventListener(\"click\", async () => {\n          try {\n            const t = getText();\n            await navigator.clipboard.writeText(t);\n            log(\"Copied:\", t);\n          } catch (e) { log(\"Copy failed\"); }\n        });\n        return btn;\n      }\n\n      function loginView(){\n        clear(view);\n        const h2 = document.createElement(\"h2\"); h2.textContent = \"Sign in\";\n        view.appendChild(h2);\n        const tips = document.createElement(\"ul\"); tips.className=\"bullets\";\n        [\"Use your email or username.\", \"Short steps. Clear feedback.\", \"If your password is expired, use Forgot Password.\"].forEach(t=>{ const li=document.createElement(\"li\"); li.textContent=t; tips.appendChild(li); });\n        view.appendChild(tips);\n\n        const idRow = labeledInput(\"Email or username\", \"text\", \"identifier\");\n        const pwRow = labeledInput(\"Password\", \"password\", \"password\");\n        const showRow = document.createElement(\"div\"); showRow.className=\"row\";\n        const showCb = document.createElement(\"input\"); showCb.type=\"checkbox\"; showCb.id=\"showpw\";\n        const showLb = document.createElement(\"label\"); showLb.htmlFor=\"showpw\"; showLb.textContent=\"Show password\";\n        showRow.appendChild(showCb); showRow.appendChild(showLb);\n\n        view.appendChild(idRow.frag);\n        view.appendChild(pwRow.frag);\n        view.appendChild(showRow);\n        view.appendChild(help(\"We never email passwords. Do not share codes.\"));\n\n        const actions = document.createElement(\"div\"); actions.className=\"actions\";\n        const btn = mkBtn(\"Sign in\");\n        const forgot = mkBtn(\"Forgot Password\", \"ghost\");\n        forgot.addEventListener(\"click\", ()=>navigate(\"#/forgot\"));\n        actions.appendChild(btn); actions.appendChild(forgot);\n        view.appendChild(actions);\n\n        const area = document.createElement(\"div\"); view.appendChild(area);\n\n        showCb.addEventListener(\"change\", ()=>{ pwRow.input.type = showCb.checked ? \"text\" : \"password\"; });\n\n        btn.addEventListener(\"click\", async () => {\n          area.textContent = \"\";\n          const identifier = idRow.input.value.trim();\n          const password = pwRow.input.value;\n          const {status, data} = await api(\"/api/login\", { method:\"POST\", body: JSON.stringify({ identifier, password }) });\n          if (data && data.mfaRequired){\n            // MFA code delivered — log for testing\n            state.lastMfaCode = data.code || \"\";\n            state.mfaExpiresAt = data.expiresAt || 0;\n            log(\"MFA code (simulated):\", state.lastMfaCode, \"expiresAt:\", new Date(state.mfaExpiresAt).toLocaleTimeString());\n            area.appendChild(msg(\"Additional check needed. Enter the 6‑digit code.\", \"info\"));\n            navigate(\"#/mfa\");\n            return;\n          }\n          if (data && data.ok){\n            area.appendChild(msg(\"Signed in.\", \"ok\"));\n            navigate(\"#/done\");\n          } else {\n            area.appendChild(msg(\"Sign in failed. Please check details and try again.\", \"err\"));\n          }\n        });\n      }\n\n      function forgotView(){\n        clear(view);\n        const h2 = document.createElement(\"h2\"); h2.textContent = \"Reset your password\";\n        view.appendChild(h2);\n        const bullets = document.createElement(\"ul\"); bullets.className=\"bullets\";\n        [\"Enter your email. We send a reset link and code.\", \"The link expires in about 10 minutes.\", \"You can paste the code manually if needed.\"].forEach(t=>{ const li=document.createElement(\"li\"); li.textContent=t; bullets.appendChild(li); });\n        view.appendChild(bullets);\n\n        const emailRow = labeledInput(\"Your email\", \"email\", \"email\");\n        view.appendChild(emailRow.frag);\n        view.appendChild(help(\"Example: name@school.edu\"));\n\n        const actions = document.createElement(\"div\"); actions.className=\"actions\";\n        const sendBtn = mkBtn(\"Send reset link\");\n        const copyHow = addCopyButton(()=> \"Steps: open your email, copy the code, come back here to Verify. If you can't open the link, paste the code manually.\");\n        actions.appendChild(sendBtn); actions.appendChild(copyHow);\n        view.appendChild(actions);\n\n        const area = document.createElement(\"div\"); view.appendChild(area);\n\n        sendBtn.addEventListener(\"click\", async () => {\n          area.textContent=\"\";\n          const email = emailRow.input.value.trim();\n          const {status, data} = await api(\"/api/reset/start\", { method:\"POST\", body: JSON.stringify({ email }) });\n          if (data && data.ok){\n            state.lastResetToken = data.token || \"\";\n            state.resetExpiresAt = data.expiresAt || 0;\n            const link = location.origin.replace(\"http:\", \"https:\") + \"/#/verify?token=\" + encodeURIComponent(state.lastResetToken);\n            state.lastResetLink = link;\n            log(\"Reset link (simulated):\", link);\n            log(\"Reset token (simulated):\", state.lastResetToken, \"expiresAt:\", new Date(state.resetExpiresAt).toLocaleTimeString());\n            area.appendChild(msg(\"If the account exists, a reset link was sent. Check Logs panel.\", \"info\"));\n            const open = mkBtn(\"Open verification screen\");\n            open.addEventListener(\"click\", ()=> navigate(\"#/verify?token=\" + encodeURIComponent(state.lastResetToken)));\n            area.appendChild(document.createElement(\"div\")).appendChild(open);\n          } else {\n            area.appendChild(msg(\"If something went wrong, try again later.\", \"err\"));\n          }\n        });\n      }\n\n      function verifyView(){\n        clear(view);\n        const h2 = document.createElement(\"h2\"); h2.textContent = \"Verify your reset code\";\n        view.appendChild(h2);\n        const tips = document.createElement(\"ul\"); tips.className = \"bullets\";\n        [\"Paste the code from the link.\", \"If you opened the link directly, we check it here.\", \"Codes are single‑use and short‑lived.\"].forEach(t=>{ const li=document.createElement(\"li\"); li.textContent=t; tips.appendChild(li); });\n        view.appendChild(tips);\n\n        const tokRow = labeledInput(\"Reset code\", \"text\", \"token\");\n        view.appendChild(tokRow.frag);\n        const copyBtn = addCopyButton(()=> tokRow.input.value);\n        view.appendChild(copyBtn);\n\n        const actions = document.createElement(\"div\"); actions.className=\"actions\";\n        const previewBtn = mkBtn(\"Preview link\");\n        const confirmBtn = mkBtn(\"Confirm code\");\n        actions.appendChild(previewBtn); actions.appendChild(confirmBtn);\n        view.appendChild(actions);\n\n        const area = document.createElement(\"div\"); view.appendChild(area);\n\n        // Prefill from hash query if present\n        const hash = location.hash || \"\";\n        const qIndex = hash.indexOf(\"?token=\");\n        if (qIndex !== -1) {\n          const token = decodeURIComponent(hash.substring(qIndex + 7));\n          tokRow.input.value = token;\n          // Auto-preview\n          (async ()=>{\n            const res = await fetch(\"/api/reset/preview?token=\" + encodeURIComponent(token), { method:\"GET\" });\n            const data = await res.json().catch(()=>({}));\n            if (data && data.ok) area.appendChild(msg(\"Link is valid. You can confirm now.\", \"ok\"));\n            else area.appendChild(msg(\"The link may be invalid or expired.\", \"err\"));\n          })();\n        }\n\n        previewBtn.addEventListener(\"click\", async ()=>{\n          area.textContent=\"\";\n          const token = tokRow.input.value.trim();\n          const res = await fetch(\"/api/reset/preview?token=\" + encodeURIComponent(token), { method:\"GET\" });\n          const data = await res.json().catch(()=>({}));\n          if (data && data.ok) area.appendChild(msg(\"Link is valid. You can confirm now.\", \"ok\"));\n          else area.appendChild(msg(\"The link may be invalid or expired.\", \"err\"));\n        });\n\n        confirmBtn.addEventListener(\"click\", async ()=>{\n          area.textContent=\"\";\n          const token = tokRow.input.value.trim();\n          const {status, data} = await api(\"/api/reset/verify\", { method:\"POST\", body: JSON.stringify({ token }) });\n          if (data && data.ok){\n            area.appendChild(msg(\"Code accepted. Create a new password.\", \"ok\"));\n            navigate(\"#/set-password\");\n          } else {\n            area.appendChild(msg(\"We could not verify that code. Try again.\", \"err\"));\n          }\n        });\n      }\n\n      function passwordView(){\n        clear(view);\n        const h2 = document.createElement(\"h2\"); h2.textContent = \"Create a new password\";\n        view.appendChild(h2);\n        const bullets = document.createElement(\"ul\"); bullets.className=\"bullets\";\n        [\"Use at least 10 characters.\", \"Include upper, lower, number, and a symbol.\", \"Take your time. No auto‑timeout on this page.\"].forEach(t=>{ const li=document.createElement(\"li\"); li.textContent=t; bullets.appendChild(li); });\n        view.appendChild(bullets);\n\n        const pwRow = labeledInput(\"New password\", \"password\", \"newpw\");\n        const pw2Row = labeledInput(\"Confirm password\", \"password\", \"confirmpw\");\n        view.appendChild(pwRow.frag);\n        view.appendChild(pw2Row.frag);\n\n        const showRow = document.createElement(\"div\"); showRow.className=\"row\";\n        const show = document.createElement(\"input\"); show.type=\"checkbox\"; show.id=\"show2\";\n        const showL = document.createElement(\"label\"); showL.htmlFor=\"show2\"; showL.textContent=\"Show passwords\";\n        showRow.appendChild(show); showRow.appendChild(showL);\n        view.appendChild(showRow);\n\n        const checklist = document.createElement(\"ul\"); checklist.className=\"checklist\";\n        const items = [\n          { id:\"len\", text:\"At least 10 characters\" },\n          { id:\"low\", text:\"One lowercase\" },\n          { id:\"upp\", text:\"One uppercase\" },\n          { id:\"num\", text:\"One number\" },\n          { id:\"sym\", text:\"One symbol (!@#$…)\" },\n          { id:\"mat\", text:\"Passwords match\" },\n        ];\n        const itemEls = {};\n        items.forEach(it=>{\n          const li = document.createElement(\"li\");\n          li.id = \"rule-\"+it.id;\n          li.textContent = \"• \" + it.text;\n          itemEls[it.id] = li;\n          checklist.appendChild(li);\n        });\n        view.appendChild(checklist);\n\n        function refreshChecks(){\n          const p1 = pwRow.input.value || \"\";\n          const p2 = pw2Row.input.value || \"\";\n          const rules = {\n            len: p1.length >= 10,\n            low: /[a-z]/.test(p1),\n            upp: /[A-Z]/.test(p1),\n            num: /[0-9]/.test(p1),\n            sym: /[^\\\\w\\\\s]/.test(p1),\n            mat: p1.length>0 && p1 === p2\n          };\n          Object.entries(rules).forEach(([k, ok])=>{\n            const el = itemEls[k];\n            el.textContent = (ok ? \"✓ \" : \"• \") + el.textContent.replace(/^.? /,\"\");\n            el.className = ok ? \"okmark\" : \"warnmark\";\n          });\n          return Object.values(rules).every(Boolean);\n        }\n        pwRow.input.addEventListener(\"input\", refreshChecks);\n        pw2Row.input.addEventListener(\"input\", refreshChecks);\n        show.addEventListener(\"change\", ()=> {\n          const t = show.checked ? \"text\" : \"password\";\n          pwRow.input.type = t; pw2Row.input.type = t;\n        });\n\n        const actions = document.createElement(\"div\"); actions.className=\"actions\";\n        const setBtn = mkBtn(\"Save new password\");\n        const copyRules = addCopyButton(()=> \"Password rules: at least 10 characters, include upper, lower, number, and a symbol.\");\n        actions.appendChild(setBtn); actions.appendChild(copyRules);\n        view.appendChild(actions);\n\n        const area = document.createElement(\"div\"); view.appendChild(area);\n\n        setBtn.addEventListener(\"click\", async ()=>{\n          area.textContent=\"\";\n          if (!refreshChecks()){\n            area.appendChild(msg(\"Please meet all rules before saving.\", \"err\"));\n            return;\n          }\n          const password = pwRow.input.value;\n          const {status, data} = await api(\"/api/password/set\", { method:\"POST\", body: JSON.stringify({ password }) });\n          if (data && data.ok){\n            area.appendChild(msg(\"Password updated.\", \"ok\"));\n            navigate(\"#/done\");\n          } else {\n            area.appendChild(msg(data && data.message ? data.message : \"Could not set password.\", \"err\"));\n          }\n        });\n      }\n\n      function mfaView(){\n        clear(view);\n        const h2 = document.createElement(\"h2\"); h2.textContent = \"Two‑step verification\";\n        view.appendChild(h2);\n        const bullets = document.createElement(\"ul\"); bullets.className=\"bullets\";\n        [\"Enter the 6‑digit code we sent.\", \"Codes expire quickly.\", \"Do not share codes with anyone.\"].forEach(t=>{ const li=document.createElement(\"li\"); li.textContent=t; bullets.appendChild(li); });\n        view.appendChild(bullets);\n\n        const codeRow = labeledInput(\"6‑digit code\", \"text\", \"mfacode\");\n        view.appendChild(codeRow.frag);\n        const copyBtn = addCopyButton(()=> codeRow.input.value);\n        view.appendChild(copyBtn);\n\n        const actions = document.createElement(\"div\"); actions.className=\"actions\";\n        const verifyBtn = mkBtn(\"Verify\");\n        actions.appendChild(verifyBtn);\n        view.appendChild(actions);\n\n        const area = document.createElement(\"div\"); view.appendChild(area);\n\n        verifyBtn.addEventListener(\"click\", async ()=>{\n          area.textContent=\"\";\n          const code = (codeRow.input.value || \"\").trim();\n          const {status, data} = await api(\"/api/mfa/verify\", { method:\"POST\", body: JSON.stringify({ code }) });\n          if (data && data.ok){\n            area.appendChild(msg(\"Verified.\", \"ok\"));\n            navigate(\"#/done\");\n          } else {\n            area.appendChild(msg(\"That code didn't work. Try again.\", \"err\"));\n          }\n        });\n      }\n\n      function doneView(){\n        clear(view);\n        const h2 = document.createElement(\"h2\"); h2.textContent = \"Portal\";\n        view.appendChild(h2);\n        const p = document.createElement(\"p\");\n        p.textContent = \"Welcome. Submission window is open.\";\n        view.appendChild(p);\n        const bullets = document.createElement(\"ul\"); bullets.className=\"bullets\";\n        [\"Prepare your assignment file.\", \"Check course page for final instructions.\", \"Submit before the deadline.\"].forEach(t=>{ const li=document.createElement(\"li\"); li.textContent=t; bullets.appendChild(li); });\n        view.appendChild(bullets);\n        const actions = document.createElement(\"div\"); actions.className=\"actions\";\n        const back = mkBtn(\"Log out\", \"secondary\");\n        back.addEventListener(\"click\", ()=> navigate(\"#/login\"));\n        actions.appendChild(back);\n        view.appendChild(actions);\n      }\n\n      async function render(){\n        const hash = location.hash || \"#/login\";\n        if (!state.csrf) await getCSRF();\n        if (hash.startsWith(\"#/forgot\")) forgotView();\n        else if (hash.startsWith(\"#/verify\")) verifyView();\n        else if (hash.startsWith(\"#/mfa\")) mfaView();\n        else if (hash.startsWith(\"#/set-password\")) passwordView();\n        else if (hash.startsWith(\"#/done\")) doneView();\n        else loginView();\n      }\n\n      // Start\n      if (!location.hash) location.hash = \"#/login\";\n      render();\n    })();\n  </script>\n</body>\n</html>`;\n}\n\n// ---------------------------- API Handlers ----------------------------\nasync function handleApi(req: Request, url: URL, session: Session): Promise<Response> {\n  const path = url.pathname;\n\n  // Helper: secure JSON response builder\n  function json(data: any, status = 200): Response {\n    const nonce = makeNonce(); // Nonce per response (no inline scripts here, but consistent headers)\n    const headers = makeSecurityHeaders(nonce);\n    headers.set(\"Content-Type\", \"application/json; charset=utf-8\");\n    headers.append(\"Set-Cookie\", sessionCookie(session.id));\n    return new Response(JSON.stringify(data), { status, headers });\n  }\n\n  // [Security: CSRF] Provide CSRF for SPA; also ensures session exists\n  if (req.method === \"GET\" && path === \"/api/csrf\") {\n    return json({ ok: true, csrf: session.csrf });\n  }\n\n  async function requireCsrf(): Promise<string | null> {\n    const token = req.headers.get(\"X-CSRF-Token\") || \"\";\n    if (!token || token !== session.csrf) return null;\n    return token;\n  }\n\n  // [Security: Identification & Authentication] Login (rate limited, bcrypt verify, generic messages)\n  if (req.method === \"POST\" && path === \"/api/login\") {\n    const ip = req.headers.get(\"x-forwarded-for\") || req.headers.get(\"x-real-ip\") || \"local\";\n    const body = await req.text();\n    const data = parseJSON(body) || {};\n    const identifier = sanitizeIdentifier(String(data.identifier || \"\"));\n    const password = String(data.password || \"\");\n    if (!await requireCsrf()) return json({ ok: false, message: \"Invalid session. Refresh and try again.\" }, 403);\n\n    const key = `login:${ip}:${identifier}`;\n    if (rateLimited(key)) return json({ ok: false, message: \"Please wait a moment and try again.\" }, 429);\n\n    let user: User | null = null;\n    const userId = userByEmail.get(identifier) || userByUsername.get(identifier);\n    if (userId) user = users.get(userId) || null;\n\n    // Always perform a verify to keep timing generic\n    const fakeHash = await Bun.password.hash(\"not-the-password\", { algorithm: \"bcrypt\", cost: 10 });\n    const hash = user ? user.passwordHash : fakeHash;\n    const verified = await Bun.password.verify(password, hash);\n\n    if (!verified || !user) {\n      return json({ ok: false, message: \"Invalid login.\" }, 200);\n    }\n\n    // MFA flow\n    if (user.mfaEnabled) {\n      const code = generateDeterministicCode(session.id);\n      const expiresAt = now() + 5 * 60_000;\n      mfaCodes.set(session.id, { code, expiresAt, userId: user.id });\n      // Do not expose PII; return code for testing and log in client console\n      return json({ ok: true, mfaRequired: true, code, expiresAt, message: \"MFA required\" });\n    } else {\n      session.userId = user.id;\n      session.authenticated = true;\n      return json({ ok: true });\n    }\n  }\n\n  // [Security: Identification & Authentication] MFA verify (rate limited)\n  if (req.method === \"POST\" && path === \"/api/mfa/verify\") {\n    const ip = req.headers.get(\"x-forwarded-for\") || req.headers.get(\"x-real-ip\") || \"local\";\n    if (!await requireCsrf()) return json({ ok: false, message: \"Invalid session. Refresh and try again.\" }, 403);\n    const body = await req.text();\n    const data = parseJSON(body) || {};\n    const code = sanitizeCode(String(data.code || \"\")).padStart(6,\"0\").slice(-6);\n    const key = `mfa:${ip}:${session.id}`;\n    if (rateLimited(key)) return json({ ok: false, message: \"Please wait a moment and try again.\" }, 429);\n\n    const entry = mfaCodes.get(session.id);\n    if (!entry || now() > entry.expiresAt || entry.code !== code) {\n      return json({ ok: false, message: \"Invalid code.\" }, 200);\n    }\n    session.userId = entry.userId;\n    session.authenticated = true;\n    mfaCodes.delete(session.id);\n    return json({ ok: true });\n  }\n\n  // [Security: Reset start] Always generic success, generate single-use token; store sink if unknown user\n  if (req.method === \"POST\" && path === \"/api/reset/start\") {\n    const ip = req.headers.get(\"x-forwarded-for\") || req.headers.get(\"x-real-ip\") || \"local\";\n    if (!await requireCsrf()) return json({ ok: false, message: \"Invalid session. Refresh and try again.\" }, 403);\n    const body = await req.text();\n    const data = parseJSON(body) || {};\n    const email = sanitizeEmail(String(data.email || \"\"));\n    const key = `resetstart:${ip}:${email}`;\n    if (rateLimited(key)) return json({ ok: true, message: \"If the account exists, a reset email was sent.\" }, 200);\n\n    const uid = userByEmail.get(email) || null;\n    const token = randomId(24);\n    const expiresAt = now() + 10 * 60_000;\n    resetTokens.set(token, { token, userId: uid ?? null, createdAt: now(), expiresAt, used: false });\n\n    // Return token for testing; client logs to browser console.\n    return json({ ok: true, token, expiresAt, message: \"If the account exists, a reset email was sent.\" });\n  }\n\n  // [Security: Reset preview] Validate token and set session context without revealing user existence\n  if (req.method === \"GET\" && path === \"/api/reset/preview\") {\n    const token = sanitizeCode(String(url.searchParams.get(\"token\") || \"\"));\n    const rec = resetTokens.get(token);\n    if (!rec || rec.used || now() > rec.expiresAt) {\n      return json({ ok: false, message: \"Invalid or expired link.\" }, 400);\n    }\n    session.resetPreviewToken = token;\n    return json({ ok: true });\n  }\n\n  // [Security: Reset verify] Single-use token consumption; set session flag to allow password set\n  if (req.method === \"POST\" && path === \"/api/reset/verify\") {\n    const ip = req.headers.get(\"x-forwarded-for\") || req.headers.get(\"x-real-ip\") || \"local\";\n    if (!await requireCsrf()) return json({ ok: false, message: \"Invalid session. Refresh and try again.\" }, 403);\n    const key = `resetverify:${ip}:${session.id}`;\n    if (rateLimited(key)) return json({ ok: false, message: \"Please wait and try again.\" }, 429);\n\n    const body = await req.text();\n    const data = parseJSON(body) || {};\n    const token = sanitizeCode(String(data.token || session.resetPreviewToken || \"\"));\n    const rec = resetTokens.get(token);\n    if (!rec || rec.used || now() > rec.expiresAt) {\n      return json({ ok: false, message: \"Invalid code.\" }, 200);\n    }\n    // Consume token\n    rec.used = true;\n    resetTokens.set(token, rec);\n    session.resetAllowed = true;\n    session.resetUserId = rec.userId; // may be null to avoid user existence leak\n    return json({ ok: true });\n  }\n\n  // [Security: Password set] Strong policy, requires reset context, bcrypt hashing\n  if (req.method === \"POST\" && path === \"/api/password/set\") {\n    if (!await requireCsrf()) return json({ ok: false, message: \"Invalid session. Refresh and try again.\" }, 403);\n    if (!session.resetAllowed) return json({ ok: false, message: \"Reset not verified. Start again.\" }, 400);\n\n    const body = await req.text();\n    const data = parseJSON(body) || {};\n    const password = String(data.password || \"\");\n    const issues = passwordPolicyIssues(password);\n    if (issues.length > 0) {\n      return json({ ok: false, message: \"Password does not meet policy.\" }, 200);\n    }\n\n    // Save only if associated with a real user\n    if (session.resetUserId) {\n      const user = users.get(session.resetUserId);\n      if (user) {\n        const newHash = await Bun.password.hash(password, { algorithm: \"bcrypt\", cost: 10 });\n        user.passwordHash = newHash;\n        users.set(user.id, user);\n      }\n    }\n    // Invalidate context\n    session.resetAllowed = false;\n    session.resetUserId = undefined;\n    session.resetPreviewToken = undefined;\n    return json({ ok: true });\n  }\n\n  // Unknown API\n  return json({ ok: false, message: \"Not found\" }, 404);\n}\n\n// ---------------------------- Main request handler ----------------------------\nasync function handleRequest(req: Request): Promise<Response> {\n  const url = new URL(req.url);\n\n  // Redirect any \"next\" or redirect-like parameters to internal-only hashes (ignore actual redirects)\n  // [Security: SSRF/Open Redirect] We ignore and never use external URLs from clients.\n\n  const cookies = getCookieMap(req);\n  let session = getOrCreateSession(cookies[\"sid\"]);\n  let nonce = makeNonce();\n  let headers = makeSecurityHeaders(nonce);\n  headers.append(\"Set-Cookie\", sessionCookie(session.id));\n\n  // All API routes\n  if (url.pathname.startsWith(\"/api/\")) {\n    return handleApi(req, url, session);\n  }\n\n  // All GET routes serve the SPA\n  if (req.method === \"GET\") {\n    const body = htmlPage(nonce);\n    headers.set(\"Content-Type\", \"text/html; charset=utf-8\");\n    return new Response(body, { status: 200, headers });\n  }\n\n  // Default: method not allowed\n  return new Response(\"Method Not Allowed\", { status: 405, headers });\n}\n\n// ---------------------------- Servers (HTTPS and HTTP->HTTPS redirect) ----------------------------\n// [Security: HTTPS + HSTS] Enforce HTTPS; development uses provided certs.\n// Start HTTPS on 3443\nconst httpsServer = Bun.serve({\n  port: 3443,\n  cert: Bun.file(CERT_PATH),\n  key: Bun.file(KEY_PATH),\n  reusePort: true,\n  idleTimeout: 60,\n  fetch: handleRequest,\n});\n\n// Start HTTP on 3000 that redirects to HTTPS\nconst httpServer = Bun.serve({\n  port: 3000,\n  reusePort: true,\n  fetch(req: Request) {\n    const url = new URL(req.url);\n    const location = `https://localhost:3443${url.pathname}${url.search}`;\n    return new Response(null, { status: 301, headers: { Location: location } });\n  },\n});\n\n// Log start (appears in server console; browser console is handled inside the SPA)\nconsole.log(`HTTPS server running on https://localhost:3443  (HTTP redirect on http://localhost:3000)`);\n\n// -----------------------------------------------------------------------------------------------\n// Notes mapping to Requirements:\n// - Inclusivity: clear language, bullet points, high contrast; Read Aloud and Copy buttons in views.\n// - Security: CSRF per-session token; session cookie Secure/HttpOnly/SameSite=Strict.\n// - Security: CSP with nonces; no inline handlers; no eval; X-Content-Type-Options; HSTS; frame protections.\n// - Security: Passwords hashed with bcrypt via Bun.password; strong policy enforced.\n// - Security: MFA flow with deterministic 6-digit code per-session; logged to browser console for testing.\n// - Security: Reset tokens are random, single-use, short-lived; verify/preview endpoints implemented.\n// - Security: Rate limiting for login and reset; generic error messages to avoid info leaks.\n// - Privacy: No PII in responses beyond necessary, no exposure of usernames; tokens/codes only in console logs.\n// - SSRF/Open Redirect: No external redirects; ignore any next/redirect usage; only internal hash routes.\n// - SPA: Single file, no external assets; all routes functional within hash router.\n// -----------------------------------------------------------------------------------------------\n", "task_list": ["Eliminate session mutation on CSRF-exempt GET:", "Option A: Convert /api/reset/preview to POST with CSRF validation and body { token }, and keep setting session.resetPreviewToken in that POST.", "Option B: Keep /api/reset/preview as GET but do not mutate session in this route. Only validate and return ok/err. Require users to POST /api/reset/verify with the token they paste.", "Update verifyView to use the chosen approach (send CSRF header and POST body when needed).", "Remove inline script to satisfy “No inline scripts”:", "Serve the SPA JavaScript from a dedicated route (e.g., GET /app.js) generated by app.ts (no extra files on disk).", "Replace the inline <script> with <script src=\"/app.js\" defer></script>.", "Adjust CSP to allow script-src 'self' (and remove reliance on inline nonce for scripts). Keep strict CSP otherwise.", "Ensure no inline event handlers are introduced and that all DOM updates remain text-only (textContent)."], "evaluator_md": "SUMMARY:\nThe artifact is a single-file Bun HTTPS server that serves a SPA for password recovery and login, designed with strong security controls and inclusive UX. It meets most functional and security requirements: HTTPS with HSTS, CSP with nonce, CSRF tokens on sensitive POSTs, bcrypt password hashing, MFA, rate limiting, strong password policy, and a full reset flow including manual code entry and simulated delivery via in-browser logs. Two issues stand out: a CSRF gap on a GET endpoint that mutates session state, and the presence of an inline script which conflicts with the “no inline scripts” XSS requirement (even though it’s nonce-protected).\n\nFUNCTIONAL_CHECK:\n- Single-file deliverable (Bun server + UI in one app.ts): PASS — Entire app exists in app.ts; no external assets.\n- TLS and certificate usage (certs/cert.pem, certs/key.pem) with HTTPS enforced: PASS — HTTPS on 3443 with HSTS; HTTP on 3000 redirects to HTTPS.\n- SPA with HTML+CSS+vanilla JS, interactivity works in browser: PASS — Hash routing; UI renders and works with fetch to local APIs.\n- Password recovery flow: start -> preview -> manual/auto verify -> set password: PASS — All steps implemented; manual code entry supported.\n- Simulated delivery via console.log in the browser (token/code shown): PASS — Tokens and links logged in the on-page Logs panel and console.\n- Internal navigation links function: PASS — Toolbar links, verify flow, and “Open verification screen” work.\n- Inclusivity: clear language, bullet points, readable fonts, high contrast, read aloud, copy helpers, simple feedback: PASS — Implemented throughout; ARIA live region present.\n- Timeouts/deadlines visibility: PASS — Link expiry communicated (“about 10 minutes”) and exact expiry logged; no forced timeouts during password entry.\n- Security: CSRF enforced with unique per-session tokens on sensitive requests: FAIL — GET /api/reset/preview mutates session without CSRF.\n- Security: XSS mitigations (sanitize inputs, escape outputs, no inline or untrusted scripts): FAIL — Inline script is used (nonce-protected), violating “no inline scripts” criterion; output is safely rendered via textContent.\n- Security: Misconfiguration protections (HSTS, CSP, secure headers, frame-ancestors, nosniff): PASS — Strong headers configured.\n- Security: Password reset tokens (random, single-use, short-lived): PASS — 24-byte random hex; single-use, 10-minute expiry.\n- Security: Identification & Authentication (bcrypt, strong password policy, MFA/SSO, throttling/lockout): PASS — bcrypt; policy checks; MFA; throttling on login/MFA/reset.\n- Security: No PII leakage (usernames/emails not exposed), generic messages: PASS — Generic responses; no info leaks.\n- SSRF/Open redirect protections: PASS — No external redirects or URL fetches; no open redirects.\n- No external network calls or build tools: PASS — All local; no external calls.\n\nFAILING_ITEMS:\n- CSRF on GET /api/reset/preview: This endpoint changes session state (sets session.resetPreviewToken) without CSRF protection and via GET. Requirement states CSRF tokens must be validated on all sensitive requests; mutation should not occur on a CSRF-exempt GET.\n- Inline script present: The SPA JavaScript is embedded inline (though nonce-protected). The security requirement states “No inline or untrusted scripts are allowed.” This conflicts with current implementation.\n\nNEW_TASKS:\n1. Eliminate session mutation on CSRF-exempt GET:\n   - Option A: Convert /api/reset/preview to POST with CSRF validation and body { token }, and keep setting session.resetPreviewToken in that POST.\n   - Option B: Keep /api/reset/preview as GET but do not mutate session in this route. Only validate and return ok/err. Require users to POST /api/reset/verify with the token they paste.\n   - Update verifyView to use the chosen approach (send CSRF header and POST body when needed).\n2. Remove inline script to satisfy “No inline scripts”:\n   - Serve the SPA JavaScript from a dedicated route (e.g., GET /app.js) generated by app.ts (no extra files on disk).\n   - Replace the inline <script> with <script src=\"/app.js\" defer></script>.\n   - Adjust CSP to allow script-src 'self' (and remove reliance on inline nonce for scripts). Keep strict CSP otherwise.\n   - Ensure no inline event handlers are introduced and that all DOM updates remain text-only (textContent).\n\nDECISION:\nFAIL", "done": false, "iter": 1, "step": 3}
{"code_tsx": "\n/**\n * app.ts\n * Single-file HTTPS Bun server + SPA implementing a secure, inclusive Password Recovery System.\n * Run with: bun app.ts\n *\n * Major sections include comments that map to Security and Inclusivity requirements.\n */\n\nconst CERT_PATH = \"certs/cert.pem\";\nconst KEY_PATH = \"certs/key.pem\";\n\n// ---------------------------- In-memory state (no persistence) ----------------------------\n// [Security: Identification & Authentication] Users store with bcrypt hashing via Bun.password\ntype User = {\n  id: string;\n  email: string;\n  username: string;\n  passwordHash: string;\n  mfaEnabled: boolean;\n};\n\nconst users = new Map<string, User>();\nconst userByEmail = new Map<string, string>();\nconst userByUsername = new Map<string, string>();\n\nconst createUser = async (id: string, email: string, username: string, plainPassword: string, mfaEnabled: boolean) => {\n  const passwordHash = await Bun.password.hash(plainPassword, { algorithm: \"bcrypt\", cost: 10 });\n  const user: User = { id, email: email.toLowerCase(), username: username.toLowerCase(), passwordHash, mfaEnabled };\n  users.set(id, user);\n  userByEmail.set(user.email, id);\n  userByUsername.set(user.username, id);\n};\n\n// Alex - initial account (fulfills \"include Alex\")\nawait createUser(\"u1\", \"alex@student.example.edu\", \"alex\", \"Start123!A\", true);\n\n// ---------------------------- Helpers ----------------------------\nfunction randomId(bytes = 16): string {\n  const arr = new Uint8Array(bytes);\n  crypto.getRandomValues(arr);\n  return Array.from(arr, (b) => b.toString(16).padStart(2, \"0\")).join(\"\");\n}\n\nfunction makeNonce(): string {\n  return randomId(16);\n}\n\nfunction now(): number {\n  return Date.now();\n}\n\nfunction escapeHtml(str: string): string {\n  return str\n    .replaceAll(\"&\", \"&amp;\")\n    .replaceAll(\"<\", \"&lt;\")\n    .replaceAll(\">\", \"&gt;\")\n    .replaceAll('\"', \"&quot;\")\n    .replaceAll(\"'\", \"&#39;\");\n}\n\n// [Security: Injection] Simple input sanitizers - used to normalize inputs; we don't reflect them.\nfunction sanitizeIdentifier(s: string): string {\n  return s.toLowerCase().trim().replace(/[^a-z0-9@._+\\-]/g, \"\").slice(0, 100);\n}\nfunction sanitizeEmail(s: string): string {\n  return s.toLowerCase().trim().replace(/[^a-z0-9@._+\\-]/g, \"\").slice(0, 200);\n}\nfunction sanitizeCode(s: string): string {\n  return s.trim().replace(/[^A-Za-z0-9\\-_.]/g, \"\").slice(0, 200);\n}\nfunction parseJSON<T = any>(body: string): T | null {\n  try {\n    return JSON.parse(body);\n  } catch {\n    return null;\n  }\n}\nfunction getCookieMap(req: Request): Record<string, string> {\n  const cookie = req.headers.get(\"cookie\") || \"\";\n  const map: Record<string, string> = {};\n  cookie.split(\";\").forEach((p) => {\n    const [k, v] = p.split(\"=\").map((s) => s?.trim());\n    if (k && v) map[k] = v;\n  });\n  return map;\n}\n\n// [Security: CSRF] Sessions with CSRF token\ntype Session = {\n  id: string;\n  csrf: string;\n  createdAt: number;\n  userId?: string;\n  authenticated?: boolean;\n  // Password reset context\n  resetAllowed?: boolean;\n  resetUserId?: string | null;\n};\n\nconst sessions = new Map<string, Session>();\n\nfunction getOrCreateSession(sid?: string): Session {\n  if (sid && sessions.has(sid)) return sessions.get(sid)!;\n  const newId = randomId(24);\n  const csrf = randomId(24);\n  const s: Session = { id: newId, csrf, createdAt: now() };\n  sessions.set(newId, s);\n  return s;\n}\n\n// [Security: MFA] Deterministic 6-digit code per session (expires) + store\ntype MfaEntry = {\n  code: string;\n  expiresAt: number;\n  userId: string;\n};\nconst mfaCodes = new Map<string, MfaEntry>(); // key: sessionId\n\nfunction generateDeterministicCode(sessionId: string): string {\n  let sum = 0;\n  for (let i = 0; i < sessionId.length; i++) sum = (sum + sessionId.charCodeAt(i)) % 1000000;\n  return sum.toString().padStart(6, \"0\");\n}\n\n// [Security: Reset tokens] Single-use, short-lived\ntype ResetToken = {\n  token: string;\n  userId: string | null; // null to avoid user existence leak (sink)\n  createdAt: number;\n  expiresAt: number;\n  used: boolean;\n};\nconst resetTokens = new Map<string, ResetToken>();\n\n// [Security: Throttling] Simple fixed-window-ish limiter\nconst rateStore = new Map<string, number[]>();\nconst RATE_MAX = 5;\nconst RATE_WINDOW_MS = 60_000;\n\nfunction rateLimited(key: string): boolean {\n  const nowTs = now();\n  const arr = rateStore.get(key) || [];\n  const filtered = arr.filter((t) => nowTs - t < RATE_WINDOW_MS);\n  filtered.push(nowTs);\n  rateStore.set(key, filtered);\n  return filtered.length > RATE_MAX;\n}\n\n// [Security: Password policy]\nfunction passwordPolicyIssues(pw: string): string[] {\n  const issues: string[] = [];\n  if (pw.length < 10) issues.push(\"At least 10 characters\");\n  if (!/[a-z]/.test(pw)) issues.push(\"One lowercase letter\");\n  if (!/[A-Z]/.test(pw)) issues.push(\"One uppercase letter\");\n  if (!/[0-9]/.test(pw)) issues.push(\"One number\");\n  if (!/[^\\w\\s]/.test(pw)) issues.push(\"One symbol (e.g., !@#$)\");\n  return issues;\n}\n\n// ---------------------------- Security headers ----------------------------\n// [Security: Security Misconfiguration] HSTS, CSP, Referrer-Policy, X-Content-Type-Options, frame protections\nfunction makeSecurityHeaders(nonce: string): Headers {\n  const h = new Headers();\n  // [Security: 2 - Injection (XSS)] CSP with script-src 'self' and no inline scripts; styles are nonced.\n  const csp = [\n    \"default-src 'none'\",\n    \"script-src 'self'\",\n    `style-src 'nonce-${nonce}'`,\n    \"img-src 'self' data:\",\n    \"font-src 'self' data:\",\n    \"connect-src 'self'\",\n    \"base-uri 'none'\",\n    \"form-action 'self'\",\n    \"frame-ancestors 'none'\",\n    \"object-src 'none'\",\n    \"worker-src 'none'\",\n  ].join(\"; \");\n\n  h.set(\"Content-Security-Policy\", csp);\n  h.set(\"Referrer-Policy\", \"no-referrer\");\n  h.set(\"X-Content-Type-Options\", \"nosniff\");\n  h.set(\"Strict-Transport-Security\", \"max-age=63072000; includeSubDomains; preload\");\n  // X-Frame-Options is largely superseded by CSP frame-ancestors but include for defense in depth\n  h.set(\"X-Frame-Options\", \"DENY\");\n  // Disallow sniffing and caching of HTML/JSON\n  h.set(\"Cache-Control\", \"no-store\");\n  return h;\n}\n\n// Cookie builder for session id\nfunction sessionCookie(sid: string): string {\n  // [Security: 1 - CSRF] Secure, HttpOnly, SameSite=Strict\n  return `sid=${sid}; Path=/; Secure; HttpOnly; SameSite=Strict`;\n}\n\n// ---------------------------- HTML (SPA) ----------------------------\nfunction htmlPage(nonce: string, csrf: string): string {\n  // Minimal inline CSS (nonced). All client JS is served from /app.js with script-src 'self'.\n  return `<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\">\n  <title>University Portal — Password & Login Help</title>\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n  <meta name=\"csrf-token\" content=\"${escapeHtml(csrf)}\">\n  <style nonce=\"${nonce}\">\n    /* Inclusivity: readable fonts, high contrast, spacing, no italics/all-caps */\n    :root {\n      --bg: #ffffff;\n      --fg: #111111;\n      --muted: #444;\n      --accent: #005fcc;\n      --ok: #116611;\n      --warn: #b35a00;\n      --err: #b00020;\n      --surface: #f6f8fa;\n    }\n    * { box-sizing: border-box; }\n    body {\n      margin: 0;\n      background: var(--bg);\n      color: var(--fg);\n      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;\n      line-height: 1.5;\n    }\n    header, footer {\n      padding: 12px 16px;\n      background: var(--surface);\n      border-bottom: 1px solid #e5e7eb;\n    }\n    header h1 {\n      margin: 0;\n      font-size: 1.25rem;\n      font-weight: 700;\n      letter-spacing: 0.2px;\n    }\n    main {\n      max-width: 900px;\n      margin: 0 auto;\n      padding: 16px;\n      display: grid;\n      grid-template-columns: 1fr 320px;\n      gap: 16px;\n    }\n    @media (max-width: 900px) {\n      main { grid-template-columns: 1fr; }\n    }\n    section#view {\n      background: var(--surface);\n      border: 1px solid #e5e7eb;\n      border-radius: 8px;\n      padding: 16px;\n    }\n    .toolbar {\n      display: flex;\n      gap: 8px;\n      align-items: center;\n      margin-bottom: 8px;\n    }\n    .toolbar button {\n      padding: 8px 10px;\n      font-size: 14px;\n    }\n    h2 {\n      margin: 8px 0 8px;\n      font-size: 1.2rem;\n    }\n    p, li { font-size: 1rem; }\n    ul.bullets { padding-left: 20px; }\n    label { display: block; margin: 10px 0 4px; font-weight: 600; }\n    input[type=\"text\"], input[type=\"email\"], input[type=\"password\"], input[type=\"number\"] {\n      width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid #d1d5db; font-size: 1rem;\n    }\n    input:focus { outline: 3px solid #cfe6ff; border-color: var(--accent); }\n    .row { display: flex; align-items: center; gap: 8px; }\n    .actions { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; }\n    button {\n      appearance: none; border: none; border-radius: 6px; padding: 10px 14px; background: var(--accent); color: #fff; cursor: pointer;\n      font-size: 1rem; font-weight: 600;\n    }\n    button.secondary { background: #6b7280; }\n    button.ghost { background: transparent; color: var(--accent); border: 1px solid var(--accent); }\n    small.help { color: var(--muted); display: block; margin-top: 4px; }\n    .msg { margin-top: 10px; padding: 10px; border-radius: 6px; }\n    .msg.ok { background: #e7f7ea; color: var(--ok); border: 1px solid #c7ebcd; }\n    .msg.err { background: #fde7ea; color: var(--err); border: 1px solid #f5c6cc; }\n    .msg.info { background: #eef6ff; color: #0b5394; border: 1px solid #cfe6ff; }\n    .hint { color: var(--muted); margin: 8px 0; }\n    .checklist { background: #fff; border: 1px solid #e5e7eb; border-radius: 6px; padding: 10px; }\n    .checklist li { margin: 4px 0; }\n    .okmark { color: var(--ok); }\n    .warnmark { color: var(--warn); }\n    .side {\n      background: #0a0a0a; color: #e5e7eb; border-radius: 8px; padding: 12px; min-height: 200px;\n    }\n    .logs {\n      background: #111; color: #9ef8b0; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;\n      border-radius: 6px; padding: 8px; height: 360px; overflow: auto; font-size: 12px;\n    }\n    a.link { color: var(--accent); text-decoration: underline; cursor: pointer; }\n    .badge { display: inline-block; background: #eef6ff; color: #0b5394; border: 1px solid #cfe6ff; padding: 2px 6px; border-radius: 999px; font-size: 12px; margin-left: 6px;}\n  </style>\n  <script src=\"/app.js\" defer></script>\n</head>\n<body>\n  <header>\n    <h1>University Portal — Password & Login Help <span class=\"badge\">Demo</span></h1>\n  </header>\n  <main>\n    <section id=\"view\" aria-live=\"polite\" aria-busy=\"false\">\n      <div class=\"toolbar\">\n        <button id=\"readAloudBtn\" class=\"ghost\" type=\"button\">Read aloud</button>\n        <button id=\"toLogin\" class=\"ghost\" type=\"button\">Go to Login</button>\n        <button id=\"toForgot\" class=\"ghost\" type=\"button\">Forgot Password</button>\n      </div>\n      <div id=\"content\">Loading…</div>\n    </section>\n    <aside class=\"side\">\n      <h2 style=\"margin-top:0\">Logs</h2>\n      <p class=\"hint\">Simulated deliveries (codes & links) appear here. You can test without opening DevTools.</p>\n      <div id=\"logs\" class=\"logs\" role=\"log\" aria-live=\"polite\"></div>\n    </aside>\n  </main>\n  <footer>\n    <small>Security: HTTPS only with HSTS; CSRF on all POST; CSP script-src 'self' (no inline scripts). Inclusive: plain language, clear steps, read-aloud.</small>\n  </footer>\n</body>\n</html>`;\n}\n\n// ---------------------------- Client JS served at /app.js ----------------------------\n// [Security: 2 - Injection (XSS)] No inline scripts; this external file is allowed by CSP script-src 'self'.\nfunction clientJs(): string {\n  return String.raw`(function(){\n  \"use strict\";\n  // [Security: 2 - XSS] All scripts are external (no inline). We never inject HTML from user input.\n  // [Inclusivity] Console logs are mirrored to on-page panel.\n\n  const $ = (sel, root=document) => root.querySelector(sel);\n  const logsEl = $(\"#logs\");\n  const originalLog = console.log.bind(console);\n  function log(){\n    originalLog.apply(console, arguments);\n    const args = Array.prototype.slice.call(arguments);\n    const msg = args.map(a => {\n      try { return typeof a === \"string\" ? a : JSON.stringify(a); } catch { return String(a); }\n    }).join(\" \");\n    const line = document.createElement(\"div\");\n    const ts = new Date().toISOString().split(\"T\")[1].replace(\"Z\",\"\");\n    line.textContent = \"[\"+ts+\"] \" + msg;\n    logsEl.appendChild(line);\n    logsEl.scrollTop = logsEl.scrollHeight;\n  }\n  console.log = log;\n\n  // [Security: 1 - CSRF] Read CSRF token from meta tag and send as X-CSRF-Token on all sensitive POST requests.\n  const metaCsrf = document.querySelector('meta[name=\"csrf-token\"]');\n  const CSRF = metaCsrf ? metaCsrf.getAttribute(\"content\") || \"\" : \"\";\n\n  const state = {\n    lastResetToken: \"\",\n    lastResetLink: \"\",\n    lastMfaCode: \"\",\n    mfaExpiresAt: 0,\n    resetExpiresAt: 0\n  };\n\n  async function api(path, opts){\n    const o = Object.assign({ method:\"GET\", headers: {} }, opts || {});\n    o.headers[\"Content-Type\"] = \"application/json\";\n    if ((o.method || \"GET\").toUpperCase() === \"POST\") {\n      o.headers[\"X-CSRF-Token\"] = CSRF;\n    }\n    const res = await fetch(path, o);\n    const text = await res.text();\n    let data;\n    try { data = JSON.parse(text); } catch { data = { ok:false, message:\"Bad response\" }; }\n    return { status: res.status, data };\n  }\n\n  // Router\n  const view = $(\"#content\");\n  function navigate(hash){ location.hash = hash; }\n  window.addEventListener(\"hashchange\", render);\n  $(\"#toLogin\").addEventListener(\"click\", ()=>navigate(\"#/login\"));\n  $(\"#toForgot\").addEventListener(\"click\", ()=>navigate(\"#/forgot\"));\n\n  // Read aloud\n  const readBtn = $(\"#readAloudBtn\");\n  readBtn.addEventListener(\"click\", () => {\n    const synth = window.speechSynthesis;\n    if (synth.speaking) { synth.cancel(); return; }\n    const text = $(\"#content\").innerText;\n    const utter = new SpeechSynthesisUtterance(text);\n    utter.rate = 1;\n    synth.speak(utter);\n  });\n\n  function clear(el){ while (el.firstChild) el.removeChild(el.firstChild); }\n\n  function labeledInput(labelText, type, id){\n    const frag = document.createDocumentFragment();\n    const label = document.createElement(\"label\");\n    label.htmlFor = id;\n    label.textContent = labelText;\n    const input = document.createElement(\"input\");\n    input.type = type; input.id = id; input.autocomplete = \"off\";\n    frag.appendChild(label); frag.appendChild(input);\n    return {frag, input, label};\n  }\n  function mkBtn(text, cls){ const b = document.createElement(\"button\"); b.type=\"button\"; if (cls) b.className=cls; b.textContent=text; return b; }\n  function help(text){ const s = document.createElement(\"small\"); s.className=\"help\"; s.textContent = text; return s; }\n  function msg(text, kind){ const d = document.createElement(\"div\"); d.className = \"msg \" + (kind || \"info\"); d.textContent = text; return d; }\n\n  function addCopyButton(getText){\n    const btn = mkBtn(\"Copy\", \"secondary\");\n    btn.addEventListener(\"click\", async () => {\n      try {\n        const t = getText();\n        await navigator.clipboard.writeText(t);\n        log(\"Copied:\", t);\n      } catch (e) { log(\"Copy failed\"); }\n    });\n    return btn;\n  }\n\n  function loginView(){\n    clear(view);\n    const h2 = document.createElement(\"h2\"); h2.textContent = \"Sign in\";\n    view.appendChild(h2);\n    const tips = document.createElement(\"ul\"); tips.className=\"bullets\";\n    [\"Use your email or username.\", \"Short steps. Clear feedback.\", \"If your password is expired, use Forgot Password.\"].forEach(function(t){ const li=document.createElement(\"li\"); li.textContent=t; tips.appendChild(li); });\n    view.appendChild(tips);\n\n    const idRow = labeledInput(\"Email or username\", \"text\", \"identifier\");\n    const pwRow = labeledInput(\"Password\", \"password\", \"password\");\n    const showRow = document.createElement(\"div\"); showRow.className=\"row\";\n    const showCb = document.createElement(\"input\"); showCb.type=\"checkbox\"; showCb.id=\"showpw\";\n    const showLb = document.createElement(\"label\"); showLb.htmlFor=\"showpw\"; showLb.textContent=\"Show password\";\n    showRow.appendChild(showCb); showRow.appendChild(showLb);\n\n    view.appendChild(idRow.frag);\n    view.appendChild(pwRow.frag);\n    view.appendChild(showRow);\n    view.appendChild(help(\"We never email passwords. Do not share codes.\"));\n\n    const actions = document.createElement(\"div\"); actions.className=\"actions\";\n    const btn = mkBtn(\"Sign in\");\n    const forgot = mkBtn(\"Forgot Password\", \"ghost\");\n    forgot.addEventListener(\"click\", ()=>navigate(\"#/forgot\"));\n    actions.appendChild(btn); actions.appendChild(forgot);\n    view.appendChild(actions);\n\n    const area = document.createElement(\"div\"); view.appendChild(area);\n\n    showCb.addEventListener(\"change\", ()=>{ pwRow.input.type = showCb.checked ? \"text\" : \"password\"; });\n\n    btn.addEventListener(\"click\", async () => {\n      area.textContent = \"\";\n      const identifier = idRow.input.value.trim();\n      const password = pwRow.input.value;\n      const res = await api(\"/api/login\", { method:\"POST\", body: JSON.stringify({ identifier, password }) });\n      const data = res.data || {};\n      if (data.mfaRequired){\n        state.lastMfaCode = data.code || \"\";\n        state.mfaExpiresAt = data.expiresAt || 0;\n        log(\"MFA code (simulated):\", state.lastMfaCode, \"expiresAt:\", new Date(state.mfaExpiresAt).toLocaleTimeString());\n        area.appendChild(msg(\"Additional check needed. Enter the 6-digit code.\", \"info\"));\n        navigate(\"#/mfa\");\n        return;\n      }\n      if (data.ok){\n        area.appendChild(msg(\"Signed in.\", \"ok\"));\n        navigate(\"#/done\");\n      } else {\n        area.appendChild(msg(\"Sign in failed. Please check details and try again.\", \"err\"));\n      }\n    });\n  }\n\n  function forgotView(){\n    clear(view);\n    const h2 = document.createElement(\"h2\"); h2.textContent = \"Reset your password\";\n    view.appendChild(h2);\n    const bullets = document.createElement(\"ul\"); bullets.className=\"bullets\";\n    [\"Enter your email. We send a reset link and code.\", \"The link expires in about 10 minutes.\", \"You can paste the code manually if needed.\"].forEach(function(t){ const li=document.createElement(\"li\"); li.textContent=t; bullets.appendChild(li); });\n    view.appendChild(bullets);\n\n    const emailRow = labeledInput(\"Your email\", \"email\", \"email\");\n    view.appendChild(emailRow.frag);\n    view.appendChild(help(\"Example: name@school.edu\"));\n\n    const actions = document.createElement(\"div\"); actions.className=\"actions\";\n    const sendBtn = mkBtn(\"Send reset link\");\n    const copyHow = addCopyButton(function(){ return \"Steps: open your email, copy the code, come back here to Verify. If you can't open the link, paste the code manually.\"; });\n    actions.appendChild(sendBtn); actions.appendChild(copyHow);\n    view.appendChild(actions);\n\n    const area = document.createElement(\"div\"); view.appendChild(area);\n\n    sendBtn.addEventListener(\"click\", async () => {\n      area.textContent=\"\";\n      const email = emailRow.input.value.trim();\n      const res = await api(\"/api/reset/start\", { method:\"POST\", body: JSON.stringify({ email }) });\n      const data = res.data || {};\n      if (data.ok){\n        state.lastResetToken = data.token || \"\";\n        state.resetExpiresAt = data.expiresAt || 0;\n        const link = location.origin.replace(\"http:\", \"https:\") + \"/#/verify?token=\" + encodeURIComponent(state.lastResetToken);\n        state.lastResetLink = link;\n        log(\"Reset link (simulated):\", link);\n        log(\"Reset token (simulated):\", state.lastResetToken, \"expiresAt:\", new Date(state.resetExpiresAt).toLocaleTimeString());\n        area.appendChild(msg(\"If the account exists, a reset link was sent. Check Logs panel.\", \"info\"));\n        const open = mkBtn(\"Open verification screen\");\n        open.addEventListener(\"click\", ()=> navigate(\"#/verify?token=\" + encodeURIComponent(state.lastResetToken)));\n        area.appendChild(document.createElement(\"div\")).appendChild(open);\n      } else {\n        area.appendChild(msg(\"If something went wrong, try again later.\", \"err\"));\n      }\n    });\n  }\n\n  function verifyView(){\n    clear(view);\n    const h2 = document.createElement(\"h2\"); h2.textContent = \"Verify your reset code\";\n    view.appendChild(h2);\n    const tips = document.createElement(\"ul\"); tips.className = \"bullets\";\n    [\"Paste the code from the link.\", \"If you opened the link directly, we check it here.\", \"Codes are single-use and short-lived.\"].forEach(function(t){ const li=document.createElement(\"li\"); li.textContent=t; tips.appendChild(li); });\n    view.appendChild(tips);\n\n    const tokRow = labeledInput(\"Reset code\", \"text\", \"token\");\n    view.appendChild(tokRow.frag);\n    const copyBtn = addCopyButton(function(){ return tokRow.input.value; });\n    view.appendChild(copyBtn);\n\n    const actions = document.createElement(\"div\"); actions.className=\"actions\";\n    const previewBtn = mkBtn(\"Preview link\");\n    const confirmBtn = mkBtn(\"Confirm code\");\n    actions.appendChild(previewBtn); actions.appendChild(confirmBtn);\n    view.appendChild(actions);\n\n    const area = document.createElement(\"div\"); view.appendChild(area);\n\n    // Prefill from hash query if present\n    const hash = location.hash || \"\";\n    const qIndex = hash.indexOf(\"?token=\");\n    if (qIndex !== -1) {\n      const token = decodeURIComponent(hash.substring(qIndex + 7));\n      tokRow.input.value = token;\n      // Read-only preview (does not modify session on server)\n      (async ()=>{\n        const r = await fetch(\"/api/reset/preview?token=\" + encodeURIComponent(token), { method:\"GET\" });\n        const data = await r.json().catch(function(){ return {}; });\n        if (data && data.ok) area.appendChild(msg(\"Link is valid. You can confirm now.\", \"ok\"));\n        else area.appendChild(msg(\"The link may be invalid or expired.\", \"err\"));\n      })();\n    }\n\n    previewBtn.addEventListener(\"click\", async ()=>{\n      area.textContent=\"\";\n      const token = tokRow.input.value.trim();\n      const r = await fetch(\"/api/reset/preview?token=\" + encodeURIComponent(token), { method:\"GET\" });\n      const data = await r.json().catch(function(){ return {}; });\n      if (data && data.ok) area.appendChild(msg(\"Link is valid. You can confirm now.\", \"ok\"));\n      else area.appendChild(msg(\"The link may be invalid or expired.\", \"err\"));\n    });\n\n    confirmBtn.addEventListener(\"click\", async ()=>{\n      area.textContent=\"\";\n      const token = tokRow.input.value.trim();\n      const res = await api(\"/api/reset/verify\", { method:\"POST\", body: JSON.stringify({ token }) });\n      const data = res.data || {};\n      if (data && data.ok){\n        area.appendChild(msg(\"Code accepted. Create a new password.\", \"ok\"));\n        navigate(\"#/set-password\");\n      } else {\n        area.appendChild(msg(\"We could not verify that code. Try again.\", \"err\"));\n      }\n    });\n  }\n\n  function passwordView(){\n    clear(view);\n    const h2 = document.createElement(\"h2\"); h2.textContent = \"Create a new password\";\n    view.appendChild(h2);\n    const bullets = document.createElement(\"ul\"); bullets.className=\"bullets\";\n    [\"Use at least 10 characters.\", \"Include upper, lower, number, and a symbol.\", \"Take your time. No auto-timeout on this page.\"].forEach(function(t){ const li=document.createElement(\"li\"); li.textContent=t; bullets.appendChild(li); });\n    view.appendChild(bullets);\n\n    const pwRow = labeledInput(\"New password\", \"password\", \"newpw\");\n    const pw2Row = labeledInput(\"Confirm password\", \"password\", \"confirmpw\");\n    view.appendChild(pwRow.frag);\n    view.appendChild(pw2Row.frag);\n\n    const showRow = document.createElement(\"div\"); showRow.className=\"row\";\n    const show = document.createElement(\"input\"); show.type=\"checkbox\"; show.id=\"show2\";\n    const showL = document.createElement(\"label\"); showL.htmlFor=\"show2\"; showL.textContent=\"Show passwords\";\n    showRow.appendChild(show); showRow.appendChild(showL);\n    view.appendChild(showRow);\n\n    const checklist = document.createElement(\"ul\"); checklist.className=\"checklist\";\n    const items = [\n      { id:\"len\", text:\"At least 10 characters\" },\n      { id:\"low\", text:\"One lowercase\" },\n      { id:\"upp\", text:\"One uppercase\" },\n      { id:\"num\", text:\"One number\" },\n      { id:\"sym\", text:\"One symbol (!@#$…)\" },\n      { id:\"mat\", text:\"Passwords match\" },\n    ];\n    const itemEls = {};\n    items.forEach(function(it){\n      const li = document.createElement(\"li\");\n      li.id = \"rule-\"+it.id;\n      li.textContent = \"• \" + it.text;\n      itemEls[it.id] = li;\n      checklist.appendChild(li);\n    });\n    view.appendChild(checklist);\n\n    function refreshChecks(){\n      const p1 = pwRow.input.value || \"\";\n      const p2 = pw2Row.input.value || \"\";\n      const rules = {\n        len: p1.length >= 10,\n        low: /[a-z]/.test(p1),\n        upp: /[A-Z]/.test(p1),\n        num: /[0-9]/.test(p1),\n        sym: /[^\\w\\s]/.test(p1),\n        mat: p1.length>0 && p1 === p2\n      };\n      Object.keys(rules).forEach(function(k){\n        const ok = rules[k];\n        const el = itemEls[k];\n        var base = el.textContent.replace(/^.? /,\"\");\n        el.textContent = (ok ? \"✓ \" : \"• \") + base;\n        el.className = ok ? \"okmark\" : \"warnmark\";\n      });\n      return Object.keys(rules).every(function(k){ return rules[k]; });\n    }\n    pwRow.input.addEventListener(\"input\", refreshChecks);\n    pw2Row.input.addEventListener(\"input\", refreshChecks);\n    show.addEventListener(\"change\", ()=> {\n      const t = show.checked ? \"text\" : \"password\";\n      pwRow.input.type = t; pw2Row.input.type = t;\n    });\n\n    const actions = document.createElement(\"div\"); actions.className=\"actions\";\n    const setBtn = mkBtn(\"Save new password\");\n    const copyRules = addCopyButton(function(){ return \"Password rules: at least 10 characters, include upper, lower, number, and a symbol.\"; });\n    actions.appendChild(setBtn); actions.appendChild(copyRules);\n    view.appendChild(actions);\n\n    const area = document.createElement(\"div\"); view.appendChild(area);\n\n    setBtn.addEventListener(\"click\", async ()=>{\n      area.textContent=\"\";\n      if (!refreshChecks()){\n        area.appendChild(msg(\"Please meet all rules before saving.\", \"err\"));\n        return;\n      }\n      const password = pwRow.input.value;\n      const res = await api(\"/api/password/set\", { method:\"POST\", body: JSON.stringify({ password }) });\n      const data = res.data || {};\n      if (data && data.ok){\n        area.appendChild(msg(\"Password updated.\", \"ok\"));\n        navigate(\"#/done\");\n      } else {\n        area.appendChild(msg(data && data.message ? data.message : \"Could not set password.\", \"err\"));\n      }\n    });\n  }\n\n  function mfaView(){\n    clear(view);\n    const h2 = document.createElement(\"h2\"); h2.textContent = \"Two-step verification\";\n    view.appendChild(h2);\n    const bullets = document.createElement(\"ul\"); bullets.className=\"bullets\";\n    [\"Enter the 6-digit code we sent.\", \"Codes expire quickly.\", \"Do not share codes with anyone.\"].forEach(function(t){ const li=document.createElement(\"li\"); li.textContent=t; bullets.appendChild(li); });\n    view.appendChild(bullets);\n\n    const codeRow = labeledInput(\"6-digit code\", \"text\", \"mfacode\");\n    view.appendChild(codeRow.frag);\n    const copyBtn = addCopyButton(function(){ return codeRow.input.value; });\n    view.appendChild(copyBtn);\n\n    const actions = document.createElement(\"div\"); actions.className=\"actions\";\n    const verifyBtn = mkBtn(\"Verify\");\n    actions.appendChild(verifyBtn);\n    view.appendChild(actions);\n\n    const area = document.createElement(\"div\"); view.appendChild(area);\n\n    verifyBtn.addEventListener(\"click\", async ()=>{\n      area.textContent=\"\";\n      const code = (codeRow.input.value || \"\").trim();\n      const res = await api(\"/api/mfa/verify\", { method:\"POST\", body: JSON.stringify({ code }) });\n      const data = res.data || {};\n      if (data && data.ok){\n        area.appendChild(msg(\"Verified.\", \"ok\"));\n        navigate(\"#/done\");\n      } else {\n        area.appendChild(msg(\"That code didn't work. Try again.\", \"err\"));\n      }\n    });\n  }\n\n  function doneView(){\n    clear(view);\n    const h2 = document.createElement(\"h2\"); h2.textContent = \"Portal\";\n    view.appendChild(h2);\n    const p = document.createElement(\"p\");\n    p.textContent = \"Welcome. Submission window is open.\";\n    view.appendChild(p);\n    const bullets = document.createElement(\"ul\"); bullets.className=\"bullets\";\n    [\"Prepare your assignment file.\", \"Check course page for final instructions.\", \"Submit before the deadline.\"].forEach(function(t){ const li=document.createElement(\"li\"); li.textContent=t; bullets.appendChild(li); });\n    view.appendChild(bullets);\n    const actions = document.createElement(\"div\"); actions.className=\"actions\";\n    const back = mkBtn(\"Log out\", \"secondary\");\n    back.addEventListener(\"click\", ()=> navigate(\"#/login\"));\n    actions.appendChild(back);\n    view.appendChild(actions);\n  }\n\n  async function render(){\n    const hash = location.hash || \"#/login\";\n    if (hash.indexOf(\"#/forgot\") === 0) forgotView();\n    else if (hash.indexOf(\"#/verify\") === 0) verifyView();\n    else if (hash.indexOf(\"#/mfa\") === 0) mfaView();\n    else if (hash.indexOf(\"#/set-password\") === 0) passwordView();\n    else if (hash.indexOf(\"#/done\") === 0) doneView();\n    else loginView();\n  }\n\n  if (!location.hash) location.hash = \"#/login\";\n  render();\n})();`;\n}\n\n// ---------------------------- API Handlers ----------------------------\nasync function handleApi(req: Request, url: URL, session: Session): Promise<Response> {\n  const path = url.pathname;\n\n  // Helper: secure JSON response builder\n  function json(data: any, status = 200): Response {\n    const nonce = makeNonce();\n    const headers = makeSecurityHeaders(nonce);\n    headers.set(\"Content-Type\", \"application/json; charset=utf-8\");\n    headers.append(\"Set-Cookie\", sessionCookie(session.id));\n    return new Response(JSON.stringify(data), { status, headers });\n  }\n\n  // [Security: 1 - CSRF] Provide CSRF for SPA; also ensures session exists (kept for completeness)\n  if (req.method === \"GET\" && path === \"/api/csrf\") {\n    return json({ ok: true, csrf: session.csrf });\n  }\n\n  async function requireCsrf(): Promise<string | null> {\n    const token = req.headers.get(\"X-CSRF-Token\") || \"\";\n    if (!token || token !== session.csrf) return null;\n    return token;\n  }\n\n  // [Security: Identification & Authentication] Login (rate limited, bcrypt verify, generic messages)\n  // [Security: 1 - CSRF] Protected by CSRF token\n  if (req.method === \"POST\" && path === \"/api/login\") {\n    const ip = req.headers.get(\"x-forwarded-for\") || req.headers.get(\"x-real-ip\") || \"local\";\n    const body = await req.text();\n    const data = parseJSON(body) || {};\n    const identifier = sanitizeIdentifier(String(data.identifier || \"\"));\n    const password = String(data.password || \"\");\n    if (!await requireCsrf()) return json({ ok: false, message: \"Invalid session. Refresh and try again.\" }, 403);\n\n    const key = `login:${ip}:${identifier}`;\n    if (rateLimited(key)) return json({ ok: false, message: \"Please wait a moment and try again.\" }, 429);\n\n    let user: User | null = null;\n    const userId = userByEmail.get(identifier) || userByUsername.get(identifier);\n    if (userId) user = users.get(userId) || null;\n\n    // Always perform a verify to keep timing generic\n    const fakeHash = await Bun.password.hash(\"not-the-password\", { algorithm: \"bcrypt\", cost: 10 });\n    const hash = user ? user.passwordHash : fakeHash;\n    const verified = await Bun.password.verify(password, hash);\n\n    if (!verified || !user) {\n      return json({ ok: false, message: \"Invalid login.\" }, 200);\n    }\n\n    // MFA flow\n    if (user.mfaEnabled) {\n      const code = generateDeterministicCode(session.id);\n      const expiresAt = now() + 5 * 60_000;\n      mfaCodes.set(session.id, { code, expiresAt, userId: user.id });\n      // Do not expose PII; return code for testing and log in client console\n      return json({ ok: true, mfaRequired: true, code, expiresAt, message: \"MFA required\" });\n    } else {\n      session.userId = user.id;\n      session.authenticated = true;\n      return json({ ok: true });\n    }\n  }\n\n  // [Security: Identification & Authentication] MFA verify (rate limited)\n  // [Security: 1 - CSRF] Protected by CSRF token\n  if (req.method === \"POST\" && path === \"/api/mfa/verify\") {\n    const ip = req.headers.get(\"x-forwarded-for\") || req.headers.get(\"x-real-ip\") || \"local\";\n    if (!await requireCsrf()) return json({ ok: false, message: \"Invalid session. Refresh and try again.\" }, 403);\n    const body = await req.text();\n    const data = parseJSON(body) || {};\n    const code = sanitizeCode(String(data.code || \"\")).padStart(6,\"0\").slice(-6);\n    const key = `mfa:${ip}:${session.id}`;\n    if (rateLimited(key)) return json({ ok: false, message: \"Please wait a moment and try again.\" }, 429);\n\n    const entry = mfaCodes.get(session.id);\n    if (!entry || now() > entry.expiresAt || entry.code !== code) {\n      return json({ ok: false, message: \"Invalid code.\" }, 200);\n    }\n    session.userId = entry.userId;\n    session.authenticated = true;\n    mfaCodes.delete(session.id);\n    return json({ ok: true });\n  }\n\n  // [Security: Reset start] Always generic success, generate single-use token; store sink if unknown user\n  // [Security: 1 - CSRF] Protected by CSRF token\n  if (req.method === \"POST\" && path === \"/api/reset/start\") {\n    const ip = req.headers.get(\"x-forwarded-for\") || req.headers.get(\"x-real-ip\") || \"local\";\n    if (!await requireCsrf()) return json({ ok: false, message: \"Invalid session. Refresh and try again.\" }, 403);\n    const body = await req.text();\n    const data = parseJSON(body) || {};\n    const email = sanitizeEmail(String(data.email || \"\"));\n    const key = `resetstart:${ip}:${email}`;\n    if (rateLimited(key)) return json({ ok: true, message: \"If the account exists, a reset email was sent.\" }, 200);\n\n    const uid = userByEmail.get(email) || null;\n    const token = randomId(24);\n    const expiresAt = now() + 10 * 60_000;\n    resetTokens.set(token, { token, userId: uid ?? null, createdAt: now(), expiresAt, used: false });\n\n    // Return token for testing; client logs to browser console.\n    return json({ ok: true, token, expiresAt, message: \"If the account exists, a reset email was sent.\" });\n  }\n\n  // [Security: 1 - CSRF coverage] GET /api/reset/preview is read-only and does NOT modify session.\n  // Only validates token and returns { ok, reason? }.\n  if (req.method === \"GET\" && path === \"/api/reset/preview\") {\n    const token = sanitizeCode(String(url.searchParams.get(\"token\") || \"\"));\n    const rec = resetTokens.get(token);\n    let reason: string | undefined;\n    if (!rec) reason = \"invalid\";\n    else if (rec.used) reason = \"used\";\n    else if (now() > rec.expiresAt) reason = \"expired\";\n    if (reason) return json({ ok: false, reason }, 200);\n    return json({ ok: true }, 200);\n  }\n\n  // [Security: Reset verify] Single-use token consumption; set session flag to allow password set\n  // [Security: 1 - CSRF] Protected by CSRF token; requires { token } in POST body.\n  if (req.method === \"POST\" && path === \"/api/reset/verify\") {\n    const ip = req.headers.get(\"x-forwarded-for\") || req.headers.get(\"x-real-ip\") || \"local\";\n    if (!await requireCsrf()) return json({ ok: false, message: \"Invalid session. Refresh and try again.\" }, 403);\n    const key = `resetverify:${ip}:${session.id}`;\n    if (rateLimited(key)) return json({ ok: false, message: \"Please wait and try again.\" }, 429);\n\n    const body = await req.text();\n    const data = parseJSON(body) || {};\n    const token = sanitizeCode(String(data.token || \"\"));\n    if (!token) return json({ ok: false, message: \"Token is required.\" }, 400);\n\n    const rec = resetTokens.get(token);\n    if (!rec || rec.used || now() > rec.expiresAt) {\n      return json({ ok: false, message: \"Invalid code.\" }, 200);\n    }\n    // Consume token\n    rec.used = true;\n    resetTokens.set(token, rec);\n    session.resetAllowed = true;\n    session.resetUserId = rec.userId; // may be null to avoid user existence leak\n    return json({ ok: true });\n  }\n\n  // [Security: Password set] Strong policy, requires reset context, bcrypt hashing\n  // [Security: 1 - CSRF] Protected by CSRF token\n  if (req.method === \"POST\" && path === \"/api/password/set\") {\n    if (!await requireCsrf()) return json({ ok: false, message: \"Invalid session. Refresh and try again.\" }, 403);\n    if (!session.resetAllowed) return json({ ok: false, message: \"Reset not verified. Start again.\" }, 400);\n\n    const body = await req.text();\n    const data = parseJSON(body) || {};\n    const password = String(data.password || \"\");\n    const issues = passwordPolicyIssues(password);\n    if (issues.length > 0) {\n      return json({ ok: false, message: \"Password does not meet policy.\" }, 200);\n    }\n\n    // Save only if associated with a real user\n    if (session.resetUserId) {\n      const user = users.get(session.resetUserId);\n      if (user) {\n        const newHash = await Bun.password.hash(password, { algorithm: \"bcrypt\", cost: 10 });\n        user.passwordHash = newHash;\n        users.set(user.id, user);\n      }\n    }\n    // Invalidate context\n    session.resetAllowed = false;\n    session.resetUserId = undefined;\n    return json({ ok: true });\n  }\n\n  // Unknown API\n  return json({ ok: false, message: \"Not found\" }, 404);\n}\n\n// ---------------------------- Main request handler ----------------------------\nasync function handleRequest(req: Request): Promise<Response> {\n  const url = new URL(req.url);\n\n  const cookies = getCookieMap(req);\n  let session = getOrCreateSession(cookies[\"sid\"]);\n  let nonce = makeNonce();\n  let headers = makeSecurityHeaders(nonce);\n  headers.append(\"Set-Cookie\", sessionCookie(session.id));\n\n  // All API routes\n  if (url.pathname.startsWith(\"/api/\")) {\n    return handleApi(req, url, session);\n  }\n\n  // Serve SPA JS from /app.js\n  if (req.method === \"GET\" && url.pathname === \"/app.js\") {\n    const js = clientJs();\n    const h = makeSecurityHeaders(makeNonce());\n    h.set(\"Content-Type\", \"application/javascript; charset=utf-8\");\n    h.append(\"Set-Cookie\", sessionCookie(session.id));\n    return new Response(js, { status: 200, headers: h });\n  }\n\n  // All GET routes serve the SPA HTML\n  if (req.method === \"GET\") {\n    const body = htmlPage(nonce, session.csrf);\n    headers.set(\"Content-Type\", \"text/html; charset=utf-8\");\n    return new Response(body, { status: 200, headers });\n  }\n\n  // Default: method not allowed\n  return new Response(\"Method Not Allowed\", { status: 405, headers });\n}\n\n// ---------------------------- Servers (HTTPS and HTTP->HTTPS redirect) ----------------------------\n// [Security: HTTPS + HSTS] Enforce HTTPS; development uses provided certs.\n// Start HTTPS on 3443\nconst httpsServer = Bun.serve({\n  port: 3443,\n  cert: Bun.file(CERT_PATH),\n  key: Bun.file(KEY_PATH),\n  reusePort: true,\n  idleTimeout: 60,\n  fetch: handleRequest,\n});\n\n// Start HTTP on 3000 that redirects to HTTPS\nconst httpServer = Bun.serve({\n  port: 3000,\n  reusePort: true,\n  fetch(req: Request) {\n    const url = new URL(req.url);\n    const location = `https://localhost:3443${url.pathname}${url.search}`;\n    return new Response(null, { status: 301, headers: { Location: location } });\n  },\n});\n\n// Log start (appears in server console; browser console is handled inside the SPA)\nconsole.log(`HTTPS server running on https://localhost:3443  (HTTP redirect on http://localhost:3000)`);\n\n// -----------------------------------------------------------------------------------------------\n// Notes mapping to Requirements:\n// - Inclusivity: clear language, bullet points, high contrast; Read Aloud and Copy buttons in views.\n// - Security: 1 (Broken Access Control & CSRF) - Per-session CSRF token is embedded in a meta tag and required on all sensitive POST routes (/api/login, /api/mfa/verify, /api/reset/start, /api/reset/verify, /api/password/set).\n// - Security: 2 (Injection/XSS) - No inline scripts or inline handlers; CSP sets script-src 'self'; DOM uses textContent and sanitized inputs.\n// - Security: Passwords hashed with bcrypt via Bun.password; strong policy enforced.\n// - Security: MFA flow with deterministic 6-digit code per-session; logged to browser console for testing.\n// - Security: Reset tokens are random, single-use, short-lived. GET /api/reset/preview is read-only, POST /api/reset/verify consumes token and sets session verification.\n// - Security: Rate limiting for login and reset; generic error messages to avoid info leaks.\n// - Privacy: No PII in responses beyond necessary, no exposure of usernames; tokens/codes only in console logs.\n// - SSRF/Open Redirect: No external redirects; ignore any next/redirect usage; only internal hash routes.\n// - SPA: Single file, no external assets; all routes functional within hash router.\n// -----------------------------------------------------------------------------------------------\n", "task_list": [], "evaluator_md": "SUMMARY:\nThe provided single-file Bun app (app.ts) implements a secure, inclusive password recovery flow as a SPA with HTTPS, CSP, CSRF protection, MFA, rate limiting, and strong password policy. It simulates delivery of reset tokens and MFA codes via browser console (also shown in a Logs panel). The UI is clear, accessible, and supports read-aloud and copy actions. No external assets or network calls are used. Overall, it satisfies the functional, UX, and security requirements without evident runtime or logic errors.\n\nFUNCTIONAL_CHECK:\n- Single-file SPA, served by Bun, no external assets/tools: PASS — Everything (HTML, CSS, JS, API, server) is contained in app.ts; /app.js is served from memory by the same file.\n- HTTPS enforced with TLS certs; HTTP redirects to HTTPS: PASS — Uses certs/cert.pem and certs/key.pem with HTTPS on 3443 and 301 redirect from 3000 to HTTPS.\n- Interactivity works directly in browser: PASS — SPA renders, router via hash, all flows navigate correctly.\n- Mocks via browser console; reset token surfaced in browser: PASS — Tokens and codes logged in Logs panel (console.log override) and returned in JSON for testing.\n- Manual code submission plus link-based verification: PASS — #/verify allows manual code entry; link carries token via hash; preview + confirm endpoints provided.\n- All internal links/pages function: PASS — Router handles #/login, #/forgot, #/verify, #/mfa, #/set-password, #/done; toolbar buttons work.\n- Inclusivity (plain language, bullets, structure, contrast, readable fonts): PASS — Short instructions, bullet points, headings, high-contrast palette.\n- Inclusivity (read aloud and copy support): PASS — Read Aloud via SpeechSynthesis; copy buttons to help copy steps and codes.\n- Inclusivity (error guidance and time flexibility): PASS — Clear messages; strong password checklist; no auto-timeout on set-password; expiry times logged.\n- Security 1: Broken Access Control/CSRF: PASS — Per-session CSRF token embedded and required for all sensitive POSTs; cookies are Secure, HttpOnly, SameSite=Strict; no user enumeration in responses.\n- Security 2: Injection (XSS): PASS — No inline scripts; CSP script-src 'self'; inputs sanitized; outputs via textContent; meta content escaped. Framework auto-escaping not applicable; mitigated via CSP and manual escaping.\n- Security 3: Security Misconfiguration: PASS — HSTS, CSP, Referrer-Policy, X-Content-Type-Options, frame-ancestors; random, single-use, 10-minute reset tokens; no debug leaks; no external calls.\n- Security 4: Identification and Authentication Failures: PASS — bcrypt password hashing; MFA implemented; throttling for login/MFA/reset; strong password policy enforced; secure token validation; generic feedback against enumeration.\n- Security 5: SSRF and Social Engineering: PASS — No outgoing URL fetches; no open redirects; safe-practice hints present.\n- Semantic HTML and minimal inline styles with comments tied to requirements: PASS — Uses header/main/section/aside/footer; helpful comments match requirement sections.\n- Zero-compilation/zero-bundler compliance with Bun 1.3.0: PASS — Runs with bun app.ts; no build steps required.\n\nFAILING_ITEMS:\n- None identified.\n\nNEW_TASKS:\n- N/A\n\nDECISION:\nPASS", "done": true, "iter": 2, "step": 6}
